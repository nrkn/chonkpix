import { generateHeightmap } from '../lib/heightmap/generate/index.js';
import { flattenRect, lowerRect, raiseRect } from '../lib/heightmap/sculpt.js';
import { heightmapToPoint3, maxHeight, minHeight, normalizeHeightmap } from '../lib/heightmap/util.js';
import { randInt } from '../lib/random.js';
import { fpsSceneHelper } from '../lib/scene/fps.js';
import { exitOnEscape, zoomOnWheel } from '../lib/scene/io.js';
import { maybe } from '../lib/util.js';
import { blitVoxels } from '../lib/voxel/blit.js';
import { createPlane, createWall } from '../lib/voxel/generate/create.js';
const mapW = 256;
const mapH = 256;
const mapCx = mapW / 2;
const mapCy = mapH / 2;
export const voxelScene = () => {
    let isActive = false;
    let voxels;
    let dirty = true;
    let fpsHelper;
    const init = async (state) => {
        voxels = generateVoxels();
        fpsHelper = fpsSceneHelper();
        await fpsHelper.init(state);
        isActive = true;
    };
    const io = (state) => {
        if (exitOnEscape(state))
            return;
        if (zoomOnWheel(state)) {
            dirty = true;
        }
    };
    const update = (state) => {
        if (!maybe(voxels))
            throw Error('voxels not initialized');
        if (!maybe(fpsHelper))
            throw Error('fpsHelper not initialized');
        if (isActive)
            io(state);
        if (!dirty)
            return;
        const buffer = state.view.getBuffer();
        const { width, height } = buffer;
        blitVoxels(buffer, voxels);
        dirty = false;
        fpsHelper.update(state);
    };
    const quit = async (_state) => {
        isActive = false;
        voxels = null;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
const generateVoxels = () => {
    const hm = normalizeHeightmap(generateHeightmap(mapW, mapH));
    // sculpt the heightmap
    const raisedHeight = raiseRect(hm, 96, 80, 16, 12);
    // x0,z0,x1,z1,y0,h - 3d coordinate system of voxel space
    const rTopWall = createWall(97, 111, 110, 111, raisedHeight, 8);
    const rBottomWall = createWall(97, 101, 110, 101, raisedHeight, 8);
    const rLeftWall = createWall(97, 110, 97, 102, raisedHeight, 8);
    const rRightWall = createWall(110, 110, 110, 102, raisedHeight, 8);
    const rRoof = createPlane(97, raisedHeight + 8, 101, 14, 10);
    const rWalls = [
        ...rTopWall,
        ...rBottomWall,
        ...rLeftWall,
        ...rRightWall,
        ...rRoof
    ];
    const rWallsVox = rWalls.map(([x, y, z]) => {
        let fcolor = 0;
        let tcolor = 0;
        const d = mapH * 2;
        const darken = 1 - z / d;
        const v = randInt(32) - 16;
        const grey = (v + 128 + y * 0.5) * darken;
        const darkGrey = grey * 0.75;
        fcolor = 0xff000000 | (grey << 16) | (grey << 8) | grey;
        tcolor = 0xff000000 | (darkGrey << 16) | (darkGrey << 8) | darkGrey;
        return [x, y, z, tcolor, fcolor];
    });
    const loweredHeight = lowerRect(hm, 32, 48, 12, 16);
    const flattenedHeight = flattenRect(hm, 64, 64, 16, 24);
    // convert the hm
    const hmP3s = heightmapToPoint3(hm);
    const hmMin = minHeight(hm);
    const hmMax = maxHeight(hm);
    const hmDelta = hmMax - hmMin;
    const greenRange = mapH;
    const greenStep = greenRange / hmDelta;
    const hmP3sVox = hmP3s.map(([x, y, z]) => {
        let hmTopColor = 0;
        let hmFrontColor = 0;
        // darken slightly as z increases
        // lower d numbers = more dark, higher = less dark
        const d = mapH * 2;
        const darken = 1 - z / d;
        // add a little randomness to the green color by using small red/blue values
        const red = (randInt(32) + 16); //* darken
        const darkRed = red * 0.75;
        const blue = (randInt(32) + 16); //* darken
        const darkBlue = blue * 0.75;
        // top should gets brighter as y increases
        // front should be top but darkened a bit
        //
        // make it a little random so it looks more interesting
        const g = randInt(32) - 16;
        // then apply a gradient based on height
        const green = (g + 64 + y * greenStep) * darken;
        const darkGreen = green * 0.75;
        hmTopColor = 0xff000000 | (blue << 16) | (green << 8) | red;
        hmFrontColor = 0xff000000 | (darkBlue << 16) | (darkGreen << 8) | darkRed;
        return [x, y, z, hmTopColor, hmFrontColor];
    });
    const voxels = [];
    voxels.push(...rWallsVox);
    voxels.push(...hmP3sVox);
    voxels.sort((a, b) => {
        // sort on z - bigger is further away
        const zDelta = b[2] - a[2];
        if (zDelta !== 0) {
            return zDelta;
        }
        // tie break on y - we want to sort smaller y first
        // so that the "tops" of voxels overlay correctly
        return a[1] - b[1];
    });
    return voxels;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm94ZWwtc2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2NlbmVzL3ZveGVsLXNjZW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLG9DQUFvQyxDQUFBO0FBQ3RFLE9BQU8sRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLDRCQUE0QixDQUFBO0FBQzlFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFDdEcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQzFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQTtBQUNwRCxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBRTlELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUN0QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDakQsT0FBTyxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQTtBQUd6RSxNQUFNLElBQUksR0FBRyxHQUFHLENBQUE7QUFDaEIsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFBO0FBRWhCLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUE7QUFDdEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQTtBQUV0QixNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUcsR0FBVSxFQUFFO0lBQ3BDLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQTtJQUNwQixJQUFJLE1BQW9CLENBQUE7SUFDeEIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFBO0lBQ2hCLElBQUksU0FBdUIsQ0FBQTtJQUUzQixNQUFNLElBQUksR0FB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QUFDLENBQUMsQ0FBQTtJQUNwQixDQUFDLENBQUMsQ0FBQTtJQUVGLE9BQU8sTUFBTSxDQUFBO0FBQ2YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2VuZXJhdGVIZWlnaHRtYXAgfSBmcm9tICcuLi9saWIvaGVpZ2h0bWFwL2dlbmVyYXRlL2luZGV4LmpzJ1xyXG5pbXBvcnQgeyBmbGF0dGVuUmVjdCwgbG93ZXJSZWN0LCByYWlzZVJlY3QgfSBmcm9tICcuLi9saWIvaGVpZ2h0bWFwL3NjdWxwdC5qcydcclxuaW1wb3J0IHsgaGVpZ2h0bWFwVG9Qb2ludDMsIG1heEhlaWdodCwgbWluSGVpZ2h0LCBub3JtYWxpemVIZWlnaHRtYXAgfSBmcm9tICcuLi9saWIvaGVpZ2h0bWFwL3V0aWwuanMnXHJcbmltcG9ydCB7IHJhbmRJbnQgfSBmcm9tICcuLi9saWIvcmFuZG9tLmpzJ1xyXG5pbXBvcnQgeyBmcHNTY2VuZUhlbHBlciB9IGZyb20gJy4uL2xpYi9zY2VuZS9mcHMuanMnXHJcbmltcG9ydCB7IGV4aXRPbkVzY2FwZSwgem9vbU9uV2hlZWwgfSBmcm9tICcuLi9saWIvc2NlbmUvaW8uanMnXHJcbmltcG9ydCB7IE1heWJlLCBTY2VuZSwgU3RhdGUgfSBmcm9tICcuLi9saWIvdHlwZXMuanMnXHJcbmltcG9ydCB7IG1heWJlIH0gZnJvbSAnLi4vbGliL3V0aWwuanMnXHJcbmltcG9ydCB7IGJsaXRWb3hlbHMgfSBmcm9tICcuLi9saWIvdm94ZWwvYmxpdC5qcydcclxuaW1wb3J0IHsgY3JlYXRlUGxhbmUsIGNyZWF0ZVdhbGwgfSBmcm9tICcuLi9saWIvdm94ZWwvZ2VuZXJhdGUvY3JlYXRlLmpzJ1xyXG5pbXBvcnQgeyBWb3ggfSBmcm9tICcuLi9saWIvdm94ZWwvdHlwZXMuanMnXHJcblxyXG5jb25zdCBtYXBXID0gMjU2XHJcbmNvbnN0IG1hcEggPSAyNTZcclxuXHJcbmNvbnN0IG1hcEN4ID0gbWFwVyAvIDJcclxuY29uc3QgbWFwQ3kgPSBtYXBIIC8gMlxyXG5cclxuZXhwb3J0IGNvbnN0IHZveGVsU2NlbmUgPSAoKTogU2NlbmUgPT4ge1xyXG4gIGxldCBpc0FjdGl2ZSA9IGZhbHNlXHJcbiAgbGV0IHZveGVsczogTWF5YmU8Vm94W10+XHJcbiAgbGV0IGRpcnR5ID0gdHJ1ZVxyXG4gIGxldCBmcHNIZWxwZXI6IE1heWJlPFNjZW5lPlxyXG5cclxuICBjb25zdCBpbml0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgdm94ZWxzID0gZ2VuZXJhdGVWb3hlbHMoKVxyXG4gICAgZnBzSGVscGVyID0gZnBzU2NlbmVIZWxwZXIoKVxyXG5cclxuICAgIGF3YWl0IGZwc0hlbHBlci5pbml0KHN0YXRlKVxyXG5cclxuICAgIGlzQWN0aXZlID0gdHJ1ZVxyXG4gIH1cclxuXHJcbiAgY29uc3QgaW8gPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpZiAoZXhpdE9uRXNjYXBlKHN0YXRlKSkgcmV0dXJuXHJcblxyXG4gICAgaWYgKHpvb21PbldoZWVsKHN0YXRlKSkge1xyXG4gICAgICBkaXJ0eSA9IHRydWVcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGlmICghbWF5YmUodm94ZWxzKSkgdGhyb3cgRXJyb3IoJ3ZveGVscyBub3QgaW5pdGlhbGl6ZWQnKVxyXG4gICAgaWYgKCFtYXliZShmcHNIZWxwZXIpKSB0aHJvdyBFcnJvcignZnBzSGVscGVyIG5vdCBpbml0aWFsaXplZCcpXHJcblxyXG4gICAgaWYgKGlzQWN0aXZlKSBpbyhzdGF0ZSlcclxuXHJcbiAgICBpZiAoIWRpcnR5KSByZXR1cm5cclxuXHJcbiAgICBjb25zdCBidWZmZXIgPSBzdGF0ZS52aWV3LmdldEJ1ZmZlcigpXHJcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IGJ1ZmZlclxyXG5cclxuICAgIGJsaXRWb3hlbHMoYnVmZmVyLCB2b3hlbHMpXHJcblxyXG4gICAgZGlydHkgPSBmYWxzZVxyXG5cclxuICAgIGZwc0hlbHBlci51cGRhdGUoc3RhdGUpXHJcbiAgfVxyXG5cclxuICBjb25zdCBxdWl0ID0gYXN5bmMgKF9zdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGlzQWN0aXZlID0gZmFsc2VcclxuICAgIHZveGVscyA9IG51bGxcclxuICB9XHJcblxyXG4gIGNvbnN0IHNldEFjdGl2ZSA9IChhY3RpdmU6IGJvb2xlYW4pID0+IHtcclxuICAgIGlzQWN0aXZlID0gYWN0aXZlXHJcbiAgfVxyXG5cclxuICByZXR1cm4geyBpbml0LCB1cGRhdGUsIHF1aXQsIHNldEFjdGl2ZSB9XHJcbn1cclxuXHJcbmNvbnN0IGdlbmVyYXRlVm94ZWxzID0gKCkgPT4ge1xyXG4gIGNvbnN0IGhtID0gbm9ybWFsaXplSGVpZ2h0bWFwKGdlbmVyYXRlSGVpZ2h0bWFwKG1hcFcsIG1hcEgpKVxyXG5cclxuICAvLyBzY3VscHQgdGhlIGhlaWdodG1hcFxyXG5cclxuICBjb25zdCByYWlzZWRIZWlnaHQgPSByYWlzZVJlY3QoaG0sIDk2LCA4MCwgMTYsIDEyKVxyXG5cclxuICAvLyB4MCx6MCx4MSx6MSx5MCxoIC0gM2QgY29vcmRpbmF0ZSBzeXN0ZW0gb2Ygdm94ZWwgc3BhY2VcclxuICBjb25zdCByVG9wV2FsbCA9IGNyZWF0ZVdhbGwoOTcsIDExMSwgMTEwLCAxMTEsIHJhaXNlZEhlaWdodCwgOClcclxuICBjb25zdCByQm90dG9tV2FsbCA9IGNyZWF0ZVdhbGwoOTcsIDEwMSwgMTEwLCAxMDEsIHJhaXNlZEhlaWdodCwgOClcclxuICBjb25zdCByTGVmdFdhbGwgPSBjcmVhdGVXYWxsKDk3LCAxMTAsIDk3LCAxMDIsIHJhaXNlZEhlaWdodCwgOClcclxuICBjb25zdCByUmlnaHRXYWxsID0gY3JlYXRlV2FsbCgxMTAsIDExMCwgMTEwLCAxMDIsIHJhaXNlZEhlaWdodCwgOClcclxuXHJcbiAgY29uc3QgclJvb2YgPSBjcmVhdGVQbGFuZSg5NywgcmFpc2VkSGVpZ2h0ICsgOCwgMTAxLCAxNCwgMTApXHJcblxyXG4gIGNvbnN0IHJXYWxscyA9IFtcclxuICAgIC4uLnJUb3BXYWxsLFxyXG4gICAgLi4uckJvdHRvbVdhbGwsXHJcbiAgICAuLi5yTGVmdFdhbGwsXHJcbiAgICAuLi5yUmlnaHRXYWxsLFxyXG4gICAgLi4uclJvb2ZcclxuICBdXHJcblxyXG4gIGNvbnN0IHJXYWxsc1ZveCA9IHJXYWxscy5tYXAoKFt4LCB5LCB6XSkgPT4ge1xyXG4gICAgbGV0IGZjb2xvciA9IDBcclxuICAgIGxldCB0Y29sb3IgPSAwXHJcblxyXG4gICAgY29uc3QgZCA9IG1hcEggKiAyXHJcbiAgICBjb25zdCBkYXJrZW4gPSAxIC0geiAvIGRcclxuXHJcbiAgICBjb25zdCB2ID0gcmFuZEludCgzMikgLSAxNlxyXG5cclxuICAgIGNvbnN0IGdyZXkgPSAodiArIDEyOCArIHkgKiAwLjUpICogZGFya2VuXHJcbiAgICBjb25zdCBkYXJrR3JleSA9IGdyZXkgKiAwLjc1XHJcblxyXG4gICAgZmNvbG9yID0gMHhmZjAwMDAwMCB8IChncmV5IDw8IDE2KSB8IChncmV5IDw8IDgpIHwgZ3JleVxyXG4gICAgdGNvbG9yID0gMHhmZjAwMDAwMCB8IChkYXJrR3JleSA8PCAxNikgfCAoZGFya0dyZXkgPDwgOCkgfCBkYXJrR3JleVxyXG5cclxuICAgIHJldHVybiBbeCwgeSwgeiwgdGNvbG9yLCBmY29sb3JdIGFzIFZveFxyXG4gIH0pXHJcblxyXG4gIGNvbnN0IGxvd2VyZWRIZWlnaHQgPSBsb3dlclJlY3QoaG0sIDMyLCA0OCwgMTIsIDE2KVxyXG5cclxuICBjb25zdCBmbGF0dGVuZWRIZWlnaHQgPSBmbGF0dGVuUmVjdChobSwgNjQsIDY0LCAxNiwgMjQpXHJcblxyXG4gIC8vIGNvbnZlcnQgdGhlIGhtXHJcblxyXG4gIGNvbnN0IGhtUDNzID0gaGVpZ2h0bWFwVG9Qb2ludDMoaG0pXHJcblxyXG4gIGNvbnN0IGhtTWluID0gbWluSGVpZ2h0KGhtKVxyXG4gIGNvbnN0IGhtTWF4ID0gbWF4SGVpZ2h0KGhtKVxyXG5cclxuICBjb25zdCBobURlbHRhID0gaG1NYXggLSBobU1pblxyXG5cclxuICBjb25zdCBncmVlblJhbmdlID0gbWFwSFxyXG5cclxuICBjb25zdCBncmVlblN0ZXAgPSBncmVlblJhbmdlIC8gaG1EZWx0YVxyXG5cclxuICBjb25zdCBobVAzc1ZveCA9IGhtUDNzLm1hcCgoW3gsIHksIHpdKSA9PiB7XHJcbiAgICBsZXQgaG1Ub3BDb2xvciA9IDBcclxuICAgIGxldCBobUZyb250Q29sb3IgPSAwXHJcblxyXG4gICAgLy8gZGFya2VuIHNsaWdodGx5IGFzIHogaW5jcmVhc2VzXHJcbiAgICAvLyBsb3dlciBkIG51bWJlcnMgPSBtb3JlIGRhcmssIGhpZ2hlciA9IGxlc3MgZGFya1xyXG4gICAgY29uc3QgZCA9IG1hcEggKiAyXHJcbiAgICBjb25zdCBkYXJrZW4gPSAxIC0geiAvIGRcclxuXHJcbiAgICAvLyBhZGQgYSBsaXR0bGUgcmFuZG9tbmVzcyB0byB0aGUgZ3JlZW4gY29sb3IgYnkgdXNpbmcgc21hbGwgcmVkL2JsdWUgdmFsdWVzXHJcbiAgICBjb25zdCByZWQgPSAocmFuZEludCgzMikgKyAxNikgLy8qIGRhcmtlblxyXG4gICAgY29uc3QgZGFya1JlZCA9IHJlZCAqIDAuNzVcclxuICAgIGNvbnN0IGJsdWUgPSAocmFuZEludCgzMikgKyAxNikgLy8qIGRhcmtlblxyXG4gICAgY29uc3QgZGFya0JsdWUgPSBibHVlICogMC43NVxyXG5cclxuICAgIC8vIHRvcCBzaG91bGQgZ2V0cyBicmlnaHRlciBhcyB5IGluY3JlYXNlc1xyXG4gICAgLy8gZnJvbnQgc2hvdWxkIGJlIHRvcCBidXQgZGFya2VuZWQgYSBiaXRcclxuICAgIC8vXHJcbiAgICAvLyBtYWtlIGl0IGEgbGl0dGxlIHJhbmRvbSBzbyBpdCBsb29rcyBtb3JlIGludGVyZXN0aW5nXHJcbiAgICBjb25zdCBnID0gcmFuZEludCgzMikgLSAxNlxyXG4gICAgLy8gdGhlbiBhcHBseSBhIGdyYWRpZW50IGJhc2VkIG9uIGhlaWdodFxyXG4gICAgY29uc3QgZ3JlZW4gPSAoZyArIDY0ICsgeSAqIGdyZWVuU3RlcCkgKiBkYXJrZW5cclxuICAgIGNvbnN0IGRhcmtHcmVlbiA9IGdyZWVuICogMC43NVxyXG5cclxuICAgIGhtVG9wQ29sb3IgPSAweGZmMDAwMDAwIHwgKGJsdWUgPDwgMTYpIHwgKGdyZWVuIDw8IDgpIHwgcmVkXHJcbiAgICBobUZyb250Q29sb3IgPSAweGZmMDAwMDAwIHwgKGRhcmtCbHVlIDw8IDE2KSB8IChkYXJrR3JlZW4gPDwgOCkgfCBkYXJrUmVkXHJcblxyXG4gICAgcmV0dXJuIFt4LCB5LCB6LCBobVRvcENvbG9yLCBobUZyb250Q29sb3JdIGFzIFZveFxyXG4gIH0pXHJcblxyXG4gIGNvbnN0IHZveGVsczogVm94W10gPSBbXVxyXG5cclxuICB2b3hlbHMucHVzaCguLi5yV2FsbHNWb3gpXHJcbiAgdm94ZWxzLnB1c2goLi4uaG1QM3NWb3gpXHJcblxyXG4gIHZveGVscy5zb3J0KChhLCBiKSA9PiB7XHJcbiAgICAvLyBzb3J0IG9uIHogLSBiaWdnZXIgaXMgZnVydGhlciBhd2F5XHJcbiAgICBjb25zdCB6RGVsdGEgPSBiWzJdIC0gYVsyXVxyXG5cclxuICAgIGlmICh6RGVsdGEgIT09IDApIHtcclxuICAgICAgcmV0dXJuIHpEZWx0YVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHRpZSBicmVhayBvbiB5IC0gd2Ugd2FudCB0byBzb3J0IHNtYWxsZXIgeSBmaXJzdFxyXG4gICAgLy8gc28gdGhhdCB0aGUgXCJ0b3BzXCIgb2Ygdm94ZWxzIG92ZXJsYXkgY29ycmVjdGx5XHJcbiAgICByZXR1cm4gYVsxXSAtIGJbMV1cclxuICB9KVxyXG5cclxuICByZXR1cm4gdm94ZWxzXHJcbn0iXX0=
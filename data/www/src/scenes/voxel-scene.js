import { generateHeightmap } from '../lib/heightmap/generate/index.js';
import { flattenRect, lowerRect, raiseRect } from '../lib/heightmap/sculpt.js';
import { heightmapToPoint3, maxHeight, minHeight, normalizeHeightmap } from '../lib/heightmap/util.js';
import { randInt } from '../lib/random.js';
import { exitOnEscape, zoomOnWheel } from '../lib/scene/io.js';
import { maybe } from '../lib/util.js';
import { blitVoxels } from '../lib/voxel/blit.js';
import { createPlane, createWall } from '../lib/voxel/generate/create.js';
const mapW = 256;
const mapH = 256;
export const voxelScene = () => {
    let isActive = false;
    let voxels;
    let dirty = true;
    const init = async (state) => {
        voxels = generateVoxels();
        isActive = true;
    };
    const io = (state) => {
        if (exitOnEscape(state))
            return;
        if (zoomOnWheel(state)) {
            dirty = true;
        }
    };
    const update = (state) => {
        if (!maybe(voxels))
            throw Error('voxels not initialized');
        if (isActive)
            io(state);
        if (!dirty)
            return;
        const buffer = state.view.getBuffer();
        const { width, height } = buffer;
        const dx = Math.floor((width - mapW) / 2);
        const dy = Math.floor((height - mapH) / 2);
        blitVoxels(buffer, voxels, dx, dy);
        dirty = false;
    };
    const quit = async (_state) => {
        isActive = false;
        voxels = null;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
const generateVoxels = () => {
    const hm = normalizeHeightmap(generateHeightmap(mapW, mapH));
    // sculpt the heightmap
    const raisedHeight = raiseRect(hm, 96, 80, 16, 12);
    // x0,z0,x1,z1,y0,h - 3d coordinate system of voxel space
    const rTopWall = createWall(97, 111, 110, 111, raisedHeight, 8);
    const rBottomWall = createWall(97, 101, 110, 101, raisedHeight, 8);
    const rLeftWall = createWall(97, 110, 97, 102, raisedHeight, 8);
    const rRightWall = createWall(110, 110, 110, 102, raisedHeight, 8);
    const rRoof = createPlane(97, raisedHeight + 8, 101, 14, 10);
    const rWalls = [
        ...rTopWall,
        ...rBottomWall,
        ...rLeftWall,
        ...rRightWall,
        ...rRoof
    ];
    const rWallsVox = rWalls.map(([x, y, z]) => {
        let fcolor = 0;
        let tcolor = 0;
        const d = mapH * 2;
        const darken = 1 - z / d;
        const v = randInt(32) - 16;
        const grey = (v + 128 + y * 0.5) * darken;
        const darkGrey = grey * 0.75;
        fcolor = 0xff000000 | (grey << 16) | (grey << 8) | grey;
        tcolor = 0xff000000 | (darkGrey << 16) | (darkGrey << 8) | darkGrey;
        return [x, y, z, tcolor, fcolor];
    });
    const loweredHeight = lowerRect(hm, 32, 48, 12, 16);
    const flattenedHeight = flattenRect(hm, 64, 64, 16, 24);
    // convert the hm
    const hmP3s = heightmapToPoint3(hm);
    const hmMin = minHeight(hm);
    const hmMax = maxHeight(hm);
    const hmDelta = hmMax - hmMin;
    const greenRange = mapH;
    const greenStep = greenRange / hmDelta;
    const hmP3sVox = hmP3s.map(([x, y, z]) => {
        let hmTopColor = 0;
        let hmFrontColor = 0;
        // darken slightly as z increases
        // lower d numbers = more dark, higher = less dark
        const d = mapH * 2;
        const darken = 1 - z / d;
        // add a little randomness to the green color by using small red/blue values
        const red = (randInt(32) + 16); //* darken
        const darkRed = red * 0.75;
        const blue = (randInt(32) + 16); //* darken
        const darkBlue = blue * 0.75;
        // top should gets brighter as y increases
        // front should be top but darkened a bit
        //
        // make it a little random so it looks more interesting
        const g = randInt(32) - 16;
        // then apply a gradient based on height
        const green = (g + 64 + y * greenStep) * darken;
        const darkGreen = green * 0.75;
        hmTopColor = 0xff000000 | (blue << 16) | (green << 8) | red;
        hmFrontColor = 0xff000000 | (darkBlue << 16) | (darkGreen << 8) | darkRed;
        return [x, y, z, hmTopColor, hmFrontColor];
    });
    const voxels = [];
    voxels.push(...rWallsVox);
    voxels.push(...hmP3sVox);
    voxels.sort((a, b) => {
        // sort on z - bigger is further away
        const zDelta = b[2] - a[2];
        if (zDelta !== 0) {
            return zDelta;
        }
        // tie break on y - we want to sort smaller y first
        // so that the "tops" of voxels overlay correctly
        return a[1] - b[1];
    });
    return voxels;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm94ZWwtc2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2NlbmVzL3ZveGVsLXNjZW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLG9DQUFvQyxDQUFBO0FBQ3RFLE9BQU8sRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLDRCQUE0QixDQUFBO0FBQzlFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFDdEcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQzFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFFOUQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlDQUFpQyxDQUFBO0FBR3pFLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQTtBQUNoQixNQUFNLElBQUksR0FBRyxHQUFHLENBQUE7QUFFaEIsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHLEdBQVUsRUFBRTtJQUNwQyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUE7SUFDcEIsSUFBSSxNQUFvQixDQUFBO0lBQ3hCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQTtJQUVoQixNQUFNLElBQUksR0FBRyxLQUFLLEVBQUUsS0FBWSxFQUFFLEVBQUU7UUFDbEMsTUFBTSxHQUFHLGNBQWMsRUFBRSxDQUFBO1FBRXpCLFFBQVEsR0FBRyxJQUFJLENBQUE7SUFDakIsQ0FBQyxDQUFBO0lBRUQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFZLEVBQUUsRUFBRTtRQUMxQixJ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QUcsU0FBUyxDQUFDLEdBQUcsTUFBTSxDQUFBO1FBQy9DLE1BQU0sU0FBUyxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUE7UUFFOUIsVUFBVSxHQUFHLFVBQVUsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUE7UUFDM0QsWUFBWSxHQUFHLFVBQVUsR0FBRyxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUE7UUFFekUsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxZQUFZLENBQVEsQ0FBQTtJQUNuRCxDQUFDLENBQUMsQ0FBQTtJQUVGLE1BQU0sTUFBTSxHQUFVLEVBQUUsQ0FBQTtJQUV4QixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUE7SUFDekIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFBO0lBRXhCLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDbkIscUNBQXFDO1FBQ3JDLE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFFMUIsSUFBSSxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDakIsT0FBTyxNQUFNLENBQUE7UUFDZixDQUFDO1FBRUQsbURBQW1EO1FBQ25ELGlEQUFpRDtRQUNqRCxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDcEIsQ0FBQyxDQUFDLENBQUE7SUFFRixPQUFPLE1BQU0sQ0FBQTtBQUNmLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdlbmVyYXRlSGVpZ2h0bWFwIH0gZnJvbSAnLi4vbGliL2hlaWdodG1hcC9nZW5lcmF0ZS9pbmRleC5qcydcclxuaW1wb3J0IHsgZmxhdHRlblJlY3QsIGxvd2VyUmVjdCwgcmFpc2VSZWN0IH0gZnJvbSAnLi4vbGliL2hlaWdodG1hcC9zY3VscHQuanMnXHJcbmltcG9ydCB7IGhlaWdodG1hcFRvUG9pbnQzLCBtYXhIZWlnaHQsIG1pbkhlaWdodCwgbm9ybWFsaXplSGVpZ2h0bWFwIH0gZnJvbSAnLi4vbGliL2hlaWdodG1hcC91dGlsLmpzJ1xyXG5pbXBvcnQgeyByYW5kSW50IH0gZnJvbSAnLi4vbGliL3JhbmRvbS5qcydcclxuaW1wb3J0IHsgZXhpdE9uRXNjYXBlLCB6b29tT25XaGVlbCB9IGZyb20gJy4uL2xpYi9zY2VuZS9pby5qcydcclxuaW1wb3J0IHsgTWF5YmUsIFNjZW5lLCBTdGF0ZSB9IGZyb20gJy4uL2xpYi90eXBlcy5qcydcclxuaW1wb3J0IHsgbWF5YmUgfSBmcm9tICcuLi9saWIvdXRpbC5qcydcclxuaW1wb3J0IHsgYmxpdFZveGVscyB9IGZyb20gJy4uL2xpYi92b3hlbC9ibGl0LmpzJ1xyXG5pbXBvcnQgeyBjcmVhdGVQbGFuZSwgY3JlYXRlV2FsbCB9IGZyb20gJy4uL2xpYi92b3hlbC9nZW5lcmF0ZS9jcmVhdGUuanMnXHJcbmltcG9ydCB7IFZveCB9IGZyb20gJy4uL2xpYi92b3hlbC90eXBlcy5qcydcclxuXHJcbmNvbnN0IG1hcFcgPSAyNTZcclxuY29uc3QgbWFwSCA9IDI1NlxyXG5cclxuZXhwb3J0IGNvbnN0IHZveGVsU2NlbmUgPSAoKTogU2NlbmUgPT4ge1xyXG4gIGxldCBpc0FjdGl2ZSA9IGZhbHNlXHJcbiAgbGV0IHZveGVsczogTWF5YmU8Vm94W10+XHJcbiAgbGV0IGRpcnR5ID0gdHJ1ZVxyXG5cclxuICBjb25zdCBpbml0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgdm94ZWxzID0gZ2VuZXJhdGVWb3hlbHMoKVxyXG5cclxuICAgIGlzQWN0aXZlID0gdHJ1ZVxyXG4gIH1cclxuXHJcbiAgY29uc3QgaW8gPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpZiAoZXhpdE9uRXNjYXBlKHN0YXRlKSkgcmV0dXJuXHJcblxyXG4gICAgaWYgKHpvb21PbldoZWVsKHN0YXRlKSkge1xyXG4gICAgICBkaXJ0eSA9IHRydWVcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGlmICghbWF5YmUodm94ZWxzKSkgdGhyb3cgRXJyb3IoJ3ZveGVscyBub3QgaW5pdGlhbGl6ZWQnKVxyXG5cclxuICAgIGlmIChpc0FjdGl2ZSkgaW8oc3RhdGUpXHJcblxyXG4gICAgaWYgKCFkaXJ0eSkgcmV0dXJuXHJcblxyXG4gICAgY29uc3QgYnVmZmVyID0gc3RhdGUudmlldy5nZXRCdWZmZXIoKVxyXG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBidWZmZXJcclxuXHJcbiAgICBjb25zdCBkeCA9IE1hdGguZmxvb3IoKHdpZHRoIC0gbWFwVykgLyAyKVxyXG4gICAgY29uc3QgZHkgPSBNYXRoLmZsb29yKChoZWlnaHQgLSBtYXBIKSAvIDIpXHJcblxyXG4gICAgYmxpdFZveGVscyhidWZmZXIsIHZveGVscywgZHgsIGR5KVxyXG5cclxuICAgIGRpcnR5ID0gZmFsc2VcclxuICB9XHJcblxyXG4gIGNvbnN0IHF1aXQgPSBhc3luYyAoX3N0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgaXNBY3RpdmUgPSBmYWxzZVxyXG4gICAgdm94ZWxzID0gbnVsbFxyXG4gIH1cclxuXHJcbiAgY29uc3Qgc2V0QWN0aXZlID0gKGFjdGl2ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgaXNBY3RpdmUgPSBhY3RpdmVcclxuICB9XHJcblxyXG4gIHJldHVybiB7IGluaXQsIHVwZGF0ZSwgcXVpdCwgc2V0QWN0aXZlIH1cclxufVxyXG5cclxuY29uc3QgZ2VuZXJhdGVWb3hlbHMgPSAoKSA9PiB7XHJcbiAgY29uc3QgaG0gPSBub3JtYWxpemVIZWlnaHRtYXAoZ2VuZXJhdGVIZWlnaHRtYXAobWFwVywgbWFwSCkpXHJcblxyXG4gIC8vIHNjdWxwdCB0aGUgaGVpZ2h0bWFwXHJcblxyXG4gIGNvbnN0IHJhaXNlZEhlaWdodCA9IHJhaXNlUmVjdChobSwgOTYsIDgwLCAxNiwgMTIpXHJcblxyXG4gIC8vIHgwLHowLHgxLHoxLHkwLGggLSAzZCBjb29yZGluYXRlIHN5c3RlbSBvZiB2b3hlbCBzcGFjZVxyXG4gIGNvbnN0IHJUb3BXYWxsID0gY3JlYXRlV2FsbCg5NywgMTExLCAxMTAsIDExMSwgcmFpc2VkSGVpZ2h0LCA4KVxyXG4gIGNvbnN0IHJCb3R0b21XYWxsID0gY3JlYXRlV2FsbCg5NywgMTAxLCAxMTAsIDEwMSwgcmFpc2VkSGVpZ2h0LCA4KVxyXG4gIGNvbnN0IHJMZWZ0V2FsbCA9IGNyZWF0ZVdhbGwoOTcsIDExMCwgOTcsIDEwMiwgcmFpc2VkSGVpZ2h0LCA4KVxyXG4gIGNvbnN0IHJSaWdodFdhbGwgPSBjcmVhdGVXYWxsKDExMCwgMTEwLCAxMTAsIDEwMiwgcmFpc2VkSGVpZ2h0LCA4KVxyXG5cclxuICBjb25zdCByUm9vZiA9IGNyZWF0ZVBsYW5lKDk3LCByYWlzZWRIZWlnaHQgKyA4LCAxMDEsIDE0LCAxMClcclxuXHJcbiAgY29uc3QgcldhbGxzID0gW1xyXG4gICAgLi4uclRvcFdhbGwsXHJcbiAgICAuLi5yQm90dG9tV2FsbCxcclxuICAgIC4uLnJMZWZ0V2FsbCxcclxuICAgIC4uLnJSaWdodFdhbGwsXHJcbiAgICAuLi5yUm9vZlxyXG4gIF1cclxuXHJcbiAgY29uc3QgcldhbGxzVm94ID0gcldhbGxzLm1hcCgoW3gsIHksIHpdKSA9PiB7XHJcbiAgICBsZXQgZmNvbG9yID0gMFxyXG4gICAgbGV0IHRjb2xvciA9IDBcclxuXHJcbiAgICBjb25zdCBkID0gbWFwSCAqIDJcclxuICAgIGNvbnN0IGRhcmtlbiA9IDEgLSB6IC8gZFxyXG5cclxuICAgIGNvbnN0IHYgPSByYW5kSW50KDMyKSAtIDE2XHJcblxyXG4gICAgY29uc3QgZ3JleSA9ICh2ICsgMTI4ICsgeSAqIDAuNSkgKiBkYXJrZW5cclxuICAgIGNvbnN0IGRhcmtHcmV5ID0gZ3JleSAqIDAuNzVcclxuXHJcbiAgICBmY29sb3IgPSAweGZmMDAwMDAwIHwgKGdyZXkgPDwgMTYpIHwgKGdyZXkgPDwgOCkgfCBncmV5XHJcbiAgICB0Y29sb3IgPSAweGZmMDAwMDAwIHwgKGRhcmtHcmV5IDw8IDE2KSB8IChkYXJrR3JleSA8PCA4KSB8IGRhcmtHcmV5XHJcblxyXG4gICAgcmV0dXJuIFt4LCB5LCB6LCB0Y29sb3IsIGZjb2xvcl0gYXMgVm94XHJcbiAgfSlcclxuXHJcbiAgY29uc3QgbG93ZXJlZEhlaWdodCA9IGxvd2VyUmVjdChobSwgMzIsIDQ4LCAxMiwgMTYpXHJcblxyXG4gIGNvbnN0IGZsYXR0ZW5lZEhlaWdodCA9IGZsYXR0ZW5SZWN0KGhtLCA2NCwgNjQsIDE2LCAyNClcclxuXHJcbiAgLy8gY29udmVydCB0aGUgaG1cclxuXHJcbiAgY29uc3QgaG1QM3MgPSBoZWlnaHRtYXBUb1BvaW50MyhobSlcclxuXHJcbiAgY29uc3QgaG1NaW4gPSBtaW5IZWlnaHQoaG0pXHJcbiAgY29uc3QgaG1NYXggPSBtYXhIZWlnaHQoaG0pXHJcblxyXG4gIGNvbnN0IGhtRGVsdGEgPSBobU1heCAtIGhtTWluXHJcblxyXG4gIGNvbnN0IGdyZWVuUmFuZ2UgPSBtYXBIXHJcblxyXG4gIGNvbnN0IGdyZWVuU3RlcCA9IGdyZWVuUmFuZ2UgLyBobURlbHRhXHJcblxyXG4gIGNvbnN0IGhtUDNzVm94ID0gaG1QM3MubWFwKChbeCwgeSwgel0pID0+IHtcclxuICAgIGxldCBobVRvcENvbG9yID0gMFxyXG4gICAgbGV0IGhtRnJvbnRDb2xvciA9IDBcclxuXHJcbiAgICAvLyBkYXJrZW4gc2xpZ2h0bHkgYXMgeiBpbmNyZWFzZXNcclxuICAgIC8vIGxvd2VyIGQgbnVtYmVycyA9IG1vcmUgZGFyaywgaGlnaGVyID0gbGVzcyBkYXJrXHJcbiAgICBjb25zdCBkID0gbWFwSCAqIDJcclxuICAgIGNvbnN0IGRhcmtlbiA9IDEgLSB6IC8gZFxyXG5cclxuICAgIC8vIGFkZCBhIGxpdHRsZSByYW5kb21uZXNzIHRvIHRoZSBncmVlbiBjb2xvciBieSB1c2luZyBzbWFsbCByZWQvYmx1ZSB2YWx1ZXNcclxuICAgIGNvbnN0IHJlZCA9IChyYW5kSW50KDMyKSArIDE2KSAvLyogZGFya2VuXHJcbiAgICBjb25zdCBkYXJrUmVkID0gcmVkICogMC43NVxyXG4gICAgY29uc3QgYmx1ZSA9IChyYW5kSW50KDMyKSArIDE2KSAvLyogZGFya2VuXHJcbiAgICBjb25zdCBkYXJrQmx1ZSA9IGJsdWUgKiAwLjc1XHJcblxyXG4gICAgLy8gdG9wIHNob3VsZCBnZXRzIGJyaWdodGVyIGFzIHkgaW5jcmVhc2VzXHJcbiAgICAvLyBmcm9udCBzaG91bGQgYmUgdG9wIGJ1dCBkYXJrZW5lZCBhIGJpdFxyXG4gICAgLy9cclxuICAgIC8vIG1ha2UgaXQgYSBsaXR0bGUgcmFuZG9tIHNvIGl0IGxvb2tzIG1vcmUgaW50ZXJlc3RpbmdcclxuICAgIGNvbnN0IGcgPSByYW5kSW50KDMyKSAtIDE2XHJcbiAgICAvLyB0aGVuIGFwcGx5IGEgZ3JhZGllbnQgYmFzZWQgb24gaGVpZ2h0XHJcbiAgICBjb25zdCBncmVlbiA9IChnICsgNjQgKyB5ICogZ3JlZW5TdGVwKSAqIGRhcmtlblxyXG4gICAgY29uc3QgZGFya0dyZWVuID0gZ3JlZW4gKiAwLjc1XHJcblxyXG4gICAgaG1Ub3BDb2xvciA9IDB4ZmYwMDAwMDAgfCAoYmx1ZSA8PCAxNikgfCAoZ3JlZW4gPDwgOCkgfCByZWRcclxuICAgIGhtRnJvbnRDb2xvciA9IDB4ZmYwMDAwMDAgfCAoZGFya0JsdWUgPDwgMTYpIHwgKGRhcmtHcmVlbiA8PCA4KSB8IGRhcmtSZWRcclxuXHJcbiAgICByZXR1cm4gW3gsIHksIHosIGhtVG9wQ29sb3IsIGhtRnJvbnRDb2xvcl0gYXMgVm94XHJcbiAgfSlcclxuXHJcbiAgY29uc3Qgdm94ZWxzOiBWb3hbXSA9IFtdXHJcblxyXG4gIHZveGVscy5wdXNoKC4uLnJXYWxsc1ZveClcclxuICB2b3hlbHMucHVzaCguLi5obVAzc1ZveClcclxuXHJcbiAgdm94ZWxzLnNvcnQoKGEsIGIpID0+IHtcclxuICAgIC8vIHNvcnQgb24geiAtIGJpZ2dlciBpcyBmdXJ0aGVyIGF3YXlcclxuICAgIGNvbnN0IHpEZWx0YSA9IGJbMl0gLSBhWzJdXHJcblxyXG4gICAgaWYgKHpEZWx0YSAhPT0gMCkge1xyXG4gICAgICByZXR1cm4gekRlbHRhXHJcbiAgICB9XHJcblxyXG4gICAgLy8gdGllIGJyZWFrIG9uIHkgLSB3ZSB3YW50IHRvIHNvcnQgc21hbGxlciB5IGZpcnN0XHJcbiAgICAvLyBzbyB0aGF0IHRoZSBcInRvcHNcIiBvZiB2b3hlbHMgb3ZlcmxheSBjb3JyZWN0bHlcclxuICAgIHJldHVybiBhWzFdIC0gYlsxXVxyXG4gIH0pXHJcblxyXG4gIHJldHVybiB2b3hlbHNcclxufSJdfQ==
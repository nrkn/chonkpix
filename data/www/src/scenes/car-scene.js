import { createImage } from '../lib/image/create.js';
import { fill } from '../lib/image/fill.js';
import { loadImage } from '../lib/image/load.js';
import { drawRotated } from '../lib/image/rotate.js';
import { pset } from '../lib/image/util.js';
import { debugTextSceneHelper } from '../lib/scene/debug-text.js';
import { maybe } from '../lib/util.js';
import { createBicycle, updateBicycle } from './car/bicycle.js';
const carW = 5; // 2.5m wide - a little over the top but needed to fit headlights lol
const carH = 9; // 4.5m long - about right
const pixelsPerMeter = 2;
const wheelBase = 7; // difference between two axles
const carCx = Math.floor(carW / 2);
const carCy = Math.floor(carH / 2);
const carColor = 0xffff9933;
const headlightColor = 0xff00ffff;
export const carScene = () => {
    let isActive = false;
    let debugHelper;
    let debugText = [];
    let track;
    let carSprite;
    //
    let car;
    //
    const init = async (state) => {
        debugHelper = debugTextSceneHelper(() => debugText);
        await debugHelper.init(state);
        //
        track = await loadImage('scenes/car/track.png');
        carSprite = createImage(carW, carH);
        fill(carSprite, carColor);
        pset(carSprite, 1, 0, headlightColor);
        pset(carSprite, 3, 0, headlightColor);
        const trackCx = Math.floor(track.width / 2);
        const trackCy = Math.floor(track.height / 2);
        car = createBicycle();
        car.location = [trackCx, trackCy];
        car.heading = 0;
        car.speed = 0;
        car.steerAngle = 0;
        car.wheelBase = wheelBase;
        isActive = true;
    };
    let turn = 0;
    let velocity = 0;
    const io = (state) => {
        // don't use key presses with repeat etc - just check if down or not
        const keys = state.getKeys();
        turn = 0;
        velocity = 0;
        if (keys['w'] || keys['W']) {
            velocity = 1;
        }
        if (keys['s'] || keys['S']) {
            velocity = -1;
        }
        if (keys['a'] || keys['A']) {
            turn = -1;
        }
        if (keys['d'] || keys['D']) {
            turn = 1;
        }
    };
    const accel = 0.0001;
    const turnRate = 0.0005;
    const deg90 = Math.PI / 2;
    const steerReturnSpeed = 0.001;
    const friction = 0.00005;
    const maxSpeed = 0.1;
    const minRevSpeed = -(maxSpeed / 2);
    const maxSteerAngle = 0.5;
    const update = (state) => {
        if (!maybe(track))
            throw Error('Expected track');
        if (!maybe(carSprite))
            throw Error('Expected carSprite');
        if (!maybe(car))
            throw Error('Expected car');
        if (isActive)
            io(state);
        const delta = state.time.getFrameTime();
        //
        // adjust car speed and steering angle based on input
        car.speed += velocity * delta * accel;
        if (car.speed > 0) {
            car.speed -= friction * delta;
            if (car.speed < 0)
                car.speed = 0;
            if (car.speed > maxSpeed)
                car.speed = maxSpeed;
        }
        else if (car.speed < 0) {
            car.speed += friction * delta;
            if (car.speed > 0)
                car.speed = 0;
            if (car.speed < minRevSpeed)
                car.speed = minRevSpeed;
        }
        if (turn) {
            const speedFactor = Math.min(1, Math.max(0, Math.abs(car.speed) / maxSpeed));
            car.steerAngle += turn * delta * turnRate * speedFactor;
            car.steerAngle = Math.max(-maxSteerAngle, Math.min(maxSteerAngle, car.steerAngle));
        }
        else {
            if (car.steerAngle > 0) {
                car.steerAngle = Math.max(0, car.steerAngle - delta * steerReturnSpeed);
            }
            else if (car.steerAngle < 0) {
                car.steerAngle = Math.min(0, car.steerAngle + delta * steerReturnSpeed);
            }
        }
        const updated = updateBicycle(car, delta);
        // we could check here for collision, that's why updated is separate from car
        // if no collision, update car
        car.location = updated.location;
        car.heading = updated.heading;
        //
        const buffer = state.view.getBuffer();
        const { width, height } = buffer;
        const vx = Math.floor(width / 2);
        // we place the car three quarters of the way down the screen facing up,
        // so we can see more of the road
        const vy = Math.floor(height * 0.75);
        // draw the track, centered on the car, onto the view, rotated by -carHeading
        drawRotated(track, car.location[0], car.location[1], buffer, vx, vy, -car.heading - deg90);
        // draw the car, centered on the car, onto the view, pointing straight up
        drawRotated(carSprite, carCx, carCy, buffer, vx, vy, 0);
        //
        if (!maybe(debugHelper))
            return;
        const fps = Math.round(1000 / delta);
        const fpsText = `${fps} fps (${delta.toFixed(1)}ms)`;
        const kmph = car.speed * 1800;
        const table = textTable([
            ['carX:', `${car.location[0].toFixed(4)}`],
            ['carY:', `${car.location[1].toFixed(4)}`],
            ['carHeading:', `${car.heading.toFixed(4)}`],
            ['carSpeed:', `${car.speed.toFixed(4)}`],
            ['carSteerAngle:', `${car.steerAngle.toFixed(4)}`],
            ['kmph:', `${kmph.toFixed(4)}`],
            ['turn:', `${turn}`],
            ['velocity:', `${velocity}`]
        ]);
        debugText = [
            fpsText,
            ...table
        ];
        debugHelper.update(state);
    };
    const quit = async (state) => {
        isActive = false;
        if (maybe(debugHelper))
            await debugHelper.quit(state);
        debugHelper = null;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
const textTable = (cells) => {
    const colWidths = new Map();
    // measure
    for (let row = 0; row < cells.length; row++) {
        for (let col = 0; col < cells[row].length; col++) {
            const cell = cells[row][col];
            const width = cell.length;
            let existingW = colWidths.get(col);
            if (!maybe(existingW)) {
                existingW = 0;
            }
            if (width > existingW) {
                colWidths.set(col, width);
            }
        }
    }
    // format
    const formatted = [];
    for (let row = 0; row < cells.length; row++) {
        let line = '';
        for (let col = 0; col < cells[row].length; col++) {
            const cell = cells[row][col];
            const width = colWidths.get(col) || 0;
            const isLast = col === cells[row].length - 1;
            if (isLast) {
                line += cell.padStart(width);
            }
            else {
                line += cell.padEnd(width + 1);
            }
        }
        formatted.push(line);
    }
    return formatted;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FyLXNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lcy9jYXItc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ3BELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ3BELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUMzQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQTtBQUVqRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFDdEMsT0FBTyxFQUFXLGFBQWEsRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUV4RSxNQUFNLElBQUksR0FBRyxDQUFDLENBQUEsQ0FBQyxxRUFBcUU7QUFDcEYsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFBLENBQUMsMEJBQTBCO0FBRXpDLE1BQU0sY0FBYyxHQUFHLENBQUMsQ0FBQTtBQUV4QixNQUFNLFNBQVMsR0FBRyxDQUFDLENBQUEsQ0FBQywrQkFBK0I7QUFFbkQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUE7QUFDbEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUE7QUFFbEMsTUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFBO0FBQzNCLE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQTtBQUVqQyxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsR0FBVSxFQUFFO0lBQ2xDLElBQUksUUFBUSxHQUFHLEtBQUss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R0FBRyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDO1FBQzVDLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUViLEtBQUssSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUM7WUFDakQsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQzVCLE1BQU0sS0FBSyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBRXJDLE1BQU0sTUFBTSxHQUFHLEdBQUcsS0FBSyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtZQUU1QyxJQUFJLE1BQU0sRUFBRSxDQUFDO2dCQUNYLElBQUksSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQzlCLENBQUM7aUJBQU0sQ0FBQztnQkFDTixJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUE7WUFDaEMsQ0FBQztRQUNILENBQUM7UUFFRCxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3RCLENBQUM7SUFFRCxPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjcmVhdGVJbWFnZSB9IGZyb20gJy4uL2xpYi9pbWFnZS9jcmVhdGUuanMnXHJcbmltcG9ydCB7IGZpbGwgfSBmcm9tICcuLi9saWIvaW1hZ2UvZmlsbC5qcydcclxuaW1wb3J0IHsgbG9hZEltYWdlIH0gZnJvbSAnLi4vbGliL2ltYWdlL2xvYWQuanMnXHJcbmltcG9ydCB7IGRyYXdSb3RhdGVkIH0gZnJvbSAnLi4vbGliL2ltYWdlL3JvdGF0ZS5qcydcclxuaW1wb3J0IHsgcHNldCB9IGZyb20gJy4uL2xpYi9pbWFnZS91dGlsLmpzJ1xyXG5pbXBvcnQgeyBkZWJ1Z1RleHRTY2VuZUhlbHBlciB9IGZyb20gJy4uL2xpYi9zY2VuZS9kZWJ1Zy10ZXh0LmpzJ1xyXG5pbXBvcnQgeyBNYXliZSwgU2NlbmUsIFN0YXRlLCBUMiB9IGZyb20gJy4uL2xpYi90eXBlcy5qcydcclxuaW1wb3J0IHsgbWF5YmUgfSBmcm9tICcuLi9saWIvdXRpbC5qcydcclxuaW1wb3J0IHsgQmljeWNsZSwgY3JlYXRlQmljeWNsZSwgdXBkYXRlQmljeWNsZSB9IGZyb20gJy4vY2FyL2JpY3ljbGUuanMnXHJcblxyXG5jb25zdCBjYXJXID0gNSAvLyAyLjVtIHdpZGUgLSBhIGxpdHRsZSBvdmVyIHRoZSB0b3AgYnV0IG5lZWRlZCB0byBmaXQgaGVhZGxpZ2h0cyBsb2xcclxuY29uc3QgY2FySCA9IDkgLy8gNC41bSBsb25nIC0gYWJvdXQgcmlnaHRcclxuXHJcbmNvbnN0IHBpeGVsc1Blck1ldGVyID0gMlxyXG5cclxuY29uc3Qgd2hlZWxCYXNlID0gNyAvLyBkaWZmZXJlbmNlIGJldHdlZW4gdHdvIGF4bGVzXHJcblxyXG5jb25zdCBjYXJDeCA9IE1hdGguZmxvb3IoY2FyVyAvIDIpXHJcbmNvbnN0IGNhckN5ID0gTWF0aC5mbG9vcihjYXJIIC8gMilcclxuXHJcbmNvbnN0IGNhckNvbG9yID0gMHhmZmZmOTkzM1xyXG5jb25zdCBoZWFkbGlnaHRDb2xvciA9IDB4ZmYwMGZmZmZcclxuXHJcbmV4cG9ydCBjb25zdCBjYXJTY2VuZSA9ICgpOiBTY2VuZSA9PiB7XHJcbiAgbGV0IGlzQWN0aXZlID0gZmFsc2VcclxuXHJcbiAgbGV0IGRlYnVnSGVscGVyOiBNYXliZTxTY2VuZT5cclxuICBsZXQgZGVidWdUZXh0OiBzdHJpbmdbXSA9IFtdXHJcblxyXG4gIGxldCB0cmFjazogTWF5YmU8SW1hZ2VEYXRhPlxyXG4gIGxldCBjYXJTcHJpdGU6IE1heWJlPEltYWdlRGF0YT5cclxuXHJcbiAgLy9cclxuXHJcbiAgbGV0IGNhcjogTWF5YmU8QmljeWNsZT5cclxuXHJcbiAgLy9cclxuXHJcbiAgY29uc3QgaW5pdCA9IGFzeW5jIChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGRlYnVnSGVscGVyID0gZGVidWdUZXh0U2NlbmVIZWxwZXIoKCkgPT4gZGVidWdUZXh0KVxyXG5cclxuICAgIGF3YWl0IGRlYnVnSGVscGVyLmluaXQoc3RhdGUpXHJcblxyXG4gICAgLy9cclxuXHJcbiAgICB0cmFjayA9IGF3YWl0IGxvYWRJbWFnZSgnc2NlbmVzL2Nhci90cmFjay5wbmcnKVxyXG5cclxuICAgIGNhclNwcml0ZSA9IGNyZWF0ZUltYWdlKGNhclcsIGNhckgpXHJcblxyXG4gICAgZmlsbChjYXJTcHJpdGUsIGNhckNvbG9yKVxyXG4gICAgcHNldChjYXJTcHJpdGUsIDEsIDAsIGhlYWRsaWdodENvbG9yKVxyXG4gICAgcHNldChjYXJTcHJpdGUsIDMsIDAsIGhlYWRsaWdodENvbG9yKVxyXG5cclxuICAgIGNvbnN0IHRyYWNrQ3ggPSBNYXRoLmZsb29yKHRyYWNrLndpZHRoIC8gMilcclxuICAgIGNvbnN0IHRyYWNrQ3kgPSBNYXRoLmZsb29yKHRyYWNrLmhlaWdodCAvIDIpXHJcblxyXG4gICAgY2FyID0gY3JlYXRlQmljeWNsZSgpXHJcbiAgICBjYXIubG9jYXRpb24gPSBbdHJhY2tDeCwgdHJhY2tDeV1cclxuICAgIGNhci5oZWFkaW5nID0gMFxyXG4gICAgY2FyLnNwZWVkID0gMFxyXG4gICAgY2FyLnN0ZWVyQW5nbGUgPSAwXHJcbiAgICBjYXIud2hlZWxCYXNlID0gd2hlZWxCYXNlXHJcblxyXG4gICAgaXNBY3RpdmUgPSB0cnVlXHJcbiAgfVxyXG5cclxuICBsZXQgdHVybiA9IDBcclxuICBsZXQgdmVsb2NpdHkgPSAwXHJcblxyXG4gIGNvbnN0IGlvID0gKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgLy8gZG9uJ3QgdXNlIGtleSBwcmVzc2VzIHdpdGggcmVwZWF0IGV0YyAtIGp1c3QgY2hlY2sgaWYgZG93biBvciBub3RcclxuICAgIGNvbnN0IGtleXMgPSBzdGF0ZS5nZXRLZXlzKClcclxuXHJcbiAgICB0dXJuID0gMFxyXG4gICAgdmVsb2NpdHkgPSAwXHJcblxyXG4gICAgaWYgKGtleXNbJ3cnXSB8fCBrZXlzWydXJ10pIHtcclxuICAgICAgdmVsb2NpdHkgPSAxXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGtleXNbJ3MnXSB8fCBrZXlzWydTJ10pIHtcclxuICAgICAgdmVsb2NpdHkgPSAtMVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChrZXlzWydhJ10gfHwga2V5c1snQSddKSB7XHJcbiAgICAgIHR1cm4gPSAtMVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChrZXlzWydkJ10gfHwga2V5c1snRCddKSB7XHJcbiAgICAgIHR1cm4gPSAxXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCBhY2NlbCA9IDAuMDAwMVxyXG4gIGNvbnN0IHR1cm5SYXRlID0gMC4wMDA1XHJcbiAgY29uc3QgZGVnOTAgPSBNYXRoLlBJIC8gMlxyXG4gIGNvbnN0IHN0ZWVyUmV0dXJuU3BlZWQgPSAwLjAwMVxyXG4gIGNvbnN0IGZyaWN0aW9uID0gMC4wMDAwNVxyXG4gIGNvbnN0IG1heFNwZWVkID0gMC4xXHJcbiAgY29uc3QgbWluUmV2U3BlZWQgPSAtKG1heFNwZWVkIC8gMilcclxuICBjb25zdCBtYXhTdGVlckFuZ2xlID0gMC41XHJcblxyXG4gIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGlmICghbWF5YmUodHJhY2spKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgdHJhY2snKVxyXG4gICAgaWYgKCFtYXliZShjYXJTcHJpdGUpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgY2FyU3ByaXRlJylcclxuICAgIGlmICghbWF5YmUoY2FyKSkgdGhyb3cgRXJyb3IoJ0V4cGVjdGVkIGNhcicpXHJcblxyXG4gICAgaWYgKGlzQWN0aXZlKSBpbyhzdGF0ZSlcclxuXHJcbiAgICBjb25zdCBkZWx0YSA9IHN0YXRlLnRpbWUuZ2V0RnJhbWVUaW1lKClcclxuXHJcbiAgICAvL1xyXG5cclxuICAgIC8vIGFkanVzdCBjYXIgc3BlZWQgYW5kIHN0ZWVyaW5nIGFuZ2xlIGJhc2VkIG9uIGlucHV0XHJcbiAgICBjYXIuc3BlZWQgKz0gdmVsb2NpdHkgKiBkZWx0YSAqIGFjY2VsXHJcblxyXG4gICAgaWYgKGNhci5zcGVlZCA+IDApIHtcclxuICAgICAgY2FyLnNwZWVkIC09IGZyaWN0aW9uICogZGVsdGFcclxuXHJcbiAgICAgIGlmIChjYXIuc3BlZWQgPCAwKSBjYXIuc3BlZWQgPSAwXHJcbiAgICAgIGlmIChjYXIuc3BlZWQgPiBtYXhTcGVlZCkgY2FyLnNwZWVkID0gbWF4U3BlZWRcclxuICAgIH0gZWxzZSBpZiAoY2FyLnNwZWVkIDwgMCkge1xyXG4gICAgICBjYXIuc3BlZWQgKz0gZnJpY3Rpb24gKiBkZWx0YVxyXG5cclxuICAgICAgaWYgKGNhci5zcGVlZCA+IDApIGNhci5zcGVlZCA9IDBcclxuICAgICAgaWYgKGNhci5zcGVlZCA8IG1pblJldlNwZWVkKSBjYXIuc3BlZWQgPSBtaW5SZXZTcGVlZFxyXG4gICAgfVxyXG5cclxuICAgIGlmICh0dXJuKSB7XHJcbiAgICAgIGNvbnN0IHNwZWVkRmFjdG9yID0gTWF0aC5taW4oMSwgTWF0aC5tYXgoMCwgTWF0aC5hYnMoY2FyLnNwZWVkKSAvIG1heFNwZWVkKSlcclxuXHJcbiAgICAgIGNhci5zdGVlckFuZ2xlICs9IHR1cm4gKiBkZWx0YSAqIHR1cm5SYXRlICogc3BlZWRGYWN0b3JcclxuXHJcbiAgICAgIGNhci5zdGVlckFuZ2xlID0gTWF0aC5tYXgoXHJcbiAgICAgICAgLW1heFN0ZWVyQW5nbGUsXHJcbiAgICAgICAgTWF0aC5taW4obWF4U3RlZXJBbmdsZSwgY2FyLnN0ZWVyQW5nbGUpXHJcbiAgICAgIClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChjYXIuc3RlZXJBbmdsZSA+IDApIHtcclxuICAgICAgICBjYXIuc3RlZXJBbmdsZSA9IE1hdGgubWF4KDAsIGNhci5zdGVlckFuZ2xlIC0gZGVsdGEgKiBzdGVlclJldHVyblNwZWVkKVxyXG4gICAgICB9IGVsc2UgaWYgKGNhci5zdGVlckFuZ2xlIDwgMCkge1xyXG4gICAgICAgIGNhci5zdGVlckFuZ2xlID0gTWF0aC5taW4oMCwgY2FyLnN0ZWVyQW5nbGUgKyBkZWx0YSAqIHN0ZWVyUmV0dXJuU3BlZWQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB1cGRhdGVkID0gdXBkYXRlQmljeWNsZShjYXIsIGRlbHRhKVxyXG5cclxuICAgIC8vIHdlIGNvdWxkIGNoZWNrIGhlcmUgZm9yIGNvbGxpc2lvbiwgdGhhdCdzIHdoeSB1cGRhdGVkIGlzIHNlcGFyYXRlIGZyb20gY2FyXHJcblxyXG4gICAgLy8gaWYgbm8gY29sbGlzaW9uLCB1cGRhdGUgY2FyXHJcbiAgICBjYXIubG9jYXRpb24gPSB1cGRhdGVkLmxvY2F0aW9uXHJcbiAgICBjYXIuaGVhZGluZyA9IHVwZGF0ZWQuaGVhZGluZ1xyXG5cclxuICAgIC8vXHJcblxyXG4gICAgY29uc3QgYnVmZmVyID0gc3RhdGUudmlldy5nZXRCdWZmZXIoKVxyXG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBidWZmZXJcclxuXHJcbiAgICBjb25zdCB2eCA9IE1hdGguZmxvb3Iod2lkdGggLyAyKVxyXG4gICAgLy8gd2UgcGxhY2UgdGhlIGNhciB0aHJlZSBxdWFydGVycyBvZiB0aGUgd2F5IGRvd24gdGhlIHNjcmVlbiBmYWNpbmcgdXAsXHJcbiAgICAvLyBzbyB3ZSBjYW4gc2VlIG1vcmUgb2YgdGhlIHJvYWRcclxuICAgIGNvbnN0IHZ5ID0gTWF0aC5mbG9vcihoZWlnaHQgKiAwLjc1KVxyXG5cclxuICAgIC8vIGRyYXcgdGhlIHRyYWNrLCBjZW50ZXJlZCBvbiB0aGUgY2FyLCBvbnRvIHRoZSB2aWV3LCByb3RhdGVkIGJ5IC1jYXJIZWFkaW5nXHJcbiAgICBkcmF3Um90YXRlZCh0cmFjaywgY2FyLmxvY2F0aW9uWzBdLCBjYXIubG9jYXRpb25bMV0sIGJ1ZmZlciwgdngsIHZ5LCAtY2FyLmhlYWRpbmcgLSBkZWc5MClcclxuICAgIC8vIGRyYXcgdGhlIGNhciwgY2VudGVyZWQgb24gdGhlIGNhciwgb250byB0aGUgdmlldywgcG9pbnRpbmcgc3RyYWlnaHQgdXBcclxuICAgIGRyYXdSb3RhdGVkKGNhclNwcml0ZSwgY2FyQ3gsIGNhckN5LCBidWZmZXIsIHZ4LCB2eSwgMClcclxuXHJcbiAgICAvL1xyXG5cclxuICAgIGlmICghbWF5YmUoZGVidWdIZWxwZXIpKSByZXR1cm5cclxuXHJcbiAgICBjb25zdCBmcHMgPSBNYXRoLnJvdW5kKDEwMDAgLyBkZWx0YSlcclxuICAgIGNvbnN0IGZwc1RleHQgPSBgJHtmcHN9IGZwcyAoJHtkZWx0YS50b0ZpeGVkKDEpfW1zKWBcclxuXHJcbiAgICBjb25zdCBrbXBoID0gY2FyLnNwZWVkICogMTgwMFxyXG5cclxuICAgIGNvbnN0IHRhYmxlID0gdGV4dFRhYmxlKFtcclxuICAgICAgWydjYXJYOicsIGAke2Nhci5sb2NhdGlvblswXS50b0ZpeGVkKDQpfWBdLFxyXG4gICAgICBbJ2Nhclk6JywgYCR7Y2FyLmxvY2F0aW9uWzFdLnRvRml4ZWQoNCl9YF0sXHJcbiAgICAgIFsnY2FySGVhZGluZzonLCBgJHtjYXIuaGVhZGluZy50b0ZpeGVkKDQpfWBdLFxyXG4gICAgICBbJ2NhclNwZWVkOicsIGAke2Nhci5zcGVlZC50b0ZpeGVkKDQpfWBdLFxyXG4gICAgICBbJ2NhclN0ZWVyQW5nbGU6JywgYCR7Y2FyLnN0ZWVyQW5nbGUudG9GaXhlZCg0KX1gXSxcclxuICAgICAgWydrbXBoOicsIGAke2ttcGgudG9GaXhlZCg0KX1gXSxcclxuICAgICAgWyd0dXJuOicsIGAke3R1cm59YF0sXHJcbiAgICAgIFsndmVsb2NpdHk6JywgYCR7dmVsb2NpdHl9YF1cclxuICAgIF0pXHJcblxyXG4gICAgZGVidWdUZXh0ID0gW1xyXG4gICAgICBmcHNUZXh0LFxyXG4gICAgICAuLi50YWJsZVxyXG4gICAgXVxyXG5cclxuICAgIGRlYnVnSGVscGVyLnVwZGF0ZShzdGF0ZSlcclxuICB9XHJcblxyXG4gIGNvbnN0IHF1aXQgPSBhc3luYyAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpc0FjdGl2ZSA9IGZhbHNlXHJcblxyXG4gICAgaWYgKG1heWJlKGRlYnVnSGVscGVyKSkgYXdhaXQgZGVidWdIZWxwZXIucXVpdChzdGF0ZSlcclxuXHJcbiAgICBkZWJ1Z0hlbHBlciA9IG51bGxcclxuICB9XHJcblxyXG4gIGNvbnN0IHNldEFjdGl2ZSA9IChhY3RpdmU6IGJvb2xlYW4pID0+IHtcclxuICAgIGlzQWN0aXZlID0gYWN0aXZlXHJcbiAgfVxyXG5cclxuICByZXR1cm4geyBpbml0LCB1cGRhdGUsIHF1aXQsIHNldEFjdGl2ZSB9XHJcbn1cclxuXHJcbmNvbnN0IHRleHRUYWJsZSA9IChjZWxsczogc3RyaW5nW11bXSk6IHN0cmluZ1tdID0+IHtcclxuICBjb25zdCBjb2xXaWR0aHMgPSBuZXcgTWFwPG51bWJlciwgbnVtYmVyPigpXHJcblxyXG4gIC8vIG1lYXN1cmVcclxuICBmb3IgKGxldCByb3cgPSAwOyByb3cgPCBjZWxscy5sZW5ndGg7IHJvdysrKSB7XHJcbiAgICBmb3IgKGxldCBjb2wgPSAwOyBjb2wgPCBjZWxsc1tyb3ddLmxlbmd0aDsgY29sKyspIHtcclxuICAgICAgY29uc3QgY2VsbCA9IGNlbGxzW3Jvd11bY29sXVxyXG4gICAgICBjb25zdCB3aWR0aCA9IGNlbGwubGVuZ3RoXHJcblxyXG4gICAgICBsZXQgZXhpc3RpbmdXID0gY29sV2lkdGhzLmdldChjb2wpXHJcblxyXG4gICAgICBpZiAoIW1heWJlKGV4aXN0aW5nVykpIHtcclxuICAgICAgICBleGlzdGluZ1cgPSAwXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICh3aWR0aCA+IGV4aXN0aW5nVykge1xyXG4gICAgICAgIGNvbFdpZHRocy5zZXQoY29sLCB3aWR0aClcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gZm9ybWF0XHJcbiAgY29uc3QgZm9ybWF0dGVkOiBzdHJpbmdbXSA9IFtdXHJcblxyXG4gIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IGNlbGxzLmxlbmd0aDsgcm93KyspIHtcclxuICAgIGxldCBsaW5lID0gJydcclxuXHJcbiAgICBmb3IgKGxldCBjb2wgPSAwOyBjb2wgPCBjZWxsc1tyb3ddLmxlbmd0aDsgY29sKyspIHtcclxuICAgICAgY29uc3QgY2VsbCA9IGNlbGxzW3Jvd11bY29sXVxyXG4gICAgICBjb25zdCB3aWR0aCA9IGNvbFdpZHRocy5nZXQoY29sKSB8fCAwXHJcblxyXG4gICAgICBjb25zdCBpc0xhc3QgPSBjb2wgPT09IGNlbGxzW3Jvd10ubGVuZ3RoIC0gMVxyXG5cclxuICAgICAgaWYgKGlzTGFzdCkge1xyXG4gICAgICAgIGxpbmUgKz0gY2VsbC5wYWRTdGFydCh3aWR0aClcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsaW5lICs9IGNlbGwucGFkRW5kKHdpZHRoICsgMSlcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZvcm1hdHRlZC5wdXNoKGxpbmUpXHJcbiAgfVxyXG5cclxuICByZXR1cm4gZm9ybWF0dGVkXHJcbn0iXX0=
import { createImage } from '../lib/image/create.js';
import { fill } from '../lib/image/fill.js';
import { loadImage } from '../lib/image/load.js';
import { drawRotated } from '../lib/image/rotate.js';
import { pset } from '../lib/image/util.js';
import { debugTextSceneHelper } from '../lib/scene/debug-text.js';
import { maybe } from '../lib/util.js';
const carW = 5; // 2.5m wide - a little over the top but needed to fit headlights lol
const carH = 9; // 4.5m long - about right
const carCx = Math.floor(carW / 2);
const carCy = Math.floor(carH / 2);
const carColor = 0xffff9933;
const headlightColor = 0xff00ffff;
// per what? these are just made up numbers :(
const carTurnSpeed = 0.0001;
const carAcceleration = 0.01;
const carTireMinAngle = -0.35; // in rads
const carTireMaxAngle = 0.35;
const carMaxSpeed = 0.05;
const friction = 0.00002;
export const carScene = () => {
    let isActive = false;
    let debugHelper;
    let debugText = [];
    let track;
    let carSprite;
    let carX = 0;
    let carY = 0;
    let carAngle = 0; // generally fixed as world rotates around car, but we might want to adjust slightly for skidding or other effects
    let carTireAngle = 0; // for steering, should be in a fixed range
    let carSpeed = 0;
    const init = async (state) => {
        debugHelper = debugTextSceneHelper(() => debugText);
        await debugHelper.init(state);
        //
        track = await loadImage('scenes/car/track.png');
        carSprite = createImage(carW, carH);
        fill(carSprite, carColor);
        pset(carSprite, 1, 0, headlightColor);
        pset(carSprite, 3, 0, headlightColor);
        const trackCx = Math.floor(track.width / 2);
        const trackCy = Math.floor(track.height / 2);
        carX = trackCx;
        carY = trackCy;
        isActive = true;
    };
    const io = (state) => {
        const presses = state.getKeyPresses();
        const delta = state.time.getFrameTime();
        let steeringInput = 0;
        let accelInput = 0;
        for (const key of presses) {
            const l = key.toLowerCase();
            // if (l === 'a') {
            //   trackAngle += carTurnSpeed * elapsed
            // }
            // if (l === 'd') {
            //   trackAngle -= carTurnSpeed * elapsed
            // }
            if (l === 'w') {
                accelInput = 1;
            }
            if (l === 's') {
                accelInput = -1;
            }
            if (l === 'a') {
                steeringInput = -1;
            }
            if (l === 'd') {
                steeringInput = 1;
            }
        }
        if (accelInput !== 0) {
            carSpeed += accelInput * carAcceleration * delta;
            if (carSpeed > carMaxSpeed)
                carSpeed = carMaxSpeed;
            if (carSpeed < 0)
                carSpeed = 0;
        }
        if (steeringInput === 0) {
            // recenter the tires - would be better if there was a delay
            // 
            // commented out as it prevents the car from turning entirely :/
            // carTireAngle = 0
        }
        else {
            carTireAngle += steeringInput * carTurnSpeed * delta;
            if (carTireAngle > carTireMaxAngle)
                carTireAngle = carTireMaxAngle;
            if (carTireAngle < carTireMinAngle)
                carTireAngle = carTireMinAngle;
        }
        presses.length = 0;
    };
    const update = (state) => {
        if (!maybe(track))
            throw Error('Expected track');
        if (!maybe(carSprite))
            throw Error('Expected carSprite');
        if (isActive)
            io(state);
        const delta = state.time.getFrameTime();
        //
        if (carSpeed !== 0) {
            carAngle += (carSpeed * carTireAngle * delta);
        }
        carX += Math.sin(carAngle) * (carSpeed * delta);
        carY -= Math.cos(carAngle) * (carSpeed * delta);
        if (carSpeed > 0) {
            carSpeed -= friction * delta;
        }
        if (carSpeed < 0)
            carSpeed = 0;
        //
        const buffer = state.view.getBuffer();
        const { width, height } = buffer;
        const vx = Math.floor(width / 2);
        // we place the car three quarters of the way down the screen facing up,
        // so we can see more of the road
        const vy = Math.floor(height * 0.75);
        // draw the track, centered on the car, onto the view, rotated by -carAngle
        drawRotated(track, carX, carY, buffer, vx, vy, -carAngle);
        // draw the car, centered on the car, onto the view, pointing straight up
        drawRotated(carSprite, carCx, carCy, buffer, vx, vy, carTireAngle);
        //
        if (!maybe(debugHelper))
            return;
        const fps = Math.round(1000 / delta);
        const fpsText = `${fps} fps (${delta.toFixed(1)}ms)`;
        const table = textTable([
            ['carX:', `${carX.toFixed(4)}`],
            ['carY:', `${carY.toFixed(4)}`],
            ['carAngle:', `${carAngle.toFixed(4)}`],
            ['carTireAngle:', `${carTireAngle.toFixed(4)}`],
            ['carSpeed:', `${carSpeed.toFixed(4)}`]
        ]);
        debugText = [
            fpsText,
            ...table
        ];
        debugHelper.update(state);
    };
    const quit = async (state) => {
        isActive = false;
        if (maybe(debugHelper))
            await debugHelper.quit(state);
        debugHelper = null;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
/*
const carDebug = textTable(
  [
    ['carX', `${ carX | 0 }`],
    // etc
  ]
)
*/
const textTable = (cells) => {
    const colWidths = new Map();
    // measure
    for (let row = 0; row < cells.length; row++) {
        for (let col = 0; col < cells[row].length; col++) {
            const cell = cells[row][col];
            const width = cell.length;
            let existingW = colWidths.get(col);
            if (!maybe(existingW)) {
                existingW = 0;
            }
            if (width > existingW) {
                colWidths.set(col, width);
            }
        }
    }
    // format
    const formatted = [];
    for (let row = 0; row < cells.length; row++) {
        let line = '';
        for (let col = 0; col < cells[row].length; col++) {
            const cell = cells[row][col];
            const width = colWidths.get(col) || 0;
            const isLast = col === cells[row].length - 1;
            if (isLast) {
                line += cell.padStart(width);
            }
            else {
                line += cell.padEnd(width + 1);
            }
        }
        formatted.push(line);
    }
    return formatted;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FyLXNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lcy9jYXItc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ3BELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ3BELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUMzQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQTtBQUVqRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFFdEMsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFBLENBQUMscUVBQXFFO0FBQ3BGLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQSxDQUFDLDBCQUEwQjtBQUV6QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUNsQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUVsQyxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUE7QUFDM0IsTUFBTSxjQUFjLEdBQUcsVUFBVSxDQUFBO0FBRWpDLDhDQUE4QztBQUM5QyxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUE7QUFDM0IsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFBO0FBQzVCLE1BQU0sZUFBZSxHQUFHLENBQUMsSUFBSSxDQUFBLENBQUMsVUFBVTtBQUN4QyxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUE7QUFDNUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFBO0FBQ3hCLE1BQU0s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WUFDNUIsTUFBTSxLQUFLLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7WUFFckMsTUFBTSxNQUFNLEdBQUcsR0FBRyxLQUFLLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1lBRTVDLElBQUksTUFBTSxFQUFFLENBQUM7Z0JBQ1gsSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDOUIsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQTtZQUNoQyxDQUFDO1FBQ0gsQ0FBQztRQUVELFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDdEIsQ0FBQztJQUVELE9BQU8sU0FBUyxDQUFBO0FBQ2xCLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZUltYWdlIH0gZnJvbSAnLi4vbGliL2ltYWdlL2NyZWF0ZS5qcydcclxuaW1wb3J0IHsgZmlsbCB9IGZyb20gJy4uL2xpYi9pbWFnZS9maWxsLmpzJ1xyXG5pbXBvcnQgeyBsb2FkSW1hZ2UgfSBmcm9tICcuLi9saWIvaW1hZ2UvbG9hZC5qcydcclxuaW1wb3J0IHsgZHJhd1JvdGF0ZWQgfSBmcm9tICcuLi9saWIvaW1hZ2Uvcm90YXRlLmpzJ1xyXG5pbXBvcnQgeyBwc2V0IH0gZnJvbSAnLi4vbGliL2ltYWdlL3V0aWwuanMnXHJcbmltcG9ydCB7IGRlYnVnVGV4dFNjZW5lSGVscGVyIH0gZnJvbSAnLi4vbGliL3NjZW5lL2RlYnVnLXRleHQuanMnXHJcbmltcG9ydCB7IE1heWJlLCBTY2VuZSwgU3RhdGUgfSBmcm9tICcuLi9saWIvdHlwZXMuanMnXHJcbmltcG9ydCB7IG1heWJlIH0gZnJvbSAnLi4vbGliL3V0aWwuanMnXHJcblxyXG5jb25zdCBjYXJXID0gNSAvLyAyLjVtIHdpZGUgLSBhIGxpdHRsZSBvdmVyIHRoZSB0b3AgYnV0IG5lZWRlZCB0byBmaXQgaGVhZGxpZ2h0cyBsb2xcclxuY29uc3QgY2FySCA9IDkgLy8gNC41bSBsb25nIC0gYWJvdXQgcmlnaHRcclxuXHJcbmNvbnN0IGNhckN4ID0gTWF0aC5mbG9vcihjYXJXIC8gMilcclxuY29uc3QgY2FyQ3kgPSBNYXRoLmZsb29yKGNhckggLyAyKVxyXG5cclxuY29uc3QgY2FyQ29sb3IgPSAweGZmZmY5OTMzXHJcbmNvbnN0IGhlYWRsaWdodENvbG9yID0gMHhmZjAwZmZmZlxyXG5cclxuLy8gcGVyIHdoYXQ/IHRoZXNlIGFyZSBqdXN0IG1hZGUgdXAgbnVtYmVycyA6KFxyXG5jb25zdCBjYXJUdXJuU3BlZWQgPSAwLjAwMDFcclxuY29uc3QgY2FyQWNjZWxlcmF0aW9uID0gMC4wMVxyXG5jb25zdCBjYXJUaXJlTWluQW5nbGUgPSAtMC4zNSAvLyBpbiByYWRzXHJcbmNvbnN0IGNhclRpcmVNYXhBbmdsZSA9IDAuMzVcclxuY29uc3QgY2FyTWF4U3BlZWQgPSAwLjA1XHJcbmNvbnN0IGZyaWN0aW9uID0gMC4wMDAwMlxyXG5cclxuZXhwb3J0IGNvbnN0IGNhclNjZW5lID0gKCk6IFNjZW5lID0+IHtcclxuICBsZXQgaXNBY3RpdmUgPSBmYWxzZVxyXG5cclxuICBsZXQgZGVidWdIZWxwZXI6IE1heWJlPFNjZW5lPlxyXG4gIGxldCBkZWJ1Z1RleHQ6IHN0cmluZ1tdID0gW11cclxuXHJcbiAgbGV0IHRyYWNrOiBNYXliZTxJbWFnZURhdGE+XHJcbiAgbGV0IGNhclNwcml0ZTogTWF5YmU8SW1hZ2VEYXRhPlxyXG5cclxuICBsZXQgY2FyWCA9IDBcclxuICBsZXQgY2FyWSA9IDBcclxuXHJcbiAgbGV0IGNhckFuZ2xlID0gMCAvLyBnZW5lcmFsbHkgZml4ZWQgYXMgd29ybGQgcm90YXRlcyBhcm91bmQgY2FyLCBidXQgd2UgbWlnaHQgd2FudCB0byBhZGp1c3Qgc2xpZ2h0bHkgZm9yIHNraWRkaW5nIG9yIG90aGVyIGVmZmVjdHNcclxuICBsZXQgY2FyVGlyZUFuZ2xlID0gMCAvLyBmb3Igc3RlZXJpbmcsIHNob3VsZCBiZSBpbiBhIGZpeGVkIHJhbmdlXHJcbiAgbGV0IGNhclNwZWVkID0gMFxyXG5cclxuICBjb25zdCBpbml0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgZGVidWdIZWxwZXIgPSBkZWJ1Z1RleHRTY2VuZUhlbHBlcigoKSA9PiBkZWJ1Z1RleHQpXHJcblxyXG4gICAgYXdhaXQgZGVidWdIZWxwZXIuaW5pdChzdGF0ZSlcclxuXHJcbiAgICAvL1xyXG5cclxuICAgIHRyYWNrID0gYXdhaXQgbG9hZEltYWdlKCdzY2VuZXMvY2FyL3RyYWNrLnBuZycpXHJcblxyXG4gICAgY2FyU3ByaXRlID0gY3JlYXRlSW1hZ2UoY2FyVywgY2FySClcclxuXHJcbiAgICBmaWxsKGNhclNwcml0ZSwgY2FyQ29sb3IpXHJcbiAgICBwc2V0KGNhclNwcml0ZSwgMSwgMCwgaGVhZGxpZ2h0Q29sb3IpXHJcbiAgICBwc2V0KGNhclNwcml0ZSwgMywgMCwgaGVhZGxpZ2h0Q29sb3IpXHJcblxyXG4gICAgY29uc3QgdHJhY2tDeCA9IE1hdGguZmxvb3IodHJhY2sud2lkdGggLyAyKVxyXG4gICAgY29uc3QgdHJhY2tDeSA9IE1hdGguZmxvb3IodHJhY2suaGVpZ2h0IC8gMilcclxuXHJcbiAgICBjYXJYID0gdHJhY2tDeFxyXG4gICAgY2FyWSA9IHRyYWNrQ3lcclxuXHJcbiAgICBpc0FjdGl2ZSA9IHRydWVcclxuICB9XHJcblxyXG4gIGNvbnN0IGlvID0gKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgY29uc3QgcHJlc3NlcyA9IHN0YXRlLmdldEtleVByZXNzZXMoKVxyXG4gICAgY29uc3QgZGVsdGEgPSBzdGF0ZS50aW1lLmdldEZyYW1lVGltZSgpXHJcbiAgICBsZXQgc3RlZXJpbmdJbnB1dCA9IDBcclxuICAgIGxldCBhY2NlbElucHV0ID0gMFxyXG4gIFxyXG4gICAgZm9yIChjb25zdCBrZXkgb2YgcHJlc3Nlcykge1xyXG4gICAgICBjb25zdCBsID0ga2V5LnRvTG93ZXJDYXNlKClcclxuXHJcbiAgICAgIC8vIGlmIChsID09PSAnYScpIHtcclxuICAgICAgLy8gICB0cmFja0FuZ2xlICs9IGNhclR1cm5TcGVlZCAqIGVsYXBzZWRcclxuICAgICAgLy8gfVxyXG4gICAgICAvLyBpZiAobCA9PT0gJ2QnKSB7XHJcbiAgICAgIC8vICAgdHJhY2tBbmdsZSAtPSBjYXJUdXJuU3BlZWQgKiBlbGFwc2VkXHJcbiAgICAgIC8vIH1cclxuXHJcbiAgICAgIGlmIChsID09PSAndycpIHtcclxuICAgICAgICBhY2NlbElucHV0ID0gMVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChsID09PSAncycpIHtcclxuICAgICAgICBhY2NlbElucHV0ID0gLTFcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGwgPT09ICdhJykge1xyXG4gICAgICAgIHN0ZWVyaW5nSW5wdXQgPSAtMVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChsID09PSAnZCcpIHtcclxuICAgICAgICBzdGVlcmluZ0lucHV0ID0gMVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGFjY2VsSW5wdXQgIT09IDApIHtcclxuICAgICAgY2FyU3BlZWQgKz0gYWNjZWxJbnB1dCAqIGNhckFjY2VsZXJhdGlvbiAqIGRlbHRhXHJcblxyXG4gICAgICBpZiAoY2FyU3BlZWQgPiBjYXJNYXhTcGVlZCkgY2FyU3BlZWQgPSBjYXJNYXhTcGVlZFxyXG4gICAgICBpZiAoY2FyU3BlZWQgPCAwKSBjYXJTcGVlZCA9IDBcclxuICAgIH1cclxuXHJcbiAgICBpZiAoc3RlZXJpbmdJbnB1dCA9PT0gMCkge1xyXG4gICAgICAvLyByZWNlbnRlciB0aGUgdGlyZXMgLSB3b3VsZCBiZSBiZXR0ZXIgaWYgdGhlcmUgd2FzIGEgZGVsYXlcclxuICAgICAgLy8gXHJcbiAgICAgIC8vIGNvbW1lbnRlZCBvdXQgYXMgaXQgcHJldmVudHMgdGhlIGNhciBmcm9tIHR1cm5pbmcgZW50aXJlbHkgOi9cclxuICAgICAgLy8gY2FyVGlyZUFuZ2xlID0gMFxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY2FyVGlyZUFuZ2xlICs9IHN0ZWVyaW5nSW5wdXQgKiBjYXJUdXJuU3BlZWQgKiBkZWx0YVxyXG4gICAgICBpZiAoY2FyVGlyZUFuZ2xlID4gY2FyVGlyZU1heEFuZ2xlKSBjYXJUaXJlQW5nbGUgPSBjYXJUaXJlTWF4QW5nbGVcclxuICAgICAgaWYgKGNhclRpcmVBbmdsZSA8IGNhclRpcmVNaW5BbmdsZSkgY2FyVGlyZUFuZ2xlID0gY2FyVGlyZU1pbkFuZ2xlXHJcbiAgICB9XHJcblxyXG4gICAgcHJlc3Nlcy5sZW5ndGggPSAwXHJcbiAgfVxyXG5cclxuICBjb25zdCB1cGRhdGUgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpZiAoIW1heWJlKHRyYWNrKSkgdGhyb3cgRXJyb3IoJ0V4cGVjdGVkIHRyYWNrJylcclxuICAgIGlmICghbWF5YmUoY2FyU3ByaXRlKSkgdGhyb3cgRXJyb3IoJ0V4cGVjdGVkIGNhclNwcml0ZScpXHJcblxyXG4gICAgaWYgKGlzQWN0aXZlKSBpbyhzdGF0ZSlcclxuXHJcbiAgICBjb25zdCBkZWx0YSA9IHN0YXRlLnRpbWUuZ2V0RnJhbWVUaW1lKClcclxuXHJcbiAgICAvL1xyXG5cclxuICAgIGlmIChjYXJTcGVlZCAhPT0gMCkge1xyXG4gICAgICBjYXJBbmdsZSArPSAoY2FyU3BlZWQgKiBjYXJUaXJlQW5nbGUgKiBkZWx0YSlcclxuICAgIH1cclxuXHJcbiAgICBjYXJYICs9IE1hdGguc2luKGNhckFuZ2xlKSAqIChjYXJTcGVlZCAqIGRlbHRhKVxyXG4gICAgY2FyWSAtPSBNYXRoLmNvcyhjYXJBbmdsZSkgKiAoY2FyU3BlZWQgKiBkZWx0YSlcclxuXHJcbiAgICBpZiAoY2FyU3BlZWQgPiAwKSB7XHJcbiAgICAgIGNhclNwZWVkIC09IGZyaWN0aW9uICogZGVsdGFcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY2FyU3BlZWQgPCAwKSBjYXJTcGVlZCA9IDBcclxuXHJcbiAgICAvL1xyXG5cclxuICAgIGNvbnN0IGJ1ZmZlciA9IHN0YXRlLnZpZXcuZ2V0QnVmZmVyKClcclxuICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gYnVmZmVyXHJcblxyXG4gICAgY29uc3QgdnggPSBNYXRoLmZsb29yKHdpZHRoIC8gMilcclxuICAgIC8vIHdlIHBsYWNlIHRoZSBjYXIgdGhyZWUgcXVhcnRlcnMgb2YgdGhlIHdheSBkb3duIHRoZSBzY3JlZW4gZmFjaW5nIHVwLFxyXG4gICAgLy8gc28gd2UgY2FuIHNlZSBtb3JlIG9mIHRoZSByb2FkXHJcbiAgICBjb25zdCB2eSA9IE1hdGguZmxvb3IoaGVpZ2h0ICogMC43NSlcclxuXHJcbiAgICAvLyBkcmF3IHRoZSB0cmFjaywgY2VudGVyZWQgb24gdGhlIGNhciwgb250byB0aGUgdmlldywgcm90YXRlZCBieSAtY2FyQW5nbGVcclxuICAgIGRyYXdSb3RhdGVkKHRyYWNrLCBjYXJYLCBjYXJZLCBidWZmZXIsIHZ4LCB2eSwgLWNhckFuZ2xlKVxyXG4gICAgLy8gZHJhdyB0aGUgY2FyLCBjZW50ZXJlZCBvbiB0aGUgY2FyLCBvbnRvIHRoZSB2aWV3LCBwb2ludGluZyBzdHJhaWdodCB1cFxyXG4gICAgZHJhd1JvdGF0ZWQoY2FyU3ByaXRlLCBjYXJDeCwgY2FyQ3ksIGJ1ZmZlciwgdngsIHZ5LCBjYXJUaXJlQW5nbGUpXHJcblxyXG4gICAgLy9cclxuXHJcbiAgICBpZiAoIW1heWJlKGRlYnVnSGVscGVyKSkgcmV0dXJuXHJcblxyXG4gICAgY29uc3QgZnBzID0gTWF0aC5yb3VuZCgxMDAwIC8gZGVsdGEpXHJcbiAgICBjb25zdCBmcHNUZXh0ID0gYCR7ZnBzfSBmcHMgKCR7ZGVsdGEudG9GaXhlZCgxKX1tcylgXHJcblxyXG4gICAgY29uc3QgdGFibGUgPSB0ZXh0VGFibGUoW1xyXG4gICAgICBbJ2Nhclg6JywgYCR7Y2FyWC50b0ZpeGVkKDQpfWBdLFxyXG4gICAgICBbJ2Nhclk6JywgYCR7Y2FyWS50b0ZpeGVkKDQpfWBdLFxyXG4gICAgICBbJ2NhckFuZ2xlOicsIGAke2NhckFuZ2xlLnRvRml4ZWQoNCl9YF0sXHJcbiAgICAgIFsnY2FyVGlyZUFuZ2xlOicsIGAke2NhclRpcmVBbmdsZS50b0ZpeGVkKDQpfWBdLFxyXG4gICAgICBbJ2NhclNwZWVkOicsIGAke2NhclNwZWVkLnRvRml4ZWQoNCl9YF1cclxuICAgIF0pXHJcblxyXG4gICAgZGVidWdUZXh0ID0gW1xyXG4gICAgICBmcHNUZXh0LFxyXG4gICAgICAuLi50YWJsZVxyXG4gICAgXVxyXG5cclxuICAgIGRlYnVnSGVscGVyLnVwZGF0ZShzdGF0ZSlcclxuICB9XHJcblxyXG4gIGNvbnN0IHF1aXQgPSBhc3luYyAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpc0FjdGl2ZSA9IGZhbHNlXHJcblxyXG4gICAgaWYgKG1heWJlKGRlYnVnSGVscGVyKSkgYXdhaXQgZGVidWdIZWxwZXIucXVpdChzdGF0ZSlcclxuXHJcbiAgICBkZWJ1Z0hlbHBlciA9IG51bGxcclxuICB9XHJcblxyXG4gIGNvbnN0IHNldEFjdGl2ZSA9IChhY3RpdmU6IGJvb2xlYW4pID0+IHtcclxuICAgIGlzQWN0aXZlID0gYWN0aXZlXHJcbiAgfVxyXG5cclxuICByZXR1cm4geyBpbml0LCB1cGRhdGUsIHF1aXQsIHNldEFjdGl2ZSB9XHJcbn1cclxuLypcclxuY29uc3QgY2FyRGVidWcgPSB0ZXh0VGFibGUoXHJcbiAgW1xyXG4gICAgWydjYXJYJywgYCR7IGNhclggfCAwIH1gXSxcclxuICAgIC8vIGV0Y1xyXG4gIF1cclxuKVxyXG4qL1xyXG5jb25zdCB0ZXh0VGFibGUgPSAoY2VsbHM6IHN0cmluZ1tdW10pOiBzdHJpbmdbXSA9PiB7XHJcbiAgY29uc3QgY29sV2lkdGhzID0gbmV3IE1hcDxudW1iZXIsIG51bWJlcj4oKVxyXG5cclxuICAvLyBtZWFzdXJlXHJcbiAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgY2VsbHMubGVuZ3RoOyByb3crKykge1xyXG4gICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgY2VsbHNbcm93XS5sZW5ndGg7IGNvbCsrKSB7XHJcbiAgICAgIGNvbnN0IGNlbGwgPSBjZWxsc1tyb3ddW2NvbF1cclxuICAgICAgY29uc3Qgd2lkdGggPSBjZWxsLmxlbmd0aFxyXG5cclxuICAgICAgbGV0IGV4aXN0aW5nVyA9IGNvbFdpZHRocy5nZXQoY29sKVxyXG5cclxuICAgICAgaWYgKCFtYXliZShleGlzdGluZ1cpKSB7XHJcbiAgICAgICAgZXhpc3RpbmdXID0gMFxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAod2lkdGggPiBleGlzdGluZ1cpIHtcclxuICAgICAgICBjb2xXaWR0aHMuc2V0KGNvbCwgd2lkdGgpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIGZvcm1hdFxyXG4gIGNvbnN0IGZvcm1hdHRlZDogc3RyaW5nW10gPSBbXVxyXG5cclxuICBmb3IgKGxldCByb3cgPSAwOyByb3cgPCBjZWxscy5sZW5ndGg7IHJvdysrKSB7XHJcbiAgICBsZXQgbGluZSA9ICcnXHJcblxyXG4gICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgY2VsbHNbcm93XS5sZW5ndGg7IGNvbCsrKSB7XHJcbiAgICAgIGNvbnN0IGNlbGwgPSBjZWxsc1tyb3ddW2NvbF1cclxuICAgICAgY29uc3Qgd2lkdGggPSBjb2xXaWR0aHMuZ2V0KGNvbCkgfHwgMFxyXG5cclxuICAgICAgY29uc3QgaXNMYXN0ID0gY29sID09PSBjZWxsc1tyb3ddLmxlbmd0aCAtIDFcclxuXHJcbiAgICAgIGlmIChpc0xhc3QpIHtcclxuICAgICAgICBsaW5lICs9IGNlbGwucGFkU3RhcnQod2lkdGgpXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbGluZSArPSBjZWxsLnBhZEVuZCh3aWR0aCArIDEpXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmb3JtYXR0ZWQucHVzaChsaW5lKVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGZvcm1hdHRlZFxyXG59Il19
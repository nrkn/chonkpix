import { createColor } from '../lib/image/color.js';
import { loadImage } from '../lib/image/load.js';
import { resize } from '../lib/image/resize.js';
import { drawRotatedAndScaled } from '../lib/image/rotate.js';
import { pset } from '../lib/image/util.js';
import { debugTextSceneHelper } from '../lib/scene/debug-text.js';
import { textTable } from '../lib/text/table-layout.js';
import { maybe } from '../lib/util.js';
import { createBicycle, updateBicycle } from './car/bicycle.js';
// 2.5m wide - a little wide but needed to fit headlights lol
const carW = 5;
// 4.5m long - about right
const carH = 9;
const carCx = Math.floor(carW / 2);
const carCy = Math.floor(carH / 2);
const carColor = 0xffff9933;
const headlightColor = 0xff00ffff;
const carConfig = {
    wheelBase: 7,
    accel_0_100: 8,
    maxSpeedKmph: 180,
    revSpeedFactor: 0.5,
    brakeFactor: 2,
    frictionFactor: 1,
    turnRate: 0.0005,
    steerReturnSpeed: 0.001,
    maxSteerAngle: 0.5
};
const worldConfig = {
    pixelsPerMeter: 2,
    globalFriction: 5
};
const minZoom = 0.5;
const maxZoom = 2;
const zoomDelta = maxZoom - minZoom;
// derived from car and world config
const deg90 = Math.PI / 2;
const deg270 = 3 * deg90;
const kmphScale = 900 * worldConfig.pixelsPerMeter;
// no rational basis -  just feels *about* right
// worth playing with!
const frictionMps2 = worldConfig.globalFriction * carConfig.frictionFactor; // m/s^2
const friction = frictionMps2 * (worldConfig.pixelsPerMeter / 1e6);
const timeTo100ms = carConfig.accel_0_100 * 1000; // eg 8000ms
// 100kmph in pixels per ms
const speed100 = 100 / kmphScale;
const netAccel = speed100 / timeTo100ms;
const accel = netAccel + friction; // ensure we take friction into account
// again - no rational basis - just feels *about* right
// car specific
const brake = accel * carConfig.brakeFactor;
const maxSpeed = carConfig.maxSpeedKmph / kmphScale;
const minRevSpeed = -(maxSpeed * carConfig.revSpeedFactor);
export const carScene = () => {
    let isActive = false;
    let lastW = 0;
    let lastH = 0;
    let debugHelper;
    let debugText = [];
    let track;
    let carSprite;
    // why bicycle? because it's a simple way to model car physics
    let car;
    //
    const init = async (state) => {
        debugHelper = debugTextSceneHelper(() => debugText);
        await debugHelper.init(state);
        //
        //track = await loadImage('scenes/car/track.png')
        //track = await loadImage('scenes/car/track-huge.png')
        track = await loadImage('scenes/car/track-huge-c2.png');
        // carSprite = createImage(carW, carH)
        // fill(carSprite, carColor)
        // pset(carSprite, 1, 0, headlightColor)
        // pset(carSprite, 3, 0, headlightColor)
        carSprite = await loadImage('scenes/car/car.png');
        //const trackCx = Math.floor(track.width / 2)
        //const trackCy = Math.floor(track.height / 2)
        const trackCx = 5411;
        const trackCy = 14696;
        car = createBicycle([trackCx, trackCy], deg270, 0, 0, carConfig.wheelBase);
        isActive = true;
    };
    let turn = 0;
    let velocity = 0;
    const io = (state) => {
        const keys = state.getKeys();
        turn = 0;
        velocity = 0;
        if (keys['w'] || keys['W']) {
            velocity = 1;
        }
        if (keys['s'] || keys['S']) {
            velocity = -1;
        }
        if (keys['a'] || keys['A']) {
            turn = -1;
        }
        if (keys['d'] || keys['D']) {
            turn = 1;
        }
        // if (zoomOnWheel(state)) {
        //   lastW = 0
        //   lastH = 0
        // }
    };
    let lastZoom = 0;
    const update = (state) => {
        if (!maybe(track))
            throw Error('Expected track');
        if (!maybe(carSprite))
            throw Error('Expected carSprite');
        if (!maybe(car))
            throw Error('Expected car');
        if (isActive)
            io(state);
        if (lastZoom === 0) {
            lastZoom = maxZoom;
        }
        const delta = state.time.getFrameTime();
        // adjust car speed and steering angle based on input
        // are we accelerating or braking?
        const a = velocity > 0 && car.speed > 0 ? accel : brake;
        car.speed += velocity * delta * a;
        if (car.speed > 0) {
            // apply friction
            car.speed -= friction * delta;
            // enforce speed limits and ensure friction doesn't make us go backwards
            if (car.speed < 0)
                car.speed = 0;
            if (car.speed > maxSpeed)
                car.speed = maxSpeed;
        }
        else if (car.speed < 0) {
            // apply friction
            car.speed += friction * delta;
            // enforce speed limits and ensure friction doesn't make us go forwards
            if (car.speed > 0)
                car.speed = 0;
            if (car.speed < minRevSpeed)
                car.speed = minRevSpeed;
        }
        if (turn) {
            // the slower we're going, the less we can turn
            // const speedFactor = Math.min(
            //   1, Math.max(0, Math.abs(car.speed) / maxSpeed)
            // )
            car.steerAngle += turn * delta * carConfig.turnRate; // * speedFactor
            // enforce steering limits
            car.steerAngle = Math.max(-carConfig.maxSteerAngle, Math.min(carConfig.maxSteerAngle, car.steerAngle));
        }
        else {
            // return steering to center
            if (car.steerAngle > 0) {
                car.steerAngle = Math.max(0, car.steerAngle - delta * carConfig.steerReturnSpeed);
            }
            else if (car.steerAngle < 0) {
                car.steerAngle = Math.min(0, car.steerAngle + delta * carConfig.steerReturnSpeed);
            }
        }
        const updated = updateBicycle(car, delta);
        // we could check here for collision, that's why it's separate from car
        // todo - collision detection
        // if no collision, update car
        car.location = updated.location;
        car.heading = updated.heading;
        //
        // const zoom = Math.round(
        //   minZoom + (1 - (Math.abs(car.speed) / maxSpeed)) * zoomDelta
        // )
        // if (zoom !== lastZoom) {
        //   state.view.setZoom(zoom)
        //   lastZoom = zoom
        // }
        const zoom = minZoom + (1 - (Math.abs(car.speed) / maxSpeed)) * zoomDelta;
        //
        const buffer = state.view.getBuffer();
        const { width, height } = buffer;
        const vx = Math.floor(width / 2);
        // we place the car down the screen facing up,
        // so we can see more of the road ahead
        const vy = Math.floor(height * 0.875);
        // draw the track, centered on the car, onto the view, rotated by -carHeading
        // and then deg90 to face "up"
        drawRotatedAndScaled(track, car.location[0], car.location[1], buffer, vx, vy, -car.heading - deg90, zoom);
        // draw the car, centered on the car, onto the view
        drawRotatedAndScaled(carSprite, carCx, carCy, buffer, vx, vy, car.steerAngle, zoom);
        // mini map
        const mmHeight = Math.floor(height / 2);
        // scale to track.height
        const mmScale = mmHeight / track.height;
        const mmWidth = Math.floor(track.width * mmScale);
        const mmX = 2;
        const mmY = height - mmHeight - 2;
        resize(track, buffer, [0, 0, track.width, track.height], [mmX, mmY, mmWidth, mmHeight]);
        const mmCarX = Math.floor(car.location[0] * mmScale) + mmX;
        const mmCarY = Math.floor(car.location[1] * mmScale) + mmY;
        const red = createColor(255, 0, 0);
        pset(buffer, mmCarX, mmCarY, red);
        if (!maybe(debugHelper))
            return;
        const kmph = car.speed * kmphScale;
        const fps = Math.round(1000 / delta);
        const fpsText = `${fps} fps (${delta.toFixed(1)}ms)`;
        const table = textTable([
            ['x:', `${car.location[0].toFixed(4)}`],
            ['y:', `${car.location[1].toFixed(4)}`],
            ['heading:', `${car.heading.toFixed(4)}`],
            ['speed:', `${car.speed.toFixed(4)}`],
            ['steer:', `${car.steerAngle.toFixed(4)}`],
            ['kmph:', `${kmph.toFixed(4)}`],
            ['turn:', `${turn}`],
            ['velocity:', `${velocity}`]
        ]);
        debugText = [
            fpsText,
            ...table
        ];
        debugHelper.update(state);
    };
    const quit = async (state) => {
        isActive = false;
        if (maybe(debugHelper))
            await debugHelper.quit(state);
        debugHelper = null;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FyLXNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lcy9jYXItc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFBO0FBR25ELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUNoRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFDL0MsT0FBTyxFQUFlLG9CQUFvQixFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFDMUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQzNDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDRCQUE0QixDQUFBO0FBRWpFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQTtBQUV2RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFDdEMsT0FBTyxFQUFXLGFBQWEsRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUV4RSw2REFBNkQ7QUFDN0QsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFBO0FBQ2QsMEJBQTBCO0FBQzFCLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQTtBQUVkLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFBO0FBQ2xDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFBO0FBRWxDLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQTtBQUMzQixNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUE7QUFjakMsTUFBTSxTQUFTLEdBQWM7SUFDM0IsU0FBUyxFQUFFLENBQUM7SUFDWixXQUFXLEVBQUUsQ0FBQztJQUNkLFlBQVksRUFBRSxHQUFHO0lBQ2pCLGNBQWMsRUFB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SUFBSSxHQUFHLEtBQUssRUFBRSxLQUFZLEVBQUUsRUFBRTtRQUNsQyxRQUFRLEdBQUcsS0FBSyxDQUFBO1FBRWhCLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQztZQUFFLE1BQU0sV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUVyRCxXQUFXLEdBQUcsSUFBSSxDQUFBO0lBQ3BCLENBQUMsQ0FBQTtJQUVELE1BQU0sU0FBUyxHQUFHLENBQUMsTUFBZSxFQUFFLEVBQUU7UUFDcEMsUUFBUSxHQUFHLE1BQU0sQ0FBQTtJQUNuQixDQUFDLENBQUE7SUFFRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUE7QUFDMUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlQ29sb3IgfSBmcm9tICcuLi9saWIvaW1hZ2UvY29sb3IuanMnXHJcbmltcG9ydCB7IGNyZWF0ZUltYWdlIH0gZnJvbSAnLi4vbGliL2ltYWdlL2NyZWF0ZS5qcydcclxuaW1wb3J0IHsgZmlsbCB9IGZyb20gJy4uL2xpYi9pbWFnZS9maWxsLmpzJ1xyXG5pbXBvcnQgeyBsb2FkSW1hZ2UgfSBmcm9tICcuLi9saWIvaW1hZ2UvbG9hZC5qcydcclxuaW1wb3J0IHsgcmVzaXplIH0gZnJvbSAnLi4vbGliL2ltYWdlL3Jlc2l6ZS5qcydcclxuaW1wb3J0IHsgZHJhd1JvdGF0ZWQsIGRyYXdSb3RhdGVkQW5kU2NhbGVkIH0gZnJvbSAnLi4vbGliL2ltYWdlL3JvdGF0ZS5qcydcclxuaW1wb3J0IHsgcHNldCB9IGZyb20gJy4uL2xpYi9pbWFnZS91dGlsLmpzJ1xyXG5pbXBvcnQgeyBkZWJ1Z1RleHRTY2VuZUhlbHBlciB9IGZyb20gJy4uL2xpYi9zY2VuZS9kZWJ1Zy10ZXh0LmpzJ1xyXG5pbXBvcnQgeyB6b29tT25XaGVlbCB9IGZyb20gJy4uL2xpYi9zY2VuZS9pby5qcydcclxuaW1wb3J0IHsgdGV4dFRhYmxlIH0gZnJvbSAnLi4vbGliL3RleHQvdGFibGUtbGF5b3V0LmpzJ1xyXG5pbXBvcnQgeyBNYXliZSwgU2NlbmUsIFN0YXRlIH0gZnJvbSAnLi4vbGliL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyBtYXliZSB9IGZyb20gJy4uL2xpYi91dGlsLmpzJ1xyXG5pbXBvcnQgeyBCaWN5Y2xlLCBjcmVhdGVCaWN5Y2xlLCB1cGRhdGVCaWN5Y2xlIH0gZnJvbSAnLi9jYXIvYmljeWNsZS5qcydcclxuXHJcbi8vIDIuNW0gd2lkZSAtIGEgbGl0dGxlIHdpZGUgYnV0IG5lZWRlZCB0byBmaXQgaGVhZGxpZ2h0cyBsb2xcclxuY29uc3QgY2FyVyA9IDVcclxuLy8gNC41bSBsb25nIC0gYWJvdXQgcmlnaHRcclxuY29uc3QgY2FySCA9IDlcclxuXHJcbmNvbnN0IGNhckN4ID0gTWF0aC5mbG9vcihjYXJXIC8gMilcclxuY29uc3QgY2FyQ3kgPSBNYXRoLmZsb29yKGNhckggLyAyKVxyXG5cclxuY29uc3QgY2FyQ29sb3IgPSAweGZmZmY5OTMzXHJcbmNvbnN0IGhlYWRsaWdodENvbG9yID0gMHhmZjAwZmZmZlxyXG5cclxudHlwZSBDYXJDb25maWcgPSB7XHJcbiAgd2hlZWxCYXNlOiBudW1iZXIgLy8gcGl4ZWxzIC0gZGlzdGFuY2UgYmV0d2VlbiBmcm9udCBhbmQgYmFjayB3aGVlbHNcclxuICBhY2NlbF8wXzEwMDogbnVtYmVyIC8vIHNlY29uZHNcclxuICBtYXhTcGVlZEttcGg6IG51bWJlclxyXG4gIHJldlNwZWVkRmFjdG9yOiBudW1iZXJcclxuICBicmFrZUZhY3RvcjogbnVtYmVyXHJcbiAgZnJpY3Rpb25GYWN0b3I6IG51bWJlclxyXG4gIHR1cm5SYXRlOiBudW1iZXIgLy8gcmFkcyBwZXIgbXNcclxuICBzdGVlclJldHVyblNwZWVkOiBudW1iZXIgLy8gcmFkcyBwZXIgbXNcclxuICBtYXhTdGVlckFuZ2xlOiBudW1iZXJcclxufVxyXG5cclxuY29uc3QgY2FyQ29uZmlnOiBDYXJDb25maWcgPSB7XHJcbiAgd2hlZWxCYXNlOiA3LFxyXG4gIGFjY2VsXzBfMTAwOiA4LFxyXG4gIG1heFNwZWVkS21waDogMTgwLFxyXG4gIHJldlNwZWVkRmFjdG9yOiAwLjUsXHJcbiAgYnJha2VGYWN0b3I6IDIsXHJcbiAgZnJpY3Rpb25GYWN0b3I6IDEsXHJcbiAgdHVyblJhdGU6IDAuMDAwNSxcclxuICBzdGVlclJldHVyblNwZWVkOiAwLjAwMSxcclxuICBtYXhTdGVlckFuZ2xlOiAwLjVcclxufVxyXG5cclxudHlwZSBXb3JsZENvbmZpZyA9IHtcclxuICBwaXhlbHNQZXJNZXRlcjogbnVtYmVyXHJcbiAgZ2xvYmFsRnJpY3Rpb246IG51bWJlclxyXG59XHJcblxyXG5jb25zdCB3b3JsZENvbmZpZzogV29ybGRDb25maWcgPSB7XHJcbiAgcGl4ZWxzUGVyTWV0ZXI6IDIsXHJcbiAgZ2xvYmFsRnJpY3Rpb246IDVcclxufVxyXG5cclxuY29uc3QgbWluWm9vbSA9IDAuNVxyXG5jb25zdCBtYXhab29tID0gMlxyXG5cclxuY29uc3Qgem9vbURlbHRhID0gbWF4Wm9vbSAtIG1pblpvb21cclxuXHJcbi8vIGRlcml2ZWQgZnJvbSBjYXIgYW5kIHdvcmxkIGNvbmZpZ1xyXG5jb25zdCBkZWc5MCA9IE1hdGguUEkgLyAyXHJcbmNvbnN0IGRlZzI3MCA9IDMgKiBkZWc5MFxyXG5cclxuY29uc3Qga21waFNjYWxlID0gOTAwICogd29ybGRDb25maWcucGl4ZWxzUGVyTWV0ZXJcclxuXHJcbi8vIG5vIHJhdGlvbmFsIGJhc2lzIC0gIGp1c3QgZmVlbHMgKmFib3V0KiByaWdodFxyXG4vLyB3b3J0aCBwbGF5aW5nIHdpdGghXHJcbmNvbnN0IGZyaWN0aW9uTXBzMiA9IHdvcmxkQ29uZmlnLmdsb2JhbEZyaWN0aW9uICogY2FyQ29uZmlnLmZyaWN0aW9uRmFjdG9yIC8vIG0vc14yXHJcbmNvbnN0IGZyaWN0aW9uID0gZnJpY3Rpb25NcHMyICogKHdvcmxkQ29uZmlnLnBpeGVsc1Blck1ldGVyIC8gMWU2KVxyXG5cclxuY29uc3QgdGltZVRvMTAwbXMgPSBjYXJDb25maWcuYWNjZWxfMF8xMDAgKiAxMDAwIC8vIGVnIDgwMDBtc1xyXG4vLyAxMDBrbXBoIGluIHBpeGVscyBwZXIgbXNcclxuY29uc3Qgc3BlZWQxMDAgPSAxMDAgLyBrbXBoU2NhbGVcclxuXHJcbmNvbnN0IG5ldEFjY2VsID0gc3BlZWQxMDAgLyB0aW1lVG8xMDBtc1xyXG5jb25zdCBhY2NlbCA9IG5ldEFjY2VsICsgZnJpY3Rpb24gLy8gZW5zdXJlIHdlIHRha2UgZnJpY3Rpb24gaW50byBhY2NvdW50XHJcbi8vIGFnYWluIC0gbm8gcmF0aW9uYWwgYmFzaXMgLSBqdXN0IGZlZWxzICphYm91dCogcmlnaHRcclxuXHJcbi8vIGNhciBzcGVjaWZpY1xyXG5jb25zdCBicmFrZSA9IGFjY2VsICogY2FyQ29uZmlnLmJyYWtlRmFjdG9yXHJcblxyXG5jb25zdCBtYXhTcGVlZCA9IGNhckNvbmZpZy5tYXhTcGVlZEttcGggLyBrbXBoU2NhbGVcclxuY29uc3QgbWluUmV2U3BlZWQgPSAtKG1heFNwZWVkICogY2FyQ29uZmlnLnJldlNwZWVkRmFjdG9yKVxyXG5cclxuZXhwb3J0IGNvbnN0IGNhclNjZW5lID0gKCk6IFNjZW5lID0+IHtcclxuICBsZXQgaXNBY3RpdmUgPSBmYWxzZVxyXG4gIGxldCBsYXN0VyA9IDBcclxuICBsZXQgbGFzdEggPSAwXHJcblxyXG4gIGxldCBkZWJ1Z0hlbHBlcjogTWF5YmU8U2NlbmU+XHJcbiAgbGV0IGRlYnVnVGV4dDogc3RyaW5nW10gPSBbXVxyXG5cclxuICBsZXQgdHJhY2s6IE1heWJlPEltYWdlRGF0YT5cclxuICBsZXQgY2FyU3ByaXRlOiBNYXliZTxJbWFnZURhdGE+XHJcblxyXG4gIC8vIHdoeSBiaWN5Y2xlPyBiZWNhdXNlIGl0J3MgYSBzaW1wbGUgd2F5IHRvIG1vZGVsIGNhciBwaHlzaWNzXHJcbiAgbGV0IGNhcjogTWF5YmU8QmljeWNsZT5cclxuXHJcbiAgLy9cclxuXHJcbiAgY29uc3QgaW5pdCA9IGFzeW5jIChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGRlYnVnSGVscGVyID0gZGVidWdUZXh0U2NlbmVIZWxwZXIoKCkgPT4gZGVidWdUZXh0KVxyXG5cclxuICAgIGF3YWl0IGRlYnVnSGVscGVyLmluaXQoc3RhdGUpXHJcblxyXG4gICAgLy9cclxuXHJcbiAgICAvL3RyYWNrID0gYXdhaXQgbG9hZEltYWdlKCdzY2VuZXMvY2FyL3RyYWNrLnBuZycpXHJcbiAgICAvL3RyYWNrID0gYXdhaXQgbG9hZEltYWdlKCdzY2VuZXMvY2FyL3RyYWNrLWh1Z2UucG5nJylcclxuICAgIHRyYWNrID0gYXdhaXQgbG9hZEltYWdlKCdzY2VuZXMvY2FyL3RyYWNrLWh1Z2UtYzIucG5nJylcclxuXHJcbiAgICAvLyBjYXJTcHJpdGUgPSBjcmVhdGVJbWFnZShjYXJXLCBjYXJIKVxyXG5cclxuICAgIC8vIGZpbGwoY2FyU3ByaXRlLCBjYXJDb2xvcilcclxuICAgIC8vIHBzZXQoY2FyU3ByaXRlLCAxLCAwLCBoZWFkbGlnaHRDb2xvcilcclxuICAgIC8vIHBzZXQoY2FyU3ByaXRlLCAzLCAwLCBoZWFkbGlnaHRDb2xvcilcclxuICAgIGNhclNwcml0ZSA9IGF3YWl0IGxvYWRJbWFnZSgnc2NlbmVzL2Nhci9jYXIucG5nJylcclxuXHJcbiAgICAvL2NvbnN0IHRyYWNrQ3ggPSBNYXRoLmZsb29yKHRyYWNrLndpZHRoIC8gMilcclxuICAgIC8vY29uc3QgdHJhY2tDeSA9IE1hdGguZmxvb3IodHJhY2suaGVpZ2h0IC8gMilcclxuICAgIGNvbnN0IHRyYWNrQ3ggPSA1NDExXHJcbiAgICBjb25zdCB0cmFja0N5ID0gMTQ2OTZcclxuXHJcbiAgICBjYXIgPSBjcmVhdGVCaWN5Y2xlKFt0cmFja0N4LCB0cmFja0N5XSwgZGVnMjcwLCAwLCAwLCBjYXJDb25maWcud2hlZWxCYXNlKVxyXG5cclxuICAgIGlzQWN0aXZlID0gdHJ1ZVxyXG4gIH1cclxuXHJcbiAgbGV0IHR1cm4gPSAwXHJcbiAgbGV0IHZlbG9jaXR5ID0gMFxyXG5cclxuICBjb25zdCBpbyA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnN0IGtleXMgPSBzdGF0ZS5nZXRLZXlzKClcclxuXHJcbiAgICB0dXJuID0gMFxyXG4gICAgdmVsb2NpdHkgPSAwXHJcblxyXG4gICAgaWYgKGtleXNbJ3cnXSB8fCBrZXlzWydXJ10pIHtcclxuICAgICAgdmVsb2NpdHkgPSAxXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGtleXNbJ3MnXSB8fCBrZXlzWydTJ10pIHtcclxuICAgICAgdmVsb2NpdHkgPSAtMVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChrZXlzWydhJ10gfHwga2V5c1snQSddKSB7XHJcbiAgICAgIHR1cm4gPSAtMVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChrZXlzWydkJ10gfHwga2V5c1snRCddKSB7XHJcbiAgICAgIHR1cm4gPSAxXHJcbiAgICB9XHJcblxyXG4gICAgLy8gaWYgKHpvb21PbldoZWVsKHN0YXRlKSkge1xyXG4gICAgLy8gICBsYXN0VyA9IDBcclxuICAgIC8vICAgbGFzdEggPSAwXHJcbiAgICAvLyB9XHJcbiAgfVxyXG5cclxuICBsZXQgbGFzdFpvb20gPSAwXHJcblxyXG4gIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGlmICghbWF5YmUodHJhY2spKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgdHJhY2snKVxyXG4gICAgaWYgKCFtYXliZShjYXJTcHJpdGUpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgY2FyU3ByaXRlJylcclxuICAgIGlmICghbWF5YmUoY2FyKSkgdGhyb3cgRXJyb3IoJ0V4cGVjdGVkIGNhcicpXHJcblxyXG4gICAgaWYgKGlzQWN0aXZlKSBpbyhzdGF0ZSlcclxuXHJcbiAgICBpZiAobGFzdFpvb20gPT09IDApIHtcclxuICAgICAgbGFzdFpvb20gPSBtYXhab29tXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZGVsdGEgPSBzdGF0ZS50aW1lLmdldEZyYW1lVGltZSgpXHJcblxyXG4gICAgLy8gYWRqdXN0IGNhciBzcGVlZCBhbmQgc3RlZXJpbmcgYW5nbGUgYmFzZWQgb24gaW5wdXRcclxuXHJcbiAgICAvLyBhcmUgd2UgYWNjZWxlcmF0aW5nIG9yIGJyYWtpbmc/XHJcbiAgICBjb25zdCBhID0gdmVsb2NpdHkgPiAwICYmIGNhci5zcGVlZCA+IDAgPyBhY2NlbCA6IGJyYWtlXHJcblxyXG4gICAgY2FyLnNwZWVkICs9IHZlbG9jaXR5ICogZGVsdGEgKiBhXHJcblxyXG4gICAgaWYgKGNhci5zcGVlZCA+IDApIHtcclxuICAgICAgLy8gYXBwbHkgZnJpY3Rpb25cclxuICAgICAgY2FyLnNwZWVkIC09IGZyaWN0aW9uICogZGVsdGFcclxuXHJcbiAgICAgIC8vIGVuZm9yY2Ugc3BlZWQgbGltaXRzIGFuZCBlbnN1cmUgZnJpY3Rpb24gZG9lc24ndCBtYWtlIHVzIGdvIGJhY2t3YXJkc1xyXG4gICAgICBpZiAoY2FyLnNwZWVkIDwgMCkgY2FyLnNwZWVkID0gMFxyXG4gICAgICBpZiAoY2FyLnNwZWVkID4gbWF4U3BlZWQpIGNhci5zcGVlZCA9IG1heFNwZWVkXHJcbiAgICB9IGVsc2UgaWYgKGNhci5zcGVlZCA8IDApIHtcclxuICAgICAgLy8gYXBwbHkgZnJpY3Rpb25cclxuICAgICAgY2FyLnNwZWVkICs9IGZyaWN0aW9uICogZGVsdGFcclxuXHJcbiAgICAgIC8vIGVuZm9yY2Ugc3BlZWQgbGltaXRzIGFuZCBlbnN1cmUgZnJpY3Rpb24gZG9lc24ndCBtYWtlIHVzIGdvIGZvcndhcmRzXHJcbiAgICAgIGlmIChjYXIuc3BlZWQgPiAwKSBjYXIuc3BlZWQgPSAwXHJcbiAgICAgIGlmIChjYXIuc3BlZWQgPCBtaW5SZXZTcGVlZCkgY2FyLnNwZWVkID0gbWluUmV2U3BlZWRcclxuICAgIH1cclxuXHJcbiAgICBpZiAodHVybikge1xyXG4gICAgICAvLyB0aGUgc2xvd2VyIHdlJ3JlIGdvaW5nLCB0aGUgbGVzcyB3ZSBjYW4gdHVyblxyXG4gICAgICAvLyBjb25zdCBzcGVlZEZhY3RvciA9IE1hdGgubWluKFxyXG4gICAgICAvLyAgIDEsIE1hdGgubWF4KDAsIE1hdGguYWJzKGNhci5zcGVlZCkgLyBtYXhTcGVlZClcclxuICAgICAgLy8gKVxyXG5cclxuICAgICAgY2FyLnN0ZWVyQW5nbGUgKz0gdHVybiAqIGRlbHRhICogY2FyQ29uZmlnLnR1cm5SYXRlLy8gKiBzcGVlZEZhY3RvclxyXG5cclxuICAgICAgLy8gZW5mb3JjZSBzdGVlcmluZyBsaW1pdHNcclxuICAgICAgY2FyLnN0ZWVyQW5nbGUgPSBNYXRoLm1heChcclxuICAgICAgICAtY2FyQ29uZmlnLm1heFN0ZWVyQW5nbGUsXHJcbiAgICAgICAgTWF0aC5taW4oY2FyQ29uZmlnLm1heFN0ZWVyQW5nbGUsIGNhci5zdGVlckFuZ2xlKVxyXG4gICAgICApXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyByZXR1cm4gc3RlZXJpbmcgdG8gY2VudGVyXHJcbiAgICAgIGlmIChjYXIuc3RlZXJBbmdsZSA+IDApIHtcclxuICAgICAgICBjYXIuc3RlZXJBbmdsZSA9IE1hdGgubWF4KFxyXG4gICAgICAgICAgMCwgY2FyLnN0ZWVyQW5nbGUgLSBkZWx0YSAqIGNhckNvbmZpZy5zdGVlclJldHVyblNwZWVkXHJcbiAgICAgICAgKVxyXG4gICAgICB9IGVsc2UgaWYgKGNhci5zdGVlckFuZ2xlIDwgMCkge1xyXG4gICAgICAgIGNhci5zdGVlckFuZ2xlID0gTWF0aC5taW4oXHJcbiAgICAgICAgICAwLCBjYXIuc3RlZXJBbmdsZSArIGRlbHRhICogY2FyQ29uZmlnLnN0ZWVyUmV0dXJuU3BlZWRcclxuICAgICAgICApXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB1cGRhdGVkID0gdXBkYXRlQmljeWNsZShjYXIsIGRlbHRhKVxyXG5cclxuICAgIC8vIHdlIGNvdWxkIGNoZWNrIGhlcmUgZm9yIGNvbGxpc2lvbiwgdGhhdCdzIHdoeSBpdCdzIHNlcGFyYXRlIGZyb20gY2FyXHJcbiAgICAvLyB0b2RvIC0gY29sbGlzaW9uIGRldGVjdGlvblxyXG5cclxuICAgIC8vIGlmIG5vIGNvbGxpc2lvbiwgdXBkYXRlIGNhclxyXG4gICAgY2FyLmxvY2F0aW9uID0gdXBkYXRlZC5sb2NhdGlvblxyXG4gICAgY2FyLmhlYWRpbmcgPSB1cGRhdGVkLmhlYWRpbmdcclxuXHJcbiAgICAvL1xyXG5cclxuICAgIC8vIGNvbnN0IHpvb20gPSBNYXRoLnJvdW5kKFxyXG4gICAgLy8gICBtaW5ab29tICsgKDEgLSAoTWF0aC5hYnMoY2FyLnNwZWVkKSAvIG1heFNwZWVkKSkgKiB6b29tRGVsdGFcclxuICAgIC8vIClcclxuXHJcbiAgICAvLyBpZiAoem9vbSAhPT0gbGFzdFpvb20pIHtcclxuICAgIC8vICAgc3RhdGUudmlldy5zZXRab29tKHpvb20pXHJcblxyXG4gICAgLy8gICBsYXN0Wm9vbSA9IHpvb21cclxuICAgIC8vIH1cclxuXHJcbiAgICBjb25zdCB6b29tID0gbWluWm9vbSArICgxIC0gKE1hdGguYWJzKGNhci5zcGVlZCkgLyBtYXhTcGVlZCkpICogem9vbURlbHRhXHJcblxyXG5cclxuXHJcblxyXG4gICAgLy9cclxuXHJcbiAgICBjb25zdCBidWZmZXIgPSBzdGF0ZS52aWV3LmdldEJ1ZmZlcigpXHJcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IGJ1ZmZlclxyXG5cclxuICAgIGNvbnN0IHZ4ID0gTWF0aC5mbG9vcih3aWR0aCAvIDIpXHJcbiAgICAvLyB3ZSBwbGFjZSB0aGUgY2FyIGRvd24gdGhlIHNjcmVlbiBmYWNpbmcgdXAsXHJcbiAgICAvLyBzbyB3ZSBjYW4gc2VlIG1vcmUgb2YgdGhlIHJvYWQgYWhlYWRcclxuICAgIGNvbnN0IHZ5ID0gTWF0aC5mbG9vcihoZWlnaHQgKiAwLjg3NSlcclxuXHJcbiAgICAvLyBkcmF3IHRoZSB0cmFjaywgY2VudGVyZWQgb24gdGhlIGNhciwgb250byB0aGUgdmlldywgcm90YXRlZCBieSAtY2FySGVhZGluZ1xyXG4gICAgLy8gYW5kIHRoZW4gZGVnOTAgdG8gZmFjZSBcInVwXCJcclxuICAgIGRyYXdSb3RhdGVkQW5kU2NhbGVkKFxyXG4gICAgICB0cmFjayxcclxuICAgICAgY2FyLmxvY2F0aW9uWzBdLCBjYXIubG9jYXRpb25bMV0sXHJcbiAgICAgIGJ1ZmZlciwgdngsIHZ5LFxyXG4gICAgICAtY2FyLmhlYWRpbmcgLSBkZWc5MCwgem9vbVxyXG4gICAgKVxyXG4gICAgLy8gZHJhdyB0aGUgY2FyLCBjZW50ZXJlZCBvbiB0aGUgY2FyLCBvbnRvIHRoZSB2aWV3XHJcbiAgICBkcmF3Um90YXRlZEFuZFNjYWxlZChcclxuICAgICAgY2FyU3ByaXRlLCBjYXJDeCwgY2FyQ3ksIGJ1ZmZlciwgdngsIHZ5LCBjYXIuc3RlZXJBbmdsZSwgem9vbVxyXG4gICAgKVxyXG5cclxuICAgIC8vIG1pbmkgbWFwXHJcblxyXG4gICAgY29uc3QgbW1IZWlnaHQgPSBNYXRoLmZsb29yKGhlaWdodCAvIDIpXHJcblxyXG4gICAgLy8gc2NhbGUgdG8gdHJhY2suaGVpZ2h0XHJcbiAgICBjb25zdCBtbVNjYWxlID0gbW1IZWlnaHQgLyB0cmFjay5oZWlnaHRcclxuXHJcbiAgICBjb25zdCBtbVdpZHRoID0gTWF0aC5mbG9vcih0cmFjay53aWR0aCAqIG1tU2NhbGUpXHJcblxyXG4gICAgY29uc3QgbW1YID0gMlxyXG4gICAgY29uc3QgbW1ZID0gaGVpZ2h0IC0gbW1IZWlnaHQgLSAyXHJcblxyXG4gICAgcmVzaXplKFxyXG4gICAgICB0cmFjaywgYnVmZmVyLFxyXG4gICAgICBbMCwgMCwgdHJhY2sud2lkdGgsIHRyYWNrLmhlaWdodF0sXHJcbiAgICAgIFttbVgsIG1tWSwgbW1XaWR0aCwgbW1IZWlnaHRdXHJcbiAgICApXHJcblxyXG4gICAgY29uc3QgbW1DYXJYID0gTWF0aC5mbG9vcihjYXIubG9jYXRpb25bMF0gKiBtbVNjYWxlKSArIG1tWFxyXG4gICAgY29uc3QgbW1DYXJZID0gTWF0aC5mbG9vcihjYXIubG9jYXRpb25bMV0gKiBtbVNjYWxlKSArIG1tWVxyXG5cclxuICAgIGNvbnN0IHJlZCA9IGNyZWF0ZUNvbG9yKDI1NSwgMCwgMClcclxuXHJcbiAgICBwc2V0KGJ1ZmZlciwgbW1DYXJYLCBtbUNhclksIHJlZClcclxuXHJcbiAgICBpZiAoIW1heWJlKGRlYnVnSGVscGVyKSkgcmV0dXJuXHJcblxyXG4gICAgY29uc3Qga21waCA9IGNhci5zcGVlZCAqIGttcGhTY2FsZVxyXG5cclxuICAgIGNvbnN0IGZwcyA9IE1hdGgucm91bmQoMTAwMCAvIGRlbHRhKVxyXG4gICAgY29uc3QgZnBzVGV4dCA9IGAke2Zwc30gZnBzICgke2RlbHRhLnRvRml4ZWQoMSl9bXMpYFxyXG5cclxuICAgIGNvbnN0IHRhYmxlID0gdGV4dFRhYmxlKFtcclxuICAgICAgWyd4OicsIGAke2Nhci5sb2NhdGlvblswXS50b0ZpeGVkKDQpfWBdLFxyXG4gICAgICBbJ3k6JywgYCR7Y2FyLmxvY2F0aW9uWzFdLnRvRml4ZWQoNCl9YF0sXHJcbiAgICAgIFsnaGVhZGluZzonLCBgJHtjYXIuaGVhZGluZy50b0ZpeGVkKDQpfWBdLFxyXG4gICAgICBbJ3NwZWVkOicsIGAke2Nhci5zcGVlZC50b0ZpeGVkKDQpfWBdLFxyXG4gICAgICBbJ3N0ZWVyOicsIGAke2Nhci5zdGVlckFuZ2xlLnRvRml4ZWQoNCl9YF0sXHJcbiAgICAgIFsna21waDonLCBgJHtrbXBoLnRvRml4ZWQoNCl9YF0sXHJcbiAgICAgIFsndHVybjonLCBgJHt0dXJufWBdLFxyXG4gICAgICBbJ3ZlbG9jaXR5OicsIGAke3ZlbG9jaXR5fWBdXHJcbiAgICBdKVxyXG5cclxuICAgIGRlYnVnVGV4dCA9IFtcclxuICAgICAgZnBzVGV4dCxcclxuICAgICAgLi4udGFibGVcclxuICAgIF1cclxuXHJcbiAgICBkZWJ1Z0hlbHBlci51cGRhdGUoc3RhdGUpXHJcbiAgfVxyXG5cclxuICBjb25zdCBxdWl0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgaXNBY3RpdmUgPSBmYWxzZVxyXG5cclxuICAgIGlmIChtYXliZShkZWJ1Z0hlbHBlcikpIGF3YWl0IGRlYnVnSGVscGVyLnF1aXQoc3RhdGUpXHJcblxyXG4gICAgZGVidWdIZWxwZXIgPSBudWxsXHJcbiAgfVxyXG5cclxuICBjb25zdCBzZXRBY3RpdmUgPSAoYWN0aXZlOiBib29sZWFuKSA9PiB7XHJcbiAgICBpc0FjdGl2ZSA9IGFjdGl2ZVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgaW5pdCwgdXBkYXRlLCBxdWl0LCBzZXRBY3RpdmUgfVxyXG59XHJcbiJdfQ==
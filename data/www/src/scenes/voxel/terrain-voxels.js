import { generateHeightmap } from '../../lib/heightmap/generate/index.js';
import { raiseHmRect, lowerHmRect, flattenHmRect } from '../../lib/heightmap/sculpt.js';
import { normalizeHmU8C, heightmapToPoint3, minHeight, maxHeight } from '../../lib/heightmap/util.js';
import { randInt } from '../../lib/random.js';
import { createWall, createPlane } from '../../lib/voxel/generate/create.js';
const mapW = 192;
const mapH = 192;
export const generateTerrainVoxels = async (state) => {
    const buffer = state.view.getBuffer();
    const { width, height } = buffer;
    // 100 ticks for hm generation
    // 1 tick for sculpting
    // 10 ticks for converting
    // 10 ticks for sorting
    const startHmTime = performance.now();
    let hm = generateHeightmap(mapW, mapH, mapW * mapH * 8);
    hm = normalizeHmU8C(hm);
    const endHmTime = performance.now();
    console.log(`heightmap generation took ${endHmTime - startHmTime}ms`);
    // sculpt the heightmap
    const startSculptTime = performance.now();
    const raisedHeight = raiseHmRect(hm, 96, 80, 16, 12);
    // x0,z0,x1,z1,y0,h - 3d coordinate system of voxel space
    const rTopWall = createWall(97, 111, 110, 111, raisedHeight, 8);
    const rBottomWall = createWall(97, 101, 110, 101, raisedHeight, 8);
    const rLeftWall = createWall(97, 110, 97, 102, raisedHeight, 8);
    const rRightWall = createWall(110, 110, 110, 102, raisedHeight, 8);
    const rRoof = createPlane(97, raisedHeight + 8, 101, 14, 10);
    const rWalls = [
        ...rTopWall,
        ...rBottomWall,
        ...rLeftWall,
        ...rRightWall,
        ...rRoof
    ];
    const loweredHeight = lowerHmRect(hm, 32, 48, 12, 16);
    const flattenedHeight = flattenHmRect(hm, 64, 64, 16, 24);
    const endSculptTime = performance.now();
    console.log(`sculpting took ${endSculptTime - startSculptTime}ms`);
    // convert the buildings
    const startConvertTime = performance.now();
    const rWallsVox = rWalls.map(([x, y, z]) => {
        let fcolor = 0;
        let tcolor = 0;
        const d = mapH * 2;
        const darken = 1 - z / d;
        const v = randInt(32) - 16;
        const grey = (v + 128 + y * 0.5) * darken;
        const darkGrey = grey * 0.75;
        fcolor = 0xff000000 | (grey << 16) | (grey << 8) | grey;
        tcolor = 0xff000000 | (darkGrey << 16) | (darkGrey << 8) | darkGrey;
        return [x, y, z, tcolor, fcolor];
    });
    // convert the hm
    const hmP3s = heightmapToPoint3(hm);
    const hmMin = minHeight(hm);
    const hmMax = maxHeight(hm);
    const hmDelta = hmMax - hmMin;
    const greenRange = mapH;
    const greenStep = greenRange / hmDelta;
    const hmP3sVox = hmP3s.map(([x, y, z]) => {
        let hmTopColor = 0;
        let hmFrontColor = 0;
        // darken slightly as z increases
        // lower d numbers = more dark, higher = less dark
        const d = mapH * 2;
        const darken = 1 - z / d;
        // add a little randomness to the green color by using small red/blue values
        const red = (randInt(32) + 16); //* darken
        const darkRed = red * 0.75;
        const blue = (randInt(32) + 16); //* darken
        const darkBlue = blue * 0.75;
        // top should gets brighter as y increases
        // front should be top but darkened a bit
        //
        // make it a little random so it looks more interesting
        const g = randInt(32) - 16;
        // then apply a gradient based on height
        const green = (g + 64 + y * greenStep) * darken;
        const darkGreen = green * 0.75;
        hmTopColor = 0xff000000 | (blue << 16) | (green << 8) | red;
        hmFrontColor = 0xff000000 | (darkBlue << 16) | (darkGreen << 8) | darkRed;
        return [x, y, z, hmTopColor, hmFrontColor];
    });
    const endConvertTime = performance.now();
    console.log(`converting took ${endConvertTime - startConvertTime}ms`);
    // create and sort voxels
    const startVoxTime = performance.now();
    const voxels = [];
    voxels.push(...rWallsVox);
    voxels.push(...hmP3sVox);
    voxels.sort((a, b) => {
        // sort on z - bigger is further away
        const zDelta = b[2] - a[2];
        if (zDelta !== 0) {
            return zDelta;
        }
        // tie break on y - we want to sort smaller y first
        // so that the "tops" of voxels overlay correctly
        return a[1] - b[1];
    });
    const endVoxTime = performance.now();
    console.log(`voxel creation took ${endVoxTime - startVoxTime}ms`);
    console.log(`total time: ${endVoxTime - startHmTime}ms`);
    console.log(`voxel count: ${voxels.length}`);
    return voxels;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFpbi12b3hlbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvc2NlbmVzL3ZveGVsL3RlcnJhaW4tdm94ZWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFBO0FBQ3pFLE9BQU8sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxNQUFNLCtCQUErQixDQUFBO0FBQ3ZGLE9BQU8sRUFBRSxjQUFjLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLDZCQUE2QixDQUFBO0FBQ3JHLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQTtBQUU3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLG9DQUFvQyxDQUFBO0FBRzVFLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQTtBQUNoQixNQUFNLElBQUksR0FBRyxHQUFHLENBQUE7QUFFaEIsTUFBTSxDQUFDLE1BQU0scUJBQXFCLEdBQUcsS0FBSyxFQUFFLEtBQVksRUFBRSxFQUFFO0lBQzFELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUE7SUFDckMsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUE7SUFFaEMsOEJBQThCO0lBQzlCLHVCQUF1QjtJQUN2QiwwQkFBMEI7SUFDMUIsdUJBQXVCO0lBRXZCLE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtJQUVyQyxJQUFJLEVBQUUsR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFFdkQsRUFBRSxHQUFHLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUV2QixNQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUE7SUFFbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsU0FBUyxHQUFHLFdBQVcsSUFBSSxDQUFDLENBQUE7SUFFckUsdUJBQXVCO0lBRXZCLE1BQU0sZUFBZSxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtJQUV6QyxNQUFNLFlBQVksR0FBRyxXQUFXLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRXBELHlEQUF5RDtJQUN6RCxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUMvRCxNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUNsRSxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUMvRCxNQUFNLFVBQVUsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUVsRSxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsRUFBRSxFQUFFLFlBQVksR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUU1RCxNQUFNLE1BQU0sR0FBRztRQUNiLEdBQUcsUUFBUTtRQUNYLEdBQUcsV0FBVztRQUNkLEdBQUcsU0FBUztRQUNaLEdBQUcsVUFBVTtRQUNiLEdBQUcsS0FBSztLQUNULENBQUE7SUFFRCxNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRXJELE1BQU0sZUFBZSxHQUFHLGFBQWEsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFFekQsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFBO0lBRXZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLGFBQWEsR0FBRyxlQUFlLElBQUksQ0FBQyxDQUFBO0lBRWxFLHdCQUF3QjtJQUV4QixNQUFNLGdCQUFnQixHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtJQUUxQyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7UUFDekMsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBQ2QsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBRWQsTUFBTSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQTtRQUNsQixNQUFNLE1BQU0sR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUV4QixNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFBO1FBRTFCLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFBO1FBQ3pDLE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUE7UUFFNUIsTUFBTSxHQUFHLFVBQVUsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUE7UUFDdkQsTUFBTSxHQUFHLFVBQVUsR0FBRyxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUE7UUFFbkUsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQVEsQ0FBQTtJQUN6QyxDQUFDLENBQUMsQ0FBQTtJQUVGLGlCQUFpQjtJQUVqQixNQUFNLEtBQUssR0FBRyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUVuQyxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDM0IsTUFBTSxLQUFLLEdBQUcsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBRTNCLE1BQU0sT0FBTyxHQUFHLEtBQUssR0FBRyxLQUFLLENBQUE7SUFFN0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFBO0lBRXZCLE1BQU0sU0FBUyxHQUFHLFVBQVUsR0FBRyxPQUFPLENBQUE7SUFFdEMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFO1FBQ3ZDLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQTtRQUNsQixJQUFJLFlBQVksR0FBRyxDQUFDLENBQUE7UUFFcEIsaUNBQWlDO1FBQ2pDLGtEQUFrRDtRQUNsRCxNQUFNLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFBO1FBQ2xCLE1BQU0sTUFBTSxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBRXhCLDRFQUE0RTtRQUM1RSxNQUFNLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQSxDQUFDLFVBQVU7UUFDekMsTUFBTSxPQUFPLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQTtRQUMxQixNQUFNLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQSxDQUFDLFVBQVU7UUFDMUMsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQTtRQUU1QiwwQ0FBMEM7UUFDMUMseUNBQXlDO1FBQ3pDLEVBQUU7UUFDRix1REFBdUQ7UUFDdkQsTUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtRQUMxQix3Q0FBd0M7UUFDeEMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxTQUFTLENBQUMsR0FBRyxNQUFNLENBQUE7UUFDL0MsTUFBTSxTQUFTLEdBQUcsS0FBSyxHQUFHLElBQUksQ0FBQTtRQUU5QixVQUFVLEdBQUcsVUFBVSxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQTtRQUMzRCxZQUFZLEdBQUcsVUFBVSxHQUFHLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQTtRQUV6RSxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLFlBQVksQ0FBUSxDQUFBO0lBQ25ELENBQUMsQ0FBQyxDQUFBO0lBRUYsTUFBTSxjQUFjLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFBO0lBRXhDLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLGNBQWMsR0FBRyxnQkFBZ0IsSUFBSSxDQUFDLENBQUE7SUFFckUseUJBQXlCO0lBRXpCLE1BQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtJQUV0QyxNQUFNLE1BQU0sR0FBVSxFQUFFLENBQUE7SUFFeEIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxDQUFBO0lBQ3pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQTtJQUV4QixNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ25CLHFDQUFxQztRQUNyQyxNQUFNLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBRTFCLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sTUFBTSxDQUFBO1FBQ2YsQ0FBQztRQUVELG1EQUFtRDtRQUNuRCxpREFBaUQ7UUFDakQsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3BCLENBQUMsQ0FBQyxDQUFBO0lBRUYsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFBO0lBRXBDLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLFVBQVUsR0FBRyxZQUFZLElBQUksQ0FBQyxDQUFBO0lBRWpFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxVQUFVLEdBQUcsV0FBVyxJQUFJLENBQUMsQ0FBQTtJQUN4RCxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQTtJQUU1QyxPQUFPLE1BQU0sQ0FBQTtBQUNmLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdlbmVyYXRlSGVpZ2h0bWFwIH0gZnJvbSAnLi4vLi4vbGliL2hlaWdodG1hcC9nZW5lcmF0ZS9pbmRleC5qcydcclxuaW1wb3J0IHsgcmFpc2VIbVJlY3QsIGxvd2VySG1SZWN0LCBmbGF0dGVuSG1SZWN0IH0gZnJvbSAnLi4vLi4vbGliL2hlaWdodG1hcC9zY3VscHQuanMnXHJcbmltcG9ydCB7IG5vcm1hbGl6ZUhtVThDLCBoZWlnaHRtYXBUb1BvaW50MywgbWluSGVpZ2h0LCBtYXhIZWlnaHQgfSBmcm9tICcuLi8uLi9saWIvaGVpZ2h0bWFwL3V0aWwuanMnXHJcbmltcG9ydCB7IHJhbmRJbnQgfSBmcm9tICcuLi8uLi9saWIvcmFuZG9tLmpzJ1xyXG5pbXBvcnQgeyBTdGF0ZSB9IGZyb20gJy4uLy4uL2xpYi90eXBlcy5qcydcclxuaW1wb3J0IHsgY3JlYXRlV2FsbCwgY3JlYXRlUGxhbmUgfSBmcm9tICcuLi8uLi9saWIvdm94ZWwvZ2VuZXJhdGUvY3JlYXRlLmpzJ1xyXG5pbXBvcnQgeyBWb3ggfSBmcm9tICcuLi8uLi9saWIvdm94ZWwvdHlwZXMuanMnXHJcblxyXG5jb25zdCBtYXBXID0gMTkyXHJcbmNvbnN0IG1hcEggPSAxOTJcclxuXHJcbmV4cG9ydCBjb25zdCBnZW5lcmF0ZVRlcnJhaW5Wb3hlbHMgPSBhc3luYyAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgY29uc3QgYnVmZmVyID0gc3RhdGUudmlldy5nZXRCdWZmZXIoKVxyXG4gIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gYnVmZmVyXHJcblxyXG4gIC8vIDEwMCB0aWNrcyBmb3IgaG0gZ2VuZXJhdGlvblxyXG4gIC8vIDEgdGljayBmb3Igc2N1bHB0aW5nXHJcbiAgLy8gMTAgdGlja3MgZm9yIGNvbnZlcnRpbmdcclxuICAvLyAxMCB0aWNrcyBmb3Igc29ydGluZ1xyXG5cclxuICBjb25zdCBzdGFydEhtVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpXHJcblxyXG4gIGxldCBobSA9IGdlbmVyYXRlSGVpZ2h0bWFwKG1hcFcsIG1hcEgsIG1hcFcgKiBtYXBIICogOClcclxuXHJcbiAgaG0gPSBub3JtYWxpemVIbVU4QyhobSlcclxuXHJcbiAgY29uc3QgZW5kSG1UaW1lID0gcGVyZm9ybWFuY2Uubm93KClcclxuXHJcbiAgY29uc29sZS5sb2coYGhlaWdodG1hcCBnZW5lcmF0aW9uIHRvb2sgJHtlbmRIbVRpbWUgLSBzdGFydEhtVGltZX1tc2ApXHJcblxyXG4gIC8vIHNjdWxwdCB0aGUgaGVpZ2h0bWFwXHJcblxyXG4gIGNvbnN0IHN0YXJ0U2N1bHB0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpXHJcblxyXG4gIGNvbnN0IHJhaXNlZEhlaWdodCA9IHJhaXNlSG1SZWN0KGhtLCA5NiwgODAsIDE2LCAxMilcclxuXHJcbiAgLy8geDAsejAseDEsejEseTAsaCAtIDNkIGNvb3JkaW5hdGUgc3lzdGVtIG9mIHZveGVsIHNwYWNlXHJcbiAgY29uc3QgclRvcFdhbGwgPSBjcmVhdGVXYWxsKDk3LCAxMTEsIDExMCwgMTExLCByYWlzZWRIZWlnaHQsIDgpXHJcbiAgY29uc3QgckJvdHRvbVdhbGwgPSBjcmVhdGVXYWxsKDk3LCAxMDEsIDExMCwgMTAxLCByYWlzZWRIZWlnaHQsIDgpXHJcbiAgY29uc3QgckxlZnRXYWxsID0gY3JlYXRlV2FsbCg5NywgMTEwLCA5NywgMTAyLCByYWlzZWRIZWlnaHQsIDgpXHJcbiAgY29uc3QgclJpZ2h0V2FsbCA9IGNyZWF0ZVdhbGwoMTEwLCAxMTAsIDExMCwgMTAyLCByYWlzZWRIZWlnaHQsIDgpXHJcblxyXG4gIGNvbnN0IHJSb29mID0gY3JlYXRlUGxhbmUoOTcsIHJhaXNlZEhlaWdodCArIDgsIDEwMSwgMTQsIDEwKVxyXG5cclxuICBjb25zdCByV2FsbHMgPSBbXHJcbiAgICAuLi5yVG9wV2FsbCxcclxuICAgIC4uLnJCb3R0b21XYWxsLFxyXG4gICAgLi4uckxlZnRXYWxsLFxyXG4gICAgLi4uclJpZ2h0V2FsbCxcclxuICAgIC4uLnJSb29mXHJcbiAgXVxyXG5cclxuICBjb25zdCBsb3dlcmVkSGVpZ2h0ID0gbG93ZXJIbVJlY3QoaG0sIDMyLCA0OCwgMTIsIDE2KVxyXG5cclxuICBjb25zdCBmbGF0dGVuZWRIZWlnaHQgPSBmbGF0dGVuSG1SZWN0KGhtLCA2NCwgNjQsIDE2LCAyNClcclxuXHJcbiAgY29uc3QgZW5kU2N1bHB0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpXHJcblxyXG4gIGNvbnNvbGUubG9nKGBzY3VscHRpbmcgdG9vayAke2VuZFNjdWxwdFRpbWUgLSBzdGFydFNjdWxwdFRpbWV9bXNgKVxyXG5cclxuICAvLyBjb252ZXJ0IHRoZSBidWlsZGluZ3NcclxuXHJcbiAgY29uc3Qgc3RhcnRDb252ZXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpXHJcblxyXG4gIGNvbnN0IHJXYWxsc1ZveCA9IHJXYWxscy5tYXAoKFt4LCB5LCB6XSkgPT4ge1xyXG4gICAgbGV0IGZjb2xvciA9IDBcclxuICAgIGxldCB0Y29sb3IgPSAwXHJcblxyXG4gICAgY29uc3QgZCA9IG1hcEggKiAyXHJcbiAgICBjb25zdCBkYXJrZW4gPSAxIC0geiAvIGRcclxuXHJcbiAgICBjb25zdCB2ID0gcmFuZEludCgzMikgLSAxNlxyXG5cclxuICAgIGNvbnN0IGdyZXkgPSAodiArIDEyOCArIHkgKiAwLjUpICogZGFya2VuXHJcbiAgICBjb25zdCBkYXJrR3JleSA9IGdyZXkgKiAwLjc1XHJcblxyXG4gICAgZmNvbG9yID0gMHhmZjAwMDAwMCB8IChncmV5IDw8IDE2KSB8IChncmV5IDw8IDgpIHwgZ3JleVxyXG4gICAgdGNvbG9yID0gMHhmZjAwMDAwMCB8IChkYXJrR3JleSA8PCAxNikgfCAoZGFya0dyZXkgPDwgOCkgfCBkYXJrR3JleVxyXG5cclxuICAgIHJldHVybiBbeCwgeSwgeiwgdGNvbG9yLCBmY29sb3JdIGFzIFZveFxyXG4gIH0pXHJcblxyXG4gIC8vIGNvbnZlcnQgdGhlIGhtXHJcblxyXG4gIGNvbnN0IGhtUDNzID0gaGVpZ2h0bWFwVG9Qb2ludDMoaG0pXHJcblxyXG4gIGNvbnN0IGhtTWluID0gbWluSGVpZ2h0KGhtKVxyXG4gIGNvbnN0IGhtTWF4ID0gbWF4SGVpZ2h0KGhtKVxyXG5cclxuICBjb25zdCBobURlbHRhID0gaG1NYXggLSBobU1pblxyXG5cclxuICBjb25zdCBncmVlblJhbmdlID0gbWFwSFxyXG5cclxuICBjb25zdCBncmVlblN0ZXAgPSBncmVlblJhbmdlIC8gaG1EZWx0YVxyXG5cclxuICBjb25zdCBobVAzc1ZveCA9IGhtUDNzLm1hcCgoW3gsIHksIHpdKSA9PiB7XHJcbiAgICBsZXQgaG1Ub3BDb2xvciA9IDBcclxuICAgIGxldCBobUZyb250Q29sb3IgPSAwXHJcblxyXG4gICAgLy8gZGFya2VuIHNsaWdodGx5IGFzIHogaW5jcmVhc2VzXHJcbiAgICAvLyBsb3dlciBkIG51bWJlcnMgPSBtb3JlIGRhcmssIGhpZ2hlciA9IGxlc3MgZGFya1xyXG4gICAgY29uc3QgZCA9IG1hcEggKiAyXHJcbiAgICBjb25zdCBkYXJrZW4gPSAxIC0geiAvIGRcclxuXHJcbiAgICAvLyBhZGQgYSBsaXR0bGUgcmFuZG9tbmVzcyB0byB0aGUgZ3JlZW4gY29sb3IgYnkgdXNpbmcgc21hbGwgcmVkL2JsdWUgdmFsdWVzXHJcbiAgICBjb25zdCByZWQgPSAocmFuZEludCgzMikgKyAxNikgLy8qIGRhcmtlblxyXG4gICAgY29uc3QgZGFya1JlZCA9IHJlZCAqIDAuNzVcclxuICAgIGNvbnN0IGJsdWUgPSAocmFuZEludCgzMikgKyAxNikgLy8qIGRhcmtlblxyXG4gICAgY29uc3QgZGFya0JsdWUgPSBibHVlICogMC43NVxyXG5cclxuICAgIC8vIHRvcCBzaG91bGQgZ2V0cyBicmlnaHRlciBhcyB5IGluY3JlYXNlc1xyXG4gICAgLy8gZnJvbnQgc2hvdWxkIGJlIHRvcCBidXQgZGFya2VuZWQgYSBiaXRcclxuICAgIC8vXHJcbiAgICAvLyBtYWtlIGl0IGEgbGl0dGxlIHJhbmRvbSBzbyBpdCBsb29rcyBtb3JlIGludGVyZXN0aW5nXHJcbiAgICBjb25zdCBnID0gcmFuZEludCgzMikgLSAxNlxyXG4gICAgLy8gdGhlbiBhcHBseSBhIGdyYWRpZW50IGJhc2VkIG9uIGhlaWdodFxyXG4gICAgY29uc3QgZ3JlZW4gPSAoZyArIDY0ICsgeSAqIGdyZWVuU3RlcCkgKiBkYXJrZW5cclxuICAgIGNvbnN0IGRhcmtHcmVlbiA9IGdyZWVuICogMC43NVxyXG5cclxuICAgIGhtVG9wQ29sb3IgPSAweGZmMDAwMDAwIHwgKGJsdWUgPDwgMTYpIHwgKGdyZWVuIDw8IDgpIHwgcmVkXHJcbiAgICBobUZyb250Q29sb3IgPSAweGZmMDAwMDAwIHwgKGRhcmtCbHVlIDw8IDE2KSB8IChkYXJrR3JlZW4gPDwgOCkgfCBkYXJrUmVkXHJcblxyXG4gICAgcmV0dXJuIFt4LCB5LCB6LCBobVRvcENvbG9yLCBobUZyb250Q29sb3JdIGFzIFZveFxyXG4gIH0pXHJcblxyXG4gIGNvbnN0IGVuZENvbnZlcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KClcclxuXHJcbiAgY29uc29sZS5sb2coYGNvbnZlcnRpbmcgdG9vayAke2VuZENvbnZlcnRUaW1lIC0gc3RhcnRDb252ZXJ0VGltZX1tc2ApXHJcblxyXG4gIC8vIGNyZWF0ZSBhbmQgc29ydCB2b3hlbHNcclxuXHJcbiAgY29uc3Qgc3RhcnRWb3hUaW1lID0gcGVyZm9ybWFuY2Uubm93KClcclxuXHJcbiAgY29uc3Qgdm94ZWxzOiBWb3hbXSA9IFtdXHJcblxyXG4gIHZveGVscy5wdXNoKC4uLnJXYWxsc1ZveClcclxuICB2b3hlbHMucHVzaCguLi5obVAzc1ZveClcclxuXHJcbiAgdm94ZWxzLnNvcnQoKGEsIGIpID0+IHtcclxuICAgIC8vIHNvcnQgb24geiAtIGJpZ2dlciBpcyBmdXJ0aGVyIGF3YXlcclxuICAgIGNvbnN0IHpEZWx0YSA9IGJbMl0gLSBhWzJdXHJcblxyXG4gICAgaWYgKHpEZWx0YSAhPT0gMCkge1xyXG4gICAgICByZXR1cm4gekRlbHRhXHJcbiAgICB9XHJcblxyXG4gICAgLy8gdGllIGJyZWFrIG9uIHkgLSB3ZSB3YW50IHRvIHNvcnQgc21hbGxlciB5IGZpcnN0XHJcbiAgICAvLyBzbyB0aGF0IHRoZSBcInRvcHNcIiBvZiB2b3hlbHMgb3ZlcmxheSBjb3JyZWN0bHlcclxuICAgIHJldHVybiBhWzFdIC0gYlsxXVxyXG4gIH0pXHJcblxyXG4gIGNvbnN0IGVuZFZveFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKVxyXG5cclxuICBjb25zb2xlLmxvZyhgdm94ZWwgY3JlYXRpb24gdG9vayAke2VuZFZveFRpbWUgLSBzdGFydFZveFRpbWV9bXNgKVxyXG5cclxuICBjb25zb2xlLmxvZyhgdG90YWwgdGltZTogJHtlbmRWb3hUaW1lIC0gc3RhcnRIbVRpbWV9bXNgKVxyXG4gIGNvbnNvbGUubG9nKGB2b3hlbCBjb3VudDogJHt2b3hlbHMubGVuZ3RofWApXHJcblxyXG4gIHJldHVybiB2b3hlbHNcclxufSJdfQ==
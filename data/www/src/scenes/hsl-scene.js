import { bresenhamLine } from '../lib/image/bresenham.js';
import { createColor, hslToRgb } from '../lib/image/color.js';
import { clampTransfer } from '../lib/image/util.js';
import { debugTextSceneHelper } from '../lib/scene/debug-text.js';
import { exitOnEscape, zoomOnWheel } from '../lib/scene/io.js';
import { maybe } from '../lib/util.js';
export const hslScene = () => {
    let isActive = false;
    let debugHelper;
    let lastW = 0;
    let lastH = 0;
    let hsla16;
    let selectedColor = hmidgrey;
    let drawRect = [0, 0, 0, 0];
    // x, y, hsla color
    let paintPts = [];
    let pmode = 'paint';
    let lastMx = null;
    let lastMy = null;
    let lastMb = false;
    let debugText = [];
    const init = async (state) => {
        debugHelper = debugTextSceneHelper(() => debugText);
        await debugHelper.init(state);
        paintPts = [];
        isActive = true;
    };
    const onResize = () => {
        hsla16 = createHsla16(lastW, lastH);
    };
    const io = (state) => {
        if (exitOnEscape(state))
            return;
        if (zoomOnWheel(state)) {
            lastW = 0;
            lastH = 0;
        }
        const keys = state.getKeyPresses();
        for (let i = 0; i < keys.length; i++) {
            const lkey = keys[i].toLowerCase();
            if (lkey === 'p') {
                pmode = 'paint';
            }
            if (lkey === 'f') {
                pmode = 'fill';
            }
        }
        keys.length = 0;
        if (!maybe(hsla16))
            return;
        const mbuts = state.mouse.getButtons();
        const mx = state.mouse.getX();
        const my = state.mouse.getY();
        const [rx, ry, rw, rh] = drawRect;
        const inDrawRect = (mx >= rx && mx < rx + rw &&
            my >= ry && my < ry + rh);
        if (mbuts[0]) {
            if (inDrawRect) {
                if (pmode === 'paint') {
                    if (!maybe(lastMx) || !maybe(lastMy)) {
                        paintPts.push([mx - rx, my - ry, selectedColor]);
                    }
                    else {
                        const line = bresenhamLine(lastMx, lastMy, mx, my);
                        for (let l = 0; l < line.length; l++) {
                            const [lx, ly] = line[l];
                            paintPts.push([lx - rx, ly - ry, selectedColor]);
                        }
                    }
                    lastMx = mx;
                    lastMy = my;
                }
                else {
                    lastMx = null;
                    lastMy = null;
                }
            }
            else {
                const index = my * hsla16.width + mx;
                selectedColor = hsla16.data[index];
            }
            lastMb = true;
        }
        else {
            lastMx = null;
            lastMy = null;
            if (lastMb && pmode === 'fill') {
                const fillPts = floodFill(hsla16, selectedColor, mx, my);
                for (let i = 0; i < fillPts.length; i++) {
                    const [fx, fy, fh] = fillPts[i];
                    paintPts.push([fx - rx, fy - ry, fh]);
                }
            }
            lastMb = false;
        }
    };
    const update = (state) => {
        if (!maybe(debugHelper))
            throw Error('debugHelper not initialized');
        if (isActive)
            io(state);
        const buffer = state.view.getBuffer();
        const { width, height } = buffer;
        if (width !== lastW || height !== lastH) {
            lastW = width;
            lastH = height;
            onResize();
        }
        // draw to hsl buffer
        if (!maybe(hsla16))
            throw Error('hsla16 not initialized');
        hsla16.data.fill(selectedColor);
        const padding = 1;
        const cellW = 16;
        const cellH = 16;
        const advX = cellW + padding;
        const advY = cellH + padding;
        let dx = padding;
        let dy = padding;
        for (let h = 0; h < 16; h++) {
            //
            for (let s = 0; s < 16; s++) {
                const destY = s + dy;
                const rowStart = destY * hsla16.width;
                for (let l = 0; l < 16; l++) {
                    const destX = l + dx;
                    const index = destX + rowStart;
                    const color = createHslaColor(h, s, l);
                    hsla16.data[index] = color;
                }
            }
            //
            dy += advY;
            const remY = height - dy;
            if (remY < cellH) {
                dy = padding;
                dx += advX;
                const remX = width - dx;
                if (remX < cellW)
                    break;
            }
        }
        dx += advX;
        const rightX = dx;
        const rightY = padding;
        const rightW = width - dx - padding;
        const rightH = height - padding * 2;
        for (let ry = 0; ry < rightH; ry++) {
            const rectY = ry + rightY;
            const rowStart = rectY * hsla16.width;
            for (let rx = 0; rx < rightW; rx++) {
                const rectX = rx + rightX;
                const index = rectX + rowStart;
                hsla16.data[index] = hblack;
            }
        }
        drawRect = [rightX, rightY, rightW, rightH];
        for (let i = 0; i < paintPts.length; i++) {
            const [px, py, ph] = paintPts[i];
            const rectX = rightX + px;
            const rectY = rightY + py;
            if (rectX < 0 || rectX >= width || rectY < 0 || rectY >= height)
                continue;
            const index = rectY * hsla16.width + rectX;
            hsla16.data[index] = ph;
        }
        //
        blitHsla(hsla16, buffer);
        //
        const frameTime = state.time.getFrameTime();
        const fps = Math.round(1000 / frameTime);
        const fpsText = `${fps} fps (${frameTime.toFixed(1)}ms)`;
        debugText = [fpsText, pmode];
        debugHelper.update(state);
    };
    const quit = async (state) => {
        isActive = false;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
const hMask = 0b1111000000000000;
const sMask = 0b0000111100000000;
const lMask = 0b0000000011110000;
const aMask = 0b0000000000001111;
const createHslaColor = (h, s, l, a = 15) => (h << 12) | (s << 8) | (l << 4) | a;
//
const hwhite = createHslaColor(0, 0, 15);
const hmidgrey = createHslaColor(0, 0, 8);
const hblack = createHslaColor(0, 0, 0);
//
const hslaColorToTuple = (color) => [
    (color & hMask) >> 12,
    (color & sMask) >> 8,
    (color & lMask) >> 4,
    color & aMask
];
const createHsla16 = (width, height) => {
    const size = width * height;
    const data = new Uint16Array(size);
    return { width, height, data };
};
const totalHsla = 16 ** 4;
const hslaToRgbaLut = new Uint32Array(totalHsla);
for (let i = 0; i < totalHsla; i++) {
    let [h, s, l, a] = hslaColorToTuple(i);
    h /= 15;
    s /= 15;
    l /= 15;
    a *= 17; // /= 15 * 255
    const [r, g, b] = hslToRgb([h, s, l]);
    const rgbaColor = createColor(r, g, b, a);
    hslaToRgbaLut[i] = rgbaColor;
}
const blitHsla = (src, dest, transfer = [0, 0, src.width, src.height, 0, 0]) => {
    const [sx, sy, sw, sh, dx, dy] = clampTransfer(src.width, src.height, dest.width, dest.height, transfer);
    const destView = new Uint32Array(dest.data.buffer);
    for (let y = 0; y < sh; y++) {
        for (let x = 0; x < sw; x++) {
            const srcIndex = x + sx + (y + sy) * src.width;
            const destIndex = x + dx + (y + dy) * dest.width;
            const hslaColor = src.data[srcIndex];
            const rgbaColor = hslaToRgbaLut[hslaColor];
            destView[destIndex] = rgbaColor;
        }
    }
    return dest;
};
const floodFill = (dest, color, x, y) => {
    const pts = [];
    const seen = new Set();
    if (x < 0 || x >= dest.width || y < 0 || y >= dest.height)
        return pts;
    const index = y * dest.width + x;
    const oldColor = dest.data[index];
    if (oldColor === color)
        return pts;
    const queue = [];
    queue.push([x, y]);
    while (queue.length > 0) {
        const [cx, cy] = queue.shift();
        if (cx < 0 || cx >= dest.width || cy < 0 || cy >= dest.height)
            continue;
        const index = cy * dest.width + cx;
        if (seen.has(index))
            continue;
        if (dest.data[index] !== oldColor)
            continue;
        pts.push([cx, cy, color]);
        seen.add(index);
        queue.push([cx, cy - 1]);
        queue.push([cx + 1, cy]);
        queue.push([cx, cy + 1]);
        queue.push([cx - 1, cy]);
    }
    return pts;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHNsLXNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lcy9oc2wtc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBQ3pELE9BQU8sRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFDN0QsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQ3BELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDRCQUE0QixDQUFBO0FBQ2pFLE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFFOUQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBSXRDLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRyxHQUFVLEVBQUU7SUFDbEMsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFBO0lBQ3BCLElBQUksV0FBeUIsQ0FBQTtJQUM3QixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7SUFDYixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7SUFDYixJQUFJLE1BQXFCLENBQUE7SUFDekIsSUFBSSxhQUFhLEdBQUcsUUFBUSxDQUFBO0lBQzVCLElBQUksUUFBUSxHQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDL0IsbUJBQW1CO0lBQ25CLElBQUksUUFBUSxHQUFTLEVBQUUsQ0FBQTtJQUN2QixJQUFJLEtBQUssR0FBVSxPQUFPLENBQUE7SUFFMUIsSUFBSSxNQUFNLEdBQWtCLElBQUksQ0FBQTtJQUNoQyxJQUFJLE1BQU0sR0FBa0IsSUFBSSxDQUFBO0lBQ2hDLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQTtJQUVsQixJQUFJLFNBQVMsR0FBYSxFQUFFLENBQUE7SUFFNUIsTUFBTSxJQUFJLEdB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QUE7QUFDWixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBicmVzZW5oYW1MaW5lIH0gZnJvbSAnLi4vbGliL2ltYWdlL2JyZXNlbmhhbS5qcydcclxuaW1wb3J0IHsgY3JlYXRlQ29sb3IsIGhzbFRvUmdiIH0gZnJvbSAnLi4vbGliL2ltYWdlL2NvbG9yLmpzJ1xyXG5pbXBvcnQgeyBjbGFtcFRyYW5zZmVyIH0gZnJvbSAnLi4vbGliL2ltYWdlL3V0aWwuanMnXHJcbmltcG9ydCB7IGRlYnVnVGV4dFNjZW5lSGVscGVyIH0gZnJvbSAnLi4vbGliL3NjZW5lL2RlYnVnLXRleHQuanMnXHJcbmltcG9ydCB7IGV4aXRPbkVzY2FwZSwgem9vbU9uV2hlZWwgfSBmcm9tICcuLi9saWIvc2NlbmUvaW8uanMnXHJcbmltcG9ydCB7IE1heWJlLCBTY2VuZSwgU3RhdGUsIFQyLCBUMywgVDQsIFQ2IH0gZnJvbSAnLi4vbGliL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyBtYXliZSB9IGZyb20gJy4uL2xpYi91dGlsLmpzJ1xyXG5cclxudHlwZSBQTW9kZSA9ICdwYWludCcgfCAnZmlsbCdcclxuXHJcbmV4cG9ydCBjb25zdCBoc2xTY2VuZSA9ICgpOiBTY2VuZSA9PiB7XHJcbiAgbGV0IGlzQWN0aXZlID0gZmFsc2VcclxuICBsZXQgZGVidWdIZWxwZXI6IE1heWJlPFNjZW5lPlxyXG4gIGxldCBsYXN0VyA9IDBcclxuICBsZXQgbGFzdEggPSAwXHJcbiAgbGV0IGhzbGExNjogTWF5YmU8SHNsYTE2PlxyXG4gIGxldCBzZWxlY3RlZENvbG9yID0gaG1pZGdyZXlcclxuICBsZXQgZHJhd1JlY3Q6IFQ0ID0gWzAsIDAsIDAsIDBdXHJcbiAgLy8geCwgeSwgaHNsYSBjb2xvclxyXG4gIGxldCBwYWludFB0czogVDNbXSA9IFtdXHJcbiAgbGV0IHBtb2RlOiBQTW9kZSA9ICdwYWludCdcclxuXHJcbiAgbGV0IGxhc3RNeDogTWF5YmU8bnVtYmVyPiA9IG51bGxcclxuICBsZXQgbGFzdE15OiBNYXliZTxudW1iZXI+ID0gbnVsbFxyXG4gIGxldCBsYXN0TWIgPSBmYWxzZVxyXG5cclxuICBsZXQgZGVidWdUZXh0OiBzdHJpbmdbXSA9IFtdXHJcblxyXG4gIGNvbnN0IGluaXQgPSBhc3luYyAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBkZWJ1Z0hlbHBlciA9IGRlYnVnVGV4dFNjZW5lSGVscGVyKCgpID0+IGRlYnVnVGV4dClcclxuXHJcbiAgICBhd2FpdCBkZWJ1Z0hlbHBlci5pbml0KHN0YXRlKVxyXG5cclxuICAgIHBhaW50UHRzID0gW11cclxuXHJcbiAgICBpc0FjdGl2ZSA9IHRydWVcclxuICB9XHJcblxyXG4gIGNvbnN0IG9uUmVzaXplID0gKCkgPT4ge1xyXG4gICAgaHNsYTE2ID0gY3JlYXRlSHNsYTE2KGxhc3RXLCBsYXN0SClcclxuICB9XHJcblxyXG4gIGNvbnN0IGlvID0gKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgaWYgKGV4aXRPbkVzY2FwZShzdGF0ZSkpIHJldHVyblxyXG5cclxuICAgIGlmICh6b29tT25XaGVlbChzdGF0ZSkpIHtcclxuICAgICAgbGFzdFcgPSAwXHJcbiAgICAgIGxhc3RIID0gMFxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGtleXMgPSBzdGF0ZS5nZXRLZXlQcmVzc2VzKClcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgY29uc3QgbGtleSA9IGtleXNbaV0udG9Mb3dlckNhc2UoKVxyXG5cclxuICAgICAgaWYgKGxrZXkgPT09ICdwJykge1xyXG4gICAgICAgIHBtb2RlID0gJ3BhaW50J1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAobGtleSA9PT0gJ2YnKSB7XHJcbiAgICAgICAgcG1vZGUgPSAnZmlsbCdcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGtleXMubGVuZ3RoID0gMFxyXG5cclxuICAgIGlmICghbWF5YmUoaHNsYTE2KSkgcmV0dXJuXHJcblxyXG4gICAgY29uc3QgbWJ1dHMgPSBzdGF0ZS5tb3VzZS5nZXRCdXR0b25zKClcclxuICAgIGNvbnN0IG14ID0gc3RhdGUubW91c2UuZ2V0WCgpXHJcbiAgICBjb25zdCBteSA9IHN0YXRlLm1vdXNlLmdldFkoKVxyXG5cclxuICAgIGNvbnN0IFtyeCwgcnksIHJ3LCByaF0gPSBkcmF3UmVjdFxyXG5cclxuICAgIGNvbnN0IGluRHJhd1JlY3QgPSAoXHJcbiAgICAgIG14ID49IHJ4ICYmIG14IDwgcnggKyBydyAmJlxyXG4gICAgICBteSA+PSByeSAmJiBteSA8IHJ5ICsgcmhcclxuICAgIClcclxuXHJcbiAgICBpZiAobWJ1dHNbMF0pIHtcclxuICAgICAgaWYgKGluRHJhd1JlY3QpIHtcclxuICAgICAgICBpZiAocG1vZGUgPT09ICdwYWludCcpIHtcclxuICAgICAgICAgIGlmICghbWF5YmUobGFzdE14KSB8fCAhbWF5YmUobGFzdE15KSkge1xyXG4gICAgICAgICAgICBwYWludFB0cy5wdXNoKFtteCAtIHJ4LCBteSAtIHJ5LCBzZWxlY3RlZENvbG9yXSlcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpbmUgPSBicmVzZW5oYW1MaW5lKGxhc3RNeCwgbGFzdE15LCBteCwgbXkpXHJcblxyXG4gICAgICAgICAgICBmb3IgKGxldCBsID0gMDsgbCA8IGxpbmUubGVuZ3RoOyBsKyspIHtcclxuICAgICAgICAgICAgICBjb25zdCBbbHgsIGx5XSA9IGxpbmVbbF1cclxuXHJcbiAgICAgICAgICAgICAgcGFpbnRQdHMucHVzaChbbHggLSByeCwgbHkgLSByeSwgc2VsZWN0ZWRDb2xvcl0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBsYXN0TXggPSBteFxyXG4gICAgICAgICAgbGFzdE15ID0gbXlcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgbGFzdE14ID0gbnVsbFxyXG4gICAgICAgICAgbGFzdE15ID0gbnVsbFxyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBpbmRleCA9IG15ICogaHNsYTE2LndpZHRoICsgbXhcclxuXHJcbiAgICAgICAgc2VsZWN0ZWRDb2xvciA9IGhzbGExNi5kYXRhW2luZGV4XVxyXG4gICAgICB9XHJcblxyXG4gICAgICBsYXN0TWIgPSB0cnVlXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsYXN0TXggPSBudWxsXHJcbiAgICAgIGxhc3RNeSA9IG51bGxcclxuXHJcbiAgICAgIGlmIChsYXN0TWIgJiYgcG1vZGUgPT09ICdmaWxsJykge1xyXG4gICAgICAgIGNvbnN0IGZpbGxQdHMgPSBmbG9vZEZpbGwoaHNsYTE2LCBzZWxlY3RlZENvbG9yLCBteCwgbXkpXHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsbFB0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgY29uc3QgW2Z4LCBmeSwgZmhdID0gZmlsbFB0c1tpXVxyXG5cclxuICAgICAgICAgIHBhaW50UHRzLnB1c2goW2Z4IC0gcngsIGZ5IC0gcnksIGZoXSlcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxhc3RNYiA9IGZhbHNlXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCB1cGRhdGUgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpZiAoIW1heWJlKGRlYnVnSGVscGVyKSkgdGhyb3cgRXJyb3IoJ2RlYnVnSGVscGVyIG5vdCBpbml0aWFsaXplZCcpXHJcblxyXG4gICAgaWYgKGlzQWN0aXZlKSBpbyhzdGF0ZSlcclxuXHJcbiAgICBjb25zdCBidWZmZXIgPSBzdGF0ZS52aWV3LmdldEJ1ZmZlcigpXHJcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IGJ1ZmZlclxyXG5cclxuICAgIGlmICh3aWR0aCAhPT0gbGFzdFcgfHwgaGVpZ2h0ICE9PSBsYXN0SCkge1xyXG4gICAgICBsYXN0VyA9IHdpZHRoXHJcbiAgICAgIGxhc3RIID0gaGVpZ2h0XHJcbiAgICAgIG9uUmVzaXplKClcclxuICAgIH1cclxuXHJcbiAgICAvLyBkcmF3IHRvIGhzbCBidWZmZXJcclxuXHJcbiAgICBpZiAoIW1heWJlKGhzbGExNikpIHRocm93IEVycm9yKCdoc2xhMTYgbm90IGluaXRpYWxpemVkJylcclxuXHJcbiAgICBoc2xhMTYuZGF0YS5maWxsKHNlbGVjdGVkQ29sb3IpXHJcblxyXG4gICAgY29uc3QgcGFkZGluZyA9IDFcclxuICAgIGNvbnN0IGNlbGxXID0gMTZcclxuICAgIGNvbnN0IGNlbGxIID0gMTZcclxuICAgIGNvbnN0IGFkdlggPSBjZWxsVyArIHBhZGRpbmdcclxuICAgIGNvbnN0IGFkdlkgPSBjZWxsSCArIHBhZGRpbmdcclxuXHJcbiAgICBsZXQgZHggPSBwYWRkaW5nXHJcbiAgICBsZXQgZHkgPSBwYWRkaW5nXHJcblxyXG4gICAgZm9yIChsZXQgaCA9IDA7IGggPCAxNjsgaCsrKSB7XHJcbiAgICAgIC8vXHJcblxyXG4gICAgICBmb3IgKGxldCBzID0gMDsgcyA8IDE2OyBzKyspIHtcclxuICAgICAgICBjb25zdCBkZXN0WSA9IHMgKyBkeVxyXG4gICAgICAgIGNvbnN0IHJvd1N0YXJ0ID0gZGVzdFkgKiBoc2xhMTYud2lkdGhcclxuXHJcbiAgICAgICAgZm9yIChsZXQgbCA9IDA7IGwgPCAxNjsgbCsrKSB7XHJcbiAgICAgICAgICBjb25zdCBkZXN0WCA9IGwgKyBkeFxyXG4gICAgICAgICAgY29uc3QgaW5kZXggPSBkZXN0WCArIHJvd1N0YXJ0XHJcblxyXG4gICAgICAgICAgY29uc3QgY29sb3IgPSBjcmVhdGVIc2xhQ29sb3IoaCwgcywgbClcclxuXHJcbiAgICAgICAgICBoc2xhMTYuZGF0YVtpbmRleF0gPSBjb2xvclxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy9cclxuXHJcbiAgICAgIGR5ICs9IGFkdllcclxuXHJcbiAgICAgIGNvbnN0IHJlbVkgPSBoZWlnaHQgLSBkeVxyXG5cclxuICAgICAgaWYgKHJlbVkgPCBjZWxsSCkge1xyXG4gICAgICAgIGR5ID0gcGFkZGluZ1xyXG4gICAgICAgIGR4ICs9IGFkdlhcclxuXHJcbiAgICAgICAgY29uc3QgcmVtWCA9IHdpZHRoIC0gZHhcclxuXHJcbiAgICAgICAgaWYgKHJlbVggPCBjZWxsVykgYnJlYWtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGR4ICs9IGFkdlhcclxuXHJcbiAgICBjb25zdCByaWdodFggPSBkeFxyXG4gICAgY29uc3QgcmlnaHRZID0gcGFkZGluZ1xyXG4gICAgY29uc3QgcmlnaHRXID0gd2lkdGggLSBkeCAtIHBhZGRpbmdcclxuICAgIGNvbnN0IHJpZ2h0SCA9IGhlaWdodCAtIHBhZGRpbmcgKiAyXHJcblxyXG4gICAgZm9yIChsZXQgcnkgPSAwOyByeSA8IHJpZ2h0SDsgcnkrKykge1xyXG4gICAgICBjb25zdCByZWN0WSA9IHJ5ICsgcmlnaHRZXHJcbiAgICAgIGNvbnN0IHJvd1N0YXJ0ID0gcmVjdFkgKiBoc2xhMTYud2lkdGhcclxuXHJcbiAgICAgIGZvciAobGV0IHJ4ID0gMDsgcnggPCByaWdodFc7IHJ4KyspIHtcclxuICAgICAgICBjb25zdCByZWN0WCA9IHJ4ICsgcmlnaHRYXHJcbiAgICAgICAgY29uc3QgaW5kZXggPSByZWN0WCArIHJvd1N0YXJ0XHJcblxyXG4gICAgICAgIGhzbGExNi5kYXRhW2luZGV4XSA9IGhibGFja1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZHJhd1JlY3QgPSBbcmlnaHRYLCByaWdodFksIHJpZ2h0VywgcmlnaHRIXVxyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFpbnRQdHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgY29uc3QgW3B4LCBweSwgcGhdID0gcGFpbnRQdHNbaV1cclxuXHJcbiAgICAgIGNvbnN0IHJlY3RYID0gcmlnaHRYICsgcHhcclxuICAgICAgY29uc3QgcmVjdFkgPSByaWdodFkgKyBweVxyXG5cclxuICAgICAgaWYgKHJlY3RYIDwgMCB8fCByZWN0WCA+PSB3aWR0aCB8fCByZWN0WSA8IDAgfHwgcmVjdFkgPj0gaGVpZ2h0KSBjb250aW51ZVxyXG5cclxuICAgICAgY29uc3QgaW5kZXggPSByZWN0WSAqIGhzbGExNi53aWR0aCArIHJlY3RYXHJcblxyXG4gICAgICBoc2xhMTYuZGF0YVtpbmRleF0gPSBwaFxyXG4gICAgfVxyXG5cclxuICAgIC8vXHJcblxyXG4gICAgYmxpdEhzbGEoaHNsYTE2LCBidWZmZXIpXHJcblxyXG4gICAgLy9cclxuXHJcbiAgICBjb25zdCBmcmFtZVRpbWUgPSBzdGF0ZS50aW1lLmdldEZyYW1lVGltZSgpXHJcbiAgICBjb25zdCBmcHMgPSBNYXRoLnJvdW5kKDEwMDAgLyBmcmFtZVRpbWUpXHJcbiAgICBjb25zdCBmcHNUZXh0ID0gYCR7ZnBzfSBmcHMgKCR7ZnJhbWVUaW1lLnRvRml4ZWQoMSl9bXMpYFxyXG5cclxuICAgIGRlYnVnVGV4dCA9IFtmcHNUZXh0LCBwbW9kZV1cclxuXHJcbiAgICBkZWJ1Z0hlbHBlci51cGRhdGUoc3RhdGUpXHJcbiAgfVxyXG5cclxuICBjb25zdCBxdWl0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgaXNBY3RpdmUgPSBmYWxzZVxyXG4gIH1cclxuXHJcbiAgY29uc3Qgc2V0QWN0aXZlID0gKGFjdGl2ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgaXNBY3RpdmUgPSBhY3RpdmVcclxuICB9XHJcblxyXG4gIHJldHVybiB7IGluaXQsIHVwZGF0ZSwgcXVpdCwgc2V0QWN0aXZlIH1cclxufVxyXG5cclxudHlwZSBIc2xhMTYgPSB7XHJcbiAgd2lkdGg6IG51bWJlclxyXG4gIGhlaWdodDogbnVtYmVyXHJcbiAgZGF0YTogVWludDE2QXJyYXlcclxufVxyXG5cclxuY29uc3QgaE1hc2sgPSAwYjExMTEwMDAwMDAwMDAwMDBcclxuY29uc3Qgc01hc2sgPSAwYjAwMDAxMTExMDAwMDAwMDBcclxuY29uc3QgbE1hc2sgPSAwYjAwMDAwMDAwMTExMTAwMDBcclxuY29uc3QgYU1hc2sgPSAwYjAwMDAwMDAwMDAwMDExMTFcclxuXHJcbmNvbnN0IGNyZWF0ZUhzbGFDb2xvciA9IChoOiBudW1iZXIsIHM6IG51bWJlciwgbDogbnVtYmVyLCBhID0gMTUpOiBudW1iZXIgPT5cclxuICAoaCA8PCAxMikgfCAocyA8PCA4KSB8IChsIDw8IDQpIHwgYVxyXG5cclxuXHJcbi8vXHJcblxyXG5jb25zdCBod2hpdGUgPSBjcmVhdGVIc2xhQ29sb3IoMCwgMCwgMTUpXHJcbmNvbnN0IGhtaWRncmV5ID0gY3JlYXRlSHNsYUNvbG9yKDAsIDAsIDgpXHJcbmNvbnN0IGhibGFjayA9IGNyZWF0ZUhzbGFDb2xvcigwLCAwLCAwKVxyXG5cclxuLy9cclxuXHJcbmNvbnN0IGhzbGFDb2xvclRvVHVwbGUgPSAoY29sb3I6IG51bWJlcik6IFQ0ID0+IFtcclxuICAoY29sb3IgJiBoTWFzaykgPj4gMTIsXHJcbiAgKGNvbG9yICYgc01hc2spID4+IDgsXHJcbiAgKGNvbG9yICYgbE1hc2spID4+IDQsXHJcbiAgY29sb3IgJiBhTWFza1xyXG5dXHJcblxyXG5jb25zdCBjcmVhdGVIc2xhMTYgPSAod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiBIc2xhMTYgPT4ge1xyXG4gIGNvbnN0IHNpemUgPSB3aWR0aCAqIGhlaWdodFxyXG4gIGNvbnN0IGRhdGEgPSBuZXcgVWludDE2QXJyYXkoc2l6ZSlcclxuXHJcbiAgcmV0dXJuIHsgd2lkdGgsIGhlaWdodCwgZGF0YSB9XHJcbn1cclxuXHJcbmNvbnN0IHRvdGFsSHNsYSA9IDE2ICoqIDRcclxuXHJcbmNvbnN0IGhzbGFUb1JnYmFMdXQgPSBuZXcgVWludDMyQXJyYXkodG90YWxIc2xhKVxyXG5cclxuZm9yIChsZXQgaSA9IDA7IGkgPCB0b3RhbEhzbGE7IGkrKykge1xyXG4gIGxldCBbaCwgcywgbCwgYV0gPSBoc2xhQ29sb3JUb1R1cGxlKGkpXHJcblxyXG4gIGggLz0gMTVcclxuICBzIC89IDE1XHJcbiAgbCAvPSAxNVxyXG4gIGEgKj0gMTcgLy8gLz0gMTUgKiAyNTVcclxuXHJcbiAgY29uc3QgW3IsIGcsIGJdID0gaHNsVG9SZ2IoW2gsIHMsIGxdKVxyXG5cclxuICBjb25zdCByZ2JhQ29sb3IgPSBjcmVhdGVDb2xvcihyLCBnLCBiLCBhKVxyXG5cclxuICBoc2xhVG9SZ2JhTHV0W2ldID0gcmdiYUNvbG9yXHJcbn1cclxuXHJcbmNvbnN0IGJsaXRIc2xhID0gKFxyXG4gIHNyYzogSHNsYTE2LCBkZXN0OiBJbWFnZURhdGEsXHJcbiAgdHJhbnNmZXI6IFQ2ID0gWzAsIDAsIHNyYy53aWR0aCwgc3JjLmhlaWdodCwgMCwgMF1cclxuKSA9PiB7XHJcbiAgY29uc3QgW3N4LCBzeSwgc3csIHNoLCBkeCwgZHldID0gY2xhbXBUcmFuc2ZlcihcclxuICAgIHNyYy53aWR0aCwgc3JjLmhlaWdodCwgZGVzdC53aWR0aCwgZGVzdC5oZWlnaHQsIHRyYW5zZmVyXHJcbiAgKVxyXG5cclxuICBjb25zdCBkZXN0VmlldyA9IG5ldyBVaW50MzJBcnJheShkZXN0LmRhdGEuYnVmZmVyKVxyXG5cclxuICBmb3IgKGxldCB5ID0gMDsgeSA8IHNoOyB5KyspIHtcclxuICAgIGZvciAobGV0IHggPSAwOyB4IDwgc3c7IHgrKykge1xyXG4gICAgICBjb25zdCBzcmNJbmRleCA9IHggKyBzeCArICh5ICsgc3kpICogc3JjLndpZHRoXHJcbiAgICAgIGNvbnN0IGRlc3RJbmRleCA9IHggKyBkeCArICh5ICsgZHkpICogZGVzdC53aWR0aFxyXG5cclxuICAgICAgY29uc3QgaHNsYUNvbG9yID0gc3JjLmRhdGFbc3JjSW5kZXhdXHJcbiAgICAgIGNvbnN0IHJnYmFDb2xvciA9IGhzbGFUb1JnYmFMdXRbaHNsYUNvbG9yXVxyXG5cclxuICAgICAgZGVzdFZpZXdbZGVzdEluZGV4XSA9IHJnYmFDb2xvclxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGRlc3RcclxufVxyXG5cclxuY29uc3QgZmxvb2RGaWxsID0gKGRlc3Q6IEhzbGExNiwgY29sb3I6IG51bWJlciwgeDogbnVtYmVyLCB5OiBudW1iZXIpID0+IHtcclxuICBjb25zdCBwdHM6IFQzW10gPSBbXVxyXG4gIGNvbnN0IHNlZW4gPSBuZXcgU2V0PG51bWJlcj4oKVxyXG5cclxuICBpZiAoeCA8IDAgfHwgeCA+PSBkZXN0LndpZHRoIHx8IHkgPCAwIHx8IHkgPj0gZGVzdC5oZWlnaHQpIHJldHVybiBwdHNcclxuXHJcbiAgY29uc3QgaW5kZXggPSB5ICogZGVzdC53aWR0aCArIHhcclxuXHJcbiAgY29uc3Qgb2xkQ29sb3IgPSBkZXN0LmRhdGFbaW5kZXhdXHJcblxyXG4gIGlmIChvbGRDb2xvciA9PT0gY29sb3IpIHJldHVybiBwdHNcclxuXHJcbiAgY29uc3QgcXVldWU6IFQyW10gPSBbXVxyXG5cclxuICBxdWV1ZS5wdXNoKFt4LCB5XSlcclxuXHJcbiAgd2hpbGUgKHF1ZXVlLmxlbmd0aCA+IDApIHtcclxuICAgIGNvbnN0IFtjeCwgY3ldID0gcXVldWUuc2hpZnQoKSFcclxuXHJcbiAgICBpZiAoY3ggPCAwIHx8IGN4ID49IGRlc3Qud2lkdGggfHwgY3kgPCAwIHx8IGN5ID49IGRlc3QuaGVpZ2h0KSBjb250aW51ZVxyXG5cclxuICAgIGNvbnN0IGluZGV4ID0gY3kgKiBkZXN0LndpZHRoICsgY3hcclxuXHJcbiAgICBpZiAoc2Vlbi5oYXMoaW5kZXgpKSBjb250aW51ZVxyXG4gICAgaWYgKGRlc3QuZGF0YVtpbmRleF0gIT09IG9sZENvbG9yKSBjb250aW51ZVxyXG5cclxuICAgIHB0cy5wdXNoKFtjeCwgY3ksIGNvbG9yXSlcclxuICAgIHNlZW4uYWRkKGluZGV4KVxyXG5cclxuICAgIHF1ZXVlLnB1c2goW2N4LCBjeSAtIDFdKVxyXG4gICAgcXVldWUucHVzaChbY3ggKyAxLCBjeV0pXHJcbiAgICBxdWV1ZS5wdXNoKFtjeCwgY3kgKyAxXSlcclxuICAgIHF1ZXVlLnB1c2goW2N4IC0gMSwgY3ldKVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHB0c1xyXG59Il19
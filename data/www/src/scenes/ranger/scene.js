import { blit } from '../../lib/image/blit.js';
import { composite } from '../../lib/image/composite.js';
import { assrt, maybe } from '../../lib/util.js';
import { drawFps } from './fps.js';
import { rangerInit } from './init.js';
import { rangerIo } from './io.js';
import { empty, tileCx, tileCy, tileH, tileW } from './tile-data.js';
import { setIndices, viewState } from './view-state.js';
export const rangerScene = () => {
    let isActive = true;
    let deps;
    let fstate;
    let vstate;
    let invalidate;
    let lastW = 0;
    let lastH = 0;
    const init = async (state) => {
        const r = await rangerInit(state);
        deps = r.deps;
        fstate = r.fstate;
        const v = viewState(lastW, lastH, tileW, tileH);
        vstate = v.state;
        invalidate = v.invalidate;
    };
    const update = (state) => {
        if (!maybe(deps))
            throw Error('Expected deps');
        if (!maybe(fstate))
            throw Error('Expected fstate');
        if (!maybe(vstate))
            throw Error('Expected vstate');
        if (!maybe(invalidate))
            throw Error('Expected invalidate');
        if (isActive)
            rangerIo(state, deps, fstate);
        const buffer = state.view.getBuffer();
        const elapsed = state.time.getElapsed();
        const [, , emptyId] = empty;
        const emptyRect = deps.tiles.rects[emptyId];
        const { width, height } = buffer;
        if (fstate.lastW !== width || fstate.lastH !== height) {
            invalidate(width, height);
            fstate.lastW = width;
            fstate.lastH = height;
        }
        const tileCol = fstate.cameraX + vstate.colLeft;
        const tileRow = fstate.cameraY + vstate.rowTop;
        setIndices(deps.tileMap, vstate.currIndices, tileCol, tileRow, vstate.cols, vstate.rows, elapsed, emptyId);
        for (let r = 0; r < vstate.rows; r++) {
            const dy = r * tileH + vstate.vTop;
            for (let c = 0; c < vstate.cols; c++) {
                const tileIndex = r * vstate.cols + c;
                const prev = vstate.prevIndices[tileIndex];
                const current = vstate.currIndices[tileIndex];
                if (prev === current) {
                    continue;
                }
                const dx = c * tileW + vstate.vLeft;
                const rect = deps.tiles.rects[current];
                blit(deps.tiles.image, buffer, [...rect, dx, dy]);
            }
        }
        //
        const cvx = Math.floor(width / 2) - tileCx;
        const cvy = Math.floor(height / 2) - tileCy;
        // always redraw the center tile 
        if (fstate.cameraY >= 0 && fstate.cameraY < deps.tileMap.height &&
            fstate.cameraX >= 0 && fstate.cameraX < deps.tileMap.width) {
            const tileIndex = fstate.cameraY * deps.tileMap.width + fstate.cameraX;
            const tile = deps.tileMap.data[tileIndex];
            const rectIndex = assrt(typeof tile === 'number' ?
                tile :
                tile(elapsed), 'Expected rectIndex');
            const rect = deps.tiles.rects[rectIndex];
            blit(deps.tiles.image, buffer, [...rect, cvx, cvy]);
        }
        else {
            blit(deps.tiles.image, buffer, [...emptyRect, cvx, cvy]);
        }
        const playerRectIndex = assrt(fstate.facing === 'left' ?
            deps.playerAnimLeft(elapsed) :
            deps.playerAnimRight(elapsed), 'Expected player rect');
        const playerRect = deps.sprites.rects[playerRectIndex];
        // always redraw the player
        composite(deps.sprites.image, buffer, [...playerRect, cvx, cvy]);
        // show fps
        drawFps(state, deps.font, width, buffer, deps.fontPts);
        //
        vstate.prevIndices = vstate.currIndices.slice();
    };
    const quit = async (_state) => {
        deps = null;
        fstate = null;
        vstate = null;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvc2NlbmVzL3Jhbmdlci9zY2VuZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0seUJBQXlCLENBQUE7QUFDOUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBRXhELE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sbUJBQW1CLENBQUE7QUFDaEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUNsQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBQ3RDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFDbEMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUVwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLGlCQUFpQixDQUFBO0FBRXZELE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxHQUFVLEVBQUU7SUFDckMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFBO0lBQ25CLElBQUksSUFBdUIsQ0FBQTtJQUMzQixJQUFJLE1BQTBCLENBQUE7SUFDOUIsSUFBSSxNQUF3QixDQUFBO0lBQzVCLElBQUksVUFBaUQsQ0FBQTtJQUVyRCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7SUFDYixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7SUFFYixNQUFNLElBQUksR0FBRyxLQUFLLEVBQUUsS0FBWSxFQUFFLEVBQUU7UUFDbEMsTUFBTSxDQUFDLEdBQUcsTUFBTSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUE7UUFFakMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUE7UUFDYixNQUFNLEdBQUcsQ0FBQyxDQUFD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QUFJLENBQUE7UUFDWCxNQUFNLEdBQUcsSUFBSSxDQUFBO1FBQ2IsTUFBTSxHQUFHLElBQUksQ0FBQTtJQUNmLENBQUMsQ0FBQTtJQUVELE1BQU0sU0FBUyxHQUFHLENBQUMsTUFBZSxFQUFFLEVBQUU7UUFDcEMsUUFBUSxHQUFHLE1BQU0sQ0FBQTtJQUNuQixDQUFDLENBQUE7SUFFRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUE7QUFDMUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYmxpdCB9IGZyb20gJy4uLy4uL2xpYi9pbWFnZS9ibGl0LmpzJ1xyXG5pbXBvcnQgeyBjb21wb3NpdGUgfSBmcm9tICcuLi8uLi9saWIvaW1hZ2UvY29tcG9zaXRlLmpzJ1xyXG5pbXBvcnQgeyBNYXliZSwgU2NlbmUsIFN0YXRlIH0gZnJvbSAnLi4vLi4vbGliL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyBhc3NydCwgbWF5YmUgfSBmcm9tICcuLi8uLi9saWIvdXRpbC5qcydcclxuaW1wb3J0IHsgZHJhd0ZwcyB9IGZyb20gJy4vZnBzLmpzJ1xyXG5pbXBvcnQgeyByYW5nZXJJbml0IH0gZnJvbSAnLi9pbml0LmpzJ1xyXG5pbXBvcnQgeyByYW5nZXJJbyB9IGZyb20gJy4vaW8uanMnXHJcbmltcG9ydCB7IGVtcHR5LCB0aWxlQ3gsIHRpbGVDeSwgdGlsZUgsIHRpbGVXIH0gZnJvbSAnLi90aWxlLWRhdGEuanMnXHJcbmltcG9ydCB7IFJhbmdlckRlcHMsIFJhbmdlclN0YXRlLCBWaWV3U3RhdGUgfSBmcm9tICcuL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyBzZXRJbmRpY2VzLCB2aWV3U3RhdGUgfSBmcm9tICcuL3ZpZXctc3RhdGUuanMnXHJcblxyXG5leHBvcnQgY29uc3QgcmFuZ2VyU2NlbmUgPSAoKTogU2NlbmUgPT4ge1xyXG4gIGxldCBpc0FjdGl2ZSA9IHRydWVcclxuICBsZXQgZGVwczogTWF5YmU8UmFuZ2VyRGVwcz5cclxuICBsZXQgZnN0YXRlOiBNYXliZTxSYW5nZXJTdGF0ZT5cclxuICBsZXQgdnN0YXRlOiBNYXliZTxWaWV3U3RhdGU+XHJcbiAgbGV0IGludmFsaWRhdGU6IE1heWJlPCh3OiBudW1iZXIsIGg6IG51bWJlcikgPT4gdm9pZD5cclxuXHJcbiAgbGV0IGxhc3RXID0gMFxyXG4gIGxldCBsYXN0SCA9IDBcclxuXHJcbiAgY29uc3QgaW5pdCA9IGFzeW5jIChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnN0IHIgPSBhd2FpdCByYW5nZXJJbml0KHN0YXRlKVxyXG5cclxuICAgIGRlcHMgPSByLmRlcHNcclxuICAgIGZzdGF0ZSA9IHIuZnN0YXRlXHJcblxyXG4gICAgY29uc3QgdiA9IHZpZXdTdGF0ZShsYXN0VywgbGFzdEgsIHRpbGVXLCB0aWxlSClcclxuXHJcbiAgICB2c3RhdGUgPSB2LnN0YXRlXHJcbiAgICBpbnZhbGlkYXRlID0gdi5pbnZhbGlkYXRlXHJcbiAgfVxyXG5cclxuICBjb25zdCB1cGRhdGUgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpZiAoIW1heWJlKGRlcHMpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgZGVwcycpXHJcbiAgICBpZiAoIW1heWJlKGZzdGF0ZSkpIHRocm93IEVycm9yKCdFeHBlY3RlZCBmc3RhdGUnKVxyXG4gICAgaWYgKCFtYXliZSh2c3RhdGUpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgdnN0YXRlJylcclxuICAgIGlmICghbWF5YmUoaW52YWxpZGF0ZSkpIHRocm93IEVycm9yKCdFeHBlY3RlZCBpbnZhbGlkYXRlJylcclxuXHJcbiAgICBpZiAoaXNBY3RpdmUpIHJhbmdlcklvKHN0YXRlLCBkZXBzLCBmc3RhdGUpXHJcblxyXG4gICAgY29uc3QgYnVmZmVyID0gc3RhdGUudmlldy5nZXRCdWZmZXIoKVxyXG4gICAgY29uc3QgZWxhcHNlZCA9IHN0YXRlLnRpbWUuZ2V0RWxhcHNlZCgpXHJcblxyXG4gICAgY29uc3QgWywgLCBlbXB0eUlkXSA9IGVtcHR5XHJcblxyXG4gICAgY29uc3QgZW1wdHlSZWN0ID0gZGVwcy50aWxlcy5yZWN0c1tlbXB0eUlkXVxyXG5cclxuICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gYnVmZmVyXHJcblxyXG4gICAgaWYgKGZzdGF0ZS5sYXN0VyAhPT0gd2lkdGggfHwgZnN0YXRlLmxhc3RIICE9PSBoZWlnaHQpIHtcclxuICAgICAgaW52YWxpZGF0ZSh3aWR0aCwgaGVpZ2h0KVxyXG4gICAgICBmc3RhdGUubGFzdFcgPSB3aWR0aFxyXG4gICAgICBmc3RhdGUubGFzdEggPSBoZWlnaHRcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB0aWxlQ29sID0gZnN0YXRlLmNhbWVyYVggKyB2c3RhdGUuY29sTGVmdFxyXG4gICAgY29uc3QgdGlsZVJvdyA9IGZzdGF0ZS5jYW1lcmFZICsgdnN0YXRlLnJvd1RvcFxyXG5cclxuICAgIHNldEluZGljZXMoXHJcbiAgICAgIGRlcHMudGlsZU1hcCwgdnN0YXRlLmN1cnJJbmRpY2VzLFxyXG4gICAgICB0aWxlQ29sLCB0aWxlUm93LCB2c3RhdGUuY29scywgdnN0YXRlLnJvd3MsXHJcbiAgICAgIGVsYXBzZWQsIGVtcHR5SWRcclxuICAgIClcclxuXHJcbiAgICBmb3IgKGxldCByID0gMDsgciA8IHZzdGF0ZS5yb3dzOyByKyspIHtcclxuICAgICAgY29uc3QgZHkgPSByICogdGlsZUggKyB2c3RhdGUudlRvcFxyXG5cclxuICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCB2c3RhdGUuY29sczsgYysrKSB7XHJcbiAgICAgICAgY29uc3QgdGlsZUluZGV4ID0gciAqIHZzdGF0ZS5jb2xzICsgY1xyXG5cclxuICAgICAgICBjb25zdCBwcmV2ID0gdnN0YXRlLnByZXZJbmRpY2VzW3RpbGVJbmRleF1cclxuICAgICAgICBjb25zdCBjdXJyZW50ID0gdnN0YXRlLmN1cnJJbmRpY2VzW3RpbGVJbmRleF0hXHJcblxyXG4gICAgICAgIGlmIChwcmV2ID09PSBjdXJyZW50KSB7XHJcbiAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZHggPSBjICogdGlsZVcgKyB2c3RhdGUudkxlZnRcclxuICAgICAgICBjb25zdCByZWN0ID0gZGVwcy50aWxlcy5yZWN0c1tjdXJyZW50XVxyXG5cclxuICAgICAgICBibGl0KGRlcHMudGlsZXMuaW1hZ2UsIGJ1ZmZlciwgWy4uLnJlY3QsIGR4LCBkeV0pXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvL1xyXG5cclxuICAgIGNvbnN0IGN2eCA9IE1hdGguZmxvb3Iod2lkdGggLyAyKSAtIHRpbGVDeFxyXG4gICAgY29uc3QgY3Z5ID0gTWF0aC5mbG9vcihoZWlnaHQgLyAyKSAtIHRpbGVDeVxyXG5cclxuICAgIC8vIGFsd2F5cyByZWRyYXcgdGhlIGNlbnRlciB0aWxlIFxyXG4gICAgaWYgKFxyXG4gICAgICBmc3RhdGUuY2FtZXJhWSA+PSAwICYmIGZzdGF0ZS5jYW1lcmFZIDwgZGVwcy50aWxlTWFwLmhlaWdodCAmJlxyXG4gICAgICBmc3RhdGUuY2FtZXJhWCA+PSAwICYmIGZzdGF0ZS5jYW1lcmFYIDwgZGVwcy50aWxlTWFwLndpZHRoXHJcbiAgICApIHtcclxuICAgICAgY29uc3QgdGlsZUluZGV4ID0gZnN0YXRlLmNhbWVyYVkgKiBkZXBzLnRpbGVNYXAud2lkdGggKyBmc3RhdGUuY2FtZXJhWFxyXG4gICAgICBjb25zdCB0aWxlID0gZGVwcy50aWxlTWFwLmRhdGFbdGlsZUluZGV4XVxyXG4gICAgICBjb25zdCByZWN0SW5kZXggPSBhc3NydChcclxuICAgICAgICB0eXBlb2YgdGlsZSA9PT0gJ251bWJlcicgP1xyXG4gICAgICAgICAgdGlsZSA6XHJcbiAgICAgICAgICB0aWxlKGVsYXBzZWQpLFxyXG4gICAgICAgICdFeHBlY3RlZCByZWN0SW5kZXgnXHJcbiAgICAgIClcclxuXHJcbiAgICAgIGNvbnN0IHJlY3QgPSBkZXBzLnRpbGVzLnJlY3RzW3JlY3RJbmRleF1cclxuXHJcbiAgICAgIGJsaXQoZGVwcy50aWxlcy5pbWFnZSwgYnVmZmVyLCBbLi4ucmVjdCwgY3Z4LCBjdnldKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgYmxpdChkZXBzLnRpbGVzLmltYWdlLCBidWZmZXIsIFsuLi5lbXB0eVJlY3QsIGN2eCwgY3Z5XSlcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwbGF5ZXJSZWN0SW5kZXggPSBhc3NydChcclxuICAgICAgZnN0YXRlLmZhY2luZyA9PT0gJ2xlZnQnID9cclxuICAgICAgICBkZXBzLnBsYXllckFuaW1MZWZ0KGVsYXBzZWQpIDpcclxuICAgICAgICBkZXBzLnBsYXllckFuaW1SaWdodChlbGFwc2VkKSxcclxuICAgICAgJ0V4cGVjdGVkIHBsYXllciByZWN0J1xyXG4gICAgKVxyXG5cclxuICAgIGNvbnN0IHBsYXllclJlY3QgPSBkZXBzLnNwcml0ZXMucmVjdHNbcGxheWVyUmVjdEluZGV4XVxyXG5cclxuICAgIC8vIGFsd2F5cyByZWRyYXcgdGhlIHBsYXllclxyXG4gICAgY29tcG9zaXRlKGRlcHMuc3ByaXRlcy5pbWFnZSwgYnVmZmVyLCBbLi4ucGxheWVyUmVjdCwgY3Z4LCBjdnldKVxyXG5cclxuICAgIC8vIHNob3cgZnBzXHJcbiAgICBkcmF3RnBzKHN0YXRlLCBkZXBzLmZvbnQsIHdpZHRoLCBidWZmZXIsIGRlcHMuZm9udFB0cylcclxuXHJcbiAgICAvL1xyXG5cclxuICAgIHZzdGF0ZS5wcmV2SW5kaWNlcyA9IHZzdGF0ZS5jdXJySW5kaWNlcy5zbGljZSgpXHJcbiAgfVxyXG5cclxuICBjb25zdCBxdWl0ID0gYXN5bmMgKF9zdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGRlcHMgPSBudWxsXHJcbiAgICBmc3RhdGUgPSBudWxsXHJcbiAgICB2c3RhdGUgPSBudWxsXHJcbiAgfVxyXG5cclxuICBjb25zdCBzZXRBY3RpdmUgPSAoYWN0aXZlOiBib29sZWFuKSA9PiB7XHJcbiAgICBpc0FjdGl2ZSA9IGFjdGl2ZVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgaW5pdCwgdXBkYXRlLCBxdWl0LCBzZXRBY3RpdmUgfVxyXG59XHJcbiJdfQ==
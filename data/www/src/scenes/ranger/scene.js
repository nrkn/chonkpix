import { blit } from '../../lib/image/blit.js';
import { composite } from '../../lib/image/composite.js';
import { assrt, maybe } from '../../lib/util.js';
import { drawFps } from './fps.js';
import { rangerInit } from './init.js';
import { rangerIo } from './io.js';
import { empty, tileCx, tileCy, tileH, tileW } from './tile-data.js';
import { setIndices, viewState } from './view-state.js';
export const rangerScene = () => {
    let isActive = true;
    let deps;
    let fstate;
    let vstate;
    let invalidate;
    let lastW = 0;
    let lastH = 0;
    const init = async (state) => {
        const r = await rangerInit(state);
        deps = r.deps;
        fstate = r.fstate;
        const v = viewState(lastW, lastH, tileW, tileH);
        vstate = v.state;
        invalidate = v.invalidate;
    };
    const update = (state) => {
        if (!maybe(deps))
            throw Error('Expected deps');
        if (!maybe(fstate))
            throw Error('Expected fstate');
        if (!maybe(vstate))
            throw Error('Expected vstate');
        if (!maybe(invalidate))
            throw Error('Expected invalidate');
        if (isActive)
            rangerIo(state, deps, fstate);
        const buffer = state.view.getBuffer();
        const elapsed = state.time.getElapsed();
        const [, , emptyId] = empty;
        const emptyRect = deps.tiles.rects[emptyId];
        const { width, height } = buffer;
        if (fstate.lastW !== width || fstate.lastH !== height) {
            invalidate(width, height);
            fstate.lastW = width;
            fstate.lastH = height;
        }
        const tileCol = fstate.cameraX + vstate.colLeft;
        const tileRow = fstate.cameraY + vstate.rowTop;
        setIndices(deps.tileMap, vstate.currIndices, tileCol, tileRow, vstate.cols, vstate.rows, elapsed, emptyId);
        for (let r = 0; r < vstate.rows; r++) {
            const dy = r * tileH + vstate.vTop;
            for (let c = 0; c < vstate.cols; c++) {
                const tileIndex = r * vstate.cols + c;
                const prev = vstate.prevIndices[tileIndex];
                const current = vstate.currIndices[tileIndex];
                if (prev === current) {
                    continue;
                }
                const dx = c * tileW + vstate.vLeft;
                const rect = deps.tiles.rects[current];
                blit(deps.tiles.image, buffer, [...rect, dx, dy]);
            }
        }
        //
        const cvx = Math.floor(width / 2) - tileCx;
        const cvy = Math.floor(height / 2) - tileCy;
        // always redraw the center tile 
        if (fstate.cameraY >= 0 && fstate.cameraY < deps.tileMap.height &&
            fstate.cameraX >= 0 && fstate.cameraX < deps.tileMap.width) {
            const tileIndex = fstate.cameraY * deps.tileMap.width + fstate.cameraX;
            const tile = deps.tileMap.data[tileIndex];
            const rectIndex = assrt(typeof tile === 'number' ?
                tile :
                tile(elapsed), 'Expected rectIndex');
            const rect = deps.tiles.rects[rectIndex];
            blit(deps.tiles.image, buffer, [...rect, cvx, cvy]);
        }
        else {
            blit(deps.tiles.image, buffer, [...emptyRect, cvx, cvy]);
        }
        const playerRectIndex = assrt(fstate.facing === 'left' ?
            deps.playerAnimLeft(elapsed) :
            deps.playerAnimRight(elapsed), 'Expected player rect');
        const playerRect = deps.sprites.rects[playerRectIndex];
        // always redraw the player
        composite(deps.sprites.image, buffer, [...playerRect, cvx, cvy]);
        // show fps
        drawFps(state, deps.font, width, buffer, deps.fontPts);
        //
        vstate.prevIndices = vstate.currIndices.slice();
    };
    const quit = async (_state) => {
        deps = null;
        fstate = null;
        vstate = null;
    };
    return { init, update, quit };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvc2NlbmVzL3Jhbmdlci9zY2VuZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0seUJBQXlCLENBQUE7QUFDOUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBRXhELE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sbUJBQW1CLENBQUE7QUFDaEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUNsQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBQ3RDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFDbEMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUVwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLGlCQUFpQixDQUFBO0FBRXZELE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxHQUFVLEVBQUU7SUFDckMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFBO0lBQ25CLElBQUksSUFBdUIsQ0FBQTtJQUMzQixJQUFJLE1BQTBCLENBQUE7SUFDOUIsSUFBSSxNQUF3QixDQUFBO0lBQzVCLElBQUksVUFBaUQsQ0FBQTtJQUVyRCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7SUFDYixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7SUFFYixNQUFNLElBQUksR0FBRyxLQUFLLEVBQUUsS0FBWSxFQUFFLEVBQUU7UUFDbEMsTUFBTSxDQUFDLEdBQUcsTUFBTSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUE7UUFFakMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUE7UUFDYixNQUFNLEdBQUcsQ0FBQyxDQUFD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QUFJLENBQUE7UUFDWCxNQUFNLEdBQUcsSUFBSSxDQUFBO1FBQ2IsTUFBTSxHQUFHLElBQUksQ0FBQTtJQUNmLENBQUMsQ0FBQTtJQUVELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFBO0FBQy9CLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGJsaXQgfSBmcm9tICcuLi8uLi9saWIvaW1hZ2UvYmxpdC5qcydcclxuaW1wb3J0IHsgY29tcG9zaXRlIH0gZnJvbSAnLi4vLi4vbGliL2ltYWdlL2NvbXBvc2l0ZS5qcydcclxuaW1wb3J0IHsgTWF5YmUsIFNjZW5lLCBTdGF0ZSB9IGZyb20gJy4uLy4uL2xpYi90eXBlcy5qcydcclxuaW1wb3J0IHsgYXNzcnQsIG1heWJlIH0gZnJvbSAnLi4vLi4vbGliL3V0aWwuanMnXHJcbmltcG9ydCB7IGRyYXdGcHMgfSBmcm9tICcuL2Zwcy5qcydcclxuaW1wb3J0IHsgcmFuZ2VySW5pdCB9IGZyb20gJy4vaW5pdC5qcydcclxuaW1wb3J0IHsgcmFuZ2VySW8gfSBmcm9tICcuL2lvLmpzJ1xyXG5pbXBvcnQgeyBlbXB0eSwgdGlsZUN4LCB0aWxlQ3ksIHRpbGVILCB0aWxlVyB9IGZyb20gJy4vdGlsZS1kYXRhLmpzJ1xyXG5pbXBvcnQgeyBSYW5nZXJEZXBzLCBSYW5nZXJTdGF0ZSwgVmlld1N0YXRlIH0gZnJvbSAnLi90eXBlcy5qcydcclxuaW1wb3J0IHsgc2V0SW5kaWNlcywgdmlld1N0YXRlIH0gZnJvbSAnLi92aWV3LXN0YXRlLmpzJ1xyXG5cclxuZXhwb3J0IGNvbnN0IHJhbmdlclNjZW5lID0gKCk6IFNjZW5lID0+IHtcclxuICBsZXQgaXNBY3RpdmUgPSB0cnVlXHJcbiAgbGV0IGRlcHM6IE1heWJlPFJhbmdlckRlcHM+XHJcbiAgbGV0IGZzdGF0ZTogTWF5YmU8UmFuZ2VyU3RhdGU+XHJcbiAgbGV0IHZzdGF0ZTogTWF5YmU8Vmlld1N0YXRlPlxyXG4gIGxldCBpbnZhbGlkYXRlOiBNYXliZTwodzogbnVtYmVyLCBoOiBudW1iZXIpID0+IHZvaWQ+XHJcblxyXG4gIGxldCBsYXN0VyA9IDBcclxuICBsZXQgbGFzdEggPSAwXHJcblxyXG4gIGNvbnN0IGluaXQgPSBhc3luYyAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBjb25zdCByID0gYXdhaXQgcmFuZ2VySW5pdChzdGF0ZSlcclxuXHJcbiAgICBkZXBzID0gci5kZXBzXHJcbiAgICBmc3RhdGUgPSByLmZzdGF0ZVxyXG5cclxuICAgIGNvbnN0IHYgPSB2aWV3U3RhdGUobGFzdFcsIGxhc3RILCB0aWxlVywgdGlsZUgpXHJcblxyXG4gICAgdnN0YXRlID0gdi5zdGF0ZVxyXG4gICAgaW52YWxpZGF0ZSA9IHYuaW52YWxpZGF0ZVxyXG4gIH1cclxuXHJcbiAgY29uc3QgdXBkYXRlID0gKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgaWYgKCFtYXliZShkZXBzKSkgdGhyb3cgRXJyb3IoJ0V4cGVjdGVkIGRlcHMnKVxyXG4gICAgaWYgKCFtYXliZShmc3RhdGUpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgZnN0YXRlJylcclxuICAgIGlmICghbWF5YmUodnN0YXRlKSkgdGhyb3cgRXJyb3IoJ0V4cGVjdGVkIHZzdGF0ZScpXHJcbiAgICBpZiAoIW1heWJlKGludmFsaWRhdGUpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgaW52YWxpZGF0ZScpXHJcblxyXG4gICAgaWYgKGlzQWN0aXZlKSByYW5nZXJJbyhzdGF0ZSwgZGVwcywgZnN0YXRlKVxyXG5cclxuICAgIGNvbnN0IGJ1ZmZlciA9IHN0YXRlLnZpZXcuZ2V0QnVmZmVyKClcclxuICAgIGNvbnN0IGVsYXBzZWQgPSBzdGF0ZS50aW1lLmdldEVsYXBzZWQoKVxyXG5cclxuICAgIGNvbnN0IFssICwgZW1wdHlJZF0gPSBlbXB0eVxyXG5cclxuICAgIGNvbnN0IGVtcHR5UmVjdCA9IGRlcHMudGlsZXMucmVjdHNbZW1wdHlJZF1cclxuXHJcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IGJ1ZmZlclxyXG5cclxuICAgIGlmIChmc3RhdGUubGFzdFcgIT09IHdpZHRoIHx8IGZzdGF0ZS5sYXN0SCAhPT0gaGVpZ2h0KSB7XHJcbiAgICAgIGludmFsaWRhdGUod2lkdGgsIGhlaWdodClcclxuICAgICAgZnN0YXRlLmxhc3RXID0gd2lkdGhcclxuICAgICAgZnN0YXRlLmxhc3RIID0gaGVpZ2h0XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdGlsZUNvbCA9IGZzdGF0ZS5jYW1lcmFYICsgdnN0YXRlLmNvbExlZnRcclxuICAgIGNvbnN0IHRpbGVSb3cgPSBmc3RhdGUuY2FtZXJhWSArIHZzdGF0ZS5yb3dUb3BcclxuXHJcbiAgICBzZXRJbmRpY2VzKFxyXG4gICAgICBkZXBzLnRpbGVNYXAsIHZzdGF0ZS5jdXJySW5kaWNlcyxcclxuICAgICAgdGlsZUNvbCwgdGlsZVJvdywgdnN0YXRlLmNvbHMsIHZzdGF0ZS5yb3dzLFxyXG4gICAgICBlbGFwc2VkLCBlbXB0eUlkXHJcbiAgICApXHJcblxyXG4gICAgZm9yIChsZXQgciA9IDA7IHIgPCB2c3RhdGUucm93czsgcisrKSB7XHJcbiAgICAgIGNvbnN0IGR5ID0gciAqIHRpbGVIICsgdnN0YXRlLnZUb3BcclxuXHJcbiAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgdnN0YXRlLmNvbHM7IGMrKykge1xyXG4gICAgICAgIGNvbnN0IHRpbGVJbmRleCA9IHIgKiB2c3RhdGUuY29scyArIGNcclxuXHJcbiAgICAgICAgY29uc3QgcHJldiA9IHZzdGF0ZS5wcmV2SW5kaWNlc1t0aWxlSW5kZXhdXHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHZzdGF0ZS5jdXJySW5kaWNlc1t0aWxlSW5kZXhdIVxyXG5cclxuICAgICAgICBpZiAocHJldiA9PT0gY3VycmVudCkge1xyXG4gICAgICAgICAgY29udGludWVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGR4ID0gYyAqIHRpbGVXICsgdnN0YXRlLnZMZWZ0XHJcbiAgICAgICAgY29uc3QgcmVjdCA9IGRlcHMudGlsZXMucmVjdHNbY3VycmVudF1cclxuXHJcbiAgICAgICAgYmxpdChkZXBzLnRpbGVzLmltYWdlLCBidWZmZXIsIFsuLi5yZWN0LCBkeCwgZHldKVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy9cclxuXHJcbiAgICBjb25zdCBjdnggPSBNYXRoLmZsb29yKHdpZHRoIC8gMikgLSB0aWxlQ3hcclxuICAgIGNvbnN0IGN2eSA9IE1hdGguZmxvb3IoaGVpZ2h0IC8gMikgLSB0aWxlQ3lcclxuXHJcbiAgICAvLyBhbHdheXMgcmVkcmF3IHRoZSBjZW50ZXIgdGlsZSBcclxuICAgIGlmIChcclxuICAgICAgZnN0YXRlLmNhbWVyYVkgPj0gMCAmJiBmc3RhdGUuY2FtZXJhWSA8IGRlcHMudGlsZU1hcC5oZWlnaHQgJiZcclxuICAgICAgZnN0YXRlLmNhbWVyYVggPj0gMCAmJiBmc3RhdGUuY2FtZXJhWCA8IGRlcHMudGlsZU1hcC53aWR0aFxyXG4gICAgKSB7XHJcbiAgICAgIGNvbnN0IHRpbGVJbmRleCA9IGZzdGF0ZS5jYW1lcmFZICogZGVwcy50aWxlTWFwLndpZHRoICsgZnN0YXRlLmNhbWVyYVhcclxuICAgICAgY29uc3QgdGlsZSA9IGRlcHMudGlsZU1hcC5kYXRhW3RpbGVJbmRleF1cclxuICAgICAgY29uc3QgcmVjdEluZGV4ID0gYXNzcnQoXHJcbiAgICAgICAgdHlwZW9mIHRpbGUgPT09ICdudW1iZXInID9cclxuICAgICAgICAgIHRpbGUgOlxyXG4gICAgICAgICAgdGlsZShlbGFwc2VkKSxcclxuICAgICAgICAnRXhwZWN0ZWQgcmVjdEluZGV4J1xyXG4gICAgICApXHJcblxyXG4gICAgICBjb25zdCByZWN0ID0gZGVwcy50aWxlcy5yZWN0c1tyZWN0SW5kZXhdXHJcblxyXG4gICAgICBibGl0KGRlcHMudGlsZXMuaW1hZ2UsIGJ1ZmZlciwgWy4uLnJlY3QsIGN2eCwgY3Z5XSlcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGJsaXQoZGVwcy50aWxlcy5pbWFnZSwgYnVmZmVyLCBbLi4uZW1wdHlSZWN0LCBjdngsIGN2eV0pXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcGxheWVyUmVjdEluZGV4ID0gYXNzcnQoXHJcbiAgICAgIGZzdGF0ZS5mYWNpbmcgPT09ICdsZWZ0JyA/XHJcbiAgICAgICAgZGVwcy5wbGF5ZXJBbmltTGVmdChlbGFwc2VkKSA6XHJcbiAgICAgICAgZGVwcy5wbGF5ZXJBbmltUmlnaHQoZWxhcHNlZCksXHJcbiAgICAgICdFeHBlY3RlZCBwbGF5ZXIgcmVjdCdcclxuICAgIClcclxuXHJcbiAgICBjb25zdCBwbGF5ZXJSZWN0ID0gZGVwcy5zcHJpdGVzLnJlY3RzW3BsYXllclJlY3RJbmRleF1cclxuXHJcbiAgICAvLyBhbHdheXMgcmVkcmF3IHRoZSBwbGF5ZXJcclxuICAgIGNvbXBvc2l0ZShkZXBzLnNwcml0ZXMuaW1hZ2UsIGJ1ZmZlciwgWy4uLnBsYXllclJlY3QsIGN2eCwgY3Z5XSlcclxuXHJcbiAgICAvLyBzaG93IGZwc1xyXG4gICAgZHJhd0ZwcyhzdGF0ZSwgZGVwcy5mb250LCB3aWR0aCwgYnVmZmVyLCBkZXBzLmZvbnRQdHMpXHJcblxyXG4gICAgLy9cclxuXHJcbiAgICB2c3RhdGUucHJldkluZGljZXMgPSB2c3RhdGUuY3VyckluZGljZXMuc2xpY2UoKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgcXVpdCA9IGFzeW5jIChfc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBkZXBzID0gbnVsbFxyXG4gICAgZnN0YXRlID0gbnVsbFxyXG4gICAgdnN0YXRlID0gbnVsbFxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgaW5pdCwgdXBkYXRlLCBxdWl0IH1cclxufVxyXG4iXX0=
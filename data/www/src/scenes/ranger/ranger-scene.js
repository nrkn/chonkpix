import { blit } from '../../lib/image/blit.js';
import { composite } from '../../lib/image/composite.js';
import { assrt, maybe } from '../../lib/util.js';
import { drawFps } from './fps.js';
import { rangerInit } from './init.js';
import { rangerIo } from './io.js';
import { empty, tileCx, tileCy, tileH, tileW } from './tile-data.js';
import { setIndices, viewState } from './view-state.js';
export const rangerScene = () => {
    let isActive = true;
    let deps;
    let fstate;
    let vstate;
    let invalidate;
    let lastW = 0;
    let lastH = 0;
    const init = async (state) => {
        const r = await rangerInit(state);
        deps = r.deps;
        fstate = r.fstate;
        const v = viewState(lastW, lastH, tileW, tileH);
        vstate = v.state;
        invalidate = v.invalidate;
    };
    const update = (state) => {
        if (!maybe(deps))
            throw Error('Expected deps');
        if (!maybe(fstate))
            throw Error('Expected fstate');
        if (!maybe(vstate))
            throw Error('Expected vstate');
        if (!maybe(invalidate))
            throw Error('Expected invalidate');
        if (isActive)
            rangerIo(state, deps, fstate);
        const buffer = state.view.getBuffer();
        const elapsed = state.time.getElapsed();
        const [, , emptyId] = empty;
        const emptyRect = deps.tiles.rects[emptyId];
        const { width, height } = buffer;
        if (lastW !== width || lastH !== height) {
            invalidate(width, height);
            lastW = width;
            lastH = height;
        }
        const tileCol = fstate.cameraX + vstate.colLeft;
        const tileRow = fstate.cameraY + vstate.rowTop;
        setIndices(deps.tileMap, vstate.currIndices, vstate.animated, tileCol, tileRow, vstate.cols, vstate.rows, elapsed, emptyId);
        for (let r = 0; r < vstate.rows; r++) {
            const dy = r * tileH + vstate.vTop;
            for (let c = 0; c < vstate.cols; c++) {
                const tileIndex = r * vstate.cols + c;
                const prev = vstate.prevIndices[tileIndex];
                const current = vstate.currIndices[tileIndex];
                if (prev === current) {
                    continue;
                }
                const dx = c * tileW + vstate.vLeft;
                const rect = deps.tiles.rects[current];
                blit(deps.tiles.image, buffer, [...rect, dx, dy]);
            }
        }
        //
        const cvx = Math.floor(width / 2) - tileCx;
        const cvy = Math.floor(height / 2) - tileCy;
        // always redraw the center tile 
        if (fstate.cameraY >= 0 && fstate.cameraY < deps.tileMap.height &&
            fstate.cameraX >= 0 && fstate.cameraX < deps.tileMap.width) {
            const tileIndex = fstate.cameraY * deps.tileMap.width + fstate.cameraX;
            const tile = deps.tileMap.data[tileIndex];
            const rectIndex = assrt(typeof tile === 'number' ?
                tile :
                tile(elapsed), 'Expected rectIndex');
            const rect = deps.tiles.rects[rectIndex];
            blit(deps.tiles.image, buffer, [...rect, cvx, cvy]);
        }
        else {
            blit(deps.tiles.image, buffer, [...emptyRect, cvx, cvy]);
        }
        const playerRectIndex = assrt(fstate.facing === 'left' ?
            deps.playerAnimLeft(elapsed) :
            deps.playerAnimRight(elapsed), 'Expected player rect');
        const playerRect = deps.sprites.rects[playerRectIndex];
        // always redraw the player
        composite(deps.sprites.image, buffer, [...playerRect, cvx, cvy]);
        fstate.moveCols = 0;
        fstate.moveRows = 0;
        // show fps
        drawFps(state, deps.font, width, buffer, deps.fontPts);
        //
        vstate.prevIndices = vstate.currIndices.slice();
    };
    const quit = async (_state) => {
        deps = null;
        fstate = null;
        vstate = null;
    };
    return { init, update, quit };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFuZ2VyLXNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3NjZW5lcy9yYW5nZXIvcmFuZ2VyLXNjZW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQTtBQUM5QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFFeEQsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQTtBQUNoRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ2xDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFDdEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFNBQVMsQ0FBQTtBQUNsQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBRXBFLE9BQU8sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUE7QUFFdkQsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFHLEdBQVUsRUFBRTtJQUNyQyxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUE7SUFDbkIsSUFBSSxJQUF1QixDQUFBO0lBQzNCLElBQUksTUFBMEIsQ0FBQTtJQUM5QixJQUFJLE1BQXdCLENBQUE7SUFDNUIsSUFBSSxVQUFpRCxDQUFBO0lBRXJELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUNiLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUViLE1BQU0sSUFBSSxHQUFHLEtBQUssRUFBRSxLQUFZLEVBQUUsRUFBRTtRQUNsQyxNQUFNLENBQUMsR0FBRyxNQUFNLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUVqQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQTtRQUNiLE1BQU0s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QUE7SUFFRCxNQUFNLElBQUksR0FBRyxLQUFLLEVBQUUsTUFBYSxFQUFFLEVBQUU7UUFDbkMsSUFBSSxHQUFHLElBQUksQ0FBQTtRQUNYLE1BQU0sR0FBRyxJQUFJLENBQUE7UUFDYixNQUFNLEdBQUcsSUFBSSxDQUFBO0lBQ2YsQ0FBQyxDQUFBO0lBRUQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUE7QUFDL0IsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYmxpdCB9IGZyb20gJy4uLy4uL2xpYi9pbWFnZS9ibGl0LmpzJ1xyXG5pbXBvcnQgeyBjb21wb3NpdGUgfSBmcm9tICcuLi8uLi9saWIvaW1hZ2UvY29tcG9zaXRlLmpzJ1xyXG5pbXBvcnQgeyBNYXliZSwgU2NlbmUsIFN0YXRlIH0gZnJvbSAnLi4vLi4vbGliL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyBhc3NydCwgbWF5YmUgfSBmcm9tICcuLi8uLi9saWIvdXRpbC5qcydcclxuaW1wb3J0IHsgZHJhd0ZwcyB9IGZyb20gJy4vZnBzLmpzJ1xyXG5pbXBvcnQgeyByYW5nZXJJbml0IH0gZnJvbSAnLi9pbml0LmpzJ1xyXG5pbXBvcnQgeyByYW5nZXJJbyB9IGZyb20gJy4vaW8uanMnXHJcbmltcG9ydCB7IGVtcHR5LCB0aWxlQ3gsIHRpbGVDeSwgdGlsZUgsIHRpbGVXIH0gZnJvbSAnLi90aWxlLWRhdGEuanMnXHJcbmltcG9ydCB7IFJhbmdlckRlcHMsIFJhbmdlclN0YXRlLCBWaWV3U3RhdGUgfSBmcm9tICcuL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyBzZXRJbmRpY2VzLCB2aWV3U3RhdGUgfSBmcm9tICcuL3ZpZXctc3RhdGUuanMnXHJcblxyXG5leHBvcnQgY29uc3QgcmFuZ2VyU2NlbmUgPSAoKTogU2NlbmUgPT4ge1xyXG4gIGxldCBpc0FjdGl2ZSA9IHRydWVcclxuICBsZXQgZGVwczogTWF5YmU8UmFuZ2VyRGVwcz5cclxuICBsZXQgZnN0YXRlOiBNYXliZTxSYW5nZXJTdGF0ZT5cclxuICBsZXQgdnN0YXRlOiBNYXliZTxWaWV3U3RhdGU+XHJcbiAgbGV0IGludmFsaWRhdGU6IE1heWJlPCh3OiBudW1iZXIsIGg6IG51bWJlcikgPT4gdm9pZD5cclxuXHJcbiAgbGV0IGxhc3RXID0gMFxyXG4gIGxldCBsYXN0SCA9IDBcclxuXHJcbiAgY29uc3QgaW5pdCA9IGFzeW5jIChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnN0IHIgPSBhd2FpdCByYW5nZXJJbml0KHN0YXRlKVxyXG5cclxuICAgIGRlcHMgPSByLmRlcHNcclxuICAgIGZzdGF0ZSA9IHIuZnN0YXRlXHJcblxyXG4gICAgY29uc3QgdiA9IHZpZXdTdGF0ZShsYXN0VywgbGFzdEgsIHRpbGVXLCB0aWxlSClcclxuXHJcbiAgICB2c3RhdGUgPSB2LnN0YXRlXHJcbiAgICBpbnZhbGlkYXRlID0gdi5pbnZhbGlkYXRlXHJcbiAgfVxyXG5cclxuICBjb25zdCB1cGRhdGUgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpZiAoIW1heWJlKGRlcHMpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgZGVwcycpXHJcbiAgICBpZiAoIW1heWJlKGZzdGF0ZSkpIHRocm93IEVycm9yKCdFeHBlY3RlZCBmc3RhdGUnKVxyXG4gICAgaWYgKCFtYXliZSh2c3RhdGUpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgdnN0YXRlJylcclxuICAgIGlmICghbWF5YmUoaW52YWxpZGF0ZSkpIHRocm93IEVycm9yKCdFeHBlY3RlZCBpbnZhbGlkYXRlJylcclxuXHJcbiAgICBpZiAoaXNBY3RpdmUpIHJhbmdlcklvKHN0YXRlLCBkZXBzLCBmc3RhdGUpXHJcblxyXG4gICAgY29uc3QgYnVmZmVyID0gc3RhdGUudmlldy5nZXRCdWZmZXIoKVxyXG4gICAgY29uc3QgZWxhcHNlZCA9IHN0YXRlLnRpbWUuZ2V0RWxhcHNlZCgpXHJcblxyXG4gICAgY29uc3QgWywgLCBlbXB0eUlkXSA9IGVtcHR5XHJcblxyXG4gICAgY29uc3QgZW1wdHlSZWN0ID0gZGVwcy50aWxlcy5yZWN0c1tlbXB0eUlkXVxyXG5cclxuICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gYnVmZmVyXHJcblxyXG4gICAgaWYgKGxhc3RXICE9PSB3aWR0aCB8fCBsYXN0SCAhPT0gaGVpZ2h0KSB7XHJcbiAgICAgIGludmFsaWRhdGUod2lkdGgsIGhlaWdodClcclxuICAgICAgbGFzdFcgPSB3aWR0aFxyXG4gICAgICBsYXN0SCA9IGhlaWdodFxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRpbGVDb2wgPSBmc3RhdGUuY2FtZXJhWCArIHZzdGF0ZS5jb2xMZWZ0XHJcbiAgICBjb25zdCB0aWxlUm93ID0gZnN0YXRlLmNhbWVyYVkgKyB2c3RhdGUucm93VG9wXHJcblxyXG4gICAgc2V0SW5kaWNlcyhcclxuICAgICAgZGVwcy50aWxlTWFwLCB2c3RhdGUuY3VyckluZGljZXMsIHZzdGF0ZS5hbmltYXRlZCxcclxuICAgICAgdGlsZUNvbCwgdGlsZVJvdywgdnN0YXRlLmNvbHMsIHZzdGF0ZS5yb3dzLFxyXG4gICAgICBlbGFwc2VkLCBlbXB0eUlkXHJcbiAgICApXHJcblxyXG4gICAgZm9yIChsZXQgciA9IDA7IHIgPCB2c3RhdGUucm93czsgcisrKSB7XHJcbiAgICAgIGNvbnN0IGR5ID0gciAqIHRpbGVIICsgdnN0YXRlLnZUb3BcclxuXHJcbiAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgdnN0YXRlLmNvbHM7IGMrKykge1xyXG4gICAgICAgIGNvbnN0IHRpbGVJbmRleCA9IHIgKiB2c3RhdGUuY29scyArIGNcclxuXHJcbiAgICAgICAgY29uc3QgcHJldiA9IHZzdGF0ZS5wcmV2SW5kaWNlc1t0aWxlSW5kZXhdXHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHZzdGF0ZS5jdXJySW5kaWNlc1t0aWxlSW5kZXhdIVxyXG5cclxuICAgICAgICBpZiAocHJldiA9PT0gY3VycmVudCkge1xyXG4gICAgICAgICAgY29udGludWVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGR4ID0gYyAqIHRpbGVXICsgdnN0YXRlLnZMZWZ0XHJcbiAgICAgICAgY29uc3QgcmVjdCA9IGRlcHMudGlsZXMucmVjdHNbY3VycmVudF1cclxuXHJcbiAgICAgICAgYmxpdChkZXBzLnRpbGVzLmltYWdlLCBidWZmZXIsIFsuLi5yZWN0LCBkeCwgZHldKVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy9cclxuXHJcbiAgICBjb25zdCBjdnggPSBNYXRoLmZsb29yKHdpZHRoIC8gMikgLSB0aWxlQ3hcclxuICAgIGNvbnN0IGN2eSA9IE1hdGguZmxvb3IoaGVpZ2h0IC8gMikgLSB0aWxlQ3lcclxuXHJcbiAgICAvLyBhbHdheXMgcmVkcmF3IHRoZSBjZW50ZXIgdGlsZSBcclxuICAgIGlmIChcclxuICAgICAgZnN0YXRlLmNhbWVyYVkgPj0gMCAmJiBmc3RhdGUuY2FtZXJhWSA8IGRlcHMudGlsZU1hcC5oZWlnaHQgJiZcclxuICAgICAgZnN0YXRlLmNhbWVyYVggPj0gMCAmJiBmc3RhdGUuY2FtZXJhWCA8IGRlcHMudGlsZU1hcC53aWR0aFxyXG4gICAgKSB7XHJcbiAgICAgIGNvbnN0IHRpbGVJbmRleCA9IGZzdGF0ZS5jYW1lcmFZICogZGVwcy50aWxlTWFwLndpZHRoICsgZnN0YXRlLmNhbWVyYVhcclxuICAgICAgY29uc3QgdGlsZSA9IGRlcHMudGlsZU1hcC5kYXRhW3RpbGVJbmRleF1cclxuICAgICAgY29uc3QgcmVjdEluZGV4ID0gYXNzcnQoXHJcbiAgICAgICAgdHlwZW9mIHRpbGUgPT09ICdudW1iZXInID9cclxuICAgICAgICAgIHRpbGUgOlxyXG4gICAgICAgICAgdGlsZShlbGFwc2VkKSxcclxuICAgICAgICAnRXhwZWN0ZWQgcmVjdEluZGV4J1xyXG4gICAgICApXHJcblxyXG4gICAgICBjb25zdCByZWN0ID0gZGVwcy50aWxlcy5yZWN0c1tyZWN0SW5kZXhdXHJcblxyXG4gICAgICBibGl0KGRlcHMudGlsZXMuaW1hZ2UsIGJ1ZmZlciwgWy4uLnJlY3QsIGN2eCwgY3Z5XSlcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGJsaXQoZGVwcy50aWxlcy5pbWFnZSwgYnVmZmVyLCBbLi4uZW1wdHlSZWN0LCBjdngsIGN2eV0pXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcGxheWVyUmVjdEluZGV4ID0gYXNzcnQoXHJcbiAgICAgIGZzdGF0ZS5mYWNpbmcgPT09ICdsZWZ0JyA/XHJcbiAgICAgICAgZGVwcy5wbGF5ZXJBbmltTGVmdChlbGFwc2VkKSA6XHJcbiAgICAgICAgZGVwcy5wbGF5ZXJBbmltUmlnaHQoZWxhcHNlZCksXHJcbiAgICAgICdFeHBlY3RlZCBwbGF5ZXIgcmVjdCdcclxuICAgIClcclxuXHJcbiAgICBjb25zdCBwbGF5ZXJSZWN0ID0gZGVwcy5zcHJpdGVzLnJlY3RzW3BsYXllclJlY3RJbmRleF1cclxuXHJcbiAgICAvLyBhbHdheXMgcmVkcmF3IHRoZSBwbGF5ZXJcclxuICAgIGNvbXBvc2l0ZShkZXBzLnNwcml0ZXMuaW1hZ2UsIGJ1ZmZlciwgWy4uLnBsYXllclJlY3QsIGN2eCwgY3Z5XSlcclxuXHJcbiAgICBmc3RhdGUubW92ZUNvbHMgPSAwXHJcbiAgICBmc3RhdGUubW92ZVJvd3MgPSAwXHJcblxyXG4gICAgLy8gc2hvdyBmcHNcclxuICAgIGRyYXdGcHMoc3RhdGUsIGRlcHMuZm9udCwgd2lkdGgsIGJ1ZmZlciwgZGVwcy5mb250UHRzKVxyXG5cclxuICAgIC8vXHJcblxyXG4gICAgdnN0YXRlLnByZXZJbmRpY2VzID0gdnN0YXRlLmN1cnJJbmRpY2VzLnNsaWNlKClcclxuICB9XHJcblxyXG4gIGNvbnN0IHF1aXQgPSBhc3luYyAoX3N0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgZGVwcyA9IG51bGxcclxuICAgIGZzdGF0ZSA9IG51bGxcclxuICAgIHZzdGF0ZSA9IG51bGxcclxuICB9XHJcblxyXG4gIHJldHVybiB7IGluaXQsIHVwZGF0ZSwgcXVpdCB9XHJcbn1cclxuIl19
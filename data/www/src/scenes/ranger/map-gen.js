import { getNeighboursCardinal, getNeighboursAll } from '../../lib/geom/neighbours.js';
import { pick, randInt } from '../../lib/random.js';
import { animator } from '../../lib/sprites/animator.js';
import { assrt } from '../../lib/util.js';
import { grasses, hut, mountains, rocks, ruins, sands, skeleton, trees, water } from './tile-data.js';
// doesn't have to be good, just has to be ok for testing
export const generateMap = (width, height) => {
    const size = width * height;
    const [_type, _name, ...waterFrames] = water;
    const waterAnim = animator(waterFrames);
    const tileMap = {
        width, height,
        data: Array(size).fill(waterAnim)
    };
    const blocking = new Set();
    const indexMap = new Map();
    const landCount = Math.floor(size * 0.7);
    const landIndices = new Set();
    const landIndicesArr = [];
    let landPlaced = 0;
    let currentLand = [Math.floor(width / 2), Math.floor(height / 2)];
    const canPlaceLand = ([x, y]) => {
        // leave edges clear for water
        if (x === 0)
            return false;
        if (y === 0)
            return false;
        if (x === width - 1)
            return false;
        if (y === height - 1)
            return false;
        const i = y * width + x;
        // can't already be land
        return !landIndices.has(i);
    };
    const maxTries = 100;
    const addLand = () => {
        let [lx, ly] = currentLand;
        let li = ly * width + lx;
        indexMap.set(li, [lx, ly]);
        landIndices.add(li);
        landIndicesArr.push(li);
        let tries = 0;
        let neighbours = getNeighboursCardinal(currentLand).filter(canPlaceLand);
        while (neighbours.length < 1) {
            const i = pick(landIndicesArr);
            const existingLand = assrt(indexMap.get(i), `Expected land at ${i}`);
            neighbours = getNeighboursCardinal(existingLand).filter(canPlaceLand);
            tries++;
            if (tries >= maxTries) {
                console.log('Failed to place land');
                return false;
            }
        }
        currentLand = pick(neighbours);
        return true;
    };
    while (landPlaced < landCount) {
        if (!addLand())
            break;
        landPlaced++;
    }
    const [, , grassStart, grassCount] = grasses;
    const [, , sandStart, sandCount] = sands;
    const [, , rockStart, rockCount] = rocks;
    const [, , treeStart, treeCount] = trees;
    const [, , ruinsStart, ruinsCount] = ruins;
    const [, , mountainStart, mountainCount] = mountains;
    const [, , hutIndex] = hut;
    const [, , skeletonIndex] = skeleton;
    for (const i of landIndices) {
        const grass = randInt(grassCount) + grassStart;
        tileMap.data[i] = grass;
    }
    for (const i of landIndices) {
        if (tileMap.data[i] === waterAnim)
            continue;
        const pt = assrt(indexMap.get(i), `Expected point at ${i}`);
        let seaNeighbours = 0;
        const neighbours = getNeighboursAll(pt);
        for (const n of neighbours) {
            const [nx, ny] = n;
            if (nx < 0 || nx >= width || ny < 0 || ny >= height)
                continue;
            const ni = ny * width + nx;
            if (tileMap.data[ni] === waterAnim)
                seaNeighbours++;
        }
        if (seaNeighbours > 0) {
            const sand = randInt(sandCount) + sandStart;
            tileMap.data[i] = sand;
            continue;
        }
        if (!randInt(10)) {
            const rock = randInt(rockCount) + rockStart;
            tileMap.data[i] = rock;
            continue;
        }
        if (!randInt(10)) {
            const tree = randInt(treeCount) + treeStart;
            tileMap.data[i] = tree;
            continue;
        }
        if (!randInt(100)) {
            const ruins = randInt(ruinsCount) + ruinsStart;
            tileMap.data[i] = ruins;
            continue;
        }
        if (!randInt(50)) {
            const mountain = randInt(mountainCount) + mountainStart;
            tileMap.data[i] = mountain;
            continue;
        }
        if (!randInt(500)) {
            tileMap.data[i] = hutIndex;
            continue;
        }
        if (!randInt(1000)) {
            tileMap.data[i] = skeletonIndex;
            continue;
        }
    }
    blocking.add(waterAnim);
    // trees
    for (let i = treeStart; i < treeStart + treeCount; i++) {
        blocking.add(i);
    }
    // mountains
    for (let i = mountainStart; i < mountainStart + mountainCount; i++) {
        blocking.add(i);
    }
    return { tileMap, blocking };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwLWdlbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9zY2VuZXMvcmFuZ2VyL21hcC1nZW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLHFCQUFxQixFQUFFLGdCQUFnQixFQUN4QyxNQUFNLDhCQUE4QixDQUFBO0FBRXJDLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUE7QUFDbkQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLCtCQUErQixDQUFBO0FBRXhELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQTtBQUV6QyxPQUFPLEVBQ0wsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQ3JFLE1BQU0sZ0JBQWdCLENBQUE7QUFJdkIseURBQXlEO0FBQ3pELE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLEtBQWEsRUFBRSxNQUFjLEVBQUUsRUFBRTtJQUMzRCxNQUFNLElBQUksR0FBRyxLQUFLLEdBQUcsTUFBTSxDQUFBO0lBRTNCLE1BQU0sQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsV0FBVyxDQUFDLEdBQUcsS0FBSyxDQUFBO0lBRTVDLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUV2QyxNQUFNLE9BQU8sR0FBWTtRQUN2QixLQUFLLEVBQUUsTUFBTTtRQUNiLElBQUksRUFBRSxLQUFLLENBQWMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztLQUMvQyxDQUFBO0lBRUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQWUsQ0FBQTtJQUV2QyxNQUFNLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBYyxDQUFBO0lBRXRDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFBO0lBRXhDLE1BQU0sV0FBVyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUE7SUFDckMsTUFBTSxjQUFjLEdBQWEsRUFBRSxDQUFBO0lBRW5DLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQTtJQUVsQixJQUFJLFdBQVcsR0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFFckUsTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUssRUFBRSxFQUFFO1FBQ2xDLDhCQUE4QjtRQUM5QixJQUFJLENBQUMsS0FBSyxDQUFDO1lBQUUsT0FBTyxLQUFLLENBQUE7UUFDekIsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUFFLE9BQU8sS0FBSyxDQUFBO1FBQ3pCLElBQUksQ0FBQyxLQUFLLEtBQUssR0FBRyxDQUFDO1lBQUUsT0FBTyxLQUFLLENBQUE7UUFDakMsSUFBSSxDQUFDLEtBQUssTUFBTSxHQUFHLENBQUM7WUFBRSxPQUFPLEtBQUssQ0FBQTtRQUVsQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQTtRQUV2Qix3QkFBd0I7UUFDeEIsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDNUIsQ0FBQyxDQUFBO0lBRUQsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFBO0lBRXBCLE1BQU0sT0FBTyxHQUFHLEdBQUcsRUFBRTtRQUNuQixJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLFdBQVcsQ0FBQTtRQUMxQixJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsS0FBSyxHQUFHLEVBQUUsQ0FBQTtRQUV4QixRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQzFCLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDbkIsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUV2QixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7UUFDYixJQUFJLFVBQVUsR0FBRyxxQkFBcUIsQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUE7UUFFeEUsT0FBTyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzdCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQTtZQUM5QixNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUVwRSxVQUFVLEdBQUcscUJBQXFCLENBQUMsWUFBWSxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFBO1lBRXJFLEtBQUssRUFBRSxDQUFBO1lBRVAsSUFBSSxLQUFLLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtnQkFFbkMsT0FBTyxLQUFLLENBQUE7WUFDZCxDQUFDO1FBQ0gsQ0FBQztRQUVELFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7UUFFOUIsT0FBTyxJQUFJLENBQUE7SUFDYixDQUFDLENBQUE7SUFFRCxPQUFPLFVBQVUsR0FBRyxTQUFTLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsT0FBTyxFQUFFO1lBQUUsTUFBSztRQUVyQixVQUFVLEVBQUUsQ0FBQTtJQUNkLENBQUM7SUFFRCxNQUFNLENBQUMsRUFBRSxBQUFELEVBQUcsVUFBVSxFQUFFLFVBQVUsQ0FBQyxHQUFHLE9BQU8sQ0FBQTtJQUM1QyxNQUFNLENBQUMsRUFBRSxBQUFELEVBQUcsU0FBUyxFQUFFLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQTtJQUN4QyxNQUFNLENBQUMsRUFBRSxBQUFELEVBQUcsU0FBUyxFQUFFLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQTtJQUN4QyxNQUFNLENBQUMsRUFBRSxBQUFELEVBQUcsU0FBUyxFQUFFLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQTtJQUN4QyxNQUFNLENBQUMsRUFBRSxBQUFELEVBQUcsVUFBVSxFQUFFLFVBQVUsQ0FBQyxHQUFHLEtBQUssQ0FBQTtJQUMxQyxNQUFNLENBQUMsRUFBRSxBQUFELEVBQUcsYUFBYSxFQUFFLGFBQWEsQ0FBQyxHQUFHLFNBQVMsQ0FBQTtJQUVwRCxNQUFNLENBQUMsRUFBRSxBQUFELEVBQUcsUUFBUSxDQUFDLEdBQUcsR0FBRyxDQUFBO0lBQzFCLE1BQU0sQ0FBQyxFQUFFLEFBQUQsRUFBRyxhQUFhLENBQUMsR0FBRyxRQUFRLENBQUE7SUFFcEMsS0FBSyxNQUFNLENBQUMsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUM1QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsVUFBVSxDQUFBO1FBRTlDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFBO0lBQ3pCLENBQUM7SUFFRCxLQUFLLE1BQU0sQ0FBQyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQzVCLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTO1lBQUUsU0FBUTtRQUUzQyxNQUFNLEVBQUUsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxxQkFBcUIsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUUzRCxJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUE7UUFFckIsTUFBTSxVQUFVLEdBQUcsZ0JBQWdCLENBQUMsRUFBRSxDQUFDLENBQUE7UUFFdkMsS0FBSyxNQUFNLENBQUMsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUMzQixNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUVsQixJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLEtBQUssSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxNQUFNO2dCQUFFLFNBQVE7WUFFN0QsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEtBQUssR0FBRyxFQUFFLENBQUE7WUFFMUIsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLFNBQVM7Z0JBQUUsYUFBYSxFQUFFLENBQUE7UUFDckQsQ0FBQztRQUVELElBQUksYUFBYSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3RCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxTQUFTLENBQUE7WUFFM0MsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUE7WUFFdEIsU0FBUTtRQUNWLENBQUM7UUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDakIsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLFNBQVMsQ0FBQTtZQUUzQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQTtZQUV0QixTQUFRO1FBQ1YsQ0FBQztRQUVELElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUNqQixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsU0FBUyxDQUFBO1lBRTNDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFBO1lBRXRCLFNBQVE7UUFDVixDQUFDO1FBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2xCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxVQUFVLENBQUE7WUFFOUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUE7WUFFdkIsU0FBUTtRQUNWLENBQUM7UUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDakIsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxHQUFHLGFBQWEsQ0FBQTtZQUV2RCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQTtZQUUxQixTQUFRO1FBQ1YsQ0FBQztRQUVELElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNsQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQTtZQUUxQixTQUFRO1FBQ1YsQ0FBQztRQUVELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNuQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLGFBQWEsQ0FBQTtZQUUvQixTQUFRO1FBQ1YsQ0FBQztJQUNILENBQUM7SUFFRCxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0lBQ3ZCLFFBQVE7SUFDUixLQUFLLElBQUksQ0FBQyxHQUFHLFNBQVMsRUFBRSxDQUFDLEdBQUcsU0FBUyxHQUFHLFNBQVMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3ZELFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDakIsQ0FBQztJQUNELFlBQVk7SUFDWixLQUFLLElBQUksQ0FBQyxHQUFHLGFBQWEsRUFBRSxDQUFDLEdBQUcsYUFBYSxHQUFHLGFBQWEsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ25FLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDakIsQ0FBQztJQUVELE9BQU8sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLENBQUE7QUFDOUIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBnZXROZWlnaGJvdXJzQ2FyZGluYWwsIGdldE5laWdoYm91cnNBbGxcclxufSBmcm9tICcuLi8uLi9saWIvZ2VvbS9uZWlnaGJvdXJzLmpzJ1xyXG5cclxuaW1wb3J0IHsgcGljaywgcmFuZEludCB9IGZyb20gJy4uLy4uL2xpYi9yYW5kb20uanMnXHJcbmltcG9ydCB7IGFuaW1hdG9yIH0gZnJvbSAnLi4vLi4vbGliL3Nwcml0ZXMvYW5pbWF0b3IuanMnXHJcbmltcG9ydCB7IFQyIH0gZnJvbSAnLi4vLi4vbGliL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyBhc3NydCB9IGZyb20gJy4uLy4uL2xpYi91dGlsLmpzJ1xyXG5cclxuaW1wb3J0IHtcclxuICBncmFzc2VzLCBodXQsIG1vdW50YWlucywgcm9ja3MsIHJ1aW5zLCBzYW5kcywgc2tlbGV0b24sIHRyZWVzLCB3YXRlclxyXG59IGZyb20gJy4vdGlsZS1kYXRhLmpzJ1xyXG5cclxuaW1wb3J0IHsgVGlsZU1hcCwgVGlsZU1hcENlbGwgfSBmcm9tICcuL3R5cGVzLmpzJ1xyXG5cclxuLy8gZG9lc24ndCBoYXZlIHRvIGJlIGdvb2QsIGp1c3QgaGFzIHRvIGJlIG9rIGZvciB0ZXN0aW5nXHJcbmV4cG9ydCBjb25zdCBnZW5lcmF0ZU1hcCA9ICh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikgPT4ge1xyXG4gIGNvbnN0IHNpemUgPSB3aWR0aCAqIGhlaWdodFxyXG5cclxuICBjb25zdCBbX3R5cGUsIF9uYW1lLCAuLi53YXRlckZyYW1lc10gPSB3YXRlclxyXG5cclxuICBjb25zdCB3YXRlckFuaW0gPSBhbmltYXRvcih3YXRlckZyYW1lcylcclxuXHJcbiAgY29uc3QgdGlsZU1hcDogVGlsZU1hcCA9IHtcclxuICAgIHdpZHRoLCBoZWlnaHQsXHJcbiAgICBkYXRhOiBBcnJheTxUaWxlTWFwQ2VsbD4oc2l6ZSkuZmlsbCh3YXRlckFuaW0pXHJcbiAgfVxyXG5cclxuICBjb25zdCBibG9ja2luZyA9IG5ldyBTZXQ8VGlsZU1hcENlbGw+KClcclxuXHJcbiAgY29uc3QgaW5kZXhNYXAgPSBuZXcgTWFwPG51bWJlciwgVDI+KClcclxuXHJcbiAgY29uc3QgbGFuZENvdW50ID0gTWF0aC5mbG9vcihzaXplICogMC43KVxyXG5cclxuICBjb25zdCBsYW5kSW5kaWNlcyA9IG5ldyBTZXQ8bnVtYmVyPigpXHJcbiAgY29uc3QgbGFuZEluZGljZXNBcnI6IG51bWJlcltdID0gW11cclxuXHJcbiAgbGV0IGxhbmRQbGFjZWQgPSAwXHJcblxyXG4gIGxldCBjdXJyZW50TGFuZDogVDIgPSBbTWF0aC5mbG9vcih3aWR0aCAvIDIpLCBNYXRoLmZsb29yKGhlaWdodCAvIDIpXVxyXG5cclxuICBjb25zdCBjYW5QbGFjZUxhbmQgPSAoW3gsIHldOiBUMikgPT4ge1xyXG4gICAgLy8gbGVhdmUgZWRnZXMgY2xlYXIgZm9yIHdhdGVyXHJcbiAgICBpZiAoeCA9PT0gMCkgcmV0dXJuIGZhbHNlXHJcbiAgICBpZiAoeSA9PT0gMCkgcmV0dXJuIGZhbHNlXHJcbiAgICBpZiAoeCA9PT0gd2lkdGggLSAxKSByZXR1cm4gZmFsc2VcclxuICAgIGlmICh5ID09PSBoZWlnaHQgLSAxKSByZXR1cm4gZmFsc2VcclxuXHJcbiAgICBjb25zdCBpID0geSAqIHdpZHRoICsgeFxyXG5cclxuICAgIC8vIGNhbid0IGFscmVhZHkgYmUgbGFuZFxyXG4gICAgcmV0dXJuICFsYW5kSW5kaWNlcy5oYXMoaSlcclxuICB9XHJcblxyXG4gIGNvbnN0IG1heFRyaWVzID0gMTAwXHJcblxyXG4gIGNvbnN0IGFkZExhbmQgPSAoKSA9PiB7XHJcbiAgICBsZXQgW2x4LCBseV0gPSBjdXJyZW50TGFuZFxyXG4gICAgbGV0IGxpID0gbHkgKiB3aWR0aCArIGx4XHJcblxyXG4gICAgaW5kZXhNYXAuc2V0KGxpLCBbbHgsIGx5XSlcclxuICAgIGxhbmRJbmRpY2VzLmFkZChsaSlcclxuICAgIGxhbmRJbmRpY2VzQXJyLnB1c2gobGkpXHJcblxyXG4gICAgbGV0IHRyaWVzID0gMFxyXG4gICAgbGV0IG5laWdoYm91cnMgPSBnZXROZWlnaGJvdXJzQ2FyZGluYWwoY3VycmVudExhbmQpLmZpbHRlcihjYW5QbGFjZUxhbmQpXHJcblxyXG4gICAgd2hpbGUgKG5laWdoYm91cnMubGVuZ3RoIDwgMSkge1xyXG4gICAgICBjb25zdCBpID0gcGljayhsYW5kSW5kaWNlc0FycilcclxuICAgICAgY29uc3QgZXhpc3RpbmdMYW5kID0gYXNzcnQoaW5kZXhNYXAuZ2V0KGkpLCBgRXhwZWN0ZWQgbGFuZCBhdCAke2l9YClcclxuXHJcbiAgICAgIG5laWdoYm91cnMgPSBnZXROZWlnaGJvdXJzQ2FyZGluYWwoZXhpc3RpbmdMYW5kKS5maWx0ZXIoY2FuUGxhY2VMYW5kKVxyXG5cclxuICAgICAgdHJpZXMrK1xyXG5cclxuICAgICAgaWYgKHRyaWVzID49IG1heFRyaWVzKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ0ZhaWxlZCB0byBwbGFjZSBsYW5kJylcclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjdXJyZW50TGFuZCA9IHBpY2sobmVpZ2hib3VycylcclxuXHJcbiAgICByZXR1cm4gdHJ1ZVxyXG4gIH1cclxuXHJcbiAgd2hpbGUgKGxhbmRQbGFjZWQgPCBsYW5kQ291bnQpIHtcclxuICAgIGlmICghYWRkTGFuZCgpKSBicmVha1xyXG5cclxuICAgIGxhbmRQbGFjZWQrK1xyXG4gIH1cclxuXHJcbiAgY29uc3QgWywgLCBncmFzc1N0YXJ0LCBncmFzc0NvdW50XSA9IGdyYXNzZXNcclxuICBjb25zdCBbLCAsIHNhbmRTdGFydCwgc2FuZENvdW50XSA9IHNhbmRzXHJcbiAgY29uc3QgWywgLCByb2NrU3RhcnQsIHJvY2tDb3VudF0gPSByb2Nrc1xyXG4gIGNvbnN0IFssICwgdHJlZVN0YXJ0LCB0cmVlQ291bnRdID0gdHJlZXNcclxuICBjb25zdCBbLCAsIHJ1aW5zU3RhcnQsIHJ1aW5zQ291bnRdID0gcnVpbnNcclxuICBjb25zdCBbLCAsIG1vdW50YWluU3RhcnQsIG1vdW50YWluQ291bnRdID0gbW91bnRhaW5zXHJcblxyXG4gIGNvbnN0IFssICwgaHV0SW5kZXhdID0gaHV0XHJcbiAgY29uc3QgWywgLCBza2VsZXRvbkluZGV4XSA9IHNrZWxldG9uXHJcblxyXG4gIGZvciAoY29uc3QgaSBvZiBsYW5kSW5kaWNlcykge1xyXG4gICAgY29uc3QgZ3Jhc3MgPSByYW5kSW50KGdyYXNzQ291bnQpICsgZ3Jhc3NTdGFydFxyXG5cclxuICAgIHRpbGVNYXAuZGF0YVtpXSA9IGdyYXNzXHJcbiAgfVxyXG5cclxuICBmb3IgKGNvbnN0IGkgb2YgbGFuZEluZGljZXMpIHtcclxuICAgIGlmICh0aWxlTWFwLmRhdGFbaV0gPT09IHdhdGVyQW5pbSkgY29udGludWVcclxuXHJcbiAgICBjb25zdCBwdCA9IGFzc3J0KGluZGV4TWFwLmdldChpKSwgYEV4cGVjdGVkIHBvaW50IGF0ICR7aX1gKVxyXG5cclxuICAgIGxldCBzZWFOZWlnaGJvdXJzID0gMFxyXG5cclxuICAgIGNvbnN0IG5laWdoYm91cnMgPSBnZXROZWlnaGJvdXJzQWxsKHB0KVxyXG5cclxuICAgIGZvciAoY29uc3QgbiBvZiBuZWlnaGJvdXJzKSB7XHJcbiAgICAgIGNvbnN0IFtueCwgbnldID0gblxyXG5cclxuICAgICAgaWYgKG54IDwgMCB8fCBueCA+PSB3aWR0aCB8fCBueSA8IDAgfHwgbnkgPj0gaGVpZ2h0KSBjb250aW51ZVxyXG5cclxuICAgICAgY29uc3QgbmkgPSBueSAqIHdpZHRoICsgbnhcclxuXHJcbiAgICAgIGlmICh0aWxlTWFwLmRhdGFbbmldID09PSB3YXRlckFuaW0pIHNlYU5laWdoYm91cnMrK1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChzZWFOZWlnaGJvdXJzID4gMCkge1xyXG4gICAgICBjb25zdCBzYW5kID0gcmFuZEludChzYW5kQ291bnQpICsgc2FuZFN0YXJ0XHJcblxyXG4gICAgICB0aWxlTWFwLmRhdGFbaV0gPSBzYW5kXHJcblxyXG4gICAgICBjb250aW51ZVxyXG4gICAgfVxyXG5cclxuICAgIGlmICghcmFuZEludCgxMCkpIHtcclxuICAgICAgY29uc3Qgcm9jayA9IHJhbmRJbnQocm9ja0NvdW50KSArIHJvY2tTdGFydFxyXG5cclxuICAgICAgdGlsZU1hcC5kYXRhW2ldID0gcm9ja1xyXG5cclxuICAgICAgY29udGludWVcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXJhbmRJbnQoMTApKSB7XHJcbiAgICAgIGNvbnN0IHRyZWUgPSByYW5kSW50KHRyZWVDb3VudCkgKyB0cmVlU3RhcnRcclxuXHJcbiAgICAgIHRpbGVNYXAuZGF0YVtpXSA9IHRyZWVcclxuXHJcbiAgICAgIGNvbnRpbnVlXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFyYW5kSW50KDEwMCkpIHtcclxuICAgICAgY29uc3QgcnVpbnMgPSByYW5kSW50KHJ1aW5zQ291bnQpICsgcnVpbnNTdGFydFxyXG5cclxuICAgICAgdGlsZU1hcC5kYXRhW2ldID0gcnVpbnNcclxuXHJcbiAgICAgIGNvbnRpbnVlXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFyYW5kSW50KDUwKSkge1xyXG4gICAgICBjb25zdCBtb3VudGFpbiA9IHJhbmRJbnQobW91bnRhaW5Db3VudCkgKyBtb3VudGFpblN0YXJ0XHJcblxyXG4gICAgICB0aWxlTWFwLmRhdGFbaV0gPSBtb3VudGFpblxyXG5cclxuICAgICAgY29udGludWVcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXJhbmRJbnQoNTAwKSkge1xyXG4gICAgICB0aWxlTWFwLmRhdGFbaV0gPSBodXRJbmRleFxyXG5cclxuICAgICAgY29udGludWVcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXJhbmRJbnQoMTAwMCkpIHtcclxuICAgICAgdGlsZU1hcC5kYXRhW2ldID0gc2tlbGV0b25JbmRleFxyXG5cclxuICAgICAgY29udGludWVcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGJsb2NraW5nLmFkZCh3YXRlckFuaW0pXHJcbiAgLy8gdHJlZXNcclxuICBmb3IgKGxldCBpID0gdHJlZVN0YXJ0OyBpIDwgdHJlZVN0YXJ0ICsgdHJlZUNvdW50OyBpKyspIHtcclxuICAgIGJsb2NraW5nLmFkZChpKVxyXG4gIH1cclxuICAvLyBtb3VudGFpbnNcclxuICBmb3IgKGxldCBpID0gbW91bnRhaW5TdGFydDsgaSA8IG1vdW50YWluU3RhcnQgKyBtb3VudGFpbkNvdW50OyBpKyspIHtcclxuICAgIGJsb2NraW5nLmFkZChpKVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgdGlsZU1hcCwgYmxvY2tpbmcgfVxyXG59XHJcbiJdfQ==
import { blit } from '../../lib/image/blit.js';
import { createColor } from '../../lib/image/color.js';
import { createImage } from '../../lib/image/create.js';
import { fill } from '../../lib/image/fill.js';
import { strokeRect } from '../../lib/image/stroke.js';
// renders two scenes side by side
// tab to switch between scenes
// escape to quit
//
// contains the requisite patterns for more complex composite scenes
export const splitScene = (left, right, bgColor = createColor(0x00, 0x00, 0x00), activeBorderColor = createColor(0xff, 0xd7, 0x00), padding = 1) => {
    let active = 0;
    let leftBuffer;
    let rightBuffer;
    let leftState;
    let rightState;
    let lastW = 0;
    let lastH = 0;
    // enable key/mouse handling for the active scene
    // disable key/mouse handling for the inactive scene
    const onSwitch = (state) => {
        if (active === 0) {
            enableIo(leftState, state);
            disableIo(rightState);
            if (left.setActive)
                left.setActive(true);
            if (right.setActive)
                right.setActive(false);
        }
        else {
            enableIo(rightState, state);
            disableIo(leftState);
            if (right.setActive)
                right.setActive(true);
            if (left.setActive)
                left.setActive(false);
        }
    };
    // get the rects for the left and right scenes taking into account padding
    const getRects = () => {
        const w = lastW - padding * 3;
        const h = lastH - padding * 2;
        const halfW = Math.floor(w / 2);
        const leftR = [padding, padding, halfW, h];
        const rightR = [halfW + padding * 2, padding, halfW, h];
        return [leftR, rightR];
    };
    const resized = (state) => {
        const buffer = state.view.getBuffer();
        lastW = buffer.width;
        lastH = buffer.height;
        const [leftR, rightR] = getRects();
        leftBuffer = createImage(leftR[2], leftR[3]);
        rightBuffer = createImage(rightR[2], rightR[3]);
        updateSize(leftState, state, leftR);
        updateSize(rightState, state, rightR);
        leftState.view.getBuffer = () => leftBuffer;
        rightState.view.getBuffer = () => rightBuffer;
    };
    const init = async (state) => {
        const buffer = state.view.getBuffer();
        lastW = buffer.width;
        lastH = buffer.height;
        leftState = wrapState(state, leftBuffer);
        rightState = wrapState(state, rightBuffer);
        resized(state);
        await left.init(leftState);
        await right.init(rightState);
        onSwitch(state);
    };
    const update = (state) => {
        // note that capturing and consuming the keys here means that child scenes
        // won't be able to see them - in this case, it is intentional, but keep
        // that in mind!
        //
        // if we find a use case for *not* doing this we can add options to the 
        // splitScene factory function
        const keys = state.getKeys();
        if (keys['Escape']) {
            //state.running = false
            state.setRunning(false);
            keys['Escape'] = false;
            return;
        }
        if (keys['Tab']) {
            active = active === 0 ? 1 : 0;
            keys['Tab'] = false;
            onSwitch(state);
        }
        const buffer = state.view.getBuffer();
        const { width, height } = buffer;
        if (width !== lastW || height !== lastH) {
            resized(state);
        }
        // update the child scenes
        left.update(leftState);
        right.update(rightState);
        // draw the split view
        const leftBorderRect = [
            0, 0,
            leftBuffer.width + padding * 2, leftBuffer.height + padding * 2
        ];
        const rightBorderRect = [
            leftBuffer.width + padding * 2 - 1, 0,
            rightBuffer.width + padding * 2, rightBuffer.height + padding * 2
        ];
        const activeRect = active === 0 ? leftBorderRect : rightBorderRect;
        const inactiveRect = active === 0 ? rightBorderRect : leftBorderRect;
        fill(buffer, bgColor);
        strokeRect(buffer, inactiveRect, bgColor);
        strokeRect(buffer, activeRect, activeBorderColor);
        blit(leftBuffer, buffer, [
            0, 0, leftBuffer.width, leftBuffer.height,
            padding, padding
        ]);
        blit(rightBuffer, buffer, [
            0, 0, rightBuffer.width, rightBuffer.height,
            leftBuffer.width + padding * 2, padding
        ]);
    };
    const quit = async (state) => {
        await left.quit(state);
        await right.quit(state);
    };
    return { init, update, quit };
};
// overwrite mouseX, mouseY and inBounds for new size
const updateSize = (state, parentState, rect) => {
    state.mouse.getX = () => parentState.mouse.getX() - rect[0];
    state.mouse.getY = () => parentState.mouse.getY() - rect[1];
    state.mouse.isInBounds = () => {
        const [_x, _y, w, h] = rect;
        return (parentState.mouse.isInBounds() &&
            state.mouse.getX() >= 0 && state.mouse.getX() < w &&
            state.mouse.getY() >= 0 && state.mouse.getY() < h);
    };
};
// this state will no longer see or modify the parent state's io
const disableIo = (state) => {
    state.getKeys = () => ({});
    state.getKeyPresses = () => [];
    state.mouse.getButtons = () => ({});
    state.mouse.takeWheel = () => 0;
};
// reattaches the parent state's io to the child state
const enableIo = (state, parentState) => {
    state.getKeys = parentState.getKeys;
    state.getKeyPresses = parentState.getKeyPresses;
    state.mouse.getButtons = parentState.mouse.getButtons;
    state.mouse.takeWheel = parentState.mouse.takeWheel;
};
// create a new wrapped state object with its own buffer
const wrapState = (state, buffer) => {
    const { getKeys, getKeyPresses, mouse, time, view, getRunning, setRunning } = state;
    const wrapped = {
        getKeys,
        getKeyPresses,
        mouse: { ...mouse },
        time: { ...time },
        view: {
            ...view,
            getBuffer: () => buffer
        },
        getRunning,
        setRunning
    };
    return wrapped;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BsaXQtc2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvc2NlbmVzL3NhbmRib3gvc3BsaXQtc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBQzlDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQTtBQUN0RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sMkJBQTJCLENBQUE7QUFDdkQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQTtBQUd0RCxrQ0FBa0M7QUFDbEMsK0JBQStCO0FBQy9CLGlCQUFpQjtBQUNqQixFQUFFO0FBQ0Ysb0VBQW9FO0FBQ3BFLE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBRyxDQUN4QixJQUFXLEVBQUUsS0FBWSxFQUN6QixPQUFPLEdBQUcsV0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQ3ZDLGlCQUFpQixHQUFHLFdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUNqRCxPQUFPLEdBQUcsQ0FBQyxFQUNKLEVBQUU7SUFDVCxJQUFJLE1BQU0sR0FBVSxDQUFDLENBQUE7SUFFckIsSUFBSSxVQUFxQixDQUFBO0lBQ3pCLElBQUksV0FBc0IsQ0FBQTtJQUUxQixJQUFJLFNBQWdCLENBQUE7SUFDcEIsSUFBSSxVQUFpQixDQUFBO0lBRXJCLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUNiLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUViLGlEQUFpRDtJQUNqRCxvREFBb0Q7SUFDcEQsTUFBTSxRQUFRLEdBQUcsQ0FBQyxLQUFZLEVBQUUsRUFBRTtRQUNoQyxJQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUNqQixRQUFRLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFBO1lBQzFCLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUNyQixJQUFJLElBQUksQ0FBQyxTQUFTO2dCQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDekMsSUFBSSxLQUFLLENBQUMsU0FBUztnQkFBRyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQzlDLENBQUM7YUFBTSxDQUFDO1lBQ04sUUFBUSxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsQ0FBQTtZQUMzQixTQUFTLENBQUMsU0FBUyxDQUFDLENBQUE7WUFDcEIsSUFBSSxLQUFLLENBQUMsU0FBUztnQkFBRyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQzNDLElBQUksSUFBSSxDQUFDLFNBQVM7Z0JBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUM1QyxDQUFDO0lBQ0gsQ0FBQyxDQUFBO0lBRUQsMEVBQTBFO0lBQzFFLE1BQU0sUUFBUSxHQUFHLEdBQVcsRUFBRTtRQUM1QixNQUFNLENBQUMsR0FBRyxLQUFLLEdBQUcsT0FBTyxHQUFHLENBQUMsQ0FBQTtRQUM3QixNQUFNLENBQUMsR0FBRyxLQUFLLEdBQUcsT0FBTyxHQUFHLENBQUMsQ0FBQTtRQUU3QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUUvQixNQUFNLEtBQUssR0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQzlDLE1BQU0sTUFBTSxHQUFPLENBQUMsS0FBSyxHQUFHLE9BQU8sR0FBRyxDQUFDLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUUzRCxPQUFPLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBQ3hCLENBQUMsQ0FBQTtJQUVELE1BQU0sT0FBTyxHQUFHLENBQUMsS0FBWSxFQUFFLEVBQUU7UUFDL0IsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUVyQyxLQUFLLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQTtRQUNwQixLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUVyQixNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxHQUFHLFFBQVEsRUFBRSxDQUFBO1FBRWxDLFVBQVUsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQzVDLFdBQVcsR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBRS9DLFVBQVUsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBQ25DLFVBQVUsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFBO1FBRXJDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQTtRQUMzQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUE7SUFDL0MsQ0FBQyxDQUFBO0lBRUQsTUFBTSxJQUFJLEdBQUcsS0FBSyxFQUFFLEtBQVksRUFBRSxFQUFFO1FBQ2xDLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUE7UUFFckMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUE7UUFDcEIsS0FBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUE7UUFFckIsU0FBUyxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUE7UUFDeEMsVUFBVSxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLENBQUE7UUFFMUMsT0FBTyxDQUFDLEtB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TyxHQUFVO1FBQ3JCLE9BQU87UUFDUCxhQUFhO1FBQ2IsS0FBSyxFQUFFLEVBQUUsR0FBRyxLQUFLLEVBQUU7UUFDbkIsSUFBSSxFQUFFLEVBQUUsR0FBRyxJQUFJLEVBQUU7UUFDakIsSUFBSSxFQUFFO1lBQ0osR0FBRyxJQUFJO1lBQ1AsU0FBUyxFQUFFLEdBQUcsRUFBRSxDQUFDLE1BQU07U0FDeEI7UUFDRCxVQUFVO1FBQ1YsVUFBVTtLQUNYLENBQUE7SUFFRCxPQUFPLE9BQU8sQ0FBQTtBQUNoQixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBibGl0IH0gZnJvbSAnLi4vLi4vbGliL2ltYWdlL2JsaXQuanMnXG5pbXBvcnQgeyBjcmVhdGVDb2xvciB9IGZyb20gJy4uLy4uL2xpYi9pbWFnZS9jb2xvci5qcydcbmltcG9ydCB7IGNyZWF0ZUltYWdlIH0gZnJvbSAnLi4vLi4vbGliL2ltYWdlL2NyZWF0ZS5qcydcbmltcG9ydCB7IGZpbGwgfSBmcm9tICcuLi8uLi9saWIvaW1hZ2UvZmlsbC5qcydcbmltcG9ydCB7IHN0cm9rZVJlY3QgfSBmcm9tICcuLi8uLi9saWIvaW1hZ2Uvc3Ryb2tlLmpzJ1xuaW1wb3J0IHsgU2NlbmUsIFN0YXRlLCBUMiwgVDQgfSBmcm9tICcuLi8uLi9saWIvdHlwZXMuanMnXG5cbi8vIHJlbmRlcnMgdHdvIHNjZW5lcyBzaWRlIGJ5IHNpZGVcbi8vIHRhYiB0byBzd2l0Y2ggYmV0d2VlbiBzY2VuZXNcbi8vIGVzY2FwZSB0byBxdWl0XG4vL1xuLy8gY29udGFpbnMgdGhlIHJlcXVpc2l0ZSBwYXR0ZXJucyBmb3IgbW9yZSBjb21wbGV4IGNvbXBvc2l0ZSBzY2VuZXNcbmV4cG9ydCBjb25zdCBzcGxpdFNjZW5lID0gKFxuICBsZWZ0OiBTY2VuZSwgcmlnaHQ6IFNjZW5lLCBcbiAgYmdDb2xvciA9IGNyZWF0ZUNvbG9yKDB4MDAsIDB4MDAsIDB4MDApLFxuICBhY3RpdmVCb3JkZXJDb2xvciA9IGNyZWF0ZUNvbG9yKDB4ZmYsIDB4ZDcsIDB4MDApLFxuICBwYWRkaW5nID0gMVxuKTogU2NlbmUgPT4ge1xuICBsZXQgYWN0aXZlOiAwIHwgMSA9IDBcblxuICBsZXQgbGVmdEJ1ZmZlcjogSW1hZ2VEYXRhXG4gIGxldCByaWdodEJ1ZmZlcjogSW1hZ2VEYXRhXG5cbiAgbGV0IGxlZnRTdGF0ZTogU3RhdGVcbiAgbGV0IHJpZ2h0U3RhdGU6IFN0YXRlXG5cbiAgbGV0IGxhc3RXID0gMFxuICBsZXQgbGFzdEggPSAwXG5cbiAgLy8gZW5hYmxlIGtleS9tb3VzZSBoYW5kbGluZyBmb3IgdGhlIGFjdGl2ZSBzY2VuZVxuICAvLyBkaXNhYmxlIGtleS9tb3VzZSBoYW5kbGluZyBmb3IgdGhlIGluYWN0aXZlIHNjZW5lXG4gIGNvbnN0IG9uU3dpdGNoID0gKHN0YXRlOiBTdGF0ZSkgPT4ge1xuICAgIGlmIChhY3RpdmUgPT09IDApIHtcbiAgICAgIGVuYWJsZUlvKGxlZnRTdGF0ZSwgc3RhdGUpXG4gICAgICBkaXNhYmxlSW8ocmlnaHRTdGF0ZSlcbiAgICAgIGlmKCBsZWZ0LnNldEFjdGl2ZSApIGxlZnQuc2V0QWN0aXZlKHRydWUpXG4gICAgICBpZiggcmlnaHQuc2V0QWN0aXZlICkgcmlnaHQuc2V0QWN0aXZlKGZhbHNlKVxuICAgIH0gZWxzZSB7XG4gICAgICBlbmFibGVJbyhyaWdodFN0YXRlLCBzdGF0ZSlcbiAgICAgIGRpc2FibGVJbyhsZWZ0U3RhdGUpXG4gICAgICBpZiggcmlnaHQuc2V0QWN0aXZlICkgcmlnaHQuc2V0QWN0aXZlKHRydWUpXG4gICAgICBpZiggbGVmdC5zZXRBY3RpdmUgKSBsZWZ0LnNldEFjdGl2ZShmYWxzZSlcbiAgICB9XG4gIH1cblxuICAvLyBnZXQgdGhlIHJlY3RzIGZvciB0aGUgbGVmdCBhbmQgcmlnaHQgc2NlbmVzIHRha2luZyBpbnRvIGFjY291bnQgcGFkZGluZ1xuICBjb25zdCBnZXRSZWN0cyA9ICgpOiBUMjxUND4gPT4ge1xuICAgIGNvbnN0IHcgPSBsYXN0VyAtIHBhZGRpbmcgKiAzXG4gICAgY29uc3QgaCA9IGxhc3RIIC0gcGFkZGluZyAqIDJcblxuICAgIGNvbnN0IGhhbGZXID0gTWF0aC5mbG9vcih3IC8gMilcblxuICAgIGNvbnN0IGxlZnRSOiBUNCA9IFtwYWRkaW5nLCBwYWRkaW5nLCBoYWxmVywgaF1cbiAgICBjb25zdCByaWdodFI6IFQ0ID0gW2hhbGZXICsgcGFkZGluZyAqIDIsIHBhZGRpbmcsIGhhbGZXLCBoXVxuXG4gICAgcmV0dXJuIFtsZWZ0UiwgcmlnaHRSXVxuICB9XG5cbiAgY29uc3QgcmVzaXplZCA9IChzdGF0ZTogU3RhdGUpID0+IHtcbiAgICBjb25zdCBidWZmZXIgPSBzdGF0ZS52aWV3LmdldEJ1ZmZlcigpXG5cbiAgICBsYXN0VyA9IGJ1ZmZlci53aWR0aFxuICAgIGxhc3RIID0gYnVmZmVyLmhlaWdodFxuXG4gICAgY29uc3QgW2xlZnRSLCByaWdodFJdID0gZ2V0UmVjdHMoKVxuXG4gICAgbGVmdEJ1ZmZlciA9IGNyZWF0ZUltYWdlKGxlZnRSWzJdLCBsZWZ0UlszXSlcbiAgICByaWdodEJ1ZmZlciA9IGNyZWF0ZUltYWdlKHJpZ2h0UlsyXSwgcmlnaHRSWzNdKVxuXG4gICAgdXBkYXRlU2l6ZShsZWZ0U3RhdGUsIHN0YXRlLCBsZWZ0UilcbiAgICB1cGRhdGVTaXplKHJpZ2h0U3RhdGUsIHN0YXRlLCByaWdodFIpXG5cbiAgICBsZWZ0U3RhdGUudmlldy5nZXRCdWZmZXIgPSAoKSA9PiBsZWZ0QnVmZmVyXG4gICAgcmlnaHRTdGF0ZS52aWV3LmdldEJ1ZmZlciA9ICgpID0+IHJpZ2h0QnVmZmVyXG4gIH1cblxuICBjb25zdCBpbml0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xuICAgIGNvbnN0IGJ1ZmZlciA9IHN0YXRlLnZpZXcuZ2V0QnVmZmVyKClcblxuICAgIGxhc3RXID0gYnVmZmVyLndpZHRoXG4gICAgbGFzdEggPSBidWZmZXIuaGVpZ2h0XG5cbiAgICBsZWZ0U3RhdGUgPSB3cmFwU3RhdGUoc3RhdGUsIGxlZnRCdWZmZXIpXG4gICAgcmlnaHRTdGF0ZSA9IHdyYXBTdGF0ZShzdGF0ZSwgcmlnaHRCdWZmZXIpXG5cbiAgICByZXNpemVkKHN0YXRlKVxuXG4gICAgYXdhaXQgbGVmdC5pbml0KGxlZnRTdGF0ZSlcbiAgICBhd2FpdCByaWdodC5pbml0KHJpZ2h0U3RhdGUpXG5cbiAgICBvblN3aXRjaChzdGF0ZSlcbiAgfVxuXG4gIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogU3RhdGUpID0+IHtcbiAgICAvLyBub3RlIHRoYXQgY2FwdHVyaW5nIGFuZCBjb25zdW1pbmcgdGhlIGtleXMgaGVyZSBtZWFucyB0aGF0IGNoaWxkIHNjZW5lc1xuICAgIC8vIHdvbid0IGJlIGFibGUgdG8gc2VlIHRoZW0gLSBpbiB0aGlzIGNhc2UsIGl0IGlzIGludGVudGlvbmFsLCBidXQga2VlcFxuICAgIC8vIHRoYXQgaW4gbWluZCFcbiAgICAvL1xuICAgIC8vIGlmIHdlIGZpbmQgYSB1c2UgY2FzZSBmb3IgKm5vdCogZG9pbmcgdGhpcyB3ZSBjYW4gYWRkIG9wdGlvbnMgdG8gdGhlIFxuICAgIC8vIHNwbGl0U2NlbmUgZmFjdG9yeSBmdW5jdGlvblxuICAgIGNvbnN0IGtleXMgPSBzdGF0ZS5nZXRLZXlzKClcblxuICAgIGlmIChrZXlzWydFc2NhcGUnXSkge1xuICAgICAgLy9zdGF0ZS5ydW5uaW5nID0gZmFsc2VcbiAgICAgIHN0YXRlLnNldFJ1bm5pbmcoZmFsc2UpXG5cbiAgICAgIGtleXNbJ0VzY2FwZSddID0gZmFsc2VcblxuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKGtleXNbJ1RhYiddKSB7XG4gICAgICBhY3RpdmUgPSBhY3RpdmUgPT09IDAgPyAxIDogMFxuICAgICAga2V5c1snVGFiJ10gPSBmYWxzZVxuXG4gICAgICBvblN3aXRjaChzdGF0ZSlcbiAgICB9XG5cbiAgICBjb25zdCBidWZmZXIgPSBzdGF0ZS52aWV3LmdldEJ1ZmZlcigpXG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBidWZmZXJcblxuICAgIGlmICh3aWR0aCAhPT0gbGFzdFcgfHwgaGVpZ2h0ICE9PSBsYXN0SCkge1xuICAgICAgcmVzaXplZChzdGF0ZSlcbiAgICB9XG5cbiAgICAvLyB1cGRhdGUgdGhlIGNoaWxkIHNjZW5lc1xuXG4gICAgbGVmdC51cGRhdGUobGVmdFN0YXRlKVxuICAgIHJpZ2h0LnVwZGF0ZShyaWdodFN0YXRlKVxuXG4gICAgLy8gZHJhdyB0aGUgc3BsaXQgdmlld1xuXG4gICAgY29uc3QgbGVmdEJvcmRlclJlY3Q6IFQ0ID0gW1xuICAgICAgMCwgMCxcbiAgICAgIGxlZnRCdWZmZXIud2lkdGggKyBwYWRkaW5nICogMiwgbGVmdEJ1ZmZlci5oZWlnaHQgKyBwYWRkaW5nICogMlxuICAgIF1cblxuICAgIGNvbnN0IHJpZ2h0Qm9yZGVyUmVjdDogVDQgPSBbXG4gICAgICBsZWZ0QnVmZmVyLndpZHRoICsgcGFkZGluZyAqIDIgLSAxLCAwLFxuICAgICAgcmlnaHRCdWZmZXIud2lkdGggKyBwYWRkaW5nICogMiwgcmlnaHRCdWZmZXIuaGVpZ2h0ICsgcGFkZGluZyAqIDJcbiAgICBdXG5cbiAgICBjb25zdCBhY3RpdmVSZWN0ID0gYWN0aXZlID09PSAwID8gbGVmdEJvcmRlclJlY3QgOiByaWdodEJvcmRlclJlY3RcbiAgICBjb25zdCBpbmFjdGl2ZVJlY3QgPSBhY3RpdmUgPT09IDAgPyByaWdodEJvcmRlclJlY3QgOiBsZWZ0Qm9yZGVyUmVjdFxuXG4gICAgZmlsbChidWZmZXIsIGJnQ29sb3IpXG5cbiAgICBzdHJva2VSZWN0KGJ1ZmZlciwgaW5hY3RpdmVSZWN0LCBiZ0NvbG9yKVxuICAgIHN0cm9rZVJlY3QoYnVmZmVyLCBhY3RpdmVSZWN0LCBhY3RpdmVCb3JkZXJDb2xvcilcblxuICAgIGJsaXQoXG4gICAgICBsZWZ0QnVmZmVyLCBidWZmZXIsXG4gICAgICBbXG4gICAgICAgIDAsIDAsIGxlZnRCdWZmZXIud2lkdGgsIGxlZnRCdWZmZXIuaGVpZ2h0LFxuICAgICAgICBwYWRkaW5nLCBwYWRkaW5nXG4gICAgICBdXG4gICAgKVxuXG4gICAgYmxpdChcbiAgICAgIHJpZ2h0QnVmZmVyLCBidWZmZXIsXG4gICAgICBbXG4gICAgICAgIDAsIDAsIHJpZ2h0QnVmZmVyLndpZHRoLCByaWdodEJ1ZmZlci5oZWlnaHQsXG4gICAgICAgIGxlZnRCdWZmZXIud2lkdGggKyBwYWRkaW5nICogMiwgcGFkZGluZ1xuICAgICAgXVxuICAgIClcbiAgfVxuXG4gIGNvbnN0IHF1aXQgPSBhc3luYyAoc3RhdGU6IFN0YXRlKSA9PiB7XG4gICAgYXdhaXQgbGVmdC5xdWl0KHN0YXRlKVxuICAgIGF3YWl0IHJpZ2h0LnF1aXQoc3RhdGUpXG4gIH1cblxuICByZXR1cm4geyBpbml0LCB1cGRhdGUsIHF1aXQgfVxufVxuXG4vLyBvdmVyd3JpdGUgbW91c2VYLCBtb3VzZVkgYW5kIGluQm91bmRzIGZvciBuZXcgc2l6ZVxuY29uc3QgdXBkYXRlU2l6ZSA9IChzdGF0ZTogU3RhdGUsIHBhcmVudFN0YXRlOiBTdGF0ZSwgcmVjdDogVDQpID0+IHtcbiAgc3RhdGUubW91c2UuZ2V0WCA9ICgpID0+IHBhcmVudFN0YXRlLm1vdXNlLmdldFgoKSAtIHJlY3RbMF1cbiAgc3RhdGUubW91c2UuZ2V0WSA9ICgpID0+IHBhcmVudFN0YXRlLm1vdXNlLmdldFkoKSAtIHJlY3RbMV1cblxuICBzdGF0ZS5tb3VzZS5pc0luQm91bmRzID0gKCkgPT4ge1xuICAgIGNvbnN0IFtfeCwgX3ksIHcsIGhdID0gcmVjdFxuXG4gICAgcmV0dXJuIChcbiAgICAgIHBhcmVudFN0YXRlLm1vdXNlLmlzSW5Cb3VuZHMoKSAmJlxuICAgICAgc3RhdGUubW91c2UuZ2V0WCgpID49IDAgJiYgc3RhdGUubW91c2UuZ2V0WCgpIDwgdyAmJlxuICAgICAgc3RhdGUubW91c2UuZ2V0WSgpID49IDAgJiYgc3RhdGUubW91c2UuZ2V0WSgpIDwgaFxuICAgIClcbiAgfVxufVxuXG4vLyB0aGlzIHN0YXRlIHdpbGwgbm8gbG9uZ2VyIHNlZSBvciBtb2RpZnkgdGhlIHBhcmVudCBzdGF0ZSdzIGlvXG5jb25zdCBkaXNhYmxlSW8gPSAoc3RhdGU6IFN0YXRlKSA9PiB7XG4gIHN0YXRlLmdldEtleXMgPSAoKSA9PiAoe30pXG4gIHN0YXRlLmdldEtleVByZXNzZXMgPSAoKSA9PiBbXVxuICBzdGF0ZS5tb3VzZS5nZXRCdXR0b25zID0gKCkgPT4gKHt9KVxuICBzdGF0ZS5tb3VzZS50YWtlV2hlZWwgPSAoKSA9PiAwXG59XG5cbi8vIHJlYXR0YWNoZXMgdGhlIHBhcmVudCBzdGF0ZSdzIGlvIHRvIHRoZSBjaGlsZCBzdGF0ZVxuY29uc3QgZW5hYmxlSW8gPSAoc3RhdGU6IFN0YXRlLCBwYXJlbnRTdGF0ZTogU3RhdGUpID0+IHtcbiAgc3RhdGUuZ2V0S2V5cyA9IHBhcmVudFN0YXRlLmdldEtleXNcbiAgc3RhdGUuZ2V0S2V5UHJlc3NlcyA9IHBhcmVudFN0YXRlLmdldEtleVByZXNzZXNcbiAgc3RhdGUubW91c2UuZ2V0QnV0dG9ucyA9IHBhcmVudFN0YXRlLm1vdXNlLmdldEJ1dHRvbnNcbiAgc3RhdGUubW91c2UudGFrZVdoZWVsID0gcGFyZW50U3RhdGUubW91c2UudGFrZVdoZWVsXG59XG5cbi8vIGNyZWF0ZSBhIG5ldyB3cmFwcGVkIHN0YXRlIG9iamVjdCB3aXRoIGl0cyBvd24gYnVmZmVyXG5jb25zdCB3cmFwU3RhdGUgPSAoc3RhdGU6IFN0YXRlLCBidWZmZXI6IEltYWdlRGF0YSk6IFN0YXRlID0+IHtcbiAgY29uc3QgeyBcbiAgICBnZXRLZXlzLCBnZXRLZXlQcmVzc2VzLCBtb3VzZSwgdGltZSwgdmlldywgZ2V0UnVubmluZywgc2V0UnVubmluZyBcbiAgfSA9IHN0YXRlXG4gIFxuICBjb25zdCB3cmFwcGVkOiBTdGF0ZSA9IHtcbiAgICBnZXRLZXlzLFxuICAgIGdldEtleVByZXNzZXMsXG4gICAgbW91c2U6IHsgLi4ubW91c2UgfSxcbiAgICB0aW1lOiB7IC4uLnRpbWUgfSxcbiAgICB2aWV3OiB7IFxuICAgICAgLi4udmlldyxcbiAgICAgIGdldEJ1ZmZlcjogKCkgPT4gYnVmZmVyXG4gICAgfSxcbiAgICBnZXRSdW5uaW5nLFxuICAgIHNldFJ1bm5pbmdcbiAgfVxuXG4gIHJldHVybiB3cmFwcGVkXG59Il19
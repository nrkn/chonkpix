import { fontImageToPoints, layoutTextLine, textLayoutToCharIndices } from '../../../lib/bmpfont/layout.js';
import { loadFontMono } from '../../../lib/bmpfont/load.js';
import { createColor } from '../../../lib/image/color.js';
import { fill, fillIndices } from '../../../lib/image/fill.js';
import { createTerminal } from '../../../lib/term/index.js';
import { maybe } from '../../../lib/util.js';
//
const _0 = 0;
const _1 = 0x55;
const _2 = 0xAA;
const _3 = 0xFF;
const _black = createColor(_0, _0, _0);
const _blue = createColor(_0, _0, _2);
const _green = createColor(_0, _2, _0);
const _cyan = createColor(_0, _2, _2);
const _red = createColor(_2, _0, _0);
const _magenta = createColor(_2, _0, _2);
const _brown = createColor(_2, _1, _0);
const _lightGray = createColor(_2, _2, _2);
const _darkGray = createColor(_1, _1, _1);
const _lightBlue = createColor(_1, _1, _3);
const _lightGreen = createColor(_1, _3, _1);
const _lightCyan = createColor(_1, _3, _3);
const _lightRed = createColor(_3, _1, _1);
const _lightMagenta = createColor(_3, _1, _3);
const _lightYellow = createColor(_3, _3, _1);
const _white = createColor(_3, _3, _3);
const cgaPalette = [
    _black, // 0
    _blue, // 1
    _green, // 2
    _cyan, // 3
    _red, // 4
    _magenta, // 5
    _brown, // 6
    _lightGray, // 7
    _darkGray, // 8
    _lightBlue, // 9
    _lightGreen, // 10
    _lightCyan, // 11
    _lightRed, // 12
    _lightMagenta, // 13
    _lightYellow, // 14
    _white // 15
];
const BLACK = 0;
const BLUE = 1;
const GREEN = 2;
const CYAN = 3;
const RED = 4;
const MAGENTA = 5;
const BROWN = 6;
const LIGHT_GRAY = 7;
const DARK_GRAY = 8;
const LIGHT_BLUE = 9;
const LIGHT_GREEN = 10; // a
const LIGHT_CYAN = 11; // b
const LIGHT_RED = 12; // c 
const LIGHT_MAGENTA = 13; // d
const LIGHT_YELLOW = 14; // e
const WHITE = 15; // f
//
// 4MB
const ramTestKb = 4096;
const ramTestSpeedKbPerMs = 0.5;
//
export const dosScene = () => {
    const padding = 2;
    const cursorRate = 500;
    let isActive = false;
    let font;
    let fontPts;
    let textCols = 0;
    let textRows = 0;
    let bg = BLACK;
    let fg = LIGHT_GRAY;
    let ramTestedKb = 0;
    const ramTestWidth = String(ramTestKb).length;
    const term = createTerminal();
    const setFont = async (state, fontName) => {
        font = await loadFontMono(fontName);
        fontPts = fontImageToPoints(font);
        const buffer = state.view.getBuffer();
        const vw = buffer.width - padding * 2;
        const vh = buffer.height - padding * 2;
        textCols = Math.floor(vw / font.width);
        textRows = Math.floor(vh / font.height);
    };
    const init = async (state) => {
        isActive = true;
        state.view.setZoom(3);
        await setFont(state, 'IBM_VGA_8x14');
        term.clear();
        // line 0
        term.appendLine('`c\x20\x1e\x20  `fAvalon   `7Released: 12/01/93');
        // line 1
        term.appendLine('`c\x1f\x20\x1f `fMastadon  `7AMCBIOS (C)1993 Avalon Mastadon Corp.,');
        // line 2
        term.appendLine('UC666C');
        // line 3
        term.appendLine();
        // line 4
        const messageRam = String(ramTestedKb | 0).padStart(ramTestWidth, ' ');
        term.appendLine(`${messageRam}KB OK`);
    };
    const resized = () => {
        console.log(`TSIZE=${textCols}x${textRows}`);
    };
    const update = (state) => {
        if (!isActive)
            return;
        if (!maybe(font))
            throw Error('Font not loaded');
        if (!maybe(fontPts))
            throw Error('Font points not loaded');
        if (ramTestedKb < ramTestKb) {
            const thisFrame = ramTestSpeedKbPerMs * state.time.getFrameTime();
            ramTestedKb = Math.min(ramTestedKb + thisFrame, ramTestKb);
            const messageRam = String(ramTestedKb | 0).padStart(ramTestWidth, ' ');
            term.updateLine(4, `${messageRam}KB OK`);
            if (ramTestedKb >= ramTestKb) {
                term.appendLine();
                term.appendLine('WAIT...');
            }
        }
        const buffer = state.view.getBuffer();
        fill(buffer, cgaPalette[bg]);
        const vw = buffer.width - padding * 2;
        const vh = buffer.height - padding * 2;
        const newTextCols = Math.floor(vw / font.width);
        const newTextRows = Math.floor(vh / font.height);
        if (newTextCols !== textCols || newTextRows !== textRows) {
            textCols = newTextCols;
            textRows = newTextRows;
            resized();
        }
        const termView = term.view(textCols, textRows);
        const isCursor = (state.time.getElapsed() % (cursorRate * 2)) < cursorRate;
        let cursor = isCursor ? '_' : ' ';
        for (let y = 0; y < termView.length; y++) {
            let rawLine = termView[y];
            const cc = handleColorCodes(rawLine);
            let line = cc.clean;
            if (y === termView.length - 1) {
                line += cursor;
            }
            // lay out the version with color codes removed
            const lineLayout = layoutTextLine(font, line);
            const dx = padding;
            const dy = padding + y * font.height;
            const indices = textLayoutToCharIndices(buffer, dx, dy, fontPts, lineLayout);
            for (let i = 0; i < indices.length; i++) {
                const ch = indices[i];
                const code = cc.codes[i];
                if (maybe(code)) {
                    fg = code;
                }
                fillIndices(ch, buffer, cgaPalette[fg]);
            }
        }
    };
    const quit = async (_state) => {
        isActive = false;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
// a color code is like eg `c or `C or `2 etc.  
// `` is an escaped backtick, so a single backtick is emitted
const handleColorCodes = (line) => {
    const codes = [];
    let clean = '';
    let currentCode = null;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '`') {
            const next = line[i + 1];
            // `` escaped backtick
            if (next === '`') {
                clean += '`';
                codes.push(currentCode);
                i++; // swallow second `
                continue;
            }
            // `c, `F, `2 etc change colour
            if (next !== undefined && /[0-9a-fA-F]/.test(next)) {
                currentCode = parseInt(next, 16);
                i++; // swallow color
                continue;
            }
            // single ` falls through
        }
        // ordinary character
        clean += ch;
        codes.push(currentCode);
    }
    return { clean, codes };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9zLXNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL3NjZW5lcy9zYW5kYm94L2Rvcy9kb3Mtc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGlCQUFpQixFQUFFLGNBQWMsRUFBRSx1QkFBdUIsRUFDM0QsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUV2QyxPQUFPLEVBQUUsWUFBWSxFQUFnQixNQUFNLDhCQUE4QixDQUFBO0FBRXpFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQTtBQUN6RCxPQUFPLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxNQUFNLDRCQUE0QixDQUFBO0FBQzlELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQTtBQUUzRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFFNUMsRUFBRTtBQUVGLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQTtBQUNaLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQTtBQUNmLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQTtBQUNmLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQTtBQUVmLE1BQU0sTUFBTSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3RDLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3JDLE1BQU0sTUFBTSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3RDLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3JDLE1BQU0sSUFBSSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3BDLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3hDLE1BQU0sTUFBTSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3RDLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQzFDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3pDLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQzFDLE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQzNDLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQzFDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3pDLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQzdDLE1BQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQzVDLE1BQU0sTUFBTSxHQUFHLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBRXRDLE1BQU0sVUFBVSxHQUFHO0lBQ2pCLE1BQU0sRUFBRSxJQUFJO0lBQ1osS0FBSyxFQUFFLElBQUk7SUFDWCxNQUFNLEVBQUUsSUFBSTtJQUNaLEtBQUssRUFBRSxJQUFJO0lBQ1gsSUFBSSxFQUFFLElBQUk7SUFDVixRQUFRLEVBQUUsSUFBSTtJQUNkLE1BQU0sRUFBRSxJQUFJO0lBQ1osVUFBVSxFQUFFLElB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LENBQUE7WUFFeEIsc0JBQXNCO1lBQ3RCLElBQUksSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO2dCQUNqQixLQUFLLElBQUksR0FBRyxDQUFBO2dCQUNaLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7Z0JBQ3ZCLENBQUMsRUFBRSxDQUFBLENBQVksbUJBQW1CO2dCQUNsQyxTQUFRO1lBQ1YsQ0FBQztZQUVELCtCQUErQjtZQUMvQixJQUFJLElBQUksS0FBSyxTQUFTLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUNuRCxXQUFXLEdBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQTtnQkFDaEMsQ0FBQyxFQUFFLENBQUEsQ0FBWSxnQkFBZ0I7Z0JBQy9CLFNBQVE7WUFDVixDQUFDO1lBRUQseUJBQXlCO1FBQzNCLENBQUM7UUFFRCxxQkFBcUI7UUFDckIsS0FBSyxJQUFJLEVBQUUsQ0FBQTtRQUNYLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7SUFDekIsQ0FBQztJQUVELE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUE7QUFDekIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgZm9udEltYWdlVG9Qb2ludHMsIGxheW91dFRleHRMaW5lLCB0ZXh0TGF5b3V0VG9DaGFySW5kaWNlc1xufSBmcm9tICcuLi8uLi8uLi9saWIvYm1wZm9udC9sYXlvdXQuanMnXG5cbmltcG9ydCB7IGxvYWRGb250TW9ubywgTW9ub0ZvbnROYW1lIH0gZnJvbSAnLi4vLi4vLi4vbGliL2JtcGZvbnQvbG9hZC5qcydcbmltcG9ydCB7IEJtcEZvbnRNLCBGb250UG9pbnRzIH0gZnJvbSAnLi4vLi4vLi4vbGliL2JtcGZvbnQvdHlwZXMuanMnXG5pbXBvcnQgeyBjcmVhdGVDb2xvciB9IGZyb20gJy4uLy4uLy4uL2xpYi9pbWFnZS9jb2xvci5qcydcbmltcG9ydCB7IGZpbGwsIGZpbGxJbmRpY2VzIH0gZnJvbSAnLi4vLi4vLi4vbGliL2ltYWdlL2ZpbGwuanMnXG5pbXBvcnQgeyBjcmVhdGVUZXJtaW5hbCB9IGZyb20gJy4uLy4uLy4uL2xpYi90ZXJtL2luZGV4LmpzJ1xuaW1wb3J0IHsgTWF5YmUsIFNjZW5lLCBTdGF0ZSB9IGZyb20gJy4uLy4uLy4uL2xpYi90eXBlcy5qcydcbmltcG9ydCB7IG1heWJlIH0gZnJvbSAnLi4vLi4vLi4vbGliL3V0aWwuanMnXG5cbi8vXG5cbmNvbnN0IF8wID0gMFxuY29uc3QgXzEgPSAweDU1XG5jb25zdCBfMiA9IDB4QUFcbmNvbnN0IF8zID0gMHhGRlxuXG5jb25zdCBfYmxhY2sgPSBjcmVhdGVDb2xvcihfMCwgXzAsIF8wKVxuY29uc3QgX2JsdWUgPSBjcmVhdGVDb2xvcihfMCwgXzAsIF8yKVxuY29uc3QgX2dyZWVuID0gY3JlYXRlQ29sb3IoXzAsIF8yLCBfMClcbmNvbnN0IF9jeWFuID0gY3JlYXRlQ29sb3IoXzAsIF8yLCBfMilcbmNvbnN0IF9yZWQgPSBjcmVhdGVDb2xvcihfMiwgXzAsIF8wKVxuY29uc3QgX21hZ2VudGEgPSBjcmVhdGVDb2xvcihfMiwgXzAsIF8yKVxuY29uc3QgX2Jyb3duID0gY3JlYXRlQ29sb3IoXzIsIF8xLCBfMClcbmNvbnN0IF9saWdodEdyYXkgPSBjcmVhdGVDb2xvcihfMiwgXzIsIF8yKVxuY29uc3QgX2RhcmtHcmF5ID0gY3JlYXRlQ29sb3IoXzEsIF8xLCBfMSlcbmNvbnN0IF9saWdodEJsdWUgPSBjcmVhdGVDb2xvcihfMSwgXzEsIF8zKVxuY29uc3QgX2xpZ2h0R3JlZW4gPSBjcmVhdGVDb2xvcihfMSwgXzMsIF8xKVxuY29uc3QgX2xpZ2h0Q3lhbiA9IGNyZWF0ZUNvbG9yKF8xLCBfMywgXzMpXG5jb25zdCBfbGlnaHRSZWQgPSBjcmVhdGVDb2xvcihfMywgXzEsIF8xKVxuY29uc3QgX2xpZ2h0TWFnZW50YSA9IGNyZWF0ZUNvbG9yKF8zLCBfMSwgXzMpXG5jb25zdCBfbGlnaHRZZWxsb3cgPSBjcmVhdGVDb2xvcihfMywgXzMsIF8xKVxuY29uc3QgX3doaXRlID0gY3JlYXRlQ29sb3IoXzMsIF8zLCBfMylcblxuY29uc3QgY2dhUGFsZXR0ZSA9IFtcbiAgX2JsYWNrLCAvLyAwXG4gIF9ibHVlLCAvLyAxXG4gIF9ncmVlbiwgLy8gMlxuICBfY3lhbiwgLy8gM1xuICBfcmVkLCAvLyA0XG4gIF9tYWdlbnRhLCAvLyA1XG4gIF9icm93biwgLy8gNlxuICBfbGlnaHRHcmF5LCAvLyA3XG4gIF9kYXJrR3JheSwgLy8gOFxuICBfbGlnaHRCbHVlLCAvLyA5XG4gIF9saWdodEdyZWVuLCAvLyAxMFxuICBfbGlnaHRDeWFuLCAvLyAxMVxuICBfbGlnaHRSZWQsIC8vIDEyXG4gIF9saWdodE1hZ2VudGEsIC8vIDEzXG4gIF9saWdodFllbGxvdywgLy8gMTRcbiAgX3doaXRlIC8vIDE1XG5dXG5cbmNvbnN0IEJMQUNLID0gMFxuY29uc3QgQkxVRSA9IDFcbmNvbnN0IEdSRUVOID0gMlxuY29uc3QgQ1lBTiA9IDNcbmNvbnN0IFJFRCA9IDRcbmNvbnN0IE1BR0VOVEEgPSA1XG5jb25zdCBCUk9XTiA9IDZcbmNvbnN0IExJR0hUX0dSQVkgPSA3XG5jb25zdCBEQVJLX0dSQVkgPSA4XG5jb25zdCBMSUdIVF9CTFVFID0gOVxuY29uc3QgTElHSFRfR1JFRU4gPSAxMCAvLyBhXG5jb25zdCBMSUdIVF9DWUFOID0gMTEgLy8gYlxuY29uc3QgTElHSFRfUkVEID0gMTIgLy8gYyBcbmNvbnN0IExJR0hUX01BR0VOVEEgPSAxMyAvLyBkXG5jb25zdCBMSUdIVF9ZRUxMT1cgPSAxNCAvLyBlXG5jb25zdCBXSElURSA9IDE1IC8vIGZcblxuLy9cblxuLy8gNE1CXG5jb25zdCByYW1UZXN0S2IgPSA0MDk2XG5cbmNvbnN0IHJhbVRlc3RTcGVlZEtiUGVyTXMgPSAwLjVcblxuLy9cblxuZXhwb3J0IGNvbnN0IGRvc1NjZW5lID0gKCk6IFNjZW5lID0+IHtcbiAgY29uc3QgcGFkZGluZyA9IDJcbiAgY29uc3QgY3Vyc29yUmF0ZSA9IDUwMFxuXG4gIGxldCBpc0FjdGl2ZSA9IGZhbHNlXG4gIGxldCBmb250OiBNYXliZTxCbXBGb250TT5cbiAgbGV0IGZvbnRQdHM6IE1heWJlPEZvbnRQb2ludHM+XG4gIGxldCB0ZXh0Q29scyA9IDBcbiAgbGV0IHRleHRSb3dzID0gMFxuXG4gIGxldCBiZyA9IEJMQUNLXG4gIGxldCBmZyA9IExJR0hUX0dSQVlcblxuICBsZXQgcmFtVGVzdGVkS2IgPSAwXG5cbiAgY29uc3QgcmFtVGVzdFdpZHRoID0gU3RyaW5nKHJhbVRlc3RLYikubGVuZ3RoXG5cbiAgY29uc3QgdGVybSA9IGNyZWF0ZVRlcm1pbmFsKClcblxuICBjb25zdCBzZXRGb250ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSwgZm9udE5hbWU6IE1vbm9Gb250TmFtZSkgPT4ge1xuICAgIGZvbnQgPSBhd2FpdCBsb2FkRm9udE1vbm8oZm9udE5hbWUpXG4gICAgZm9udFB0cyA9IGZvbnRJbWFnZVRvUG9pbnRzKGZvbnQpXG5cbiAgICBjb25zdCBidWZmZXIgPSBzdGF0ZS52aWV3LmdldEJ1ZmZlcigpXG5cbiAgICBjb25zdCB2dyA9IGJ1ZmZlci53aWR0aCAtIHBhZGRpbmcgKiAyXG4gICAgY29uc3QgdmggPSBidWZmZXIuaGVpZ2h0IC0gcGFkZGluZyAqIDJcblxuICAgIHRleHRDb2xzID0gTWF0aC5mbG9vcih2dyAvIGZvbnQud2lkdGgpXG4gICAgdGV4dFJvd3MgPSBNYXRoLmZsb29yKHZoIC8gZm9udC5oZWlnaHQpXG4gIH1cblxuICBjb25zdCBpbml0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xuICAgIGlzQWN0aXZlID0gdHJ1ZVxuXG4gICAgc3RhdGUudmlldy5zZXRab29tKDMpXG5cbiAgICBhd2FpdCBzZXRGb250KHN0YXRlLCAnSUJNX1ZHQV84eDE0JylcblxuICAgIHRlcm0uY2xlYXIoKVxuICAgIC8vIGxpbmUgMFxuICAgIHRlcm0uYXBwZW5kTGluZShcbiAgICAgICdgY1xceDIwXFx4MWVcXHgyMCAgYGZBdmFsb24gICBgN1JlbGVhc2VkOiAxMi8wMS85MydcbiAgICApXG4gICAgLy8gbGluZSAxXG4gICAgdGVybS5hcHBlbmRMaW5lKFxuICAgICAgJ2BjXFx4MWZcXHgyMFxceDFmIGBmTWFzdGFkb24gIGA3QU1DQklPUyAoQykxOTkzIEF2YWxvbiBNYXN0YWRvbiBDb3JwLiwnXG4gICAgKVxuICAgIC8vIGxpbmUgMlxuICAgIHRlcm0uYXBwZW5kTGluZSgnVUM2NjZDJylcbiAgICAvLyBsaW5lIDNcbiAgICB0ZXJtLmFwcGVuZExpbmUoKVxuICAgIC8vIGxpbmUgNFxuICAgIGNvbnN0IG1lc3NhZ2VSYW0gPSBTdHJpbmcocmFtVGVzdGVkS2IgfCAwKS5wYWRTdGFydChyYW1UZXN0V2lkdGgsICcgJylcbiAgICB0ZXJtLmFwcGVuZExpbmUoYCR7bWVzc2FnZVJhbX1LQiBPS2ApXG4gIH1cblxuICBjb25zdCByZXNpemVkID0gKCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKGBUU0laRT0ke3RleHRDb2xzfXgke3RleHRSb3dzfWApXG4gIH1cblxuICBjb25zdCB1cGRhdGUgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XG4gICAgaWYgKCFpc0FjdGl2ZSkgcmV0dXJuXG5cbiAgICBpZiAoIW1heWJlKGZvbnQpKSB0aHJvdyBFcnJvcignRm9udCBub3QgbG9hZGVkJylcbiAgICBpZiAoIW1heWJlKGZvbnRQdHMpKSB0aHJvdyBFcnJvcignRm9udCBwb2ludHMgbm90IGxvYWRlZCcpXG5cbiAgICBpZiAocmFtVGVzdGVkS2IgPCByYW1UZXN0S2IpIHtcbiAgICAgIGNvbnN0IHRoaXNGcmFtZSA9IHJhbVRlc3RTcGVlZEtiUGVyTXMgKiBzdGF0ZS50aW1lLmdldEZyYW1lVGltZSgpXG5cbiAgICAgIHJhbVRlc3RlZEtiID0gTWF0aC5taW4ocmFtVGVzdGVkS2IgKyB0aGlzRnJhbWUsIHJhbVRlc3RLYilcblxuICAgICAgY29uc3QgbWVzc2FnZVJhbSA9IFN0cmluZyhyYW1UZXN0ZWRLYiB8IDApLnBhZFN0YXJ0KHJhbVRlc3RXaWR0aCwgJyAnKVxuICAgICAgdGVybS51cGRhdGVMaW5lKDQsIGAke21lc3NhZ2VSYW19S0IgT0tgKVxuXG4gICAgICBpZiAocmFtVGVzdGVkS2IgPj0gcmFtVGVzdEtiKSB7XG4gICAgICAgIHRlcm0uYXBwZW5kTGluZSgpXG4gICAgICAgIHRlcm0uYXBwZW5kTGluZSgnV0FJVC4uLicpXG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgYnVmZmVyID0gc3RhdGUudmlldy5nZXRCdWZmZXIoKVxuXG4gICAgZmlsbChidWZmZXIsIGNnYVBhbGV0dGVbYmddKVxuXG4gICAgY29uc3QgdncgPSBidWZmZXIud2lkdGggLSBwYWRkaW5nICogMlxuICAgIGNvbnN0IHZoID0gYnVmZmVyLmhlaWdodCAtIHBhZGRpbmcgKiAyXG5cbiAgICBjb25zdCBuZXdUZXh0Q29scyA9IE1hdGguZmxvb3IodncgLyBmb250LndpZHRoKVxuICAgIGNvbnN0IG5ld1RleHRSb3dzID0gTWF0aC5mbG9vcih2aCAvIGZvbnQuaGVpZ2h0KVxuXG4gICAgaWYgKG5ld1RleHRDb2xzICE9PSB0ZXh0Q29scyB8fCBuZXdUZXh0Um93cyAhPT0gdGV4dFJvd3MpIHtcbiAgICAgIHRleHRDb2xzID0gbmV3VGV4dENvbHNcbiAgICAgIHRleHRSb3dzID0gbmV3VGV4dFJvd3NcblxuICAgICAgcmVzaXplZCgpXG4gICAgfVxuXG4gICAgY29uc3QgdGVybVZpZXcgPSB0ZXJtLnZpZXcodGV4dENvbHMsIHRleHRSb3dzKVxuXG4gICAgY29uc3QgaXNDdXJzb3IgPSAoc3RhdGUudGltZS5nZXRFbGFwc2VkKCkgJSAoY3Vyc29yUmF0ZSAqIDIpKSA8IGN1cnNvclJhdGVcblxuICAgIGxldCBjdXJzb3IgPSBpc0N1cnNvciA/ICdfJyA6ICcgJ1xuXG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0ZXJtVmlldy5sZW5ndGg7IHkrKykge1xuICAgICAgbGV0IHJhd0xpbmUgPSB0ZXJtVmlld1t5XVxuXG4gICAgICBjb25zdCBjYyA9IGhhbmRsZUNvbG9yQ29kZXMocmF3TGluZSlcblxuICAgICAgbGV0IGxpbmUgPSBjYy5jbGVhblxuXG4gICAgICBpZiAoeSA9PT0gdGVybVZpZXcubGVuZ3RoIC0gMSkge1xuICAgICAgICBsaW5lICs9IGN1cnNvclxuICAgICAgfVxuXG4gICAgICAvLyBsYXkgb3V0IHRoZSB2ZXJzaW9uIHdpdGggY29sb3IgY29kZXMgcmVtb3ZlZFxuICAgICAgY29uc3QgbGluZUxheW91dCA9IGxheW91dFRleHRMaW5lKGZvbnQsIGxpbmUpXG4gICAgICBjb25zdCBkeCA9IHBhZGRpbmdcbiAgICAgIGNvbnN0IGR5ID0gcGFkZGluZyArIHkgKiBmb250LmhlaWdodFxuXG4gICAgICBjb25zdCBpbmRpY2VzID0gdGV4dExheW91dFRvQ2hhckluZGljZXMoXG4gICAgICAgIGJ1ZmZlciwgZHgsIGR5LCBmb250UHRzLCBsaW5lTGF5b3V0XG4gICAgICApXG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kaWNlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBjaCA9IGluZGljZXNbaV1cbiAgICAgICAgY29uc3QgY29kZSA9IGNjLmNvZGVzW2ldXG5cbiAgICAgICAgaWYgKG1heWJlKGNvZGUpKSB7XG4gICAgICAgICAgZmcgPSBjb2RlXG4gICAgICAgIH1cblxuICAgICAgICBmaWxsSW5kaWNlcyhjaCwgYnVmZmVyLCBjZ2FQYWxldHRlW2ZnXSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdCBxdWl0ID0gYXN5bmMgKF9zdGF0ZTogU3RhdGUpID0+IHtcbiAgICBpc0FjdGl2ZSA9IGZhbHNlXG4gIH1cblxuICBjb25zdCBzZXRBY3RpdmUgPSAoYWN0aXZlOiBib29sZWFuKSA9PiB7XG4gICAgaXNBY3RpdmUgPSBhY3RpdmVcbiAgfVxuXG4gIHJldHVybiB7IGluaXQsIHVwZGF0ZSwgcXVpdCwgc2V0QWN0aXZlIH1cbn1cblxuLy8gYSBjb2xvciBjb2RlIGlzIGxpa2UgZWcgYGMgb3IgYEMgb3IgYDIgZXRjLiAgXG4vLyBgYCBpcyBhbiBlc2NhcGVkIGJhY2t0aWNrLCBzbyBhIHNpbmdsZSBiYWNrdGljayBpcyBlbWl0dGVkXG5jb25zdCBoYW5kbGVDb2xvckNvZGVzID0gKGxpbmU6IHN0cmluZykgPT4ge1xuICBjb25zdCBjb2RlczogKG51bWJlciB8IG51bGwpW10gPSBbXVxuICBsZXQgY2xlYW4gPSAnJ1xuICBsZXQgY3VycmVudENvZGU6IG51bWJlciB8IG51bGwgPSBudWxsXG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaW5lLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgY2ggPSBsaW5lW2ldXG5cbiAgICBpZiAoY2ggPT09ICdgJykge1xuICAgICAgY29uc3QgbmV4dCA9IGxpbmVbaSArIDFdXG5cbiAgICAgIC8vIGBgIGVzY2FwZWQgYmFja3RpY2tcbiAgICAgIGlmIChuZXh0ID09PSAnYCcpIHtcbiAgICAgICAgY2xlYW4gKz0gJ2AnXG4gICAgICAgIGNvZGVzLnB1c2goY3VycmVudENvZGUpXG4gICAgICAgIGkrKyAgICAgICAgICAgIC8vIHN3YWxsb3cgc2Vjb25kIGBcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cblxuICAgICAgLy8gYGMsIGBGLCBgMiBldGMgY2hhbmdlIGNvbG91clxuICAgICAgaWYgKG5leHQgIT09IHVuZGVmaW5lZCAmJiAvWzAtOWEtZkEtRl0vLnRlc3QobmV4dCkpIHtcbiAgICAgICAgY3VycmVudENvZGUgPSBwYXJzZUludChuZXh0LCAxNilcbiAgICAgICAgaSsrICAgICAgICAgICAgLy8gc3dhbGxvdyBjb2xvclxuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICAvLyBzaW5nbGUgYCBmYWxscyB0aHJvdWdoXG4gICAgfVxuXG4gICAgLy8gb3JkaW5hcnkgY2hhcmFjdGVyXG4gICAgY2xlYW4gKz0gY2hcbiAgICBjb2Rlcy5wdXNoKGN1cnJlbnRDb2RlKVxuICB9XG5cbiAgcmV0dXJuIHsgY2xlYW4sIGNvZGVzIH1cbn0iXX0=
import { generateHeightmap } from '../../../lib/heightmap/generate/index.js';
import { raiseRect, lowerRect, flattenRect } from '../../../lib/heightmap/sculpt.js';
import { normalizeHeightmap, heightmapToPoint3, minHeight, maxHeight } from '../../../lib/heightmap/util.js';
import { randInt } from '../../../lib/random.js';
import { createWall, createPlane } from '../../../lib/voxel/generate/create.js';
const mapW = 192;
const mapH = 192;
export const generateTerrainVoxels = async (state) => {
    const buffer = state.view.getBuffer();
    const { width, height } = buffer;
    // 100 ticks for hm generation
    // 1 tick for sculpting
    // 10 ticks for converting
    // 10 ticks for sorting
    const startHmTime = performance.now();
    let hm = generateHeightmap(mapW, mapH, mapW * mapH * 8);
    hm = normalizeHeightmap(hm);
    const endHmTime = performance.now();
    console.log(`heightmap generation took ${endHmTime - startHmTime}ms`);
    // sculpt the heightmap
    const startSculptTime = performance.now();
    const raisedHeight = raiseRect(hm, 96, 80, 16, 12);
    // x0,z0,x1,z1,y0,h - 3d coordinate system of voxel space
    const rTopWall = createWall(97, 111, 110, 111, raisedHeight, 8);
    const rBottomWall = createWall(97, 101, 110, 101, raisedHeight, 8);
    const rLeftWall = createWall(97, 110, 97, 102, raisedHeight, 8);
    const rRightWall = createWall(110, 110, 110, 102, raisedHeight, 8);
    const rRoof = createPlane(97, raisedHeight + 8, 101, 14, 10);
    const rWalls = [
        ...rTopWall,
        ...rBottomWall,
        ...rLeftWall,
        ...rRightWall,
        ...rRoof
    ];
    const loweredHeight = lowerRect(hm, 32, 48, 12, 16);
    const flattenedHeight = flattenRect(hm, 64, 64, 16, 24);
    const endSculptTime = performance.now();
    console.log(`sculpting took ${endSculptTime - startSculptTime}ms`);
    // convert the buildings
    const startConvertTime = performance.now();
    const rWallsVox = rWalls.map(([x, y, z]) => {
        let fcolor = 0;
        let tcolor = 0;
        const d = mapH * 2;
        const darken = 1 - z / d;
        const v = randInt(32) - 16;
        const grey = (v + 128 + y * 0.5) * darken;
        const darkGrey = grey * 0.75;
        fcolor = 0xff000000 | (grey << 16) | (grey << 8) | grey;
        tcolor = 0xff000000 | (darkGrey << 16) | (darkGrey << 8) | darkGrey;
        return [x, y, z, tcolor, fcolor];
    });
    // convert the hm
    const hmP3s = heightmapToPoint3(hm);
    const hmMin = minHeight(hm);
    const hmMax = maxHeight(hm);
    const hmDelta = hmMax - hmMin;
    const greenRange = mapH;
    const greenStep = greenRange / hmDelta;
    const hmP3sVox = hmP3s.map(([x, y, z]) => {
        let hmTopColor = 0;
        let hmFrontColor = 0;
        // darken slightly as z increases
        // lower d numbers = more dark, higher = less dark
        const d = mapH * 2;
        const darken = 1 - z / d;
        // add a little randomness to the green color by using small red/blue values
        const red = (randInt(32) + 16); //* darken
        const darkRed = red * 0.75;
        const blue = (randInt(32) + 16); //* darken
        const darkBlue = blue * 0.75;
        // top should gets brighter as y increases
        // front should be top but darkened a bit
        //
        // make it a little random so it looks more interesting
        const g = randInt(32) - 16;
        // then apply a gradient based on height
        const green = (g + 64 + y * greenStep) * darken;
        const darkGreen = green * 0.75;
        hmTopColor = 0xff000000 | (blue << 16) | (green << 8) | red;
        hmFrontColor = 0xff000000 | (darkBlue << 16) | (darkGreen << 8) | darkRed;
        return [x, y, z, hmTopColor, hmFrontColor];
    });
    const endConvertTime = performance.now();
    console.log(`converting took ${endConvertTime - startConvertTime}ms`);
    // create and sort voxels
    const startVoxTime = performance.now();
    const voxels = [];
    voxels.push(...rWallsVox);
    voxels.push(...hmP3sVox);
    voxels.sort((a, b) => {
        // sort on z - bigger is further away
        const zDelta = b[2] - a[2];
        if (zDelta !== 0) {
            return zDelta;
        }
        // tie break on y - we want to sort smaller y first
        // so that the "tops" of voxels overlay correctly
        return a[1] - b[1];
    });
    const endVoxTime = performance.now();
    console.log(`voxel creation took ${endVoxTime - startVoxTime}ms`);
    console.log(`total time: ${endVoxTime - startHmTime}ms`);
    console.log(`voxel count: ${voxels.length}`);
    return voxels;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFpbi12b3hlbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvc2NlbmVzL3NhbmRib3gvdm94ZWwvdGVycmFpbi12b3hlbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMENBQTBDLENBQUE7QUFDNUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0NBQWtDLENBQUE7QUFDcEYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUM1RyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFFaEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQTtBQUcvRSxNQUFNLElBQUksR0FBRyxHQUFHLENBQUE7QUFDaEIsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFBO0FBRWhCLE1BQU0sQ0FBQyxNQUFNLHFCQUFxQixHQUFHLEtBQUssRUFBRSxLQUFZLEVBQUUsRUFBRTtJQUMxRCxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBQ3JDLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFBO0lBRWhDLDhCQUE4QjtJQUM5Qix1QkFBdUI7SUFDdkIsMEJBQTBCO0lBQzFCLHVCQUF1QjtJQUV2QixNQUFNLFdBQVcsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUE7SUFFckMsSUFBSSxFQUFFLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBRXZELEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUUzQixNQUFN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QUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBRTFCLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sTUFBTSxDQUFBO1FBQ2YsQ0FBQztRQUVELG1EQUFtRDtRQUNuRCxpREFBaUQ7UUFDakQsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3BCLENBQUMsQ0FBQyxDQUFBO0lBRUYsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFBO0lBRXBDLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLFVBQVUsR0FBRyxZQUFZLElBQUksQ0FBQyxDQUFBO0lBRWpFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxVQUFVLEdBQUcsV0FBVyxJQUFJLENBQUMsQ0FBQTtJQUN4RCxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQTtJQUU1QyxPQUFPLE1BQU0sQ0FBQTtBQUNmLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdlbmVyYXRlSGVpZ2h0bWFwIH0gZnJvbSAnLi4vLi4vLi4vbGliL2hlaWdodG1hcC9nZW5lcmF0ZS9pbmRleC5qcydcbmltcG9ydCB7IHJhaXNlUmVjdCwgbG93ZXJSZWN0LCBmbGF0dGVuUmVjdCB9IGZyb20gJy4uLy4uLy4uL2xpYi9oZWlnaHRtYXAvc2N1bHB0LmpzJ1xuaW1wb3J0IHsgbm9ybWFsaXplSGVpZ2h0bWFwLCBoZWlnaHRtYXBUb1BvaW50MywgbWluSGVpZ2h0LCBtYXhIZWlnaHQgfSBmcm9tICcuLi8uLi8uLi9saWIvaGVpZ2h0bWFwL3V0aWwuanMnXG5pbXBvcnQgeyByYW5kSW50IH0gZnJvbSAnLi4vLi4vLi4vbGliL3JhbmRvbS5qcydcbmltcG9ydCB7IFN0YXRlIH0gZnJvbSAnLi4vLi4vLi4vbGliL3R5cGVzLmpzJ1xuaW1wb3J0IHsgY3JlYXRlV2FsbCwgY3JlYXRlUGxhbmUgfSBmcm9tICcuLi8uLi8uLi9saWIvdm94ZWwvZ2VuZXJhdGUvY3JlYXRlLmpzJ1xuaW1wb3J0IHsgVm94IH0gZnJvbSAnLi4vLi4vLi4vbGliL3ZveGVsL3R5cGVzLmpzJ1xuXG5jb25zdCBtYXBXID0gMTkyXG5jb25zdCBtYXBIID0gMTkyXG5cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZVRlcnJhaW5Wb3hlbHMgPSBhc3luYyAoc3RhdGU6IFN0YXRlKSA9PiB7XG4gIGNvbnN0IGJ1ZmZlciA9IHN0YXRlLnZpZXcuZ2V0QnVmZmVyKClcbiAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBidWZmZXJcblxuICAvLyAxMDAgdGlja3MgZm9yIGhtIGdlbmVyYXRpb25cbiAgLy8gMSB0aWNrIGZvciBzY3VscHRpbmdcbiAgLy8gMTAgdGlja3MgZm9yIGNvbnZlcnRpbmdcbiAgLy8gMTAgdGlja3MgZm9yIHNvcnRpbmdcblxuICBjb25zdCBzdGFydEhtVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpXG5cbiAgbGV0IGhtID0gZ2VuZXJhdGVIZWlnaHRtYXAobWFwVywgbWFwSCwgbWFwVyAqIG1hcEggKiA4KVxuXG4gIGhtID0gbm9ybWFsaXplSGVpZ2h0bWFwKGhtKVxuXG4gIGNvbnN0IGVuZEhtVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpXG5cbiAgY29uc29sZS5sb2coYGhlaWdodG1hcCBnZW5lcmF0aW9uIHRvb2sgJHtlbmRIbVRpbWUgLSBzdGFydEhtVGltZX1tc2ApXG5cbiAgLy8gc2N1bHB0IHRoZSBoZWlnaHRtYXBcblxuICBjb25zdCBzdGFydFNjdWxwdFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKVxuXG4gIGNvbnN0IHJhaXNlZEhlaWdodCA9IHJhaXNlUmVjdChobSwgOTYsIDgwLCAxNiwgMTIpXG5cbiAgLy8geDAsejAseDEsejEseTAsaCAtIDNkIGNvb3JkaW5hdGUgc3lzdGVtIG9mIHZveGVsIHNwYWNlXG4gIGNvbnN0IHJUb3BXYWxsID0gY3JlYXRlV2FsbCg5NywgMTExLCAxMTAsIDExMSwgcmFpc2VkSGVpZ2h0LCA4KVxuICBjb25zdCByQm90dG9tV2FsbCA9IGNyZWF0ZVdhbGwoOTcsIDEwMSwgMTEwLCAxMDEsIHJhaXNlZEhlaWdodCwgOClcbiAgY29uc3QgckxlZnRXYWxsID0gY3JlYXRlV2FsbCg5NywgMTEwLCA5NywgMTAyLCByYWlzZWRIZWlnaHQsIDgpXG4gIGNvbnN0IHJSaWdodFdhbGwgPSBjcmVhdGVXYWxsKDExMCwgMTEwLCAxMTAsIDEwMiwgcmFpc2VkSGVpZ2h0LCA4KVxuXG4gIGNvbnN0IHJSb29mID0gY3JlYXRlUGxhbmUoOTcsIHJhaXNlZEhlaWdodCArIDgsIDEwMSwgMTQsIDEwKVxuXG4gIGNvbnN0IHJXYWxscyA9IFtcbiAgICAuLi5yVG9wV2FsbCxcbiAgICAuLi5yQm90dG9tV2FsbCxcbiAgICAuLi5yTGVmdFdhbGwsXG4gICAgLi4uclJpZ2h0V2FsbCxcbiAgICAuLi5yUm9vZlxuICBdXG5cbiAgY29uc3QgbG93ZXJlZEhlaWdodCA9IGxvd2VyUmVjdChobSwgMzIsIDQ4LCAxMiwgMTYpXG5cbiAgY29uc3QgZmxhdHRlbmVkSGVpZ2h0ID0gZmxhdHRlblJlY3QoaG0sIDY0LCA2NCwgMTYsIDI0KVxuXG4gIGNvbnN0IGVuZFNjdWxwdFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKVxuXG4gIGNvbnNvbGUubG9nKGBzY3VscHRpbmcgdG9vayAke2VuZFNjdWxwdFRpbWUgLSBzdGFydFNjdWxwdFRpbWV9bXNgKVxuXG4gIC8vIGNvbnZlcnQgdGhlIGJ1aWxkaW5nc1xuXG4gIGNvbnN0IHN0YXJ0Q29udmVydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKVxuXG4gIGNvbnN0IHJXYWxsc1ZveCA9IHJXYWxscy5tYXAoKFt4LCB5LCB6XSkgPT4ge1xuICAgIGxldCBmY29sb3IgPSAwXG4gICAgbGV0IHRjb2xvciA9IDBcblxuICAgIGNvbnN0IGQgPSBtYXBIICogMlxuICAgIGNvbnN0IGRhcmtlbiA9IDEgLSB6IC8gZFxuXG4gICAgY29uc3QgdiA9IHJhbmRJbnQoMzIpIC0gMTZcblxuICAgIGNvbnN0IGdyZXkgPSAodiArIDEyOCArIHkgKiAwLjUpICogZGFya2VuXG4gICAgY29uc3QgZGFya0dyZXkgPSBncmV5ICogMC43NVxuXG4gICAgZmNvbG9yID0gMHhmZjAwMDAwMCB8IChncmV5IDw8IDE2KSB8IChncmV5IDw8IDgpIHwgZ3JleVxuICAgIHRjb2xvciA9IDB4ZmYwMDAwMDAgfCAoZGFya0dyZXkgPDwgMTYpIHwgKGRhcmtHcmV5IDw8IDgpIHwgZGFya0dyZXlcblxuICAgIHJldHVybiBbeCwgeSwgeiwgdGNvbG9yLCBmY29sb3JdIGFzIFZveFxuICB9KVxuXG4gIC8vIGNvbnZlcnQgdGhlIGhtXG5cbiAgY29uc3QgaG1QM3MgPSBoZWlnaHRtYXBUb1BvaW50MyhobSlcblxuICBjb25zdCBobU1pbiA9IG1pbkhlaWdodChobSlcbiAgY29uc3QgaG1NYXggPSBtYXhIZWlnaHQoaG0pXG5cbiAgY29uc3QgaG1EZWx0YSA9IGhtTWF4IC0gaG1NaW5cblxuICBjb25zdCBncmVlblJhbmdlID0gbWFwSFxuXG4gIGNvbnN0IGdyZWVuU3RlcCA9IGdyZWVuUmFuZ2UgLyBobURlbHRhXG5cbiAgY29uc3QgaG1QM3NWb3ggPSBobVAzcy5tYXAoKFt4LCB5LCB6XSkgPT4ge1xuICAgIGxldCBobVRvcENvbG9yID0gMFxuICAgIGxldCBobUZyb250Q29sb3IgPSAwXG5cbiAgICAvLyBkYXJrZW4gc2xpZ2h0bHkgYXMgeiBpbmNyZWFzZXNcbiAgICAvLyBsb3dlciBkIG51bWJlcnMgPSBtb3JlIGRhcmssIGhpZ2hlciA9IGxlc3MgZGFya1xuICAgIGNvbnN0IGQgPSBtYXBIICogMlxuICAgIGNvbnN0IGRhcmtlbiA9IDEgLSB6IC8gZFxuXG4gICAgLy8gYWRkIGEgbGl0dGxlIHJhbmRvbW5lc3MgdG8gdGhlIGdyZWVuIGNvbG9yIGJ5IHVzaW5nIHNtYWxsIHJlZC9ibHVlIHZhbHVlc1xuICAgIGNvbnN0IHJlZCA9IChyYW5kSW50KDMyKSArIDE2KSAvLyogZGFya2VuXG4gICAgY29uc3QgZGFya1JlZCA9IHJlZCAqIDAuNzVcbiAgICBjb25zdCBibHVlID0gKHJhbmRJbnQoMzIpICsgMTYpIC8vKiBkYXJrZW5cbiAgICBjb25zdCBkYXJrQmx1ZSA9IGJsdWUgKiAwLjc1XG5cbiAgICAvLyB0b3Agc2hvdWxkIGdldHMgYnJpZ2h0ZXIgYXMgeSBpbmNyZWFzZXNcbiAgICAvLyBmcm9udCBzaG91bGQgYmUgdG9wIGJ1dCBkYXJrZW5lZCBhIGJpdFxuICAgIC8vXG4gICAgLy8gbWFrZSBpdCBhIGxpdHRsZSByYW5kb20gc28gaXQgbG9va3MgbW9yZSBpbnRlcmVzdGluZ1xuICAgIGNvbnN0IGcgPSByYW5kSW50KDMyKSAtIDE2XG4gICAgLy8gdGhlbiBhcHBseSBhIGdyYWRpZW50IGJhc2VkIG9uIGhlaWdodFxuICAgIGNvbnN0IGdyZWVuID0gKGcgKyA2NCArIHkgKiBncmVlblN0ZXApICogZGFya2VuXG4gICAgY29uc3QgZGFya0dyZWVuID0gZ3JlZW4gKiAwLjc1XG5cbiAgICBobVRvcENvbG9yID0gMHhmZjAwMDAwMCB8IChibHVlIDw8IDE2KSB8IChncmVlbiA8PCA4KSB8IHJlZFxuICAgIGhtRnJvbnRDb2xvciA9IDB4ZmYwMDAwMDAgfCAoZGFya0JsdWUgPDwgMTYpIHwgKGRhcmtHcmVlbiA8PCA4KSB8IGRhcmtSZWRcblxuICAgIHJldHVybiBbeCwgeSwgeiwgaG1Ub3BDb2xvciwgaG1Gcm9udENvbG9yXSBhcyBWb3hcbiAgfSlcblxuICBjb25zdCBlbmRDb252ZXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpXG5cbiAgY29uc29sZS5sb2coYGNvbnZlcnRpbmcgdG9vayAke2VuZENvbnZlcnRUaW1lIC0gc3RhcnRDb252ZXJ0VGltZX1tc2ApXG5cbiAgLy8gY3JlYXRlIGFuZCBzb3J0IHZveGVsc1xuXG4gIGNvbnN0IHN0YXJ0Vm94VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpXG5cbiAgY29uc3Qgdm94ZWxzOiBWb3hbXSA9IFtdXG5cbiAgdm94ZWxzLnB1c2goLi4ucldhbGxzVm94KVxuICB2b3hlbHMucHVzaCguLi5obVAzc1ZveClcblxuICB2b3hlbHMuc29ydCgoYSwgYikgPT4ge1xuICAgIC8vIHNvcnQgb24geiAtIGJpZ2dlciBpcyBmdXJ0aGVyIGF3YXlcbiAgICBjb25zdCB6RGVsdGEgPSBiWzJdIC0gYVsyXVxuXG4gICAgaWYgKHpEZWx0YSAhPT0gMCkge1xuICAgICAgcmV0dXJuIHpEZWx0YVxuICAgIH1cblxuICAgIC8vIHRpZSBicmVhayBvbiB5IC0gd2Ugd2FudCB0byBzb3J0IHNtYWxsZXIgeSBmaXJzdFxuICAgIC8vIHNvIHRoYXQgdGhlIFwidG9wc1wiIG9mIHZveGVscyBvdmVybGF5IGNvcnJlY3RseVxuICAgIHJldHVybiBhWzFdIC0gYlsxXVxuICB9KVxuXG4gIGNvbnN0IGVuZFZveFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKVxuXG4gIGNvbnNvbGUubG9nKGB2b3hlbCBjcmVhdGlvbiB0b29rICR7ZW5kVm94VGltZSAtIHN0YXJ0Vm94VGltZX1tc2ApXG5cbiAgY29uc29sZS5sb2coYHRvdGFsIHRpbWU6ICR7ZW5kVm94VGltZSAtIHN0YXJ0SG1UaW1lfW1zYClcbiAgY29uc29sZS5sb2coYHZveGVsIGNvdW50OiAke3ZveGVscy5sZW5ndGh9YClcblxuICByZXR1cm4gdm94ZWxzXG59Il19
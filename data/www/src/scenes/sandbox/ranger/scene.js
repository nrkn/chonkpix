import { blit } from '../../../lib/image/blit.js';
import { composite } from '../../../lib/image/composite.js';
import { assrt, maybe } from '../../../lib/util.js';
import { drawFps } from './fps.js';
import { rangerInit } from './init.js';
import { rangerIo } from './io.js';
import { empty, tileCx, tileCy, tileH, tileW } from './tile-data.js';
import { setIndices, viewState } from './view-state.js';
export const rangerScene = () => {
    let isActive = true;
    let deps;
    let fstate;
    let vstate;
    let invalidate;
    let lastW = 0;
    let lastH = 0;
    const init = async (state) => {
        const r = await rangerInit(state);
        deps = r.deps;
        fstate = r.fstate;
        const v = viewState(lastW, lastH, tileW, tileH);
        vstate = v.state;
        invalidate = v.invalidate;
    };
    const update = (state) => {
        if (!maybe(deps))
            throw Error('Expected deps');
        if (!maybe(fstate))
            throw Error('Expected fstate');
        if (!maybe(vstate))
            throw Error('Expected vstate');
        if (!maybe(invalidate))
            throw Error('Expected invalidate');
        if (isActive)
            rangerIo(state, deps, fstate);
        const buffer = state.view.getBuffer();
        const elapsed = state.time.getElapsed();
        const [, , emptyId] = empty;
        const emptyRect = deps.tiles.rects[emptyId];
        const { width, height } = buffer;
        if (fstate.lastW !== width || fstate.lastH !== height) {
            invalidate(width, height);
            fstate.lastW = width;
            fstate.lastH = height;
        }
        const tileCol = fstate.cameraX + vstate.colLeft;
        const tileRow = fstate.cameraY + vstate.rowTop;
        setIndices(deps.tileMap, vstate.currIndices, tileCol, tileRow, vstate.cols, vstate.rows, elapsed, emptyId);
        for (let r = 0; r < vstate.rows; r++) {
            const dy = r * tileH + vstate.vTop;
            for (let c = 0; c < vstate.cols; c++) {
                const tileIndex = r * vstate.cols + c;
                const prev = vstate.prevIndices[tileIndex];
                const current = vstate.currIndices[tileIndex];
                if (prev === current) {
                    continue;
                }
                const dx = c * tileW + vstate.vLeft;
                const rect = deps.tiles.rects[current];
                blit(deps.tiles.image, buffer, [...rect, dx, dy]);
            }
        }
        //
        const cvx = Math.floor(width / 2) - tileCx;
        const cvy = Math.floor(height / 2) - tileCy;
        // always redraw the center tile 
        if (fstate.cameraY >= 0 && fstate.cameraY < deps.tileMap.height &&
            fstate.cameraX >= 0 && fstate.cameraX < deps.tileMap.width) {
            const tileIndex = fstate.cameraY * deps.tileMap.width + fstate.cameraX;
            const tile = deps.tileMap.data[tileIndex];
            const rectIndex = assrt(typeof tile === 'number' ?
                tile :
                tile(elapsed), 'Expected rectIndex');
            const rect = deps.tiles.rects[rectIndex];
            blit(deps.tiles.image, buffer, [...rect, cvx, cvy]);
        }
        else {
            blit(deps.tiles.image, buffer, [...emptyRect, cvx, cvy]);
        }
        const playerRectIndex = assrt(fstate.facing === 'left' ?
            deps.playerAnimLeft(elapsed) :
            deps.playerAnimRight(elapsed), 'Expected player rect');
        const playerRect = deps.sprites.rects[playerRectIndex];
        // always redraw the player
        composite(deps.sprites.image, buffer, [...playerRect, cvx, cvy]);
        // show fps
        drawFps(state, deps.font, width, buffer, deps.fontPts);
        //
        vstate.prevIndices = vstate.currIndices.slice();
    };
    const quit = async (_state) => {
        deps = null;
        fstate = null;
        vstate = null;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvc2NlbmVzL3NhbmRib3gvcmFuZ2VyL3NjZW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFFM0QsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ2xDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFDdEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFNBQVMsQ0FBQTtBQUNsQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBRXBFLE9BQU8sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUE7QUFFdkQsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFHLEdBQVUsRUFBRTtJQUNyQyxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUE7SUFDbkIsSUFBSSxJQUF1QixDQUFBO0lBQzNCLElBQUksTUFBMEIsQ0FBQTtJQUM5QixJQUFJLE1BQXdCLENBQUE7SUFDNUIsSUFBSSxVQUFpRCxDQUFBO0lBRXJELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUNiLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUViLE1BQU0sSUFBSSxHQUFHLEtBQUssRUFBRSxLQUFZLEVBQUUsRUFBRTtRQUNsQyxNQUFNLENBQUMsR0FBRyxNQUFNLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUVqQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQTtRQUNiLE1BQU0sR0FB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SUFBSSxHQUFHLElBQUksQ0FBQTtRQUNYLE1BQU0sR0FBRyxJQUFJLENBQUE7UUFDYixNQUFNLEdBQUcsSUFBSSxDQUFBO0lBQ2YsQ0FBQyxDQUFBO0lBRUQsTUFBTSxTQUFTLEdBQUcsQ0FBQyxNQUFlLEVBQUUsRUFBRTtRQUNwQyxRQUFRLEdBQUcsTUFBTSxDQUFBO0lBQ25CLENBQUMsQ0FBQTtJQUVELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQTtBQUMxQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBibGl0IH0gZnJvbSAnLi4vLi4vLi4vbGliL2ltYWdlL2JsaXQuanMnXG5pbXBvcnQgeyBjb21wb3NpdGUgfSBmcm9tICcuLi8uLi8uLi9saWIvaW1hZ2UvY29tcG9zaXRlLmpzJ1xuaW1wb3J0IHsgTWF5YmUsIFNjZW5lLCBTdGF0ZSB9IGZyb20gJy4uLy4uLy4uL2xpYi90eXBlcy5qcydcbmltcG9ydCB7IGFzc3J0LCBtYXliZSB9IGZyb20gJy4uLy4uLy4uL2xpYi91dGlsLmpzJ1xuaW1wb3J0IHsgZHJhd0ZwcyB9IGZyb20gJy4vZnBzLmpzJ1xuaW1wb3J0IHsgcmFuZ2VySW5pdCB9IGZyb20gJy4vaW5pdC5qcydcbmltcG9ydCB7IHJhbmdlcklvIH0gZnJvbSAnLi9pby5qcydcbmltcG9ydCB7IGVtcHR5LCB0aWxlQ3gsIHRpbGVDeSwgdGlsZUgsIHRpbGVXIH0gZnJvbSAnLi90aWxlLWRhdGEuanMnXG5pbXBvcnQgeyBSYW5nZXJEZXBzLCBSYW5nZXJTdGF0ZSwgVmlld1N0YXRlIH0gZnJvbSAnLi90eXBlcy5qcydcbmltcG9ydCB7IHNldEluZGljZXMsIHZpZXdTdGF0ZSB9IGZyb20gJy4vdmlldy1zdGF0ZS5qcydcblxuZXhwb3J0IGNvbnN0IHJhbmdlclNjZW5lID0gKCk6IFNjZW5lID0+IHtcbiAgbGV0IGlzQWN0aXZlID0gdHJ1ZVxuICBsZXQgZGVwczogTWF5YmU8UmFuZ2VyRGVwcz5cbiAgbGV0IGZzdGF0ZTogTWF5YmU8UmFuZ2VyU3RhdGU+XG4gIGxldCB2c3RhdGU6IE1heWJlPFZpZXdTdGF0ZT5cbiAgbGV0IGludmFsaWRhdGU6IE1heWJlPCh3OiBudW1iZXIsIGg6IG51bWJlcikgPT4gdm9pZD5cblxuICBsZXQgbGFzdFcgPSAwXG4gIGxldCBsYXN0SCA9IDBcblxuICBjb25zdCBpbml0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xuICAgIGNvbnN0IHIgPSBhd2FpdCByYW5nZXJJbml0KHN0YXRlKVxuXG4gICAgZGVwcyA9IHIuZGVwc1xuICAgIGZzdGF0ZSA9IHIuZnN0YXRlXG5cbiAgICBjb25zdCB2ID0gdmlld1N0YXRlKGxhc3RXLCBsYXN0SCwgdGlsZVcsIHRpbGVIKVxuXG4gICAgdnN0YXRlID0gdi5zdGF0ZVxuICAgIGludmFsaWRhdGUgPSB2LmludmFsaWRhdGVcbiAgfVxuXG4gIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogU3RhdGUpID0+IHtcbiAgICBpZiAoIW1heWJlKGRlcHMpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgZGVwcycpXG4gICAgaWYgKCFtYXliZShmc3RhdGUpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgZnN0YXRlJylcbiAgICBpZiAoIW1heWJlKHZzdGF0ZSkpIHRocm93IEVycm9yKCdFeHBlY3RlZCB2c3RhdGUnKVxuICAgIGlmICghbWF5YmUoaW52YWxpZGF0ZSkpIHRocm93IEVycm9yKCdFeHBlY3RlZCBpbnZhbGlkYXRlJylcblxuICAgIGlmIChpc0FjdGl2ZSkgcmFuZ2VySW8oc3RhdGUsIGRlcHMsIGZzdGF0ZSlcblxuICAgIGNvbnN0IGJ1ZmZlciA9IHN0YXRlLnZpZXcuZ2V0QnVmZmVyKClcbiAgICBjb25zdCBlbGFwc2VkID0gc3RhdGUudGltZS5nZXRFbGFwc2VkKClcblxuICAgIGNvbnN0IFssICwgZW1wdHlJZF0gPSBlbXB0eVxuXG4gICAgY29uc3QgZW1wdHlSZWN0ID0gZGVwcy50aWxlcy5yZWN0c1tlbXB0eUlkXVxuXG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBidWZmZXJcblxuICAgIGlmIChmc3RhdGUubGFzdFcgIT09IHdpZHRoIHx8IGZzdGF0ZS5sYXN0SCAhPT0gaGVpZ2h0KSB7XG4gICAgICBpbnZhbGlkYXRlKHdpZHRoLCBoZWlnaHQpXG4gICAgICBmc3RhdGUubGFzdFcgPSB3aWR0aFxuICAgICAgZnN0YXRlLmxhc3RIID0gaGVpZ2h0XG4gICAgfVxuXG4gICAgY29uc3QgdGlsZUNvbCA9IGZzdGF0ZS5jYW1lcmFYICsgdnN0YXRlLmNvbExlZnRcbiAgICBjb25zdCB0aWxlUm93ID0gZnN0YXRlLmNhbWVyYVkgKyB2c3RhdGUucm93VG9wXG5cbiAgICBzZXRJbmRpY2VzKFxuICAgICAgZGVwcy50aWxlTWFwLCB2c3RhdGUuY3VyckluZGljZXMsXG4gICAgICB0aWxlQ29sLCB0aWxlUm93LCB2c3RhdGUuY29scywgdnN0YXRlLnJvd3MsXG4gICAgICBlbGFwc2VkLCBlbXB0eUlkXG4gICAgKVxuXG4gICAgZm9yIChsZXQgciA9IDA7IHIgPCB2c3RhdGUucm93czsgcisrKSB7XG4gICAgICBjb25zdCBkeSA9IHIgKiB0aWxlSCArIHZzdGF0ZS52VG9wXG5cbiAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgdnN0YXRlLmNvbHM7IGMrKykge1xuICAgICAgICBjb25zdCB0aWxlSW5kZXggPSByICogdnN0YXRlLmNvbHMgKyBjXG5cbiAgICAgICAgY29uc3QgcHJldiA9IHZzdGF0ZS5wcmV2SW5kaWNlc1t0aWxlSW5kZXhdXG4gICAgICAgIGNvbnN0IGN1cnJlbnQgPSB2c3RhdGUuY3VyckluZGljZXNbdGlsZUluZGV4XSFcblxuICAgICAgICBpZiAocHJldiA9PT0gY3VycmVudCkge1xuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkeCA9IGMgKiB0aWxlVyArIHZzdGF0ZS52TGVmdFxuICAgICAgICBjb25zdCByZWN0ID0gZGVwcy50aWxlcy5yZWN0c1tjdXJyZW50XVxuXG4gICAgICAgIGJsaXQoZGVwcy50aWxlcy5pbWFnZSwgYnVmZmVyLCBbLi4ucmVjdCwgZHgsIGR5XSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvL1xuXG4gICAgY29uc3QgY3Z4ID0gTWF0aC5mbG9vcih3aWR0aCAvIDIpIC0gdGlsZUN4XG4gICAgY29uc3QgY3Z5ID0gTWF0aC5mbG9vcihoZWlnaHQgLyAyKSAtIHRpbGVDeVxuXG4gICAgLy8gYWx3YXlzIHJlZHJhdyB0aGUgY2VudGVyIHRpbGUgXG4gICAgaWYgKFxuICAgICAgZnN0YXRlLmNhbWVyYVkgPj0gMCAmJiBmc3RhdGUuY2FtZXJhWSA8IGRlcHMudGlsZU1hcC5oZWlnaHQgJiZcbiAgICAgIGZzdGF0ZS5jYW1lcmFYID49IDAgJiYgZnN0YXRlLmNhbWVyYVggPCBkZXBzLnRpbGVNYXAud2lkdGhcbiAgICApIHtcbiAgICAgIGNvbnN0IHRpbGVJbmRleCA9IGZzdGF0ZS5jYW1lcmFZICogZGVwcy50aWxlTWFwLndpZHRoICsgZnN0YXRlLmNhbWVyYVhcbiAgICAgIGNvbnN0IHRpbGUgPSBkZXBzLnRpbGVNYXAuZGF0YVt0aWxlSW5kZXhdXG4gICAgICBjb25zdCByZWN0SW5kZXggPSBhc3NydChcbiAgICAgICAgdHlwZW9mIHRpbGUgPT09ICdudW1iZXInID9cbiAgICAgICAgICB0aWxlIDpcbiAgICAgICAgICB0aWxlKGVsYXBzZWQpLFxuICAgICAgICAnRXhwZWN0ZWQgcmVjdEluZGV4J1xuICAgICAgKVxuXG4gICAgICBjb25zdCByZWN0ID0gZGVwcy50aWxlcy5yZWN0c1tyZWN0SW5kZXhdXG5cbiAgICAgIGJsaXQoZGVwcy50aWxlcy5pbWFnZSwgYnVmZmVyLCBbLi4ucmVjdCwgY3Z4LCBjdnldKVxuICAgIH0gZWxzZSB7XG4gICAgICBibGl0KGRlcHMudGlsZXMuaW1hZ2UsIGJ1ZmZlciwgWy4uLmVtcHR5UmVjdCwgY3Z4LCBjdnldKVxuICAgIH1cblxuICAgIGNvbnN0IHBsYXllclJlY3RJbmRleCA9IGFzc3J0KFxuICAgICAgZnN0YXRlLmZhY2luZyA9PT0gJ2xlZnQnID9cbiAgICAgICAgZGVwcy5wbGF5ZXJBbmltTGVmdChlbGFwc2VkKSA6XG4gICAgICAgIGRlcHMucGxheWVyQW5pbVJpZ2h0KGVsYXBzZWQpLFxuICAgICAgJ0V4cGVjdGVkIHBsYXllciByZWN0J1xuICAgIClcblxuICAgIGNvbnN0IHBsYXllclJlY3QgPSBkZXBzLnNwcml0ZXMucmVjdHNbcGxheWVyUmVjdEluZGV4XVxuXG4gICAgLy8gYWx3YXlzIHJlZHJhdyB0aGUgcGxheWVyXG4gICAgY29tcG9zaXRlKGRlcHMuc3ByaXRlcy5pbWFnZSwgYnVmZmVyLCBbLi4ucGxheWVyUmVjdCwgY3Z4LCBjdnldKVxuXG4gICAgLy8gc2hvdyBmcHNcbiAgICBkcmF3RnBzKHN0YXRlLCBkZXBzLmZvbnQsIHdpZHRoLCBidWZmZXIsIGRlcHMuZm9udFB0cylcblxuICAgIC8vXG5cbiAgICB2c3RhdGUucHJldkluZGljZXMgPSB2c3RhdGUuY3VyckluZGljZXMuc2xpY2UoKVxuICB9XG5cbiAgY29uc3QgcXVpdCA9IGFzeW5jIChfc3RhdGU6IFN0YXRlKSA9PiB7XG4gICAgZGVwcyA9IG51bGxcbiAgICBmc3RhdGUgPSBudWxsXG4gICAgdnN0YXRlID0gbnVsbFxuICB9XG5cbiAgY29uc3Qgc2V0QWN0aXZlID0gKGFjdGl2ZTogYm9vbGVhbikgPT4ge1xuICAgIGlzQWN0aXZlID0gYWN0aXZlXG4gIH1cblxuICByZXR1cm4geyBpbml0LCB1cGRhdGUsIHF1aXQsIHNldEFjdGl2ZSB9XG59XG4iXX0=
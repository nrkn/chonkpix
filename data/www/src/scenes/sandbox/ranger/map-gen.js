import { getNeighboursCardinal, getNeighboursAll } from '../../../lib/geom/neighbours.js';
import { pick, randInt } from '../../../lib/random.js';
import { animator } from '../../../lib/sprites/animator.js';
import { assrt } from '../../../lib/util.js';
import { grasses, hut, mountains, rocks, ruins, sands, skeleton, trees, water } from './tile-data.js';
// doesn't have to be good, just has to be ok for testing
export const generateMap = (width, height) => {
    const size = width * height;
    const [_type, _name, ...waterFrames] = water;
    const waterAnim = animator(waterFrames);
    const tileMap = {
        width, height,
        data: Array(size).fill(waterAnim)
    };
    const blocking = new Set();
    const indexMap = new Map();
    const landCount = Math.floor(size * 0.7);
    const landIndices = new Set();
    const landIndicesArr = [];
    let landPlaced = 0;
    let currentLand = [Math.floor(width / 2), Math.floor(height / 2)];
    const canPlaceLand = ([x, y]) => {
        // leave edges clear for water
        if (x === 0)
            return false;
        if (y === 0)
            return false;
        if (x === width - 1)
            return false;
        if (y === height - 1)
            return false;
        const i = y * width + x;
        // can't already be land
        return !landIndices.has(i);
    };
    const maxTries = 100;
    const addLand = () => {
        let [lx, ly] = currentLand;
        let li = ly * width + lx;
        indexMap.set(li, [lx, ly]);
        landIndices.add(li);
        landIndicesArr.push(li);
        let tries = 0;
        let neighbours = getNeighboursCardinal(currentLand).filter(canPlaceLand);
        while (neighbours.length < 1) {
            const i = pick(landIndicesArr);
            const existingLand = assrt(indexMap.get(i), `Expected land at ${i}`);
            neighbours = getNeighboursCardinal(existingLand).filter(canPlaceLand);
            tries++;
            if (tries >= maxTries) {
                console.log('Failed to place land');
                return false;
            }
        }
        currentLand = pick(neighbours);
        return true;
    };
    while (landPlaced < landCount) {
        if (!addLand())
            break;
        landPlaced++;
    }
    const [, , grassStart, grassCount] = grasses;
    const [, , sandStart, sandCount] = sands;
    const [, , rockStart, rockCount] = rocks;
    const [, , treeStart, treeCount] = trees;
    const [, , ruinsStart, ruinsCount] = ruins;
    const [, , mountainStart, mountainCount] = mountains;
    const [, , hutIndex] = hut;
    const [, , skeletonIndex] = skeleton;
    for (const i of landIndices) {
        const grass = randInt(grassCount) + grassStart;
        tileMap.data[i] = grass;
    }
    for (const i of landIndices) {
        if (tileMap.data[i] === waterAnim)
            continue;
        const pt = assrt(indexMap.get(i), `Expected point at ${i}`);
        let seaNeighbours = 0;
        const neighbours = getNeighboursAll(pt);
        for (const n of neighbours) {
            const [nx, ny] = n;
            if (nx < 0 || nx >= width || ny < 0 || ny >= height)
                continue;
            const ni = ny * width + nx;
            if (tileMap.data[ni] === waterAnim)
                seaNeighbours++;
        }
        if (seaNeighbours > 0) {
            const sand = randInt(sandCount) + sandStart;
            tileMap.data[i] = sand;
            continue;
        }
        if (!randInt(10)) {
            const rock = randInt(rockCount) + rockStart;
            tileMap.data[i] = rock;
            continue;
        }
        if (!randInt(10)) {
            const tree = randInt(treeCount) + treeStart;
            tileMap.data[i] = tree;
            continue;
        }
        if (!randInt(100)) {
            const ruins = randInt(ruinsCount) + ruinsStart;
            tileMap.data[i] = ruins;
            continue;
        }
        if (!randInt(50)) {
            const mountain = randInt(mountainCount) + mountainStart;
            tileMap.data[i] = mountain;
            continue;
        }
        if (!randInt(500)) {
            tileMap.data[i] = hutIndex;
            continue;
        }
        if (!randInt(1000)) {
            tileMap.data[i] = skeletonIndex;
            continue;
        }
    }
    blocking.add(waterAnim);
    // trees
    for (let i = treeStart; i < treeStart + treeCount; i++) {
        blocking.add(i);
    }
    // mountains
    for (let i = mountainStart; i < mountainStart + mountainCount; i++) {
        blocking.add(i);
    }
    return { tileMap, blocking };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwLWdlbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9zY2VuZXMvc2FuZGJveC9yYW5nZXIvbWFwLWdlbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wscUJBQXFCLEVBQUUsZ0JBQWdCLEVBQ3hDLE1BQU0saUNBQWlDLENBQUE7QUFFeEMsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQTtBQUN0RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sa0NBQWtDLENBQUE7QUFFM0QsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBRTVDLE9BQU8sRUFDTCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFDckUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUl2Qix5REFBeUQ7QUFDekQsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFHLENBQUMsS0FBYSxFQUFFLE1BQWMsRUFBRSxFQUFFO0lBQzNELE1BQU0sSUFBSSxHQUFHLEtBQUssR0FBRyxNQUFNLENBQUE7SUFFM0IsTUFBTSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxXQUFXLENBQUMsR0FBRyxLQUFLLENBQUE7SUFFNUMsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBRXZDLE1BQU0sT0FBTyxHQUFZO1FBQ3ZCLEtBQUssRUFBRSxNQUFNO1FBQ2IsSUFBSSxFQUFFLEtBQUssQ0FBYyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO0tBQy9DLENBQUE7SUFFRCxNQUFNLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBZSxDQUFBO0lBRXZDLE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxFQUFjLENBQUE7SUFFdEMsTUFBTSxTQUFTLEdB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QixTQUFRO1FBQ1YsQ0FBQztRQUVELElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUNqQixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLEdBQUcsYUFBYSxDQUFBO1lBRXZELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFBO1lBRTFCLFNBQVE7UUFDVixDQUFDO1FBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2xCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFBO1lBRTFCLFNBQVE7UUFDVixDQUFDO1FBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ25CLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsYUFBYSxDQUFBO1lBRS9CLFNBQVE7UUFDVixDQUFDO0lBQ0gsQ0FBQztJQUVELFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDdkIsUUFBUTtJQUNSLEtBQUssSUFBSSxDQUFDLEdBQUcsU0FBUyxFQUFFLENBQUMsR0FBRyxTQUFTLEdBQUcsU0FBUyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDdkQsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNqQixDQUFDO0lBQ0QsWUFBWTtJQUNaLEtBQUssSUFBSSxDQUFDLEdBQUcsYUFBYSxFQUFFLENBQUMsR0FBRyxhQUFhLEdBQUcsYUFBYSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDbkUsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNqQixDQUFDO0lBRUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsQ0FBQTtBQUM5QixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBnZXROZWlnaGJvdXJzQ2FyZGluYWwsIGdldE5laWdoYm91cnNBbGxcbn0gZnJvbSAnLi4vLi4vLi4vbGliL2dlb20vbmVpZ2hib3Vycy5qcydcblxuaW1wb3J0IHsgcGljaywgcmFuZEludCB9IGZyb20gJy4uLy4uLy4uL2xpYi9yYW5kb20uanMnXG5pbXBvcnQgeyBhbmltYXRvciB9IGZyb20gJy4uLy4uLy4uL2xpYi9zcHJpdGVzL2FuaW1hdG9yLmpzJ1xuaW1wb3J0IHsgVDIgfSBmcm9tICcuLi8uLi8uLi9saWIvdHlwZXMuanMnXG5pbXBvcnQgeyBhc3NydCB9IGZyb20gJy4uLy4uLy4uL2xpYi91dGlsLmpzJ1xuXG5pbXBvcnQge1xuICBncmFzc2VzLCBodXQsIG1vdW50YWlucywgcm9ja3MsIHJ1aW5zLCBzYW5kcywgc2tlbGV0b24sIHRyZWVzLCB3YXRlclxufSBmcm9tICcuL3RpbGUtZGF0YS5qcydcblxuaW1wb3J0IHsgVGlsZU1hcCwgVGlsZU1hcENlbGwgfSBmcm9tICcuL3R5cGVzLmpzJ1xuXG4vLyBkb2Vzbid0IGhhdmUgdG8gYmUgZ29vZCwganVzdCBoYXMgdG8gYmUgb2sgZm9yIHRlc3RpbmdcbmV4cG9ydCBjb25zdCBnZW5lcmF0ZU1hcCA9ICh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikgPT4ge1xuICBjb25zdCBzaXplID0gd2lkdGggKiBoZWlnaHRcblxuICBjb25zdCBbX3R5cGUsIF9uYW1lLCAuLi53YXRlckZyYW1lc10gPSB3YXRlclxuXG4gIGNvbnN0IHdhdGVyQW5pbSA9IGFuaW1hdG9yKHdhdGVyRnJhbWVzKVxuXG4gIGNvbnN0IHRpbGVNYXA6IFRpbGVNYXAgPSB7XG4gICAgd2lkdGgsIGhlaWdodCxcbiAgICBkYXRhOiBBcnJheTxUaWxlTWFwQ2VsbD4oc2l6ZSkuZmlsbCh3YXRlckFuaW0pXG4gIH1cblxuICBjb25zdCBibG9ja2luZyA9IG5ldyBTZXQ8VGlsZU1hcENlbGw+KClcblxuICBjb25zdCBpbmRleE1hcCA9IG5ldyBNYXA8bnVtYmVyLCBUMj4oKVxuXG4gIGNvbnN0IGxhbmRDb3VudCA9IE1hdGguZmxvb3Ioc2l6ZSAqIDAuNylcblxuICBjb25zdCBsYW5kSW5kaWNlcyA9IG5ldyBTZXQ8bnVtYmVyPigpXG4gIGNvbnN0IGxhbmRJbmRpY2VzQXJyOiBudW1iZXJbXSA9IFtdXG5cbiAgbGV0IGxhbmRQbGFjZWQgPSAwXG5cbiAgbGV0IGN1cnJlbnRMYW5kOiBUMiA9IFtNYXRoLmZsb29yKHdpZHRoIC8gMiksIE1hdGguZmxvb3IoaGVpZ2h0IC8gMildXG5cbiAgY29uc3QgY2FuUGxhY2VMYW5kID0gKFt4LCB5XTogVDIpID0+IHtcbiAgICAvLyBsZWF2ZSBlZGdlcyBjbGVhciBmb3Igd2F0ZXJcbiAgICBpZiAoeCA9PT0gMCkgcmV0dXJuIGZhbHNlXG4gICAgaWYgKHkgPT09IDApIHJldHVybiBmYWxzZVxuICAgIGlmICh4ID09PSB3aWR0aCAtIDEpIHJldHVybiBmYWxzZVxuICAgIGlmICh5ID09PSBoZWlnaHQgLSAxKSByZXR1cm4gZmFsc2VcblxuICAgIGNvbnN0IGkgPSB5ICogd2lkdGggKyB4XG5cbiAgICAvLyBjYW4ndCBhbHJlYWR5IGJlIGxhbmRcbiAgICByZXR1cm4gIWxhbmRJbmRpY2VzLmhhcyhpKVxuICB9XG5cbiAgY29uc3QgbWF4VHJpZXMgPSAxMDBcblxuICBjb25zdCBhZGRMYW5kID0gKCkgPT4ge1xuICAgIGxldCBbbHgsIGx5XSA9IGN1cnJlbnRMYW5kXG4gICAgbGV0IGxpID0gbHkgKiB3aWR0aCArIGx4XG5cbiAgICBpbmRleE1hcC5zZXQobGksIFtseCwgbHldKVxuICAgIGxhbmRJbmRpY2VzLmFkZChsaSlcbiAgICBsYW5kSW5kaWNlc0Fyci5wdXNoKGxpKVxuXG4gICAgbGV0IHRyaWVzID0gMFxuICAgIGxldCBuZWlnaGJvdXJzID0gZ2V0TmVpZ2hib3Vyc0NhcmRpbmFsKGN1cnJlbnRMYW5kKS5maWx0ZXIoY2FuUGxhY2VMYW5kKVxuXG4gICAgd2hpbGUgKG5laWdoYm91cnMubGVuZ3RoIDwgMSkge1xuICAgICAgY29uc3QgaSA9IHBpY2sobGFuZEluZGljZXNBcnIpXG4gICAgICBjb25zdCBleGlzdGluZ0xhbmQgPSBhc3NydChpbmRleE1hcC5nZXQoaSksIGBFeHBlY3RlZCBsYW5kIGF0ICR7aX1gKVxuXG4gICAgICBuZWlnaGJvdXJzID0gZ2V0TmVpZ2hib3Vyc0NhcmRpbmFsKGV4aXN0aW5nTGFuZCkuZmlsdGVyKGNhblBsYWNlTGFuZClcblxuICAgICAgdHJpZXMrK1xuXG4gICAgICBpZiAodHJpZXMgPj0gbWF4VHJpZXMpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ0ZhaWxlZCB0byBwbGFjZSBsYW5kJylcblxuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjdXJyZW50TGFuZCA9IHBpY2sobmVpZ2hib3VycylcblxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICB3aGlsZSAobGFuZFBsYWNlZCA8IGxhbmRDb3VudCkge1xuICAgIGlmICghYWRkTGFuZCgpKSBicmVha1xuXG4gICAgbGFuZFBsYWNlZCsrXG4gIH1cblxuICBjb25zdCBbLCAsIGdyYXNzU3RhcnQsIGdyYXNzQ291bnRdID0gZ3Jhc3Nlc1xuICBjb25zdCBbLCAsIHNhbmRTdGFydCwgc2FuZENvdW50XSA9IHNhbmRzXG4gIGNvbnN0IFssICwgcm9ja1N0YXJ0LCByb2NrQ291bnRdID0gcm9ja3NcbiAgY29uc3QgWywgLCB0cmVlU3RhcnQsIHRyZWVDb3VudF0gPSB0cmVlc1xuICBjb25zdCBbLCAsIHJ1aW5zU3RhcnQsIHJ1aW5zQ291bnRdID0gcnVpbnNcbiAgY29uc3QgWywgLCBtb3VudGFpblN0YXJ0LCBtb3VudGFpbkNvdW50XSA9IG1vdW50YWluc1xuXG4gIGNvbnN0IFssICwgaHV0SW5kZXhdID0gaHV0XG4gIGNvbnN0IFssICwgc2tlbGV0b25JbmRleF0gPSBza2VsZXRvblxuXG4gIGZvciAoY29uc3QgaSBvZiBsYW5kSW5kaWNlcykge1xuICAgIGNvbnN0IGdyYXNzID0gcmFuZEludChncmFzc0NvdW50KSArIGdyYXNzU3RhcnRcblxuICAgIHRpbGVNYXAuZGF0YVtpXSA9IGdyYXNzXG4gIH1cblxuICBmb3IgKGNvbnN0IGkgb2YgbGFuZEluZGljZXMpIHtcbiAgICBpZiAodGlsZU1hcC5kYXRhW2ldID09PSB3YXRlckFuaW0pIGNvbnRpbnVlXG5cbiAgICBjb25zdCBwdCA9IGFzc3J0KGluZGV4TWFwLmdldChpKSwgYEV4cGVjdGVkIHBvaW50IGF0ICR7aX1gKVxuXG4gICAgbGV0IHNlYU5laWdoYm91cnMgPSAwXG5cbiAgICBjb25zdCBuZWlnaGJvdXJzID0gZ2V0TmVpZ2hib3Vyc0FsbChwdClcblxuICAgIGZvciAoY29uc3QgbiBvZiBuZWlnaGJvdXJzKSB7XG4gICAgICBjb25zdCBbbngsIG55XSA9IG5cblxuICAgICAgaWYgKG54IDwgMCB8fCBueCA+PSB3aWR0aCB8fCBueSA8IDAgfHwgbnkgPj0gaGVpZ2h0KSBjb250aW51ZVxuXG4gICAgICBjb25zdCBuaSA9IG55ICogd2lkdGggKyBueFxuXG4gICAgICBpZiAodGlsZU1hcC5kYXRhW25pXSA9PT0gd2F0ZXJBbmltKSBzZWFOZWlnaGJvdXJzKytcbiAgICB9XG5cbiAgICBpZiAoc2VhTmVpZ2hib3VycyA+IDApIHtcbiAgICAgIGNvbnN0IHNhbmQgPSByYW5kSW50KHNhbmRDb3VudCkgKyBzYW5kU3RhcnRcblxuICAgICAgdGlsZU1hcC5kYXRhW2ldID0gc2FuZFxuXG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGlmICghcmFuZEludCgxMCkpIHtcbiAgICAgIGNvbnN0IHJvY2sgPSByYW5kSW50KHJvY2tDb3VudCkgKyByb2NrU3RhcnRcblxuICAgICAgdGlsZU1hcC5kYXRhW2ldID0gcm9ja1xuXG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGlmICghcmFuZEludCgxMCkpIHtcbiAgICAgIGNvbnN0IHRyZWUgPSByYW5kSW50KHRyZWVDb3VudCkgKyB0cmVlU3RhcnRcblxuICAgICAgdGlsZU1hcC5kYXRhW2ldID0gdHJlZVxuXG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGlmICghcmFuZEludCgxMDApKSB7XG4gICAgICBjb25zdCBydWlucyA9IHJhbmRJbnQocnVpbnNDb3VudCkgKyBydWluc1N0YXJ0XG5cbiAgICAgIHRpbGVNYXAuZGF0YVtpXSA9IHJ1aW5zXG5cbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgaWYgKCFyYW5kSW50KDUwKSkge1xuICAgICAgY29uc3QgbW91bnRhaW4gPSByYW5kSW50KG1vdW50YWluQ291bnQpICsgbW91bnRhaW5TdGFydFxuXG4gICAgICB0aWxlTWFwLmRhdGFbaV0gPSBtb3VudGFpblxuXG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGlmICghcmFuZEludCg1MDApKSB7XG4gICAgICB0aWxlTWFwLmRhdGFbaV0gPSBodXRJbmRleFxuXG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGlmICghcmFuZEludCgxMDAwKSkge1xuICAgICAgdGlsZU1hcC5kYXRhW2ldID0gc2tlbGV0b25JbmRleFxuXG4gICAgICBjb250aW51ZVxuICAgIH1cbiAgfVxuXG4gIGJsb2NraW5nLmFkZCh3YXRlckFuaW0pXG4gIC8vIHRyZWVzXG4gIGZvciAobGV0IGkgPSB0cmVlU3RhcnQ7IGkgPCB0cmVlU3RhcnQgKyB0cmVlQ291bnQ7IGkrKykge1xuICAgIGJsb2NraW5nLmFkZChpKVxuICB9XG4gIC8vIG1vdW50YWluc1xuICBmb3IgKGxldCBpID0gbW91bnRhaW5TdGFydDsgaSA8IG1vdW50YWluU3RhcnQgKyBtb3VudGFpbkNvdW50OyBpKyspIHtcbiAgICBibG9ja2luZy5hZGQoaSlcbiAgfVxuXG4gIHJldHVybiB7IHRpbGVNYXAsIGJsb2NraW5nIH1cbn1cbiJdfQ==
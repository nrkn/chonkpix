import { lineToRows, rectToRows, triangleToRows } from '../lib/image/rows.js';
import { polygonTriangles } from '../sandbox/util.js';
import { takeMouse, releaseMouse } from '../lib/engine.js';
import { blit, blitRows } from '../lib/image/blit.js';
import { bresenhamLine } from '../lib/image/bresenham.js';
import { colorToRgba, createColor, generateHues, sampleGradient } from '../lib/image/color.js';
import { composite } from '../lib/image/composite.js';
import { fill, fillCol, fillIndices, fillRows } from '../lib/image/fill.js';
import { loadImage } from '../lib/image/load.js';
import { drawRotated } from '../lib/image/rotate.js';
import { pointsToIndices } from '../lib/image/util.js';
import { generateGridLayout, generateNamedGridLayout } from '../lib/grid/index.js';
import { rowQuery } from '../lib/image/query.js';
import { createImage } from '../lib/image/create.js';
import { limitedLogger, maybe } from '../lib/util.js';
const readAlpha = (state, ch, destroy = false) => {
    const upper = ch.toUpperCase();
    const lower = ch.toLowerCase();
    const keys = state.getKeys();
    const alpha = keys[upper] ? upper : keys[lower] ? lower : null;
    if (destroy && alpha) {
        keys[alpha] = false;
    }
    return alpha;
};
export const debugScene = () => {
    let testImg0;
    let pattern0;
    let cursor;
    let pattern0Rows;
    const patternColors = generateHues(8);
    const patternColorImage = createImage(8, 8);
    for (let x = 0; x < 8; x++) {
        const color = patternColors[x];
        fillCol(patternColorImage, color, x);
    }
    const minPolySides = 3;
    const maxPolySides = 128;
    // enough for one run through, then stop logging, otherwise we flood console
    // calling *every* frame
    const gradientLogger = limitedLogger(32);
    let polySides = 5;
    let polyRotation = 0;
    let strokePoly = false;
    let isActive = true;
    const init = async (_state) => {
        console.log('starting debug scene');
        testImg0 = await loadImage('scenes/debug/test-0.png');
        pattern0 = await loadImage('scenes/debug/pattern-0.png');
        cursor = await loadImage('scenes/debug/cursor.png');
        polyRotation = 0;
        pattern0Rows = rowQuery(pattern0, r => r === 0);
        console.log('pattern0Rows', pattern0Rows);
        takeMouse();
    };
    const bgColor0 = [0x33, 0x99, 0xff];
    const bgColor1 = [0x11, 0x77, 0xdd];
    const paintColor = [0xff, 0x88, 0x00];
    let painting = false;
    let lastPaintX = null;
    let lastPaintY = null;
    // nb - these are retained even when the scene exits and restarts
    // as a test for scenes holding state between runs
    //
    // if this is not desired, state should be reset in init or quit on each run
    //
    const paintPts = {};
    const getPaintRow = (y) => (paintPts[y] || (paintPts[y] = {}));
    const addPaintPt = (x, y) => {
        // you get gaps if you move the mouse quickly, so interpolate between last 
        // point and this point
        if (maybe(lastPaintX) && maybe(lastPaintY)) {
            const line = bresenhamLine(lastPaintX, lastPaintY, x, y);
            for (const [x, y] of line) {
                getPaintRow(y)[x] = true;
            }
        }
        else {
            getPaintRow(y)[x] = true;
        }
        lastPaintX = x;
        lastPaintY = y;
    };
    let frame = 0;
    const _handleKeys = (state) => {
        const keys = state.getKeys();
        if (keys['Escape']) {
            state.setRunning(false);
            // consume the key
            keys['Escape'] = false;
            return;
        }
        if (keys['ArrowUp']) {
            polySides--;
            keys['ArrowUp'] = false;
        }
        if (keys['ArrowDown']) {
            polySides++;
            keys['ArrowDown'] = false;
        }
        const sState = readAlpha(state, 'S', true);
        if (sState) {
            strokePoly = !strokePoly;
        }
    };
    const update = (state) => {
        if (isActive) {
            _handleKeys(state);
            polySides = Math.min(Math.max(polySides, minPolySides), maxPolySides);
            // capture a reference - it is a destructive read
            const wheel = state.mouse.getWheel();
            const zoom = state.view.getZoom();
            if (wheel < 0) {
                state.view.setZoom(zoom + 1);
            }
            else if (wheel > 0) {
                state.view.setZoom(zoom - 1);
            }
            // maybe paint
            if (state.mouse.getButtons()[0]) {
                addPaintPt(state.mouse.getX(), state.mouse.getY());
                painting = true;
            }
            else if (painting) {
                painting = false;
                lastPaintX = null;
                lastPaintY = null;
            }
        }
        const buffer = state.view.getBuffer();
        const { width, height } = buffer;
        // not very efficent - plenty of faster ways to do this - but that's a good
        // thing, we're trying to stuff as much into the debug scene as possible
        // so we can give it a bit of a stress test
        //
        // even with everything we're doing still comfortably runs at 60fps tho!
        for (let y = 0; y < height; y++) {
            const row = y * width;
            for (let x = 0; x < width; x++) {
                const index = row + x;
                const dataIndex = index * 4;
                const isPaint = paintPts[y] && paintPts[y][x];
                if (isPaint) {
                    buffer.data[dataIndex] = paintColor[0];
                    buffer.data[dataIndex + 1] = paintColor[1];
                    buffer.data[dataIndex + 2] = paintColor[2];
                    buffer.data[dataIndex + 3] = 0xff;
                    continue;
                }
                const isCheck = (x + y) % 2 === 0;
                buffer.data[dataIndex] = isCheck ? bgColor0[0] : bgColor1[0];
                buffer.data[dataIndex + 1] = isCheck ? bgColor0[1] : bgColor1[1];
                buffer.data[dataIndex + 2] = isCheck ? bgColor0[2] : bgColor1[2];
                buffer.data[dataIndex + 3] = 0xff;
            }
        }
        // sprites, blitting, composite etc
        // a0..b7    
        const testGrid = generateNamedGridLayout(generateGridLayout(32, 32, 2, 8, 1, 1));
        const { width: gw } = testGrid;
        const offX = width - gw;
        const offY = 0;
        // straight blit
        const { a0 } = testGrid;
        const a0X = a0[0] + offX;
        const a0Y = a0[1] + offY;
        blit(testImg0, buffer, [0, 0, testImg0.width, testImg0.height, a0X, a0Y]);
        // testing oob on src
        const { b0 } = testGrid;
        const b0X = b0[0] + offX - 16;
        const b0Y = b0[1] + offY - 16;
        blit(testImg0, buffer, [
            -16, -16, testImg0.width + 32, testImg0.height + 32,
            b0X, b0Y
        ]);
        // alpha composite
        const { a1 } = testGrid;
        const a1X = a1[0] + offX;
        const a1Y = a1[1] + offY;
        composite(testImg0, buffer, [0, 0, testImg0.width, testImg0.height, a1X, a1Y], 0.5);
        // oob on dest
        const { b1 } = testGrid;
        const b1X = b1[0] + offX + 16;
        const b1Y = b1[1] + offY;
        blit(testImg0, buffer, [
            0, 0, testImg0.width, testImg0.height,
            b1X, b1Y
        ]);
        // color fill
        const { a2 } = testGrid;
        const a2X = a2[0] + offX;
        const a2Y = a2[1] + offY;
        const color = createColor(0x6c, 0x28, 0xbc);
        fill(buffer, color, [a2X, a2Y, testImg0.width, testImg0.height]);
        // sprite rotation
        const { b2 } = testGrid;
        const b2X = b2[0] + offX + testImg0.width / 2;
        const b2Y = b2[1] + offY + testImg0.height / 2;
        drawRotated(testImg0, testImg0.width / 2, testImg0.height / 2, buffer, b2X, b2Y, polyRotation);
        // blitRows test
        const { a3 } = testGrid;
        const a3X = a3[0] + offX;
        const a3Y = a3[1] + offY;
        fill(buffer, createColor(0, 0, 0), [a3X, a3Y, pattern0.width, pattern0.height]);
        blitRows(patternColorImage, pattern0Rows, buffer, a3X, a3Y);
        // gradient test
        const { b3 } = testGrid;
        const b3X = b3[0] + offX;
        const b3Y = b3[1] + offY;
        const gColors0 = generateHues(6);
        const step0 = 1 / (gColors0.length - 1);
        const gStops0 = gColors0.map((c, i) => {
            const rgba = colorToRgba(c);
            return [...rgba, i * step0];
        });
        const gImage0 = createImage(32, 32);
        for (let x = 0; x < gImage0.width; x++) {
            const at = x / (gImage0.width - 1);
            const rgba = sampleGradient(gStops0, at);
            const color = createColor(...rgba);
            fillCol(gImage0, color, x);
        }
        blit(gImage0, buffer, [0, 0, gImage0.width, gImage0.height, b3X, b3Y]);
        // gradient test 2, alpha + composite
        const { a4 } = testGrid;
        const a4X = a4[0] + offX;
        const a4Y = a4[1] + offY;
        const gColors1 = gColors0.slice().reverse();
        const step1 = 1 / (gColors1.length - 1);
        const gstops1 = gColors1.map((c, i) => {
            const [r, g, b] = colorToRgba(c);
            const a = i * step1 * 255;
            return [r, g, b, a, i * step1];
        });
        const gImage1 = createImage(32, 32);
        for (let x = 0; x < gImage1.width; x++) {
            const at = x / (gImage1.width - 1);
            const rgba = sampleGradient(gstops1, at);
            const color = createColor(...rgba);
            gradientLogger.log('gradient', x, rgba);
            fillCol(gImage1, color, x);
        }
        composite(gImage1, buffer, [0, 0, gImage1.width, gImage1.height, a4X, a4Y]);
        // horizontally sloping line
        const testLineColor = createColor(0x33, 0xff, 0x99);
        const testLine = [-32, height / 2 - 32, width + 32, height / 2 + 32];
        // nb - this is only faster with the right slope - otherwise it is slower
        // it is better to use bresenham for the general case
        const testLineRows = lineToRows(...testLine);
        fillRows(testLineRows, buffer, testLineColor);
        // rect via rows
        const rectColor = createColor(0xff, 0x99, 0x33);
        const testRect = [48, 48, 32, 24];
        const testRectRows = rectToRows(...testRect);
        fillRows(testRectRows, buffer, rectColor);
        // polygon
        const minSide = Math.min(width, height);
        const fillColors = generateHues(polySides);
        const shape = polygonTriangles(polySides, width / 2, height / 2, minSide / 4, polyRotation);
        const frameTime = state.time.getFrameTime();
        const rotateBy = 0.001 * frameTime;
        const strokeLine = (line, color) => {
            const pts = bresenhamLine(...line);
            const indices = pointsToIndices(width, height, 1)(pts);
            fillIndices(indices, buffer, color);
        };
        const strokeTri = (tri, color) => {
            const line0 = [tri[0][0], tri[0][1], tri[1][0], tri[1][1]];
            const line1 = [tri[1][0], tri[1][1], tri[2][0], tri[2][1]];
            const line2 = [tri[2][0], tri[2][1], tri[0][0], tri[0][1]];
            strokeLine(line0, color);
            strokeLine(line1, color);
            strokeLine(line2, color);
        };
        for (let i = 0; i < polySides; i++) {
            const color = fillColors[i % fillColors.length];
            const tri = shape[i];
            const ptriRows = triangleToRows(...tri);
            fillRows(ptriRows, buffer, color);
        }
        const strokeColors = strokePoly ? generateHues(polySides, 50) : fillColors;
        for (let i = 0; i < polySides; i++) {
            const color = strokeColors[i % strokeColors.length];
            const tri = shape[i];
            strokeTri(tri, color);
        }
        // show custom cursor
        if (state.mouse.isInBounds()) {
            composite(cursor, buffer, [0, 0, cursor.width, cursor.height, state.mouse.getX(), state.mouse.getY()]);
        }
        //
        polyRotation += rotateBy;
        frame++;
    };
    const quit = async (state) => {
        console.log('quitting debug scene');
        releaseMouse();
    };
    const setActive = (active) => {
        // we just got focus
        if (active && !isActive) {
            takeMouse();
        }
        // we just lost focus 
        if (!active && isActive) {
            releaseMouse();
        }
        isActive = active;
    };
    return { init, update, quit, setActive };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVidWctc2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2NlbmVzL2RlYnVnLXNjZW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQzdFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDMUQsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUNyRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMkJBQTJCLENBQUE7QUFDekQsT0FBTyxFQUNMLFdBQVcsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFDdkQsTUFBTSx1QkFBdUIsQ0FBQTtBQUM5QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sMkJBQTJCLENBQUE7QUFDckQsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQzNFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUNoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFDcEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBRXRELE9BQU8sRUFDTCxrQkFBa0IsRUFBRSx1QkFBdUIsRUFDNUMsTUFBTSxzQkFBc0IsQ0FBQTtBQUU3QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFDaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ3BELE9BQU8sRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7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Q25CLENBQUMsQ0FBQTtJQUVELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQTtBQUMxQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsaW5lVG9Sb3dzLCByZWN0VG9Sb3dzLCB0cmlhbmdsZVRvUm93cyB9IGZyb20gJy4uL2xpYi9pbWFnZS9yb3dzLmpzJ1xyXG5pbXBvcnQgeyBwb2x5Z29uVHJpYW5nbGVzIH0gZnJvbSAnLi4vc2FuZGJveC91dGlsLmpzJ1xyXG5pbXBvcnQgeyB0YWtlTW91c2UsIHJlbGVhc2VNb3VzZSB9IGZyb20gJy4uL2xpYi9lbmdpbmUuanMnXHJcbmltcG9ydCB7IGJsaXQsIGJsaXRSb3dzIH0gZnJvbSAnLi4vbGliL2ltYWdlL2JsaXQuanMnXHJcbmltcG9ydCB7IGJyZXNlbmhhbUxpbmUgfSBmcm9tICcuLi9saWIvaW1hZ2UvYnJlc2VuaGFtLmpzJ1xyXG5pbXBvcnQge1xyXG4gIGNvbG9yVG9SZ2JhLCBjcmVhdGVDb2xvciwgZ2VuZXJhdGVIdWVzLCBzYW1wbGVHcmFkaWVudFxyXG59IGZyb20gJy4uL2xpYi9pbWFnZS9jb2xvci5qcydcclxuaW1wb3J0IHsgY29tcG9zaXRlIH0gZnJvbSAnLi4vbGliL2ltYWdlL2NvbXBvc2l0ZS5qcydcclxuaW1wb3J0IHsgZmlsbCwgZmlsbENvbCwgZmlsbEluZGljZXMsIGZpbGxSb3dzIH0gZnJvbSAnLi4vbGliL2ltYWdlL2ZpbGwuanMnXHJcbmltcG9ydCB7IGxvYWRJbWFnZSB9IGZyb20gJy4uL2xpYi9pbWFnZS9sb2FkLmpzJ1xyXG5pbXBvcnQgeyBkcmF3Um90YXRlZCB9IGZyb20gJy4uL2xpYi9pbWFnZS9yb3RhdGUuanMnXHJcbmltcG9ydCB7IHBvaW50c1RvSW5kaWNlcyB9IGZyb20gJy4uL2xpYi9pbWFnZS91dGlsLmpzJ1xyXG5pbXBvcnQgeyBNYXliZSwgU2NlbmUsIFN0YXRlLCBUMiwgVDMsIFQ0LCBUNSB9IGZyb20gJy4uL2xpYi90eXBlcy5qcydcclxuaW1wb3J0IHtcclxuICBnZW5lcmF0ZUdyaWRMYXlvdXQsIGdlbmVyYXRlTmFtZWRHcmlkTGF5b3V0XHJcbn0gZnJvbSAnLi4vbGliL2dyaWQvaW5kZXguanMnXHJcbmltcG9ydCB7IFJvdyB9IGZyb20gJy4uL2xpYi9pbWFnZS90eXBlcy5qcydcclxuaW1wb3J0IHsgcm93UXVlcnkgfSBmcm9tICcuLi9saWIvaW1hZ2UvcXVlcnkuanMnXHJcbmltcG9ydCB7IGNyZWF0ZUltYWdlIH0gZnJvbSAnLi4vbGliL2ltYWdlL2NyZWF0ZS5qcydcclxuaW1wb3J0IHsgbGltaXRlZExvZ2dlciwgbWF5YmUgfSBmcm9tICcuLi9saWIvdXRpbC5qcydcclxuXHJcbmNvbnN0IHJlYWRBbHBoYSA9IChzdGF0ZTogU3RhdGUsIGNoOiBzdHJpbmcsIGRlc3Ryb3kgPSBmYWxzZSkgPT4ge1xyXG4gIGNvbnN0IHVwcGVyID0gY2gudG9VcHBlckNhc2UoKVxyXG4gIGNvbnN0IGxvd2VyID0gY2gudG9Mb3dlckNhc2UoKVxyXG5cclxuICBjb25zdCBrZXlzID0gc3RhdGUuZ2V0S2V5cygpXHJcblxyXG4gIGNvbnN0IGFscGhhID0ga2V5c1t1cHBlcl0gPyB1cHBlciA6IGtleXNbbG93ZXJdID8gbG93ZXIgOiBudWxsXHJcblxyXG4gIGlmIChkZXN0cm95ICYmIGFscGhhKSB7XHJcbiAgICBrZXlzW2FscGhhXSA9IGZhbHNlXHJcbiAgfVxyXG5cclxuICByZXR1cm4gYWxwaGFcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGRlYnVnU2NlbmUgPSAoKTogU2NlbmUgPT4ge1xyXG4gIGxldCB0ZXN0SW1nMDogSW1hZ2VEYXRhXHJcbiAgbGV0IHBhdHRlcm4wOiBJbWFnZURhdGFcclxuICBsZXQgY3Vyc29yOiBJbWFnZURhdGFcclxuXHJcbiAgbGV0IHBhdHRlcm4wUm93czogUm93PG5ldmVyPltdXHJcbiAgY29uc3QgcGF0dGVybkNvbG9ycyA9IGdlbmVyYXRlSHVlcyg4KVxyXG4gIGNvbnN0IHBhdHRlcm5Db2xvckltYWdlID0gY3JlYXRlSW1hZ2UoOCwgOClcclxuXHJcbiAgZm9yIChsZXQgeCA9IDA7IHggPCA4OyB4KyspIHtcclxuICAgIGNvbnN0IGNvbG9yID0gcGF0dGVybkNvbG9yc1t4XVxyXG5cclxuICAgIGZpbGxDb2wocGF0dGVybkNvbG9ySW1hZ2UsIGNvbG9yLCB4KVxyXG4gIH1cclxuXHJcbiAgY29uc3QgbWluUG9seVNpZGVzID0gM1xyXG4gIGNvbnN0IG1heFBvbHlTaWRlcyA9IDEyOFxyXG5cclxuICAvLyBlbm91Z2ggZm9yIG9uZSBydW4gdGhyb3VnaCwgdGhlbiBzdG9wIGxvZ2dpbmcsIG90aGVyd2lzZSB3ZSBmbG9vZCBjb25zb2xlXHJcbiAgLy8gY2FsbGluZyAqZXZlcnkqIGZyYW1lXHJcbiAgY29uc3QgZ3JhZGllbnRMb2dnZXIgPSBsaW1pdGVkTG9nZ2VyKDMyKVxyXG5cclxuICBsZXQgcG9seVNpZGVzID0gNVxyXG4gIGxldCBwb2x5Um90YXRpb24gPSAwXHJcbiAgbGV0IHN0cm9rZVBvbHkgPSBmYWxzZVxyXG5cclxuICBsZXQgaXNBY3RpdmUgPSB0cnVlXHJcblxyXG4gIGNvbnN0IGluaXQgPSBhc3luYyAoX3N0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgY29uc29sZS5sb2coJ3N0YXJ0aW5nIGRlYnVnIHNjZW5lJylcclxuXHJcbiAgICB0ZXN0SW1nMCA9IGF3YWl0IGxvYWRJbWFnZSgnc2NlbmVzL2RlYnVnL3Rlc3QtMC5wbmcnKVxyXG4gICAgcGF0dGVybjAgPSBhd2FpdCBsb2FkSW1hZ2UoJ3NjZW5lcy9kZWJ1Zy9wYXR0ZXJuLTAucG5nJylcclxuICAgIGN1cnNvciA9IGF3YWl0IGxvYWRJbWFnZSgnc2NlbmVzL2RlYnVnL2N1cnNvci5wbmcnKVxyXG5cclxuICAgIHBvbHlSb3RhdGlvbiA9IDBcclxuXHJcbiAgICBwYXR0ZXJuMFJvd3MgPSByb3dRdWVyeShwYXR0ZXJuMCwgciA9PiByID09PSAwKVxyXG5cclxuICAgIGNvbnNvbGUubG9nKCdwYXR0ZXJuMFJvd3MnLCBwYXR0ZXJuMFJvd3MpXHJcblxyXG4gICAgdGFrZU1vdXNlKClcclxuICB9XHJcblxyXG4gIGNvbnN0IGJnQ29sb3IwOiBUMyA9IFsweDMzLCAweDk5LCAweGZmXVxyXG4gIGNvbnN0IGJnQ29sb3IxOiBUMyA9IFsweDExLCAweDc3LCAweGRkXVxyXG5cclxuICBjb25zdCBwYWludENvbG9yOiBUMyA9IFsweGZmLCAweDg4LCAweDAwXVxyXG4gIGxldCBwYWludGluZyA9IGZhbHNlXHJcbiAgbGV0IGxhc3RQYWludFg6IE1heWJlPG51bWJlcj4gPSBudWxsXHJcbiAgbGV0IGxhc3RQYWludFk6IE1heWJlPG51bWJlcj4gPSBudWxsXHJcblxyXG4gIC8vIG5iIC0gdGhlc2UgYXJlIHJldGFpbmVkIGV2ZW4gd2hlbiB0aGUgc2NlbmUgZXhpdHMgYW5kIHJlc3RhcnRzXHJcbiAgLy8gYXMgYSB0ZXN0IGZvciBzY2VuZXMgaG9sZGluZyBzdGF0ZSBiZXR3ZWVuIHJ1bnNcclxuICAvL1xyXG4gIC8vIGlmIHRoaXMgaXMgbm90IGRlc2lyZWQsIHN0YXRlIHNob3VsZCBiZSByZXNldCBpbiBpbml0IG9yIHF1aXQgb24gZWFjaCBydW5cclxuICAvL1xyXG4gIGNvbnN0IHBhaW50UHRzOiBSZWNvcmQ8bnVtYmVyLCBNYXliZTxSZWNvcmQ8bnVtYmVyLCBNYXliZTxib29sZWFuPj4+PiA9IHt9XHJcblxyXG4gIGNvbnN0IGdldFBhaW50Um93ID0gKHk6IG51bWJlcikgPT4gKHBhaW50UHRzW3ldIHx8IChwYWludFB0c1t5XSA9IHt9KSlcclxuXHJcbiAgY29uc3QgYWRkUGFpbnRQdCA9ICh4OiBudW1iZXIsIHk6IG51bWJlcikgPT4ge1xyXG4gICAgLy8geW91IGdldCBnYXBzIGlmIHlvdSBtb3ZlIHRoZSBtb3VzZSBxdWlja2x5LCBzbyBpbnRlcnBvbGF0ZSBiZXR3ZWVuIGxhc3QgXHJcbiAgICAvLyBwb2ludCBhbmQgdGhpcyBwb2ludFxyXG4gICAgaWYgKG1heWJlKGxhc3RQYWludFgpICYmIG1heWJlKGxhc3RQYWludFkpKSB7XHJcbiAgICAgIGNvbnN0IGxpbmUgPSBicmVzZW5oYW1MaW5lKGxhc3RQYWludFgsIGxhc3RQYWludFksIHgsIHkpXHJcblxyXG4gICAgICBmb3IgKGNvbnN0IFt4LCB5XSBvZiBsaW5lKSB7XHJcbiAgICAgICAgZ2V0UGFpbnRSb3coeSlbeF0gPSB0cnVlXHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGdldFBhaW50Um93KHkpW3hdID0gdHJ1ZVxyXG4gICAgfVxyXG5cclxuICAgIGxhc3RQYWludFggPSB4XHJcbiAgICBsYXN0UGFpbnRZID0geVxyXG4gIH1cclxuXHJcbiAgbGV0IGZyYW1lID0gMFxyXG5cclxuICBjb25zdCBfaGFuZGxlS2V5cyA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnN0IGtleXMgPSBzdGF0ZS5nZXRLZXlzKClcclxuXHJcbiAgICBpZiAoa2V5c1snRXNjYXBlJ10pIHtcclxuICAgICAgc3RhdGUuc2V0UnVubmluZyhmYWxzZSlcclxuXHJcbiAgICAgIC8vIGNvbnN1bWUgdGhlIGtleVxyXG4gICAgICBrZXlzWydFc2NhcGUnXSA9IGZhbHNlXHJcblxyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICBpZiAoa2V5c1snQXJyb3dVcCddKSB7XHJcbiAgICAgIHBvbHlTaWRlcy0tXHJcblxyXG4gICAgICBrZXlzWydBcnJvd1VwJ10gPSBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChrZXlzWydBcnJvd0Rvd24nXSkge1xyXG4gICAgICBwb2x5U2lkZXMrK1xyXG5cclxuICAgICAga2V5c1snQXJyb3dEb3duJ10gPSBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHNTdGF0ZSA9IHJlYWRBbHBoYShzdGF0ZSwgJ1MnLCB0cnVlKVxyXG5cclxuICAgIGlmIChzU3RhdGUpIHtcclxuICAgICAgc3Ryb2tlUG9seSA9ICFzdHJva2VQb2x5XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCB1cGRhdGUgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpZiAoaXNBY3RpdmUpIHtcclxuICAgICAgX2hhbmRsZUtleXMoc3RhdGUpXHJcblxyXG4gICAgICBwb2x5U2lkZXMgPSBNYXRoLm1pbihNYXRoLm1heChwb2x5U2lkZXMsIG1pblBvbHlTaWRlcyksIG1heFBvbHlTaWRlcylcclxuXHJcbiAgICAgIC8vIGNhcHR1cmUgYSByZWZlcmVuY2UgLSBpdCBpcyBhIGRlc3RydWN0aXZlIHJlYWRcclxuICAgICAgY29uc3Qgd2hlZWwgPSBzdGF0ZS5tb3VzZS5nZXRXaGVlbCgpXHJcbiAgICAgIGNvbnN0IHpvb20gPSBzdGF0ZS52aWV3LmdldFpvb20oKVxyXG5cclxuICAgICAgaWYgKHdoZWVsIDwgMCkge1xyXG4gICAgICAgIHN0YXRlLnZpZXcuc2V0Wm9vbSggem9vbSArIDEgKVxyXG4gICAgICB9IGVsc2UgaWYgKHdoZWVsID4gMCkge1xyXG4gICAgICAgIHN0YXRlLnZpZXcuc2V0Wm9vbSggem9vbSAtIDEgKVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBtYXliZSBwYWludFxyXG4gICAgICBpZiAoc3RhdGUubW91c2UuZ2V0QnV0dG9ucygpWzBdKSB7XHJcbiAgICAgICAgYWRkUGFpbnRQdChzdGF0ZS5tb3VzZS5nZXRYKCksIHN0YXRlLm1vdXNlLmdldFkoKSlcclxuICAgICAgICBwYWludGluZyA9IHRydWVcclxuICAgICAgfSBlbHNlIGlmIChwYWludGluZykge1xyXG4gICAgICAgIHBhaW50aW5nID0gZmFsc2VcclxuICAgICAgICBsYXN0UGFpbnRYID0gbnVsbFxyXG4gICAgICAgIGxhc3RQYWludFkgPSBudWxsXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBidWZmZXIgPSBzdGF0ZS52aWV3LmdldEJ1ZmZlcigpXHJcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IGJ1ZmZlclxyXG5cclxuICAgIC8vIG5vdCB2ZXJ5IGVmZmljZW50IC0gcGxlbnR5IG9mIGZhc3RlciB3YXlzIHRvIGRvIHRoaXMgLSBidXQgdGhhdCdzIGEgZ29vZFxyXG4gICAgLy8gdGhpbmcsIHdlJ3JlIHRyeWluZyB0byBzdHVmZiBhcyBtdWNoIGludG8gdGhlIGRlYnVnIHNjZW5lIGFzIHBvc3NpYmxlXHJcbiAgICAvLyBzbyB3ZSBjYW4gZ2l2ZSBpdCBhIGJpdCBvZiBhIHN0cmVzcyB0ZXN0XHJcbiAgICAvL1xyXG4gICAgLy8gZXZlbiB3aXRoIGV2ZXJ5dGhpbmcgd2UncmUgZG9pbmcgc3RpbGwgY29tZm9ydGFibHkgcnVucyBhdCA2MGZwcyB0aG8hXHJcblxyXG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCBoZWlnaHQ7IHkrKykge1xyXG4gICAgICBjb25zdCByb3cgPSB5ICogd2lkdGhcclxuXHJcbiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgd2lkdGg7IHgrKykge1xyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gcm93ICsgeFxyXG4gICAgICAgIGNvbnN0IGRhdGFJbmRleCA9IGluZGV4ICogNFxyXG5cclxuICAgICAgICBjb25zdCBpc1BhaW50ID0gcGFpbnRQdHNbeV0gJiYgcGFpbnRQdHNbeV0hW3hdXHJcblxyXG4gICAgICAgIGlmIChpc1BhaW50KSB7XHJcbiAgICAgICAgICBidWZmZXIuZGF0YVtkYXRhSW5kZXhdID0gcGFpbnRDb2xvclswXVxyXG4gICAgICAgICAgYnVmZmVyLmRhdGFbZGF0YUluZGV4ICsgMV0gPSBwYWludENvbG9yWzFdXHJcbiAgICAgICAgICBidWZmZXIuZGF0YVtkYXRhSW5kZXggKyAyXSA9IHBhaW50Q29sb3JbMl1cclxuICAgICAgICAgIGJ1ZmZlci5kYXRhW2RhdGFJbmRleCArIDNdID0gMHhmZlxyXG5cclxuICAgICAgICAgIGNvbnRpbnVlXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpc0NoZWNrID0gKHggKyB5KSAlIDIgPT09IDBcclxuXHJcbiAgICAgICAgYnVmZmVyLmRhdGFbZGF0YUluZGV4XSA9IGlzQ2hlY2sgPyBiZ0NvbG9yMFswXSA6IGJnQ29sb3IxWzBdXHJcbiAgICAgICAgYnVmZmVyLmRhdGFbZGF0YUluZGV4ICsgMV0gPSBpc0NoZWNrID8gYmdDb2xvcjBbMV0gOiBiZ0NvbG9yMVsxXVxyXG4gICAgICAgIGJ1ZmZlci5kYXRhW2RhdGFJbmRleCArIDJdID0gaXNDaGVjayA/IGJnQ29sb3IwWzJdIDogYmdDb2xvcjFbMl1cclxuICAgICAgICBidWZmZXIuZGF0YVtkYXRhSW5kZXggKyAzXSA9IDB4ZmZcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHNwcml0ZXMsIGJsaXR0aW5nLCBjb21wb3NpdGUgZXRjXHJcblxyXG4gICAgLy8gYTAuLmI3ICAgIFxyXG4gICAgY29uc3QgdGVzdEdyaWQgPSBnZW5lcmF0ZU5hbWVkR3JpZExheW91dChcclxuICAgICAgZ2VuZXJhdGVHcmlkTGF5b3V0KDMyLCAzMiwgMiwgOCwgMSwgMSlcclxuICAgIClcclxuXHJcbiAgICBjb25zdCB7IHdpZHRoOiBndyB9ID0gdGVzdEdyaWRcclxuXHJcbiAgICBjb25zdCBvZmZYID0gd2lkdGggLSBnd1xyXG4gICAgY29uc3Qgb2ZmWSA9IDBcclxuXHJcbiAgICAvLyBzdHJhaWdodCBibGl0XHJcblxyXG4gICAgY29uc3QgeyBhMCB9ID0gdGVzdEdyaWRcclxuICAgIGNvbnN0IGEwWCA9IGEwWzBdICsgb2ZmWFxyXG4gICAgY29uc3QgYTBZID0gYTBbMV0gKyBvZmZZXHJcblxyXG4gICAgYmxpdCh0ZXN0SW1nMCwgYnVmZmVyLCBbMCwgMCwgdGVzdEltZzAud2lkdGgsIHRlc3RJbWcwLmhlaWdodCwgYTBYLCBhMFldKVxyXG5cclxuICAgIC8vIHRlc3Rpbmcgb29iIG9uIHNyY1xyXG5cclxuICAgIGNvbnN0IHsgYjAgfSA9IHRlc3RHcmlkXHJcbiAgICBjb25zdCBiMFggPSBiMFswXSArIG9mZlggLSAxNlxyXG4gICAgY29uc3QgYjBZID0gYjBbMV0gKyBvZmZZIC0gMTZcclxuXHJcbiAgICBibGl0KFxyXG4gICAgICB0ZXN0SW1nMCwgYnVmZmVyLFxyXG4gICAgICBbXHJcbiAgICAgICAgLTE2LCAtMTYsIHRlc3RJbWcwLndpZHRoICsgMzIsIHRlc3RJbWcwLmhlaWdodCArIDMyLFxyXG4gICAgICAgIGIwWCwgYjBZXHJcbiAgICAgIF1cclxuICAgIClcclxuXHJcbiAgICAvLyBhbHBoYSBjb21wb3NpdGVcclxuXHJcbiAgICBjb25zdCB7IGExIH0gPSB0ZXN0R3JpZFxyXG4gICAgY29uc3QgYTFYID0gYTFbMF0gKyBvZmZYXHJcbiAgICBjb25zdCBhMVkgPSBhMVsxXSArIG9mZllcclxuXHJcbiAgICBjb21wb3NpdGUoXHJcbiAgICAgIHRlc3RJbWcwLCBidWZmZXIsIFswLCAwLCB0ZXN0SW1nMC53aWR0aCwgdGVzdEltZzAuaGVpZ2h0LCBhMVgsIGExWV0sIDAuNVxyXG4gICAgKVxyXG5cclxuICAgIC8vIG9vYiBvbiBkZXN0XHJcblxyXG4gICAgY29uc3QgeyBiMSB9ID0gdGVzdEdyaWRcclxuICAgIGNvbnN0IGIxWCA9IGIxWzBdICsgb2ZmWCArIDE2XHJcbiAgICBjb25zdCBiMVkgPSBiMVsxXSArIG9mZllcclxuXHJcbiAgICBibGl0KFxyXG4gICAgICB0ZXN0SW1nMCwgYnVmZmVyLFxyXG4gICAgICBbXHJcbiAgICAgICAgMCwgMCwgdGVzdEltZzAud2lkdGgsIHRlc3RJbWcwLmhlaWdodCxcclxuICAgICAgICBiMVgsIGIxWVxyXG4gICAgICBdXHJcbiAgICApXHJcblxyXG4gICAgLy8gY29sb3IgZmlsbFxyXG5cclxuICAgIGNvbnN0IHsgYTIgfSA9IHRlc3RHcmlkXHJcbiAgICBjb25zdCBhMlggPSBhMlswXSArIG9mZlhcclxuICAgIGNvbnN0IGEyWSA9IGEyWzFdICsgb2ZmWVxyXG5cclxuICAgIGNvbnN0IGNvbG9yID0gY3JlYXRlQ29sb3IoMHg2YywgMHgyOCwgMHhiYylcclxuXHJcbiAgICBmaWxsKFxyXG4gICAgICBidWZmZXIsIGNvbG9yLFxyXG4gICAgICBbYTJYLCBhMlksIHRlc3RJbWcwLndpZHRoLCB0ZXN0SW1nMC5oZWlnaHRdXHJcbiAgICApXHJcblxyXG4gICAgLy8gc3ByaXRlIHJvdGF0aW9uXHJcblxyXG4gICAgY29uc3QgeyBiMiB9ID0gdGVzdEdyaWRcclxuICAgIGNvbnN0IGIyWCA9IGIyWzBdICsgb2ZmWCArIHRlc3RJbWcwLndpZHRoIC8gMlxyXG4gICAgY29uc3QgYjJZID0gYjJbMV0gKyBvZmZZICsgdGVzdEltZzAuaGVpZ2h0IC8gMlxyXG5cclxuICAgIGRyYXdSb3RhdGVkKFxyXG4gICAgICB0ZXN0SW1nMCwgdGVzdEltZzAud2lkdGggLyAyLCB0ZXN0SW1nMC5oZWlnaHQgLyAyLFxyXG4gICAgICBidWZmZXIsIGIyWCwgYjJZLFxyXG4gICAgICBwb2x5Um90YXRpb25cclxuICAgIClcclxuXHJcbiAgICAvLyBibGl0Um93cyB0ZXN0XHJcblxyXG4gICAgY29uc3QgeyBhMyB9ID0gdGVzdEdyaWRcclxuICAgIGNvbnN0IGEzWCA9IGEzWzBdICsgb2ZmWFxyXG4gICAgY29uc3QgYTNZID0gYTNbMV0gKyBvZmZZXHJcblxyXG4gICAgZmlsbChidWZmZXIsIGNyZWF0ZUNvbG9yKDAsIDAsIDApLCBbYTNYLCBhM1ksIHBhdHRlcm4wLndpZHRoLCBwYXR0ZXJuMC5oZWlnaHRdKVxyXG5cclxuICAgIGJsaXRSb3dzKFxyXG4gICAgICBwYXR0ZXJuQ29sb3JJbWFnZSwgcGF0dGVybjBSb3dzLCBidWZmZXIsIGEzWCwgYTNZXHJcbiAgICApXHJcblxyXG4gICAgLy8gZ3JhZGllbnQgdGVzdFxyXG5cclxuICAgIGNvbnN0IHsgYjMgfSA9IHRlc3RHcmlkXHJcbiAgICBjb25zdCBiM1ggPSBiM1swXSArIG9mZlhcclxuICAgIGNvbnN0IGIzWSA9IGIzWzFdICsgb2ZmWVxyXG5cclxuICAgIGNvbnN0IGdDb2xvcnMwID0gZ2VuZXJhdGVIdWVzKDYpXHJcblxyXG4gICAgY29uc3Qgc3RlcDAgPSAxIC8gKGdDb2xvcnMwLmxlbmd0aCAtIDEpXHJcblxyXG4gICAgY29uc3QgZ1N0b3BzMCA9IGdDb2xvcnMwLm1hcCgoYywgaSkgPT4ge1xyXG4gICAgICBjb25zdCByZ2JhID0gY29sb3JUb1JnYmEoYylcclxuXHJcbiAgICAgIHJldHVybiBbLi4ucmdiYSwgaSAqIHN0ZXAwXSBhcyBUNVxyXG4gICAgfSlcclxuXHJcbiAgICBjb25zdCBnSW1hZ2UwID0gY3JlYXRlSW1hZ2UoMzIsIDMyKVxyXG5cclxuICAgIGZvciAobGV0IHggPSAwOyB4IDwgZ0ltYWdlMC53aWR0aDsgeCsrKSB7XHJcbiAgICAgIGNvbnN0IGF0ID0geCAvIChnSW1hZ2UwLndpZHRoIC0gMSlcclxuICAgICAgY29uc3QgcmdiYSA9IHNhbXBsZUdyYWRpZW50KGdTdG9wczAsIGF0KVxyXG4gICAgICBjb25zdCBjb2xvciA9IGNyZWF0ZUNvbG9yKC4uLnJnYmEpXHJcblxyXG4gICAgICBmaWxsQ29sKGdJbWFnZTAsIGNvbG9yLCB4KVxyXG4gICAgfVxyXG5cclxuICAgIGJsaXQoZ0ltYWdlMCwgYnVmZmVyLCBbMCwgMCwgZ0ltYWdlMC53aWR0aCwgZ0ltYWdlMC5oZWlnaHQsIGIzWCwgYjNZXSlcclxuXHJcbiAgICAvLyBncmFkaWVudCB0ZXN0IDIsIGFscGhhICsgY29tcG9zaXRlXHJcblxyXG4gICAgY29uc3QgeyBhNCB9ID0gdGVzdEdyaWRcclxuICAgIGNvbnN0IGE0WCA9IGE0WzBdICsgb2ZmWFxyXG4gICAgY29uc3QgYTRZID0gYTRbMV0gKyBvZmZZXHJcblxyXG4gICAgY29uc3QgZ0NvbG9yczEgPSBnQ29sb3JzMC5zbGljZSgpLnJldmVyc2UoKVxyXG5cclxuICAgIGNvbnN0IHN0ZXAxID0gMSAvIChnQ29sb3JzMS5sZW5ndGggLSAxKVxyXG5cclxuICAgIGNvbnN0IGdzdG9wczEgPSBnQ29sb3JzMS5tYXAoKGMsIGkpID0+IHtcclxuICAgICAgY29uc3QgW3IsIGcsIGJdID0gY29sb3JUb1JnYmEoYylcclxuICAgICAgY29uc3QgYSA9IGkgKiBzdGVwMSAqIDI1NVxyXG5cclxuICAgICAgcmV0dXJuIFtyLCBnLCBiLCBhLCBpICogc3RlcDFdIGFzIFQ1XHJcbiAgICB9KVxyXG5cclxuICAgIGNvbnN0IGdJbWFnZTEgPSBjcmVhdGVJbWFnZSgzMiwgMzIpXHJcblxyXG4gICAgZm9yIChsZXQgeCA9IDA7IHggPCBnSW1hZ2UxLndpZHRoOyB4KyspIHtcclxuICAgICAgY29uc3QgYXQgPSB4IC8gKGdJbWFnZTEud2lkdGggLSAxKVxyXG4gICAgICBjb25zdCByZ2JhID0gc2FtcGxlR3JhZGllbnQoZ3N0b3BzMSwgYXQpXHJcbiAgICAgIGNvbnN0IGNvbG9yID0gY3JlYXRlQ29sb3IoLi4ucmdiYSlcclxuXHJcbiAgICAgIGdyYWRpZW50TG9nZ2VyLmxvZygnZ3JhZGllbnQnLCB4LCByZ2JhKVxyXG5cclxuICAgICAgZmlsbENvbChnSW1hZ2UxLCBjb2xvciwgeClcclxuICAgIH1cclxuXHJcbiAgICBjb21wb3NpdGUoXHJcbiAgICAgIGdJbWFnZTEsIGJ1ZmZlciwgWzAsIDAsIGdJbWFnZTEud2lkdGgsIGdJbWFnZTEuaGVpZ2h0LCBhNFgsIGE0WV1cclxuICAgIClcclxuXHJcbiAgICAvLyBob3Jpem9udGFsbHkgc2xvcGluZyBsaW5lXHJcblxyXG4gICAgY29uc3QgdGVzdExpbmVDb2xvciA9IGNyZWF0ZUNvbG9yKDB4MzMsIDB4ZmYsIDB4OTkpXHJcblxyXG4gICAgY29uc3QgdGVzdExpbmU6IFQ0ID0gWy0zMiwgaGVpZ2h0IC8gMiAtIDMyLCB3aWR0aCArIDMyLCBoZWlnaHQgLyAyICsgMzJdXHJcblxyXG4gICAgLy8gbmIgLSB0aGlzIGlzIG9ubHkgZmFzdGVyIHdpdGggdGhlIHJpZ2h0IHNsb3BlIC0gb3RoZXJ3aXNlIGl0IGlzIHNsb3dlclxyXG4gICAgLy8gaXQgaXMgYmV0dGVyIHRvIHVzZSBicmVzZW5oYW0gZm9yIHRoZSBnZW5lcmFsIGNhc2VcclxuICAgIGNvbnN0IHRlc3RMaW5lUm93cyA9IGxpbmVUb1Jvd3MoLi4udGVzdExpbmUpXHJcblxyXG4gICAgZmlsbFJvd3ModGVzdExpbmVSb3dzLCBidWZmZXIsIHRlc3RMaW5lQ29sb3IpXHJcblxyXG4gICAgLy8gcmVjdCB2aWEgcm93c1xyXG5cclxuICAgIGNvbnN0IHJlY3RDb2xvciA9IGNyZWF0ZUNvbG9yKDB4ZmYsIDB4OTksIDB4MzMpXHJcblxyXG4gICAgY29uc3QgdGVzdFJlY3Q6IFQ0ID0gWzQ4LCA0OCwgMzIsIDI0XVxyXG4gICAgY29uc3QgdGVzdFJlY3RSb3dzID0gcmVjdFRvUm93cyguLi50ZXN0UmVjdClcclxuXHJcbiAgICBmaWxsUm93cyh0ZXN0UmVjdFJvd3MsIGJ1ZmZlciwgcmVjdENvbG9yKVxyXG5cclxuICAgIC8vIHBvbHlnb25cclxuXHJcbiAgICBjb25zdCBtaW5TaWRlID0gTWF0aC5taW4od2lkdGgsIGhlaWdodClcclxuICAgIGNvbnN0IGZpbGxDb2xvcnMgPSBnZW5lcmF0ZUh1ZXMocG9seVNpZGVzKVxyXG5cclxuICAgIGNvbnN0IHNoYXBlID0gcG9seWdvblRyaWFuZ2xlcyhcclxuICAgICAgcG9seVNpZGVzLCB3aWR0aCAvIDIsIGhlaWdodCAvIDIsIG1pblNpZGUgLyA0LCBwb2x5Um90YXRpb25cclxuICAgIClcclxuXHJcbiAgICBjb25zdCBmcmFtZVRpbWUgPSBzdGF0ZS50aW1lLmdldEZyYW1lVGltZSgpXHJcbiAgICBjb25zdCByb3RhdGVCeSA9IDAuMDAxICogZnJhbWVUaW1lXHJcblxyXG4gICAgY29uc3Qgc3Ryb2tlTGluZSA9IChsaW5lOiBUNCwgY29sb3I6IG51bWJlcikgPT4ge1xyXG4gICAgICBjb25zdCBwdHMgPSBicmVzZW5oYW1MaW5lKC4uLmxpbmUpXHJcbiAgICAgIGNvbnN0IGluZGljZXMgPSBwb2ludHNUb0luZGljZXMod2lkdGgsIGhlaWdodCwgMSkocHRzKVxyXG5cclxuICAgICAgZmlsbEluZGljZXMoaW5kaWNlcywgYnVmZmVyLCBjb2xvcilcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdHJva2VUcmkgPSAodHJpOiBUMzxUMj4sIGNvbG9yOiBudW1iZXIpID0+IHtcclxuICAgICAgY29uc3QgbGluZTA6IFQ0ID0gW3RyaVswXVswXSwgdHJpWzBdWzFdLCB0cmlbMV1bMF0sIHRyaVsxXVsxXV1cclxuICAgICAgY29uc3QgbGluZTE6IFQ0ID0gW3RyaVsxXVswXSwgdHJpWzFdWzFdLCB0cmlbMl1bMF0sIHRyaVsyXVsxXV1cclxuICAgICAgY29uc3QgbGluZTI6IFQ0ID0gW3RyaVsyXVswXSwgdHJpWzJdWzFdLCB0cmlbMF1bMF0sIHRyaVswXVsxXV1cclxuXHJcbiAgICAgIHN0cm9rZUxpbmUobGluZTAsIGNvbG9yKVxyXG4gICAgICBzdHJva2VMaW5lKGxpbmUxLCBjb2xvcilcclxuICAgICAgc3Ryb2tlTGluZShsaW5lMiwgY29sb3IpXHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb2x5U2lkZXM7IGkrKykge1xyXG4gICAgICBjb25zdCBjb2xvciA9IGZpbGxDb2xvcnNbaSAlIGZpbGxDb2xvcnMubGVuZ3RoXVxyXG4gICAgICBjb25zdCB0cmkgPSBzaGFwZVtpXVxyXG5cclxuICAgICAgY29uc3QgcHRyaVJvd3MgPSB0cmlhbmdsZVRvUm93cyguLi50cmkpXHJcbiAgICAgIGZpbGxSb3dzKHB0cmlSb3dzLCBidWZmZXIsIGNvbG9yKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN0cm9rZUNvbG9ycyA9IHN0cm9rZVBvbHkgPyBnZW5lcmF0ZUh1ZXMocG9seVNpZGVzLCA1MCkgOiBmaWxsQ29sb3JzXHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb2x5U2lkZXM7IGkrKykge1xyXG4gICAgICBjb25zdCBjb2xvciA9IHN0cm9rZUNvbG9yc1tpICUgc3Ryb2tlQ29sb3JzLmxlbmd0aF1cclxuICAgICAgY29uc3QgdHJpID0gc2hhcGVbaV1cclxuXHJcbiAgICAgIHN0cm9rZVRyaSh0cmksIGNvbG9yKVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHNob3cgY3VzdG9tIGN1cnNvclxyXG5cclxuICAgIGlmIChzdGF0ZS5tb3VzZS5pc0luQm91bmRzKCkpIHtcclxuICAgICAgY29tcG9zaXRlKFxyXG4gICAgICAgIGN1cnNvciwgYnVmZmVyLFxyXG4gICAgICAgIFswLCAwLCBjdXJzb3Iud2lkdGgsIGN1cnNvci5oZWlnaHQsIHN0YXRlLm1vdXNlLmdldFgoKSwgc3RhdGUubW91c2UuZ2V0WSgpXVxyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgLy9cclxuXHJcbiAgICBwb2x5Um90YXRpb24gKz0gcm90YXRlQnlcclxuXHJcbiAgICBmcmFtZSsrXHJcbiAgfVxyXG5cclxuICBjb25zdCBxdWl0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgY29uc29sZS5sb2coJ3F1aXR0aW5nIGRlYnVnIHNjZW5lJylcclxuXHJcbiAgICByZWxlYXNlTW91c2UoKVxyXG4gIH1cclxuXHJcbiAgY29uc3Qgc2V0QWN0aXZlID0gKGFjdGl2ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgLy8gd2UganVzdCBnb3QgZm9jdXNcclxuICAgIGlmIChhY3RpdmUgJiYgIWlzQWN0aXZlKSB7XHJcbiAgICAgIHRha2VNb3VzZSgpXHJcbiAgICB9XHJcblxyXG4gICAgLy8gd2UganVzdCBsb3N0IGZvY3VzIFxyXG4gICAgaWYgKCFhY3RpdmUgJiYgaXNBY3RpdmUpIHtcclxuICAgICAgcmVsZWFzZU1vdXNlKClcclxuICAgIH1cclxuXHJcbiAgICBpc0FjdGl2ZSA9IGFjdGl2ZVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgaW5pdCwgdXBkYXRlLCBxdWl0LCBzZXRBY3RpdmUgfVxyXG59XHJcbiJdfQ==
import { lineToRows, rectToRows, triangleToRows } from '../lib/image/rows.js';
import { polygonTriangles } from '../sandbox/util.js';
import { takeMouse, releaseMouse } from '../lib/engine.js';
import { blit, blitRows } from '../lib/image/blit.js';
import { bresenhamLine } from '../lib/image/bresenham.js';
import { colorToRgba, createColor, generateHues, sampleGradient } from '../lib/image/color.js';
import { composite } from '../lib/image/composite.js';
import { fill, fillCol, fillIndices, fillRows } from '../lib/image/fill.js';
import { loadImage } from '../lib/image/load.js';
import { drawRotated } from '../lib/image/rotate.js';
import { pointsToIndices } from '../lib/image/util.js';
import { generateGridLayout, generateNamedGridLayout } from '../lib/grid/index.js';
import { rowQuery } from '../lib/image/query.js';
import { createImage } from '../lib/image/create.js';
import { limitedLogger, maybe } from '../lib/util.js';
const readAlpha = (state, ch, destroy = false) => {
    const upper = ch.toUpperCase();
    const lower = ch.toLowerCase();
    const keys = state.getKeys();
    const alpha = keys[upper] ? upper : keys[lower] ? lower : null;
    if (destroy && alpha) {
        keys[alpha] = false;
    }
    return alpha;
};
export const debugScene = () => {
    let testImg0;
    let pattern0;
    let cursor;
    let pattern0Rows;
    const patternColors = generateHues(8);
    const patternColorImage = createImage(8, 8);
    for (let x = 0; x < 8; x++) {
        const color = patternColors[x];
        fillCol(patternColorImage, color, x);
    }
    const minPolySides = 3;
    const maxPolySides = 128;
    // enough for one run through, then stop logging, otherwise we flood console
    // calling *every* frame
    const gradientLogger = limitedLogger(32);
    let polySides = 5;
    let polyRotation = 0;
    let strokePoly = false;
    let isActive = true;
    const init = async (_state) => {
        console.log('starting debug scene');
        testImg0 = await loadImage('scenes/debug/test-0.png');
        pattern0 = await loadImage('scenes/debug/pattern-0.png');
        cursor = await loadImage('scenes/debug/cursor.png');
        polyRotation = 0;
        pattern0Rows = rowQuery(pattern0, r => r === 0);
        console.log('pattern0Rows', pattern0Rows);
        takeMouse();
    };
    const bgColor0 = [0x33, 0x99, 0xff];
    const bgColor1 = [0x11, 0x77, 0xdd];
    const paintColor = [0xff, 0x88, 0x00];
    let painting = false;
    let lastPaintX = null;
    let lastPaintY = null;
    // nb - these are retained even when the scene exits and restarts
    // as a test for scenes holding state between runs
    //
    // if this is not desired, state should be reset in init or quit on each run
    //
    const paintPts = {};
    const getPaintRow = (y) => (paintPts[y] || (paintPts[y] = {}));
    const addPaintPt = (x, y) => {
        // you get gaps if you move the mouse quickly, so interpolate between last 
        // point and this point
        if (maybe(lastPaintX) && maybe(lastPaintY)) {
            const line = bresenhamLine(lastPaintX, lastPaintY, x, y);
            for (const [x, y] of line) {
                getPaintRow(y)[x] = true;
            }
        }
        else {
            getPaintRow(y)[x] = true;
        }
        lastPaintX = x;
        lastPaintY = y;
    };
    let frame = 0;
    const _handleKeys = (state) => {
        const keys = state.getKeys();
        if (keys['Escape']) {
            state.setRunning(false);
            // consume the key
            keys['Escape'] = false;
            return;
        }
        if (keys['ArrowUp']) {
            polySides--;
            keys['ArrowUp'] = false;
        }
        if (keys['ArrowDown']) {
            polySides++;
            keys['ArrowDown'] = false;
        }
        const sState = readAlpha(state, 'S', true);
        if (sState) {
            strokePoly = !strokePoly;
        }
    };
    const update = (state) => {
        if (isActive) {
            _handleKeys(state);
            polySides = Math.min(Math.max(polySides, minPolySides), maxPolySides);
            // capture a reference - it is a destructive read
            const wheel = state.mouse.takeWheel();
            const zoom = state.view.getZoom();
            if (wheel < 0) {
                state.view.setZoom(zoom + 1);
            }
            else if (wheel > 0) {
                state.view.setZoom(zoom - 1);
            }
            // maybe paint
            if (state.mouse.getButtons()[0]) {
                addPaintPt(state.mouse.getX(), state.mouse.getY());
                painting = true;
            }
            else if (painting) {
                painting = false;
                lastPaintX = null;
                lastPaintY = null;
            }
        }
        const buffer = state.view.getBuffer();
        const { width, height } = buffer;
        // not very efficent - plenty of faster ways to do this - but that's a good
        // thing, we're trying to stuff as much into the debug scene as possible
        // so we can give it a bit of a stress test
        //
        // even with everything we're doing still comfortably runs at 60fps tho!
        for (let y = 0; y < height; y++) {
            const row = y * width;
            for (let x = 0; x < width; x++) {
                const index = row + x;
                const dataIndex = index * 4;
                const isPaint = paintPts[y] && paintPts[y][x];
                if (isPaint) {
                    buffer.data[dataIndex] = paintColor[0];
                    buffer.data[dataIndex + 1] = paintColor[1];
                    buffer.data[dataIndex + 2] = paintColor[2];
                    buffer.data[dataIndex + 3] = 0xff;
                    continue;
                }
                const isCheck = (x + y) % 2 === 0;
                buffer.data[dataIndex] = isCheck ? bgColor0[0] : bgColor1[0];
                buffer.data[dataIndex + 1] = isCheck ? bgColor0[1] : bgColor1[1];
                buffer.data[dataIndex + 2] = isCheck ? bgColor0[2] : bgColor1[2];
                buffer.data[dataIndex + 3] = 0xff;
            }
        }
        // sprites, blitting, composite etc
        // a0..b7    
        const testGrid = generateNamedGridLayout(generateGridLayout(32, 32, 2, 8, 1, 1));
        const { width: gw } = testGrid;
        const offX = width - gw;
        const offY = 0;
        // straight blit
        const { a0 } = testGrid;
        const a0X = a0[0] + offX;
        const a0Y = a0[1] + offY;
        blit(testImg0, buffer, [0, 0, testImg0.width, testImg0.height, a0X, a0Y]);
        // testing oob on src
        const { b0 } = testGrid;
        const b0X = b0[0] + offX - 16;
        const b0Y = b0[1] + offY - 16;
        blit(testImg0, buffer, [
            -16, -16, testImg0.width + 32, testImg0.height + 32,
            b0X, b0Y
        ]);
        // alpha composite
        const { a1 } = testGrid;
        const a1X = a1[0] + offX;
        const a1Y = a1[1] + offY;
        composite(testImg0, buffer, [0, 0, testImg0.width, testImg0.height, a1X, a1Y], 0.5);
        // oob on dest
        const { b1 } = testGrid;
        const b1X = b1[0] + offX + 16;
        const b1Y = b1[1] + offY;
        blit(testImg0, buffer, [
            0, 0, testImg0.width, testImg0.height,
            b1X, b1Y
        ]);
        // color fill
        const { a2 } = testGrid;
        const a2X = a2[0] + offX;
        const a2Y = a2[1] + offY;
        const color = createColor(0x6c, 0x28, 0xbc);
        fill(buffer, color, [a2X, a2Y, testImg0.width, testImg0.height]);
        // sprite rotation
        const { b2 } = testGrid;
        const b2X = b2[0] + offX + testImg0.width / 2;
        const b2Y = b2[1] + offY + testImg0.height / 2;
        drawRotated(testImg0, testImg0.width / 2, testImg0.height / 2, buffer, b2X, b2Y, polyRotation);
        // blitRows test
        const { a3 } = testGrid;
        const a3X = a3[0] + offX;
        const a3Y = a3[1] + offY;
        fill(buffer, createColor(0, 0, 0), [a3X, a3Y, pattern0.width, pattern0.height]);
        blitRows(patternColorImage, pattern0Rows, buffer, a3X, a3Y);
        // gradient test
        const { b3 } = testGrid;
        const b3X = b3[0] + offX;
        const b3Y = b3[1] + offY;
        const gColors0 = generateHues(6);
        const step0 = 1 / (gColors0.length - 1);
        const gStops0 = gColors0.map((c, i) => {
            const rgba = colorToRgba(c);
            return [...rgba, i * step0];
        });
        const gImage0 = createImage(32, 32);
        for (let x = 0; x < gImage0.width; x++) {
            const at = x / (gImage0.width - 1);
            const rgba = sampleGradient(gStops0, at);
            const color = createColor(...rgba);
            fillCol(gImage0, color, x);
        }
        blit(gImage0, buffer, [0, 0, gImage0.width, gImage0.height, b3X, b3Y]);
        // gradient test 2, alpha + composite
        const { a4 } = testGrid;
        const a4X = a4[0] + offX;
        const a4Y = a4[1] + offY;
        const gColors1 = gColors0.slice().reverse();
        const step1 = 1 / (gColors1.length - 1);
        const gstops1 = gColors1.map((c, i) => {
            const [r, g, b] = colorToRgba(c);
            const a = i * step1 * 255;
            return [r, g, b, a, i * step1];
        });
        const gImage1 = createImage(32, 32);
        for (let x = 0; x < gImage1.width; x++) {
            const at = x / (gImage1.width - 1);
            const rgba = sampleGradient(gstops1, at);
            const color = createColor(...rgba);
            gradientLogger.log('gradient', x, rgba);
            fillCol(gImage1, color, x);
        }
        composite(gImage1, buffer, [0, 0, gImage1.width, gImage1.height, a4X, a4Y]);
        // horizontally sloping line
        const testLineColor = createColor(0x33, 0xff, 0x99);
        const testLine = [-32, height / 2 - 32, width + 32, height / 2 + 32];
        // nb - this is only faster with the right slope - otherwise it is slower
        // it is better to use bresenham for the general case
        const testLineRows = lineToRows(...testLine);
        fillRows(testLineRows, buffer, testLineColor);
        // rect via rows
        const rectColor = createColor(0xff, 0x99, 0x33);
        const testRect = [48, 48, 32, 24];
        const testRectRows = rectToRows(...testRect);
        fillRows(testRectRows, buffer, rectColor);
        // polygon
        const minSide = Math.min(width, height);
        const fillColors = generateHues(polySides);
        const shape = polygonTriangles(polySides, width / 2, height / 2, minSide / 4, polyRotation);
        const frameTime = state.time.getFrameTime();
        const rotateBy = 0.001 * frameTime;
        const strokeLine = (line, color) => {
            const pts = bresenhamLine(...line);
            const indices = pointsToIndices(width, height, 1)(pts);
            fillIndices(indices, buffer, color);
        };
        const strokeTri = (tri, color) => {
            const line0 = [tri[0][0], tri[0][1], tri[1][0], tri[1][1]];
            const line1 = [tri[1][0], tri[1][1], tri[2][0], tri[2][1]];
            const line2 = [tri[2][0], tri[2][1], tri[0][0], tri[0][1]];
            strokeLine(line0, color);
            strokeLine(line1, color);
            strokeLine(line2, color);
        };
        for (let i = 0; i < polySides; i++) {
            const color = fillColors[i % fillColors.length];
            const tri = shape[i];
            const ptriRows = triangleToRows(...tri);
            fillRows(ptriRows, buffer, color);
        }
        const strokeColors = strokePoly ? generateHues(polySides, 50) : fillColors;
        for (let i = 0; i < polySides; i++) {
            const color = strokeColors[i % strokeColors.length];
            const tri = shape[i];
            strokeTri(tri, color);
        }
        // show custom cursor
        if (state.mouse.isInBounds()) {
            composite(cursor, buffer, [0, 0, cursor.width, cursor.height, state.mouse.getX(), state.mouse.getY()]);
        }
        //
        polyRotation += rotateBy;
        frame++;
    };
    const quit = async (state) => {
        console.log('quitting debug scene');
        releaseMouse();
    };
    const setActive = (active) => {
        // we just got focus
        if (active && !isActive) {
            takeMouse();
        }
        // we just lost focus 
        if (!active && isActive) {
            releaseMouse();
        }
        isActive = active;
    };
    return { init, update, quit, setActive };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVidWctc2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2NlbmVzL2RlYnVnLXNjZW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQzdFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDMUQsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUNyRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMkJBQTJCLENBQUE7QUFDekQsT0FBTyxFQUNMLFdBQVcsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFDdkQsTUFBTSx1QkFBdUIsQ0FBQTtBQUM5QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sMkJBQTJCLENBQUE7QUFDckQsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQzNFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUNoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFDcEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBRXRELE9BQU8sRUFDTCxrQkFBa0IsRUFBRSx1QkFBdUIsRUFDNUMsTUFBTSxzQkFBc0IsQ0FBQTtBQUU3QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFDaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ3BELE9BQU8sRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7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Q25CLENBQUMsQ0FBQTtJQUVELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQTtBQUMxQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsaW5lVG9Sb3dzLCByZWN0VG9Sb3dzLCB0cmlhbmdsZVRvUm93cyB9IGZyb20gJy4uL2xpYi9pbWFnZS9yb3dzLmpzJ1xyXG5pbXBvcnQgeyBwb2x5Z29uVHJpYW5nbGVzIH0gZnJvbSAnLi4vc2FuZGJveC91dGlsLmpzJ1xyXG5pbXBvcnQgeyB0YWtlTW91c2UsIHJlbGVhc2VNb3VzZSB9IGZyb20gJy4uL2xpYi9lbmdpbmUuanMnXHJcbmltcG9ydCB7IGJsaXQsIGJsaXRSb3dzIH0gZnJvbSAnLi4vbGliL2ltYWdlL2JsaXQuanMnXHJcbmltcG9ydCB7IGJyZXNlbmhhbUxpbmUgfSBmcm9tICcuLi9saWIvaW1hZ2UvYnJlc2VuaGFtLmpzJ1xyXG5pbXBvcnQge1xyXG4gIGNvbG9yVG9SZ2JhLCBjcmVhdGVDb2xvciwgZ2VuZXJhdGVIdWVzLCBzYW1wbGVHcmFkaWVudFxyXG59IGZyb20gJy4uL2xpYi9pbWFnZS9jb2xvci5qcydcclxuaW1wb3J0IHsgY29tcG9zaXRlIH0gZnJvbSAnLi4vbGliL2ltYWdlL2NvbXBvc2l0ZS5qcydcclxuaW1wb3J0IHsgZmlsbCwgZmlsbENvbCwgZmlsbEluZGljZXMsIGZpbGxSb3dzIH0gZnJvbSAnLi4vbGliL2ltYWdlL2ZpbGwuanMnXHJcbmltcG9ydCB7IGxvYWRJbWFnZSB9IGZyb20gJy4uL2xpYi9pbWFnZS9sb2FkLmpzJ1xyXG5pbXBvcnQgeyBkcmF3Um90YXRlZCB9IGZyb20gJy4uL2xpYi9pbWFnZS9yb3RhdGUuanMnXHJcbmltcG9ydCB7IHBvaW50c1RvSW5kaWNlcyB9IGZyb20gJy4uL2xpYi9pbWFnZS91dGlsLmpzJ1xyXG5pbXBvcnQgeyBNYXliZSwgU2NlbmUsIFN0YXRlLCBUMiwgVDMsIFQ0LCBUNSB9IGZyb20gJy4uL2xpYi90eXBlcy5qcydcclxuaW1wb3J0IHtcclxuICBnZW5lcmF0ZUdyaWRMYXlvdXQsIGdlbmVyYXRlTmFtZWRHcmlkTGF5b3V0XHJcbn0gZnJvbSAnLi4vbGliL2dyaWQvaW5kZXguanMnXHJcbmltcG9ydCB7IFJvdyB9IGZyb20gJy4uL2xpYi9pbWFnZS90eXBlcy5qcydcclxuaW1wb3J0IHsgcm93UXVlcnkgfSBmcm9tICcuLi9saWIvaW1hZ2UvcXVlcnkuanMnXHJcbmltcG9ydCB7IGNyZWF0ZUltYWdlIH0gZnJvbSAnLi4vbGliL2ltYWdlL2NyZWF0ZS5qcydcclxuaW1wb3J0IHsgbGltaXRlZExvZ2dlciwgbWF5YmUgfSBmcm9tICcuLi9saWIvdXRpbC5qcydcclxuXHJcbmNvbnN0IHJlYWRBbHBoYSA9IChzdGF0ZTogU3RhdGUsIGNoOiBzdHJpbmcsIGRlc3Ryb3kgPSBmYWxzZSkgPT4ge1xyXG4gIGNvbnN0IHVwcGVyID0gY2gudG9VcHBlckNhc2UoKVxyXG4gIGNvbnN0IGxvd2VyID0gY2gudG9Mb3dlckNhc2UoKVxyXG5cclxuICBjb25zdCBrZXlzID0gc3RhdGUuZ2V0S2V5cygpXHJcblxyXG4gIGNvbnN0IGFscGhhID0ga2V5c1t1cHBlcl0gPyB1cHBlciA6IGtleXNbbG93ZXJdID8gbG93ZXIgOiBudWxsXHJcblxyXG4gIGlmIChkZXN0cm95ICYmIGFscGhhKSB7XHJcbiAgICBrZXlzW2FscGhhXSA9IGZhbHNlXHJcbiAgfVxyXG5cclxuICByZXR1cm4gYWxwaGFcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGRlYnVnU2NlbmUgPSAoKTogU2NlbmUgPT4ge1xyXG4gIGxldCB0ZXN0SW1nMDogSW1hZ2VEYXRhXHJcbiAgbGV0IHBhdHRlcm4wOiBJbWFnZURhdGFcclxuICBsZXQgY3Vyc29yOiBJbWFnZURhdGFcclxuXHJcbiAgbGV0IHBhdHRlcm4wUm93czogUm93PG5ldmVyPltdXHJcbiAgY29uc3QgcGF0dGVybkNvbG9ycyA9IGdlbmVyYXRlSHVlcyg4KVxyXG4gIGNvbnN0IHBhdHRlcm5Db2xvckltYWdlID0gY3JlYXRlSW1hZ2UoOCwgOClcclxuXHJcbiAgZm9yIChsZXQgeCA9IDA7IHggPCA4OyB4KyspIHtcclxuICAgIGNvbnN0IGNvbG9yID0gcGF0dGVybkNvbG9yc1t4XVxyXG5cclxuICAgIGZpbGxDb2wocGF0dGVybkNvbG9ySW1hZ2UsIGNvbG9yLCB4KVxyXG4gIH1cclxuXHJcbiAgY29uc3QgbWluUG9seVNpZGVzID0gM1xyXG4gIGNvbnN0IG1heFBvbHlTaWRlcyA9IDEyOFxyXG5cclxuICAvLyBlbm91Z2ggZm9yIG9uZSBydW4gdGhyb3VnaCwgdGhlbiBzdG9wIGxvZ2dpbmcsIG90aGVyd2lzZSB3ZSBmbG9vZCBjb25zb2xlXHJcbiAgLy8gY2FsbGluZyAqZXZlcnkqIGZyYW1lXHJcbiAgY29uc3QgZ3JhZGllbnRMb2dnZXIgPSBsaW1pdGVkTG9nZ2VyKDMyKVxyXG5cclxuICBsZXQgcG9seVNpZGVzID0gNVxyXG4gIGxldCBwb2x5Um90YXRpb24gPSAwXHJcbiAgbGV0IHN0cm9rZVBvbHkgPSBmYWxzZVxyXG5cclxuICBsZXQgaXNBY3RpdmUgPSB0cnVlXHJcblxyXG4gIGNvbnN0IGluaXQgPSBhc3luYyAoX3N0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgY29uc29sZS5sb2coJ3N0YXJ0aW5nIGRlYnVnIHNjZW5lJylcclxuXHJcbiAgICB0ZXN0SW1nMCA9IGF3YWl0IGxvYWRJbWFnZSgnc2NlbmVzL2RlYnVnL3Rlc3QtMC5wbmcnKVxyXG4gICAgcGF0dGVybjAgPSBhd2FpdCBsb2FkSW1hZ2UoJ3NjZW5lcy9kZWJ1Zy9wYXR0ZXJuLTAucG5nJylcclxuICAgIGN1cnNvciA9IGF3YWl0IGxvYWRJbWFnZSgnc2NlbmVzL2RlYnVnL2N1cnNvci5wbmcnKVxyXG5cclxuICAgIHBvbHlSb3RhdGlvbiA9IDBcclxuXHJcbiAgICBwYXR0ZXJuMFJvd3MgPSByb3dRdWVyeShwYXR0ZXJuMCwgciA9PiByID09PSAwKVxyXG5cclxuICAgIGNvbnNvbGUubG9nKCdwYXR0ZXJuMFJvd3MnLCBwYXR0ZXJuMFJvd3MpXHJcblxyXG4gICAgdGFrZU1vdXNlKClcclxuICB9XHJcblxyXG4gIGNvbnN0IGJnQ29sb3IwOiBUMyA9IFsweDMzLCAweDk5LCAweGZmXVxyXG4gIGNvbnN0IGJnQ29sb3IxOiBUMyA9IFsweDExLCAweDc3LCAweGRkXVxyXG5cclxuICBjb25zdCBwYWludENvbG9yOiBUMyA9IFsweGZmLCAweDg4LCAweDAwXVxyXG4gIGxldCBwYWludGluZyA9IGZhbHNlXHJcbiAgbGV0IGxhc3RQYWludFg6IE1heWJlPG51bWJlcj4gPSBudWxsXHJcbiAgbGV0IGxhc3RQYWludFk6IE1heWJlPG51bWJlcj4gPSBudWxsXHJcblxyXG4gIC8vIG5iIC0gdGhlc2UgYXJlIHJldGFpbmVkIGV2ZW4gd2hlbiB0aGUgc2NlbmUgZXhpdHMgYW5kIHJlc3RhcnRzXHJcbiAgLy8gYXMgYSB0ZXN0IGZvciBzY2VuZXMgaG9sZGluZyBzdGF0ZSBiZXR3ZWVuIHJ1bnNcclxuICAvL1xyXG4gIC8vIGlmIHRoaXMgaXMgbm90IGRlc2lyZWQsIHN0YXRlIHNob3VsZCBiZSByZXNldCBpbiBpbml0IG9yIHF1aXQgb24gZWFjaCBydW5cclxuICAvL1xyXG4gIGNvbnN0IHBhaW50UHRzOiBSZWNvcmQ8bnVtYmVyLCBNYXliZTxSZWNvcmQ8bnVtYmVyLCBNYXliZTxib29sZWFuPj4+PiA9IHt9XHJcblxyXG4gIGNvbnN0IGdldFBhaW50Um93ID0gKHk6IG51bWJlcikgPT4gKHBhaW50UHRzW3ldIHx8IChwYWludFB0c1t5XSA9IHt9KSlcclxuXHJcbiAgY29uc3QgYWRkUGFpbnRQdCA9ICh4OiBudW1iZXIsIHk6IG51bWJlcikgPT4ge1xyXG4gICAgLy8geW91IGdldCBnYXBzIGlmIHlvdSBtb3ZlIHRoZSBtb3VzZSBxdWlja2x5LCBzbyBpbnRlcnBvbGF0ZSBiZXR3ZWVuIGxhc3QgXHJcbiAgICAvLyBwb2ludCBhbmQgdGhpcyBwb2ludFxyXG4gICAgaWYgKG1heWJlKGxhc3RQYWludFgpICYmIG1heWJlKGxhc3RQYWludFkpKSB7XHJcbiAgICAgIGNvbnN0IGxpbmUgPSBicmVzZW5oYW1MaW5lKGxhc3RQYWludFgsIGxhc3RQYWludFksIHgsIHkpXHJcblxyXG4gICAgICBmb3IgKGNvbnN0IFt4LCB5XSBvZiBsaW5lKSB7XHJcbiAgICAgICAgZ2V0UGFpbnRSb3coeSlbeF0gPSB0cnVlXHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGdldFBhaW50Um93KHkpW3hdID0gdHJ1ZVxyXG4gICAgfVxyXG5cclxuICAgIGxhc3RQYWludFggPSB4XHJcbiAgICBsYXN0UGFpbnRZID0geVxyXG4gIH1cclxuXHJcbiAgbGV0IGZyYW1lID0gMFxyXG5cclxuICBjb25zdCBfaGFuZGxlS2V5cyA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnN0IGtleXMgPSBzdGF0ZS5nZXRLZXlzKClcclxuXHJcbiAgICBpZiAoa2V5c1snRXNjYXBlJ10pIHtcclxuICAgICAgc3RhdGUuc2V0UnVubmluZyhmYWxzZSlcclxuXHJcbiAgICAgIC8vIGNvbnN1bWUgdGhlIGtleVxyXG4gICAgICBrZXlzWydFc2NhcGUnXSA9IGZhbHNlXHJcblxyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICBpZiAoa2V5c1snQXJyb3dVcCddKSB7XHJcbiAgICAgIHBvbHlTaWRlcy0tXHJcblxyXG4gICAgICBrZXlzWydBcnJvd1VwJ10gPSBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChrZXlzWydBcnJvd0Rvd24nXSkge1xyXG4gICAgICBwb2x5U2lkZXMrK1xyXG5cclxuICAgICAga2V5c1snQXJyb3dEb3duJ10gPSBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHNTdGF0ZSA9IHJlYWRBbHBoYShzdGF0ZSwgJ1MnLCB0cnVlKVxyXG5cclxuICAgIGlmIChzU3RhdGUpIHtcclxuICAgICAgc3Ryb2tlUG9seSA9ICFzdHJva2VQb2x5XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCB1cGRhdGUgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpZiAoaXNBY3RpdmUpIHtcclxuICAgICAgX2hhbmRsZUtleXMoc3RhdGUpXHJcblxyXG4gICAgICBwb2x5U2lkZXMgPSBNYXRoLm1pbihNYXRoLm1heChwb2x5U2lkZXMsIG1pblBvbHlTaWRlcyksIG1heFBvbHlTaWRlcylcclxuXHJcbiAgICAgIC8vIGNhcHR1cmUgYSByZWZlcmVuY2UgLSBpdCBpcyBhIGRlc3RydWN0aXZlIHJlYWRcclxuICAgICAgY29uc3Qgd2hlZWwgPSBzdGF0ZS5tb3VzZS50YWtlV2hlZWwoKVxyXG4gICAgICBjb25zdCB6b29tID0gc3RhdGUudmlldy5nZXRab29tKClcclxuXHJcbiAgICAgIGlmICh3aGVlbCA8IDApIHtcclxuICAgICAgICBzdGF0ZS52aWV3LnNldFpvb20oIHpvb20gKyAxIClcclxuICAgICAgfSBlbHNlIGlmICh3aGVlbCA+IDApIHtcclxuICAgICAgICBzdGF0ZS52aWV3LnNldFpvb20oIHpvb20gLSAxIClcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gbWF5YmUgcGFpbnRcclxuICAgICAgaWYgKHN0YXRlLm1vdXNlLmdldEJ1dHRvbnMoKVswXSkge1xyXG4gICAgICAgIGFkZFBhaW50UHQoc3RhdGUubW91c2UuZ2V0WCgpLCBzdGF0ZS5tb3VzZS5nZXRZKCkpXHJcbiAgICAgICAgcGFpbnRpbmcgPSB0cnVlXHJcbiAgICAgIH0gZWxzZSBpZiAocGFpbnRpbmcpIHtcclxuICAgICAgICBwYWludGluZyA9IGZhbHNlXHJcbiAgICAgICAgbGFzdFBhaW50WCA9IG51bGxcclxuICAgICAgICBsYXN0UGFpbnRZID0gbnVsbFxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYnVmZmVyID0gc3RhdGUudmlldy5nZXRCdWZmZXIoKVxyXG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBidWZmZXJcclxuXHJcbiAgICAvLyBub3QgdmVyeSBlZmZpY2VudCAtIHBsZW50eSBvZiBmYXN0ZXIgd2F5cyB0byBkbyB0aGlzIC0gYnV0IHRoYXQncyBhIGdvb2RcclxuICAgIC8vIHRoaW5nLCB3ZSdyZSB0cnlpbmcgdG8gc3R1ZmYgYXMgbXVjaCBpbnRvIHRoZSBkZWJ1ZyBzY2VuZSBhcyBwb3NzaWJsZVxyXG4gICAgLy8gc28gd2UgY2FuIGdpdmUgaXQgYSBiaXQgb2YgYSBzdHJlc3MgdGVzdFxyXG4gICAgLy9cclxuICAgIC8vIGV2ZW4gd2l0aCBldmVyeXRoaW5nIHdlJ3JlIGRvaW5nIHN0aWxsIGNvbWZvcnRhYmx5IHJ1bnMgYXQgNjBmcHMgdGhvIVxyXG5cclxuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgaGVpZ2h0OyB5KyspIHtcclxuICAgICAgY29uc3Qgcm93ID0geSAqIHdpZHRoXHJcblxyXG4gICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHdpZHRoOyB4KyspIHtcclxuICAgICAgICBjb25zdCBpbmRleCA9IHJvdyArIHhcclxuICAgICAgICBjb25zdCBkYXRhSW5kZXggPSBpbmRleCAqIDRcclxuXHJcbiAgICAgICAgY29uc3QgaXNQYWludCA9IHBhaW50UHRzW3ldICYmIHBhaW50UHRzW3ldIVt4XVxyXG5cclxuICAgICAgICBpZiAoaXNQYWludCkge1xyXG4gICAgICAgICAgYnVmZmVyLmRhdGFbZGF0YUluZGV4XSA9IHBhaW50Q29sb3JbMF1cclxuICAgICAgICAgIGJ1ZmZlci5kYXRhW2RhdGFJbmRleCArIDFdID0gcGFpbnRDb2xvclsxXVxyXG4gICAgICAgICAgYnVmZmVyLmRhdGFbZGF0YUluZGV4ICsgMl0gPSBwYWludENvbG9yWzJdXHJcbiAgICAgICAgICBidWZmZXIuZGF0YVtkYXRhSW5kZXggKyAzXSA9IDB4ZmZcclxuXHJcbiAgICAgICAgICBjb250aW51ZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaXNDaGVjayA9ICh4ICsgeSkgJSAyID09PSAwXHJcblxyXG4gICAgICAgIGJ1ZmZlci5kYXRhW2RhdGFJbmRleF0gPSBpc0NoZWNrID8gYmdDb2xvcjBbMF0gOiBiZ0NvbG9yMVswXVxyXG4gICAgICAgIGJ1ZmZlci5kYXRhW2RhdGFJbmRleCArIDFdID0gaXNDaGVjayA/IGJnQ29sb3IwWzFdIDogYmdDb2xvcjFbMV1cclxuICAgICAgICBidWZmZXIuZGF0YVtkYXRhSW5kZXggKyAyXSA9IGlzQ2hlY2sgPyBiZ0NvbG9yMFsyXSA6IGJnQ29sb3IxWzJdXHJcbiAgICAgICAgYnVmZmVyLmRhdGFbZGF0YUluZGV4ICsgM10gPSAweGZmXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBzcHJpdGVzLCBibGl0dGluZywgY29tcG9zaXRlIGV0Y1xyXG5cclxuICAgIC8vIGEwLi5iNyAgICBcclxuICAgIGNvbnN0IHRlc3RHcmlkID0gZ2VuZXJhdGVOYW1lZEdyaWRMYXlvdXQoXHJcbiAgICAgIGdlbmVyYXRlR3JpZExheW91dCgzMiwgMzIsIDIsIDgsIDEsIDEpXHJcbiAgICApXHJcblxyXG4gICAgY29uc3QgeyB3aWR0aDogZ3cgfSA9IHRlc3RHcmlkXHJcblxyXG4gICAgY29uc3Qgb2ZmWCA9IHdpZHRoIC0gZ3dcclxuICAgIGNvbnN0IG9mZlkgPSAwXHJcblxyXG4gICAgLy8gc3RyYWlnaHQgYmxpdFxyXG5cclxuICAgIGNvbnN0IHsgYTAgfSA9IHRlc3RHcmlkXHJcbiAgICBjb25zdCBhMFggPSBhMFswXSArIG9mZlhcclxuICAgIGNvbnN0IGEwWSA9IGEwWzFdICsgb2ZmWVxyXG5cclxuICAgIGJsaXQodGVzdEltZzAsIGJ1ZmZlciwgWzAsIDAsIHRlc3RJbWcwLndpZHRoLCB0ZXN0SW1nMC5oZWlnaHQsIGEwWCwgYTBZXSlcclxuXHJcbiAgICAvLyB0ZXN0aW5nIG9vYiBvbiBzcmNcclxuXHJcbiAgICBjb25zdCB7IGIwIH0gPSB0ZXN0R3JpZFxyXG4gICAgY29uc3QgYjBYID0gYjBbMF0gKyBvZmZYIC0gMTZcclxuICAgIGNvbnN0IGIwWSA9IGIwWzFdICsgb2ZmWSAtIDE2XHJcblxyXG4gICAgYmxpdChcclxuICAgICAgdGVzdEltZzAsIGJ1ZmZlcixcclxuICAgICAgW1xyXG4gICAgICAgIC0xNiwgLTE2LCB0ZXN0SW1nMC53aWR0aCArIDMyLCB0ZXN0SW1nMC5oZWlnaHQgKyAzMixcclxuICAgICAgICBiMFgsIGIwWVxyXG4gICAgICBdXHJcbiAgICApXHJcblxyXG4gICAgLy8gYWxwaGEgY29tcG9zaXRlXHJcblxyXG4gICAgY29uc3QgeyBhMSB9ID0gdGVzdEdyaWRcclxuICAgIGNvbnN0IGExWCA9IGExWzBdICsgb2ZmWFxyXG4gICAgY29uc3QgYTFZID0gYTFbMV0gKyBvZmZZXHJcblxyXG4gICAgY29tcG9zaXRlKFxyXG4gICAgICB0ZXN0SW1nMCwgYnVmZmVyLCBbMCwgMCwgdGVzdEltZzAud2lkdGgsIHRlc3RJbWcwLmhlaWdodCwgYTFYLCBhMVldLCAwLjVcclxuICAgIClcclxuXHJcbiAgICAvLyBvb2Igb24gZGVzdFxyXG5cclxuICAgIGNvbnN0IHsgYjEgfSA9IHRlc3RHcmlkXHJcbiAgICBjb25zdCBiMVggPSBiMVswXSArIG9mZlggKyAxNlxyXG4gICAgY29uc3QgYjFZID0gYjFbMV0gKyBvZmZZXHJcblxyXG4gICAgYmxpdChcclxuICAgICAgdGVzdEltZzAsIGJ1ZmZlcixcclxuICAgICAgW1xyXG4gICAgICAgIDAsIDAsIHRlc3RJbWcwLndpZHRoLCB0ZXN0SW1nMC5oZWlnaHQsXHJcbiAgICAgICAgYjFYLCBiMVlcclxuICAgICAgXVxyXG4gICAgKVxyXG5cclxuICAgIC8vIGNvbG9yIGZpbGxcclxuXHJcbiAgICBjb25zdCB7IGEyIH0gPSB0ZXN0R3JpZFxyXG4gICAgY29uc3QgYTJYID0gYTJbMF0gKyBvZmZYXHJcbiAgICBjb25zdCBhMlkgPSBhMlsxXSArIG9mZllcclxuXHJcbiAgICBjb25zdCBjb2xvciA9IGNyZWF0ZUNvbG9yKDB4NmMsIDB4MjgsIDB4YmMpXHJcblxyXG4gICAgZmlsbChcclxuICAgICAgYnVmZmVyLCBjb2xvcixcclxuICAgICAgW2EyWCwgYTJZLCB0ZXN0SW1nMC53aWR0aCwgdGVzdEltZzAuaGVpZ2h0XVxyXG4gICAgKVxyXG5cclxuICAgIC8vIHNwcml0ZSByb3RhdGlvblxyXG5cclxuICAgIGNvbnN0IHsgYjIgfSA9IHRlc3RHcmlkXHJcbiAgICBjb25zdCBiMlggPSBiMlswXSArIG9mZlggKyB0ZXN0SW1nMC53aWR0aCAvIDJcclxuICAgIGNvbnN0IGIyWSA9IGIyWzFdICsgb2ZmWSArIHRlc3RJbWcwLmhlaWdodCAvIDJcclxuXHJcbiAgICBkcmF3Um90YXRlZChcclxuICAgICAgdGVzdEltZzAsIHRlc3RJbWcwLndpZHRoIC8gMiwgdGVzdEltZzAuaGVpZ2h0IC8gMixcclxuICAgICAgYnVmZmVyLCBiMlgsIGIyWSxcclxuICAgICAgcG9seVJvdGF0aW9uXHJcbiAgICApXHJcblxyXG4gICAgLy8gYmxpdFJvd3MgdGVzdFxyXG5cclxuICAgIGNvbnN0IHsgYTMgfSA9IHRlc3RHcmlkXHJcbiAgICBjb25zdCBhM1ggPSBhM1swXSArIG9mZlhcclxuICAgIGNvbnN0IGEzWSA9IGEzWzFdICsgb2ZmWVxyXG5cclxuICAgIGZpbGwoYnVmZmVyLCBjcmVhdGVDb2xvcigwLCAwLCAwKSwgW2EzWCwgYTNZLCBwYXR0ZXJuMC53aWR0aCwgcGF0dGVybjAuaGVpZ2h0XSlcclxuXHJcbiAgICBibGl0Um93cyhcclxuICAgICAgcGF0dGVybkNvbG9ySW1hZ2UsIHBhdHRlcm4wUm93cywgYnVmZmVyLCBhM1gsIGEzWVxyXG4gICAgKVxyXG5cclxuICAgIC8vIGdyYWRpZW50IHRlc3RcclxuXHJcbiAgICBjb25zdCB7IGIzIH0gPSB0ZXN0R3JpZFxyXG4gICAgY29uc3QgYjNYID0gYjNbMF0gKyBvZmZYXHJcbiAgICBjb25zdCBiM1kgPSBiM1sxXSArIG9mZllcclxuXHJcbiAgICBjb25zdCBnQ29sb3JzMCA9IGdlbmVyYXRlSHVlcyg2KVxyXG5cclxuICAgIGNvbnN0IHN0ZXAwID0gMSAvIChnQ29sb3JzMC5sZW5ndGggLSAxKVxyXG5cclxuICAgIGNvbnN0IGdTdG9wczAgPSBnQ29sb3JzMC5tYXAoKGMsIGkpID0+IHtcclxuICAgICAgY29uc3QgcmdiYSA9IGNvbG9yVG9SZ2JhKGMpXHJcblxyXG4gICAgICByZXR1cm4gWy4uLnJnYmEsIGkgKiBzdGVwMF0gYXMgVDVcclxuICAgIH0pXHJcblxyXG4gICAgY29uc3QgZ0ltYWdlMCA9IGNyZWF0ZUltYWdlKDMyLCAzMilcclxuXHJcbiAgICBmb3IgKGxldCB4ID0gMDsgeCA8IGdJbWFnZTAud2lkdGg7IHgrKykge1xyXG4gICAgICBjb25zdCBhdCA9IHggLyAoZ0ltYWdlMC53aWR0aCAtIDEpXHJcbiAgICAgIGNvbnN0IHJnYmEgPSBzYW1wbGVHcmFkaWVudChnU3RvcHMwLCBhdClcclxuICAgICAgY29uc3QgY29sb3IgPSBjcmVhdGVDb2xvciguLi5yZ2JhKVxyXG5cclxuICAgICAgZmlsbENvbChnSW1hZ2UwLCBjb2xvciwgeClcclxuICAgIH1cclxuXHJcbiAgICBibGl0KGdJbWFnZTAsIGJ1ZmZlciwgWzAsIDAsIGdJbWFnZTAud2lkdGgsIGdJbWFnZTAuaGVpZ2h0LCBiM1gsIGIzWV0pXHJcblxyXG4gICAgLy8gZ3JhZGllbnQgdGVzdCAyLCBhbHBoYSArIGNvbXBvc2l0ZVxyXG5cclxuICAgIGNvbnN0IHsgYTQgfSA9IHRlc3RHcmlkXHJcbiAgICBjb25zdCBhNFggPSBhNFswXSArIG9mZlhcclxuICAgIGNvbnN0IGE0WSA9IGE0WzFdICsgb2ZmWVxyXG5cclxuICAgIGNvbnN0IGdDb2xvcnMxID0gZ0NvbG9yczAuc2xpY2UoKS5yZXZlcnNlKClcclxuXHJcbiAgICBjb25zdCBzdGVwMSA9IDEgLyAoZ0NvbG9yczEubGVuZ3RoIC0gMSlcclxuXHJcbiAgICBjb25zdCBnc3RvcHMxID0gZ0NvbG9yczEubWFwKChjLCBpKSA9PiB7XHJcbiAgICAgIGNvbnN0IFtyLCBnLCBiXSA9IGNvbG9yVG9SZ2JhKGMpXHJcbiAgICAgIGNvbnN0IGEgPSBpICogc3RlcDEgKiAyNTVcclxuXHJcbiAgICAgIHJldHVybiBbciwgZywgYiwgYSwgaSAqIHN0ZXAxXSBhcyBUNVxyXG4gICAgfSlcclxuXHJcbiAgICBjb25zdCBnSW1hZ2UxID0gY3JlYXRlSW1hZ2UoMzIsIDMyKVxyXG5cclxuICAgIGZvciAobGV0IHggPSAwOyB4IDwgZ0ltYWdlMS53aWR0aDsgeCsrKSB7XHJcbiAgICAgIGNvbnN0IGF0ID0geCAvIChnSW1hZ2UxLndpZHRoIC0gMSlcclxuICAgICAgY29uc3QgcmdiYSA9IHNhbXBsZUdyYWRpZW50KGdzdG9wczEsIGF0KVxyXG4gICAgICBjb25zdCBjb2xvciA9IGNyZWF0ZUNvbG9yKC4uLnJnYmEpXHJcblxyXG4gICAgICBncmFkaWVudExvZ2dlci5sb2coJ2dyYWRpZW50JywgeCwgcmdiYSlcclxuXHJcbiAgICAgIGZpbGxDb2woZ0ltYWdlMSwgY29sb3IsIHgpXHJcbiAgICB9XHJcblxyXG4gICAgY29tcG9zaXRlKFxyXG4gICAgICBnSW1hZ2UxLCBidWZmZXIsIFswLCAwLCBnSW1hZ2UxLndpZHRoLCBnSW1hZ2UxLmhlaWdodCwgYTRYLCBhNFldXHJcbiAgICApXHJcblxyXG4gICAgLy8gaG9yaXpvbnRhbGx5IHNsb3BpbmcgbGluZVxyXG5cclxuICAgIGNvbnN0IHRlc3RMaW5lQ29sb3IgPSBjcmVhdGVDb2xvcigweDMzLCAweGZmLCAweDk5KVxyXG5cclxuICAgIGNvbnN0IHRlc3RMaW5lOiBUNCA9IFstMzIsIGhlaWdodCAvIDIgLSAzMiwgd2lkdGggKyAzMiwgaGVpZ2h0IC8gMiArIDMyXVxyXG5cclxuICAgIC8vIG5iIC0gdGhpcyBpcyBvbmx5IGZhc3RlciB3aXRoIHRoZSByaWdodCBzbG9wZSAtIG90aGVyd2lzZSBpdCBpcyBzbG93ZXJcclxuICAgIC8vIGl0IGlzIGJldHRlciB0byB1c2UgYnJlc2VuaGFtIGZvciB0aGUgZ2VuZXJhbCBjYXNlXHJcbiAgICBjb25zdCB0ZXN0TGluZVJvd3MgPSBsaW5lVG9Sb3dzKC4uLnRlc3RMaW5lKVxyXG5cclxuICAgIGZpbGxSb3dzKHRlc3RMaW5lUm93cywgYnVmZmVyLCB0ZXN0TGluZUNvbG9yKVxyXG5cclxuICAgIC8vIHJlY3QgdmlhIHJvd3NcclxuXHJcbiAgICBjb25zdCByZWN0Q29sb3IgPSBjcmVhdGVDb2xvcigweGZmLCAweDk5LCAweDMzKVxyXG5cclxuICAgIGNvbnN0IHRlc3RSZWN0OiBUNCA9IFs0OCwgNDgsIDMyLCAyNF1cclxuICAgIGNvbnN0IHRlc3RSZWN0Um93cyA9IHJlY3RUb1Jvd3MoLi4udGVzdFJlY3QpXHJcblxyXG4gICAgZmlsbFJvd3ModGVzdFJlY3RSb3dzLCBidWZmZXIsIHJlY3RDb2xvcilcclxuXHJcbiAgICAvLyBwb2x5Z29uXHJcblxyXG4gICAgY29uc3QgbWluU2lkZSA9IE1hdGgubWluKHdpZHRoLCBoZWlnaHQpXHJcbiAgICBjb25zdCBmaWxsQ29sb3JzID0gZ2VuZXJhdGVIdWVzKHBvbHlTaWRlcylcclxuXHJcbiAgICBjb25zdCBzaGFwZSA9IHBvbHlnb25UcmlhbmdsZXMoXHJcbiAgICAgIHBvbHlTaWRlcywgd2lkdGggLyAyLCBoZWlnaHQgLyAyLCBtaW5TaWRlIC8gNCwgcG9seVJvdGF0aW9uXHJcbiAgICApXHJcblxyXG4gICAgY29uc3QgZnJhbWVUaW1lID0gc3RhdGUudGltZS5nZXRGcmFtZVRpbWUoKVxyXG4gICAgY29uc3Qgcm90YXRlQnkgPSAwLjAwMSAqIGZyYW1lVGltZVxyXG5cclxuICAgIGNvbnN0IHN0cm9rZUxpbmUgPSAobGluZTogVDQsIGNvbG9yOiBudW1iZXIpID0+IHtcclxuICAgICAgY29uc3QgcHRzID0gYnJlc2VuaGFtTGluZSguLi5saW5lKVxyXG4gICAgICBjb25zdCBpbmRpY2VzID0gcG9pbnRzVG9JbmRpY2VzKHdpZHRoLCBoZWlnaHQsIDEpKHB0cylcclxuXHJcbiAgICAgIGZpbGxJbmRpY2VzKGluZGljZXMsIGJ1ZmZlciwgY29sb3IpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3Ryb2tlVHJpID0gKHRyaTogVDM8VDI+LCBjb2xvcjogbnVtYmVyKSA9PiB7XHJcbiAgICAgIGNvbnN0IGxpbmUwOiBUNCA9IFt0cmlbMF1bMF0sIHRyaVswXVsxXSwgdHJpWzFdWzBdLCB0cmlbMV1bMV1dXHJcbiAgICAgIGNvbnN0IGxpbmUxOiBUNCA9IFt0cmlbMV1bMF0sIHRyaVsxXVsxXSwgdHJpWzJdWzBdLCB0cmlbMl1bMV1dXHJcbiAgICAgIGNvbnN0IGxpbmUyOiBUNCA9IFt0cmlbMl1bMF0sIHRyaVsyXVsxXSwgdHJpWzBdWzBdLCB0cmlbMF1bMV1dXHJcblxyXG4gICAgICBzdHJva2VMaW5lKGxpbmUwLCBjb2xvcilcclxuICAgICAgc3Ryb2tlTGluZShsaW5lMSwgY29sb3IpXHJcbiAgICAgIHN0cm9rZUxpbmUobGluZTIsIGNvbG9yKVxyXG4gICAgfVxyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9seVNpZGVzOyBpKyspIHtcclxuICAgICAgY29uc3QgY29sb3IgPSBmaWxsQ29sb3JzW2kgJSBmaWxsQ29sb3JzLmxlbmd0aF1cclxuICAgICAgY29uc3QgdHJpID0gc2hhcGVbaV1cclxuXHJcbiAgICAgIGNvbnN0IHB0cmlSb3dzID0gdHJpYW5nbGVUb1Jvd3MoLi4udHJpKVxyXG4gICAgICBmaWxsUm93cyhwdHJpUm93cywgYnVmZmVyLCBjb2xvcilcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdHJva2VDb2xvcnMgPSBzdHJva2VQb2x5ID8gZ2VuZXJhdGVIdWVzKHBvbHlTaWRlcywgNTApIDogZmlsbENvbG9yc1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9seVNpZGVzOyBpKyspIHtcclxuICAgICAgY29uc3QgY29sb3IgPSBzdHJva2VDb2xvcnNbaSAlIHN0cm9rZUNvbG9ycy5sZW5ndGhdXHJcbiAgICAgIGNvbnN0IHRyaSA9IHNoYXBlW2ldXHJcblxyXG4gICAgICBzdHJva2VUcmkodHJpLCBjb2xvcilcclxuICAgIH1cclxuXHJcbiAgICAvLyBzaG93IGN1c3RvbSBjdXJzb3JcclxuXHJcbiAgICBpZiAoc3RhdGUubW91c2UuaXNJbkJvdW5kcygpKSB7XHJcbiAgICAgIGNvbXBvc2l0ZShcclxuICAgICAgICBjdXJzb3IsIGJ1ZmZlcixcclxuICAgICAgICBbMCwgMCwgY3Vyc29yLndpZHRoLCBjdXJzb3IuaGVpZ2h0LCBzdGF0ZS5tb3VzZS5nZXRYKCksIHN0YXRlLm1vdXNlLmdldFkoKV1cclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIC8vXHJcblxyXG4gICAgcG9seVJvdGF0aW9uICs9IHJvdGF0ZUJ5XHJcblxyXG4gICAgZnJhbWUrK1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcXVpdCA9IGFzeW5jIChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdxdWl0dGluZyBkZWJ1ZyBzY2VuZScpXHJcblxyXG4gICAgcmVsZWFzZU1vdXNlKClcclxuICB9XHJcblxyXG4gIGNvbnN0IHNldEFjdGl2ZSA9IChhY3RpdmU6IGJvb2xlYW4pID0+IHtcclxuICAgIC8vIHdlIGp1c3QgZ290IGZvY3VzXHJcbiAgICBpZiAoYWN0aXZlICYmICFpc0FjdGl2ZSkge1xyXG4gICAgICB0YWtlTW91c2UoKVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHdlIGp1c3QgbG9zdCBmb2N1cyBcclxuICAgIGlmICghYWN0aXZlICYmIGlzQWN0aXZlKSB7XHJcbiAgICAgIHJlbGVhc2VNb3VzZSgpXHJcbiAgICB9XHJcblxyXG4gICAgaXNBY3RpdmUgPSBhY3RpdmVcclxuICB9XHJcblxyXG4gIHJldHVybiB7IGluaXQsIHVwZGF0ZSwgcXVpdCwgc2V0QWN0aXZlIH1cclxufVxyXG4iXX0=
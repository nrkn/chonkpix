import { blit } from '../lib/image/blit.js';
import { createColor } from '../lib/image/color.js';
import { createImage } from '../lib/image/create.js';
import { fill } from '../lib/image/fill.js';
import { strokeRect } from '../lib/image/stroke.js';
// renders two scenes side by side
// tab to switch between scenes
// escape to quit
//
// contains the requisite patterns for more complex composite scenes
export const splitScene = (left, right, bgColor = createColor(0x00, 0x00, 0x00), activeBorderColor = createColor(0xff, 0xd7, 0x00), padding = 1) => {
    let active = 0;
    let leftBuffer;
    let rightBuffer;
    let leftState;
    let rightState;
    let lastW = 0;
    let lastH = 0;
    // enable key/mouse handling for the active scene
    // disable key/mouse handling for the inactive scene
    const onSwitch = (state) => {
        if (active === 0) {
            enableIo(leftState, state);
            disableIo(rightState);
            if (left.setActive)
                left.setActive(true);
            if (right.setActive)
                right.setActive(false);
        }
        else {
            enableIo(rightState, state);
            disableIo(leftState);
            if (right.setActive)
                right.setActive(true);
            if (left.setActive)
                left.setActive(false);
        }
    };
    // get the rects for the left and right scenes taking into account padding
    const getRects = () => {
        const w = lastW - padding * 3;
        const h = lastH - padding * 2;
        const halfW = Math.floor(w / 2);
        const leftR = [padding, padding, halfW, h];
        const rightR = [halfW + padding * 2, padding, halfW, h];
        return [leftR, rightR];
    };
    const resized = (state) => {
        lastW = state.view.buffer.width;
        lastH = state.view.buffer.height;
        const [leftR, rightR] = getRects();
        leftBuffer = createImage(leftR[2], leftR[3]);
        rightBuffer = createImage(rightR[2], rightR[3]);
        updateSize(leftState, state, leftR);
        updateSize(rightState, state, rightR);
        Object.defineProperty(leftState.view, 'buffer', {
            get() {
                return leftBuffer;
            }
        });
        Object.defineProperty(rightState.view, 'buffer', {
            get() {
                return rightBuffer;
            }
        });
    };
    const init = async (state) => {
        lastW = state.view.buffer.width;
        lastH = state.view.buffer.height;
        leftState = wrapState(state, leftBuffer);
        rightState = wrapState(state, rightBuffer);
        resized(state);
        await left.init(leftState);
        await right.init(rightState);
        onSwitch(state);
    };
    const update = (state) => {
        // note that capturing and consuming the keys here means that child scenes
        // won't be able to see them - in this case, it is intentional, but keep
        // that in mind!
        //
        // if we find a use case for *not* doing this we can add options to the 
        // splitScene factory function
        if (state.keys['Escape']) {
            state.running = false;
            state.keys['Escape'] = false;
            return;
        }
        if (state.keys['Tab']) {
            active = active === 0 ? 1 : 0;
            state.keys['Tab'] = false;
            onSwitch(state);
        }
        const { buffer } = state.view;
        const { width, height } = buffer;
        if (width !== lastW || height !== lastH) {
            resized(state);
        }
        // update the child scenes
        left.update(leftState);
        right.update(rightState);
        // draw the split view
        const leftBorderRect = [
            0, 0,
            leftBuffer.width + padding * 2, leftBuffer.height + padding * 2
        ];
        const rightBorderRect = [
            leftBuffer.width + padding * 2 - 1, 0,
            rightBuffer.width + padding * 2, rightBuffer.height + padding * 2
        ];
        const activeRect = active === 0 ? leftBorderRect : rightBorderRect;
        const inactiveRect = active === 0 ? rightBorderRect : leftBorderRect;
        fill(buffer, bgColor);
        strokeRect(buffer, inactiveRect, bgColor);
        strokeRect(buffer, activeRect, activeBorderColor);
        blit(leftBuffer, buffer, [
            0, 0, leftBuffer.width, leftBuffer.height,
            padding, padding
        ]);
        blit(rightBuffer, buffer, [
            0, 0, rightBuffer.width, rightBuffer.height,
            leftBuffer.width + padding * 2, padding
        ]);
    };
    const quit = async (state) => {
        await left.quit(state);
        await right.quit(state);
    };
    return { init, update, quit };
};
// overwrite mouseX, mouseY and inBounds for new size
const updateSize = (state, parentState, rect) => {
    Object.defineProperty(state.mouse, 'x', {
        get() {
            return parentState.mouse.x - rect[0];
        }
    });
    Object.defineProperty(state.mouse, 'y', {
        get() {
            return parentState.mouse.y - rect[1];
        }
    });
    Object.defineProperty(state.mouse, 'inBounds', {
        get() {
            const [_x, _y, w, h] = rect;
            return (parentState.mouse.inBounds &&
                state.mouse.x >= 0 && state.mouse.x < w &&
                state.mouse.y >= 0 && state.mouse.y < h);
        }
    });
};
// this state will no longer see or modify the parent state's io
const disableIo = (state) => {
    Object.defineProperty(state, 'keys', {
        get() {
            return {};
        },
        set(_value) {
            // ignore
        }
    });
    Object.defineProperty(state, 'keyPresses', {
        get() {
            return [];
        },
        set(_value) {
            // ignore
        }
    });
    Object.defineProperty(state.mouse, 'buttons', {
        get() {
            return {};
        },
        set(_value) {
            // ignore
        }
    });
    Object.defineProperty(state.mouse, 'wheel', {
        get() {
            return 0;
        }
    });
};
// reattaches the parent state's io to the child state
const enableIo = (state, parentState) => {
    Object.defineProperty(state, 'keys', {
        get() {
            return parentState.keys;
        },
        set(value) {
            parentState.keys = value;
        }
    });
    Object.defineProperty(state, 'keyPresses', {
        get() {
            return parentState.keyPresses;
        },
        set(value) {
            parentState.keyPresses = value;
        }
    });
    Object.defineProperty(state.mouse, 'buttons', {
        get() {
            return parentState.mouse.buttons;
        },
        set(value) {
            parentState.mouse.buttons = value;
        }
    });
    Object.defineProperty(state.mouse, 'wheel', {
        get() {
            return parentState.mouse.wheel;
        }
    });
};
// create a new wrapped state object with its own buffer
const wrapState = (state, buffer) => {
    const wrapped = {
        get keys() {
            return state.keys;
        },
        set keys(value) {
            state.keys = value;
        },
        get keyPresses() {
            return state.keyPresses;
        },
        set keyPresses(value) {
            state.keyPresses = value;
        },
        mouse: {
            get buttons() {
                return state.mouse.buttons;
            },
            set buttons(value) {
                state.mouse.buttons = value;
            },
            get x() {
                return state.mouse.x;
            },
            get y() {
                return state.mouse.y;
            },
            get inBounds() {
                return state.mouse.inBounds;
            },
            get wheel() {
                return state.mouse.wheel;
            }
        },
        time: {
            get elapsed() {
                return state.time.elapsed;
            },
            get frameTime() {
                return state.time.frameTime;
            }
        },
        view: {
            get zoom() {
                return state.view.zoom;
            },
            set zoom(value) {
                state.view.zoom = value;
            },
            get buffer() {
                return buffer;
            }
        },
        get running() {
            return state.running;
        },
        set running(value) {
            state.running = value;
        },
        get debug() {
            return state.debug;
        },
        set debug(value) {
            state.debug = value;
        }
    };
    return wrapped;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BsaXQtc2NlbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2NlbmVzL3NwbGl0LXNjZW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUMzQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFDbkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ3BELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFHbkQsa0NBQWtDO0FBQ2xDLCtCQUErQjtBQUMvQixpQkFBaUI7QUFDakIsRUFBRTtBQUNGLG9FQUFvRTtBQUNwRSxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUcsQ0FDeEIsSUFBVyxFQUFFLEtBQVksRUFDekIsT0FBTyxHQUFHLFdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUN2QyxpQkFBaUIsR0FBRyxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsRUFDakQsT0FBTyxHQUFHLENBQUMsRUFDSixFQUFFO0lBQ1QsSUFBSSxNQUFNLEdBQVUsQ0FBQyxDQUFBO0lBRXJCLElBQUksVUFBcUIsQ0FBQTtJQUN6QixJQUFJLFdBQXNCLENBQUE7SUFFMUIsSUFBSSxTQUFnQixDQUFBO0lBQ3BCLElBQUksVUFBaUIsQ0FBQTtJQUVyQixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7SUFDYixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7SUFFYixpREFBaUQ7SUFDakQsb0RBQW9EO0lBQ3BELE1BQU0sUUFBUSxHQUFHLENBQUMsS0FBWSxFQUFFLEVBQUU7UUFDaEMsSUFBSSxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDakIsUUFBUSxDQUFDLFNB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SUFBSSxHQUFHLEtBQUssQ0FBQTtZQUN6QixDQUFDO1lBQ0QsSUFBSSxNQUFNO2dCQUNSLE9BQU8sTUFBTSxDQUFBO1lBQ2YsQ0FBQztTQUNGO1FBRUQsSUFBSSxPQUFPO1lBQ1QsT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFBO1FBQ3RCLENBQUM7UUFDRCxJQUFJLE9BQU8sQ0FBQyxLQUFLO1lBQ2YsS0FBSyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUE7UUFDdkIsQ0FBQztRQUNELElBQUksS0FBSztZQUNQLE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FBQTtRQUNwQixDQUFDO1FBQ0QsSUFBSSxLQUFLLENBQUMsS0FBSztZQUNiLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1FBQ3JCLENBQUM7S0FDRixDQUFBO0lBRUQsT0FBTyxPQUFPLENBQUE7QUFDaEIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYmxpdCB9IGZyb20gJy4uL2xpYi9pbWFnZS9ibGl0LmpzJ1xyXG5pbXBvcnQgeyBjcmVhdGVDb2xvciB9IGZyb20gJy4uL2xpYi9pbWFnZS9jb2xvci5qcydcclxuaW1wb3J0IHsgY3JlYXRlSW1hZ2UgfSBmcm9tICcuLi9saWIvaW1hZ2UvY3JlYXRlLmpzJ1xyXG5pbXBvcnQgeyBmaWxsIH0gZnJvbSAnLi4vbGliL2ltYWdlL2ZpbGwuanMnXHJcbmltcG9ydCB7IHN0cm9rZVJlY3QgfSBmcm9tICcuLi9saWIvaW1hZ2Uvc3Ryb2tlLmpzJ1xyXG5pbXBvcnQgeyBTY2VuZSwgU3RhdGUsIFQyLCBUNCB9IGZyb20gJy4uL2xpYi90eXBlcy5qcydcclxuXHJcbi8vIHJlbmRlcnMgdHdvIHNjZW5lcyBzaWRlIGJ5IHNpZGVcclxuLy8gdGFiIHRvIHN3aXRjaCBiZXR3ZWVuIHNjZW5lc1xyXG4vLyBlc2NhcGUgdG8gcXVpdFxyXG4vL1xyXG4vLyBjb250YWlucyB0aGUgcmVxdWlzaXRlIHBhdHRlcm5zIGZvciBtb3JlIGNvbXBsZXggY29tcG9zaXRlIHNjZW5lc1xyXG5leHBvcnQgY29uc3Qgc3BsaXRTY2VuZSA9IChcclxuICBsZWZ0OiBTY2VuZSwgcmlnaHQ6IFNjZW5lLCBcclxuICBiZ0NvbG9yID0gY3JlYXRlQ29sb3IoMHgwMCwgMHgwMCwgMHgwMCksXHJcbiAgYWN0aXZlQm9yZGVyQ29sb3IgPSBjcmVhdGVDb2xvcigweGZmLCAweGQ3LCAweDAwKSxcclxuICBwYWRkaW5nID0gMVxyXG4pOiBTY2VuZSA9PiB7XHJcbiAgbGV0IGFjdGl2ZTogMCB8IDEgPSAwXHJcblxyXG4gIGxldCBsZWZ0QnVmZmVyOiBJbWFnZURhdGFcclxuICBsZXQgcmlnaHRCdWZmZXI6IEltYWdlRGF0YVxyXG5cclxuICBsZXQgbGVmdFN0YXRlOiBTdGF0ZVxyXG4gIGxldCByaWdodFN0YXRlOiBTdGF0ZVxyXG5cclxuICBsZXQgbGFzdFcgPSAwXHJcbiAgbGV0IGxhc3RIID0gMFxyXG5cclxuICAvLyBlbmFibGUga2V5L21vdXNlIGhhbmRsaW5nIGZvciB0aGUgYWN0aXZlIHNjZW5lXHJcbiAgLy8gZGlzYWJsZSBrZXkvbW91c2UgaGFuZGxpbmcgZm9yIHRoZSBpbmFjdGl2ZSBzY2VuZVxyXG4gIGNvbnN0IG9uU3dpdGNoID0gKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgaWYgKGFjdGl2ZSA9PT0gMCkge1xyXG4gICAgICBlbmFibGVJbyhsZWZ0U3RhdGUsIHN0YXRlKVxyXG4gICAgICBkaXNhYmxlSW8ocmlnaHRTdGF0ZSlcclxuICAgICAgaWYoIGxlZnQuc2V0QWN0aXZlICkgbGVmdC5zZXRBY3RpdmUodHJ1ZSlcclxuICAgICAgaWYoIHJpZ2h0LnNldEFjdGl2ZSApIHJpZ2h0LnNldEFjdGl2ZShmYWxzZSlcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGVuYWJsZUlvKHJpZ2h0U3RhdGUsIHN0YXRlKVxyXG4gICAgICBkaXNhYmxlSW8obGVmdFN0YXRlKVxyXG4gICAgICBpZiggcmlnaHQuc2V0QWN0aXZlICkgcmlnaHQuc2V0QWN0aXZlKHRydWUpXHJcbiAgICAgIGlmKCBsZWZ0LnNldEFjdGl2ZSApIGxlZnQuc2V0QWN0aXZlKGZhbHNlKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gZ2V0IHRoZSByZWN0cyBmb3IgdGhlIGxlZnQgYW5kIHJpZ2h0IHNjZW5lcyB0YWtpbmcgaW50byBhY2NvdW50IHBhZGRpbmdcclxuICBjb25zdCBnZXRSZWN0cyA9ICgpOiBUMjxUND4gPT4ge1xyXG4gICAgY29uc3QgdyA9IGxhc3RXIC0gcGFkZGluZyAqIDNcclxuICAgIGNvbnN0IGggPSBsYXN0SCAtIHBhZGRpbmcgKiAyXHJcblxyXG4gICAgY29uc3QgaGFsZlcgPSBNYXRoLmZsb29yKHcgLyAyKVxyXG5cclxuICAgIGNvbnN0IGxlZnRSOiBUNCA9IFtwYWRkaW5nLCBwYWRkaW5nLCBoYWxmVywgaF1cclxuICAgIGNvbnN0IHJpZ2h0UjogVDQgPSBbaGFsZlcgKyBwYWRkaW5nICogMiwgcGFkZGluZywgaGFsZlcsIGhdXHJcblxyXG4gICAgcmV0dXJuIFtsZWZ0UiwgcmlnaHRSXVxyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVzaXplZCA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGxhc3RXID0gc3RhdGUudmlldy5idWZmZXIud2lkdGhcclxuICAgIGxhc3RIID0gc3RhdGUudmlldy5idWZmZXIuaGVpZ2h0XHJcblxyXG4gICAgY29uc3QgW2xlZnRSLCByaWdodFJdID0gZ2V0UmVjdHMoKVxyXG5cclxuICAgIGxlZnRCdWZmZXIgPSBjcmVhdGVJbWFnZShsZWZ0UlsyXSwgbGVmdFJbM10pXHJcbiAgICByaWdodEJ1ZmZlciA9IGNyZWF0ZUltYWdlKHJpZ2h0UlsyXSwgcmlnaHRSWzNdKVxyXG5cclxuICAgIHVwZGF0ZVNpemUobGVmdFN0YXRlLCBzdGF0ZSwgbGVmdFIpXHJcbiAgICB1cGRhdGVTaXplKHJpZ2h0U3RhdGUsIHN0YXRlLCByaWdodFIpXHJcblxyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxlZnRTdGF0ZS52aWV3LCAnYnVmZmVyJywge1xyXG4gICAgICBnZXQoKSB7XHJcbiAgICAgICAgcmV0dXJuIGxlZnRCdWZmZXJcclxuICAgICAgfVxyXG4gICAgfSlcclxuXHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocmlnaHRTdGF0ZS52aWV3LCAnYnVmZmVyJywge1xyXG4gICAgICBnZXQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHJpZ2h0QnVmZmVyXHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBjb25zdCBpbml0ID0gYXN5bmMgKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgbGFzdFcgPSBzdGF0ZS52aWV3LmJ1ZmZlci53aWR0aFxyXG4gICAgbGFzdEggPSBzdGF0ZS52aWV3LmJ1ZmZlci5oZWlnaHRcclxuXHJcbiAgICBsZWZ0U3RhdGUgPSB3cmFwU3RhdGUoc3RhdGUsIGxlZnRCdWZmZXIpXHJcbiAgICByaWdodFN0YXRlID0gd3JhcFN0YXRlKHN0YXRlLCByaWdodEJ1ZmZlcilcclxuXHJcbiAgICByZXNpemVkKHN0YXRlKVxyXG5cclxuICAgIGF3YWl0IGxlZnQuaW5pdChsZWZ0U3RhdGUpXHJcbiAgICBhd2FpdCByaWdodC5pbml0KHJpZ2h0U3RhdGUpXHJcblxyXG4gICAgb25Td2l0Y2goc3RhdGUpXHJcbiAgfVxyXG5cclxuICBjb25zdCB1cGRhdGUgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICAvLyBub3RlIHRoYXQgY2FwdHVyaW5nIGFuZCBjb25zdW1pbmcgdGhlIGtleXMgaGVyZSBtZWFucyB0aGF0IGNoaWxkIHNjZW5lc1xyXG4gICAgLy8gd29uJ3QgYmUgYWJsZSB0byBzZWUgdGhlbSAtIGluIHRoaXMgY2FzZSwgaXQgaXMgaW50ZW50aW9uYWwsIGJ1dCBrZWVwXHJcbiAgICAvLyB0aGF0IGluIG1pbmQhXHJcbiAgICAvL1xyXG4gICAgLy8gaWYgd2UgZmluZCBhIHVzZSBjYXNlIGZvciAqbm90KiBkb2luZyB0aGlzIHdlIGNhbiBhZGQgb3B0aW9ucyB0byB0aGUgXHJcbiAgICAvLyBzcGxpdFNjZW5lIGZhY3RvcnkgZnVuY3Rpb25cclxuICAgIGlmIChzdGF0ZS5rZXlzWydFc2NhcGUnXSkge1xyXG4gICAgICBzdGF0ZS5ydW5uaW5nID0gZmFsc2VcclxuICAgICAgc3RhdGUua2V5c1snRXNjYXBlJ10gPSBmYWxzZVxyXG5cclxuICAgICAgcmV0dXJuXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHN0YXRlLmtleXNbJ1RhYiddKSB7XHJcbiAgICAgIGFjdGl2ZSA9IGFjdGl2ZSA9PT0gMCA/IDEgOiAwXHJcbiAgICAgIHN0YXRlLmtleXNbJ1RhYiddID0gZmFsc2VcclxuXHJcbiAgICAgIG9uU3dpdGNoKHN0YXRlKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHsgYnVmZmVyIH0gPSBzdGF0ZS52aWV3XHJcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IGJ1ZmZlclxyXG5cclxuICAgIGlmICh3aWR0aCAhPT0gbGFzdFcgfHwgaGVpZ2h0ICE9PSBsYXN0SCkge1xyXG4gICAgICByZXNpemVkKHN0YXRlKVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHVwZGF0ZSB0aGUgY2hpbGQgc2NlbmVzXHJcblxyXG4gICAgbGVmdC51cGRhdGUobGVmdFN0YXRlKVxyXG4gICAgcmlnaHQudXBkYXRlKHJpZ2h0U3RhdGUpXHJcblxyXG4gICAgLy8gZHJhdyB0aGUgc3BsaXQgdmlld1xyXG5cclxuICAgIGNvbnN0IGxlZnRCb3JkZXJSZWN0OiBUNCA9IFtcclxuICAgICAgMCwgMCxcclxuICAgICAgbGVmdEJ1ZmZlci53aWR0aCArIHBhZGRpbmcgKiAyLCBsZWZ0QnVmZmVyLmhlaWdodCArIHBhZGRpbmcgKiAyXHJcbiAgICBdXHJcblxyXG4gICAgY29uc3QgcmlnaHRCb3JkZXJSZWN0OiBUNCA9IFtcclxuICAgICAgbGVmdEJ1ZmZlci53aWR0aCArIHBhZGRpbmcgKiAyIC0gMSwgMCxcclxuICAgICAgcmlnaHRCdWZmZXIud2lkdGggKyBwYWRkaW5nICogMiwgcmlnaHRCdWZmZXIuaGVpZ2h0ICsgcGFkZGluZyAqIDJcclxuICAgIF1cclxuXHJcbiAgICBjb25zdCBhY3RpdmVSZWN0ID0gYWN0aXZlID09PSAwID8gbGVmdEJvcmRlclJlY3QgOiByaWdodEJvcmRlclJlY3RcclxuICAgIGNvbnN0IGluYWN0aXZlUmVjdCA9IGFjdGl2ZSA9PT0gMCA/IHJpZ2h0Qm9yZGVyUmVjdCA6IGxlZnRCb3JkZXJSZWN0XHJcblxyXG4gICAgZmlsbChidWZmZXIsIGJnQ29sb3IpXHJcblxyXG4gICAgc3Ryb2tlUmVjdChidWZmZXIsIGluYWN0aXZlUmVjdCwgYmdDb2xvcilcclxuICAgIHN0cm9rZVJlY3QoYnVmZmVyLCBhY3RpdmVSZWN0LCBhY3RpdmVCb3JkZXJDb2xvcilcclxuXHJcbiAgICBibGl0KFxyXG4gICAgICBsZWZ0QnVmZmVyLCBidWZmZXIsXHJcbiAgICAgIFtcclxuICAgICAgICAwLCAwLCBsZWZ0QnVmZmVyLndpZHRoLCBsZWZ0QnVmZmVyLmhlaWdodCxcclxuICAgICAgICBwYWRkaW5nLCBwYWRkaW5nXHJcbiAgICAgIF1cclxuICAgIClcclxuXHJcbiAgICBibGl0KFxyXG4gICAgICByaWdodEJ1ZmZlciwgYnVmZmVyLFxyXG4gICAgICBbXHJcbiAgICAgICAgMCwgMCwgcmlnaHRCdWZmZXIud2lkdGgsIHJpZ2h0QnVmZmVyLmhlaWdodCxcclxuICAgICAgICBsZWZ0QnVmZmVyLndpZHRoICsgcGFkZGluZyAqIDIsIHBhZGRpbmdcclxuICAgICAgXVxyXG4gICAgKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgcXVpdCA9IGFzeW5jIChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGF3YWl0IGxlZnQucXVpdChzdGF0ZSlcclxuICAgIGF3YWl0IHJpZ2h0LnF1aXQoc3RhdGUpXHJcbiAgfVxyXG5cclxuICByZXR1cm4geyBpbml0LCB1cGRhdGUsIHF1aXQgfVxyXG59XHJcblxyXG4vLyBvdmVyd3JpdGUgbW91c2VYLCBtb3VzZVkgYW5kIGluQm91bmRzIGZvciBuZXcgc2l6ZVxyXG5jb25zdCB1cGRhdGVTaXplID0gKHN0YXRlOiBTdGF0ZSwgcGFyZW50U3RhdGU6IFN0YXRlLCByZWN0OiBUNCkgPT4ge1xyXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdGF0ZS5tb3VzZSwgJ3gnLCB7XHJcbiAgICBnZXQoKSB7XHJcbiAgICAgIHJldHVybiBwYXJlbnRTdGF0ZS5tb3VzZS54IC0gcmVjdFswXVxyXG4gICAgfVxyXG4gIH0pXHJcblxyXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdGF0ZS5tb3VzZSwgJ3knLCB7XHJcbiAgICBnZXQoKSB7XHJcbiAgICAgIHJldHVybiBwYXJlbnRTdGF0ZS5tb3VzZS55IC0gcmVjdFsxXVxyXG4gICAgfVxyXG4gIH0pXHJcblxyXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdGF0ZS5tb3VzZSwgJ2luQm91bmRzJywge1xyXG4gICAgZ2V0KCkge1xyXG4gICAgICBjb25zdCBbX3gsIF95LCB3LCBoXSA9IHJlY3RcclxuXHJcbiAgICAgIHJldHVybiAoXHJcbiAgICAgICAgcGFyZW50U3RhdGUubW91c2UuaW5Cb3VuZHMgJiZcclxuICAgICAgICBzdGF0ZS5tb3VzZS54ID49IDAgJiYgc3RhdGUubW91c2UueCA8IHcgJiZcclxuICAgICAgICBzdGF0ZS5tb3VzZS55ID49IDAgJiYgc3RhdGUubW91c2UueSA8IGhcclxuICAgICAgKVxyXG4gICAgfVxyXG4gIH0pXHJcbn1cclxuXHJcbi8vIHRoaXMgc3RhdGUgd2lsbCBubyBsb25nZXIgc2VlIG9yIG1vZGlmeSB0aGUgcGFyZW50IHN0YXRlJ3MgaW9cclxuY29uc3QgZGlzYWJsZUlvID0gKHN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdGF0ZSwgJ2tleXMnLCB7XHJcbiAgICBnZXQoKSB7XHJcbiAgICAgIHJldHVybiB7fVxyXG4gICAgfSxcclxuICAgIHNldChfdmFsdWU6IFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+KSB7XHJcbiAgICAgIC8vIGlnbm9yZVxyXG4gICAgfVxyXG4gIH0pXHJcblxyXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdGF0ZSwgJ2tleVByZXNzZXMnLCB7XHJcbiAgICBnZXQoKSB7XHJcbiAgICAgIHJldHVybiBbXVxyXG4gICAgfSxcclxuICAgIHNldChfdmFsdWU6IHN0cmluZ1tdKSB7XHJcbiAgICAgIC8vIGlnbm9yZVxyXG4gICAgfVxyXG4gIH0pXHJcblxyXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdGF0ZS5tb3VzZSwgJ2J1dHRvbnMnLCB7XHJcbiAgICBnZXQoKSB7XHJcbiAgICAgIHJldHVybiB7fVxyXG4gICAgfSxcclxuICAgIHNldChfdmFsdWU6IFJlY29yZDxudW1iZXIsIGJvb2xlYW4+KSB7XHJcbiAgICAgIC8vIGlnbm9yZVxyXG4gICAgfVxyXG4gIH0pXHJcblxyXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdGF0ZS5tb3VzZSwgJ3doZWVsJywge1xyXG4gICAgZ2V0KCkge1xyXG4gICAgICByZXR1cm4gMFxyXG4gICAgfVxyXG4gIH0pXHJcbn1cclxuXHJcbi8vIHJlYXR0YWNoZXMgdGhlIHBhcmVudCBzdGF0ZSdzIGlvIHRvIHRoZSBjaGlsZCBzdGF0ZVxyXG5jb25zdCBlbmFibGVJbyA9IChzdGF0ZTogU3RhdGUsIHBhcmVudFN0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdGF0ZSwgJ2tleXMnLCB7XHJcbiAgICBnZXQoKSB7XHJcbiAgICAgIHJldHVybiBwYXJlbnRTdGF0ZS5rZXlzXHJcbiAgICB9LFxyXG4gICAgc2V0KHZhbHVlOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPikge1xyXG4gICAgICBwYXJlbnRTdGF0ZS5rZXlzID0gdmFsdWVcclxuICAgIH1cclxuICB9KVxyXG5cclxuICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc3RhdGUsICdrZXlQcmVzc2VzJywge1xyXG4gICAgZ2V0KCkge1xyXG4gICAgICByZXR1cm4gcGFyZW50U3RhdGUua2V5UHJlc3Nlc1xyXG4gICAgfSxcclxuICAgIHNldCh2YWx1ZTogc3RyaW5nW10pIHtcclxuICAgICAgcGFyZW50U3RhdGUua2V5UHJlc3NlcyA9IHZhbHVlXHJcbiAgICB9XHJcbiAgfSlcclxuXHJcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHN0YXRlLm1vdXNlLCAnYnV0dG9ucycsIHtcclxuICAgIGdldCgpIHtcclxuICAgICAgcmV0dXJuIHBhcmVudFN0YXRlLm1vdXNlLmJ1dHRvbnNcclxuICAgIH0sXHJcbiAgICBzZXQodmFsdWU6IFJlY29yZDxudW1iZXIsIGJvb2xlYW4+KSB7XHJcbiAgICAgIHBhcmVudFN0YXRlLm1vdXNlLmJ1dHRvbnMgPSB2YWx1ZVxyXG4gICAgfVxyXG4gIH0pXHJcblxyXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdGF0ZS5tb3VzZSwgJ3doZWVsJywge1xyXG4gICAgZ2V0KCkge1xyXG4gICAgICByZXR1cm4gcGFyZW50U3RhdGUubW91c2Uud2hlZWxcclxuICAgIH1cclxuICB9KVxyXG59XHJcblxyXG4vLyBjcmVhdGUgYSBuZXcgd3JhcHBlZCBzdGF0ZSBvYmplY3Qgd2l0aCBpdHMgb3duIGJ1ZmZlclxyXG5jb25zdCB3cmFwU3RhdGUgPSAoc3RhdGU6IFN0YXRlLCBidWZmZXI6IEltYWdlRGF0YSk6IFN0YXRlID0+IHtcclxuICBjb25zdCB3cmFwcGVkOiBTdGF0ZSA9IHtcclxuICAgIGdldCBrZXlzKCkge1xyXG4gICAgICByZXR1cm4gc3RhdGUua2V5c1xyXG4gICAgfSxcclxuICAgIHNldCBrZXlzKHZhbHVlKSB7XHJcbiAgICAgIHN0YXRlLmtleXMgPSB2YWx1ZVxyXG4gICAgfSxcclxuICAgIGdldCBrZXlQcmVzc2VzKCkge1xyXG4gICAgICByZXR1cm4gc3RhdGUua2V5UHJlc3Nlc1xyXG4gICAgfSxcclxuICAgIHNldCBrZXlQcmVzc2VzKHZhbHVlKSB7XHJcbiAgICAgIHN0YXRlLmtleVByZXNzZXMgPSB2YWx1ZVxyXG4gICAgfSxcclxuXHJcbiAgICBtb3VzZToge1xyXG4gICAgICBnZXQgYnV0dG9ucygpIHtcclxuICAgICAgICByZXR1cm4gc3RhdGUubW91c2UuYnV0dG9uc1xyXG4gICAgICB9LFxyXG4gICAgICBzZXQgYnV0dG9ucyh2YWx1ZSkge1xyXG4gICAgICAgIHN0YXRlLm1vdXNlLmJ1dHRvbnMgPSB2YWx1ZVxyXG4gICAgICB9LFxyXG4gICAgICBnZXQgeCgpIHtcclxuICAgICAgICByZXR1cm4gc3RhdGUubW91c2UueFxyXG4gICAgICB9LFxyXG4gICAgICBnZXQgeSgpIHtcclxuICAgICAgICByZXR1cm4gc3RhdGUubW91c2UueVxyXG4gICAgICB9LFxyXG4gICAgICBnZXQgaW5Cb3VuZHMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHN0YXRlLm1vdXNlLmluQm91bmRzXHJcbiAgICAgIH0sXHJcbiAgICAgIGdldCB3aGVlbCgpIHtcclxuICAgICAgICByZXR1cm4gc3RhdGUubW91c2Uud2hlZWxcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICB0aW1lOiB7XHJcbiAgICAgIGdldCBlbGFwc2VkKCkge1xyXG4gICAgICAgIHJldHVybiBzdGF0ZS50aW1lLmVsYXBzZWRcclxuICAgICAgfSxcclxuICAgICAgZ2V0IGZyYW1lVGltZSgpIHtcclxuICAgICAgICByZXR1cm4gc3RhdGUudGltZS5mcmFtZVRpbWVcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICB2aWV3OiB7XHJcbiAgICAgIGdldCB6b29tKCkge1xyXG4gICAgICAgIHJldHVybiBzdGF0ZS52aWV3Lnpvb21cclxuICAgICAgfSxcclxuICAgICAgc2V0IHpvb20odmFsdWUpIHtcclxuICAgICAgICBzdGF0ZS52aWV3Lnpvb20gPSB2YWx1ZVxyXG4gICAgICB9LFxyXG4gICAgICBnZXQgYnVmZmVyKCkge1xyXG4gICAgICAgIHJldHVybiBidWZmZXJcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBnZXQgcnVubmluZygpIHtcclxuICAgICAgcmV0dXJuIHN0YXRlLnJ1bm5pbmdcclxuICAgIH0sXHJcbiAgICBzZXQgcnVubmluZyh2YWx1ZSkge1xyXG4gICAgICBzdGF0ZS5ydW5uaW5nID0gdmFsdWVcclxuICAgIH0sXHJcbiAgICBnZXQgZGVidWcoKSB7XHJcbiAgICAgIHJldHVybiBzdGF0ZS5kZWJ1Z1xyXG4gICAgfSxcclxuICAgIHNldCBkZWJ1Zyh2YWx1ZSkge1xyXG4gICAgICBzdGF0ZS5kZWJ1ZyA9IHZhbHVlXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gd3JhcHBlZFxyXG59Il19
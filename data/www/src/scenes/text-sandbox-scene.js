import { fontImageToPoints, layoutTextLine, textLayoutToIndices } from '../lib/bmpfont/layout.js';
import { createColor } from '../lib/image/color.js';
import { fill, fillIndices } from '../lib/image/fill.js';
import { loadImage } from '../lib/image/load.js';
import { findSizeSlug, parseSizeSlug } from '../lib/slug.js';
import { createTerminal } from '../lib/term/index.js';
import { assrt, assrtInt } from '../lib/util.js';
const fontPath = 'data';
const monoFontFiles = [
    'ATI_SmallW_6x8',
    'EverexME_5x8',
    'HP_100LX_6x8',
    'Portfolio_6x8',
    'TsengEVA_132_6x8',
    'IBM_EGA_8x8',
    'IBM_VGA_8x14',
    'IBM_VGA_8x16',
    'IBM_VGA_9x8',
    'IBM_VGA_9x14',
    'IBM_VGA_9x16'
];
const loadFontMono = async (name) => {
    const image = await loadImage(`${fontPath}/Bm437_${name}.png`);
    const sizeSlug = assrt(findSizeSlug(name), 'Expected size slug');
    const [width, height] = parseSizeSlug(sizeSlug);
    const cols = assrtInt(image.width / width);
    const rows = assrtInt(image.height / height);
    const font = {
        type: 'mono',
        width,
        height,
        leading: 0, // built into the bitmap glyphs
        image: image,
        rects: {},
        advance: 0, // built into the bitmap glyphs
        fallback: 127
    };
    for (let r = 0; r < rows; r++) {
        const rowIndex = r * cols;
        for (let c = 0; c < cols; c++) {
            const charCode = rowIndex + c;
            font.rects[charCode] = [c * width, r * height, width, height];
        }
    }
    return font;
};
export const textSandboxScene = () => {
    const fonts = new Map();
    const term = createTerminal();
    let fontIndex = 1;
    let font;
    let fontPts;
    let textCols;
    let textRows;
    let isActive = true;
    const setFont = (state, fontIndex) => {
        const fontName = monoFontFiles[fontIndex];
        font = assrt(fonts.get(fontName), `Expected font ${fontName}`);
        fontPts = fontImageToPoints(font);
        const buffer = state.view.getBuffer();
        const vw = buffer.width - padding * 2;
        const vh = buffer.height - padding * 2;
        textCols = Math.floor(vw / font.width);
        textRows = Math.floor(vh / font.height);
        term.appendLine(`FONT=${fontName}`);
    };
    const resized = () => {
        term.appendLine(`TSIZE=${textCols}x${textRows}`);
    };
    const init = async (state) => {
        console.log('initializing text sandbox scene');
        for (const n of monoFontFiles) {
            fonts.set(n, await loadFontMono(n));
        }
        term.clear();
        term.appendLine('Text Mode Sandbox');
        fontIndex = 1;
        setFont(state, fontIndex);
        resized();
    };
    const bgColor = createColor(0x1f, 0x1f, 0x1f);
    const fgColor = createColor(0x4f, 0xc1, 0xff);
    const padding = 2;
    const cursorRate = 500;
    const _handleKeys = (state) => {
        const keys = state.getKeys();
        if (keys['Escape']) {
            state.setRunning(false);
            // consume the key
            keys['Escape'] = false;
            return;
        }
        const fState = keys['F1'];
        if (fState) {
            fontIndex = (fontIndex + 1) % monoFontFiles.length;
            keys['F1'] = false;
            setFont(state, fontIndex);
            resized();
        }
        const keyPresses = state.getKeyPresses();
        for (const key of keyPresses) {
            if (printableKeySet.has(key)) {
                term.append(key);
            }
            if (key === 'Enter') {
                term.appendLine();
            }
            if (key === 'Backspace') {
                term.backspace();
                console.log('backspace');
            }
        }
        // consume all key presses
        keyPresses.length = 0;
    };
    const update = (state) => {
        if (isActive) {
            // keys
            _handleKeys(state);
            // mouse
            const wheel = state.mouse.getWheel();
            const zoom = state.view.getZoom();
            if (wheel < 0) {
                //state.view.zoom += 1
                state.view.setZoom(zoom + 1);
            }
            else if (wheel > 0) {
                state.view.setZoom(zoom - 1);
            }
        }
        // draw
        const buffer = state.view.getBuffer();
        fill(buffer, bgColor);
        const vw = buffer.width - padding * 2;
        const vh = buffer.height - padding * 2;
        const newTextCols = Math.floor(vw / font.width);
        const newTextRows = Math.floor(vh / font.height);
        if (newTextCols !== textCols || newTextRows !== textRows) {
            textCols = newTextCols;
            textRows = newTextRows;
            resized();
        }
        const termView = term.view(textCols, textRows);
        const isCursor = (state.time.getElapsed() % (cursorRate * 2)) < cursorRate;
        let cursor = isCursor ? '_' : ' ';
        for (let y = 0; y < termView.length; y++) {
            let line = termView[y];
            if (y === termView.length - 1) {
                line += cursor;
            }
            const lineLayout = layoutTextLine(font, line);
            const dx = padding;
            const dy = padding + y * font.height;
            const indices = textLayoutToIndices(buffer, dx, dy, fontPts, lineLayout);
            fillIndices(indices, buffer, fgColor);
        }
        // debug
        const frameTime = state.time.getFrameTime();
        const fps = Math.round(1000 / frameTime);
        const fpsText = `${fps} fps (${frameTime.toFixed(1)}ms)`;
        const fpsW = font.width * fpsText.length + padding * 2;
        const fpsH = font.height + padding * 2;
        const fpsX = buffer.width - fpsW - padding;
        const fpsY = padding;
        const fpsBg = createColor(0x00, 0x78, 0xd4);
        const fpsFg = createColor(0xff, 0xd7, 0x00);
        fill(buffer, fpsBg, [fpsX, fpsY, fpsW, fpsH]);
        const fpsLayout = layoutTextLine(font, fpsText);
        const fpsIndices = textLayoutToIndices(buffer, fpsX + padding, fpsY + padding, fontPts, fpsLayout);
        fillIndices(fpsIndices, buffer, fpsFg);
    };
    const quit = async (_state) => {
        console.log('quitting text sandbox scene');
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
// keyboard handling
// this subset should be fine to start with
const modifierKeys = [
    'Alt', 'AltGraph', 'CapsLock', 'Control', 'NumLock', 'ScrollLock', 'Shift'
];
const whitespaceKeys = [
    'Enter', 'Tab', ' '
];
const navigationKeys = [
    'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'End', 'Home', 'PageDown',
    'PageUp'
];
const editingKeys = [
    'Backspace', 'Delete', 'Insert'
];
// nb Escape is used by the scene to exit so we'll never be able to trap it,
// but leaving it in anyway in case things change in future
const uiKeys = [
    'Escape', 'Help', 'Pause'
];
const alphaKeys = [
    'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',
    'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
    'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm',
    'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'
];
const numberKeys = [
    '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'
];
const symbolKeys = [
    '!', '"', '#', '$', '%', '&', '\'', '(', ')', '*', '+', ',', '-',
    '.', '/', ':', ';', '<', '=', '>', '?', '@', '[', '\\', ']', '^',
    '_', '`', '{', '|', '}', '~'
];
// eg keys that will be echoed to the terminal, not control or special keys
const printableKeys = [
    ...alphaKeys, ...numberKeys, ...symbolKeys, ' '
];
const printableKeySet = new Set(printableKeys);
const allKeys = [
    ...modifierKeys, ...whitespaceKeys, ...navigationKeys, ...editingKeys,
    ...uiKeys, ...alphaKeys, ...numberKeys, ...symbolKeys
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dC1zYW5kYm94LXNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lcy90ZXh0LXNhbmRib3gtc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGlCQUFpQixFQUFFLGNBQWMsRUFBRSxtQkFBbUIsRUFDdkQsTUFBTSwwQkFBMEIsQ0FBQTtBQUdqQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFDbkQsT0FBTyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDaEQsT0FBTyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUM1RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFFckQsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUVoRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUE7QUFFdkIsTUFBTSxhQUFhLEdBQUc7SUFDcEIsZ0JBQWdCO0lBQ2hCLGNBQWM7SUFDZCxjQUFjO0lBQ2QsZUFBZTtJQUNmLGtCQUFrQjtJQUNsQixhQUFhO0lBQ2IsY0FBYztJQUNkLGNBQWM7SUFDZCxhQUFhO0lBQ2IsY0FBYztJQUNkLGNBQWM7Q0FDTixDQUFBO0FBSVYsTUFBTSxZQUFZLEdBQUcsS0FBSyxFQUFFLElBQWtCLEVBQUUsRUFBRTtJQUNoRCxNQUFNLEtBQUssR0FBRyxNQUFNLFNBQVMsQ0FBQyxHQUFHLFFBQVEsVUFBVSxJQUFJLE1BQU0sQ0FBQyxDQUFBO0lBQzlELE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsb0JBQW9CLENBQUMsQ0FBQTtJQUNoRSxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FB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LENBQUE7QUFFVixNQUFNLFVBQVUsR0FBRztJQUNqQixHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHO0NBQ3hDLENBQUE7QUFFVixNQUFNLFVBQVUsR0FBRztJQUNqQixHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHO0lBQ2hFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUc7SUFDaEUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHO0NBQ3BCLENBQUE7QUFFViwyRUFBMkU7QUFDM0UsTUFBTSxhQUFhLEdBQUc7SUFDcEIsR0FBRyxTQUFTLEVBQUUsR0FBRyxVQUFVLEVBQUUsR0FBRyxVQUFVLEVBQUUsR0FBRztDQUN2QyxDQUFBO0FBSVYsTUFBTSxlQUFlLEdBQUcsSUFBSSxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUE7QUFFOUMsTUFBTSxPQUFPLEdBQUc7SUFDZCxHQUFHLFlBQVksRUFBRSxHQUFHLGNBQWMsRUFBRSxHQUFHLGNBQWMsRUFBRSxHQUFHLFdBQVc7SUFDckUsR0FBRyxNQUFNLEVBQUUsR0FBRyxTQUFTLEVBQUUsR0FBRyxVQUFVLEVBQUUsR0FBRyxVQUFVO0NBQzdDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIGZvbnRJbWFnZVRvUG9pbnRzLCBsYXlvdXRUZXh0TGluZSwgdGV4dExheW91dFRvSW5kaWNlc1xyXG59IGZyb20gJy4uL2xpYi9ibXBmb250L2xheW91dC5qcydcclxuXHJcbmltcG9ydCB7IEJtcEZvbnRNLCBGb250UG9pbnRzIH0gZnJvbSAnLi4vbGliL2JtcGZvbnQvdHlwZXMuanMnXHJcbmltcG9ydCB7IGNyZWF0ZUNvbG9yIH0gZnJvbSAnLi4vbGliL2ltYWdlL2NvbG9yLmpzJ1xyXG5pbXBvcnQgeyBmaWxsLCBmaWxsSW5kaWNlcyB9IGZyb20gJy4uL2xpYi9pbWFnZS9maWxsLmpzJ1xyXG5pbXBvcnQgeyBsb2FkSW1hZ2UgfSBmcm9tICcuLi9saWIvaW1hZ2UvbG9hZC5qcydcclxuaW1wb3J0IHsgZmluZFNpemVTbHVnLCBwYXJzZVNpemVTbHVnIH0gZnJvbSAnLi4vbGliL3NsdWcuanMnXHJcbmltcG9ydCB7IGNyZWF0ZVRlcm1pbmFsIH0gZnJvbSAnLi4vbGliL3Rlcm0vaW5kZXguanMnXHJcbmltcG9ydCB7IFNjZW5lLCBTdGF0ZSB9IGZyb20gJy4uL2xpYi90eXBlcy5qcydcclxuaW1wb3J0IHsgYXNzcnQsIGFzc3J0SW50IH0gZnJvbSAnLi4vbGliL3V0aWwuanMnXHJcblxyXG5jb25zdCBmb250UGF0aCA9ICdkYXRhJ1xyXG5cclxuY29uc3QgbW9ub0ZvbnRGaWxlcyA9IFtcclxuICAnQVRJX1NtYWxsV182eDgnLFxyXG4gICdFdmVyZXhNRV81eDgnLFxyXG4gICdIUF8xMDBMWF82eDgnLFxyXG4gICdQb3J0Zm9saW9fNng4JyxcclxuICAnVHNlbmdFVkFfMTMyXzZ4OCcsXHJcbiAgJ0lCTV9FR0FfOHg4JyxcclxuICAnSUJNX1ZHQV84eDE0JyxcclxuICAnSUJNX1ZHQV84eDE2JyxcclxuICAnSUJNX1ZHQV85eDgnLFxyXG4gICdJQk1fVkdBXzl4MTQnLFxyXG4gICdJQk1fVkdBXzl4MTYnXHJcbl0gYXMgY29uc3RcclxuXHJcbnR5cGUgTW9ub0ZvbnROYW1lID0gdHlwZW9mIG1vbm9Gb250RmlsZXNbbnVtYmVyXVxyXG5cclxuY29uc3QgbG9hZEZvbnRNb25vID0gYXN5bmMgKG5hbWU6IE1vbm9Gb250TmFtZSkgPT4ge1xyXG4gIGNvbnN0IGltYWdlID0gYXdhaXQgbG9hZEltYWdlKGAke2ZvbnRQYXRofS9CbTQzN18ke25hbWV9LnBuZ2ApXHJcbiAgY29uc3Qgc2l6ZVNsdWcgPSBhc3NydChmaW5kU2l6ZVNsdWcobmFtZSksICdFeHBlY3RlZCBzaXplIHNsdWcnKVxyXG4gIGNvbnN0IFt3aWR0aCwgaGVpZ2h0XSA9IHBhcnNlU2l6ZVNsdWcoc2l6ZVNsdWcpXHJcblxyXG4gIGNvbnN0IGNvbHMgPSBhc3NydEludChpbWFnZS53aWR0aCAvIHdpZHRoKVxyXG4gIGNvbnN0IHJvd3MgPSBhc3NydEludChpbWFnZS5oZWlnaHQgLyBoZWlnaHQpXHJcblxyXG4gIGNvbnN0IGZvbnQ6IEJtcEZvbnRNID0ge1xyXG4gICAgdHlwZTogJ21vbm8nLFxyXG4gICAgd2lkdGgsXHJcbiAgICBoZWlnaHQsXHJcbiAgICBsZWFkaW5nOiAwLCAvLyBidWlsdCBpbnRvIHRoZSBiaXRtYXAgZ2x5cGhzXHJcbiAgICBpbWFnZTogaW1hZ2UsXHJcbiAgICByZWN0czoge30sXHJcbiAgICBhZHZhbmNlOiAwLCAvLyBidWlsdCBpbnRvIHRoZSBiaXRtYXAgZ2x5cGhzXHJcbiAgICBmYWxsYmFjazogMTI3XHJcbiAgfVxyXG5cclxuICBmb3IgKGxldCByID0gMDsgciA8IHJvd3M7IHIrKykge1xyXG4gICAgY29uc3Qgcm93SW5kZXggPSByICogY29sc1xyXG4gICAgZm9yIChsZXQgYyA9IDA7IGMgPCBjb2xzOyBjKyspIHtcclxuICAgICAgY29uc3QgY2hhckNvZGUgPSByb3dJbmRleCArIGNcclxuXHJcbiAgICAgIGZvbnQucmVjdHNbY2hhckNvZGVdID0gW2MgKiB3aWR0aCwgciAqIGhlaWdodCwgd2lkdGgsIGhlaWdodF1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBmb250XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCB0ZXh0U2FuZGJveFNjZW5lID0gKCk6IFNjZW5lID0+IHtcclxuICBjb25zdCBmb250cyA9IG5ldyBNYXA8TW9ub0ZvbnROYW1lLCBCbXBGb250TT4oKVxyXG4gIGNvbnN0IHRlcm0gPSBjcmVhdGVUZXJtaW5hbCgpXHJcblxyXG4gIGxldCBmb250SW5kZXggPSAxXHJcbiAgbGV0IGZvbnQ6IEJtcEZvbnRNXHJcbiAgbGV0IGZvbnRQdHM6IEZvbnRQb2ludHNcclxuICBsZXQgdGV4dENvbHM6IG51bWJlclxyXG4gIGxldCB0ZXh0Um93czogbnVtYmVyXHJcblxyXG4gIGxldCBpc0FjdGl2ZSA9IHRydWVcclxuXHJcbiAgY29uc3Qgc2V0Rm9udCA9IChzdGF0ZTogU3RhdGUsIGZvbnRJbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICBjb25zdCBmb250TmFtZTogTW9ub0ZvbnROYW1lID0gbW9ub0ZvbnRGaWxlc1tmb250SW5kZXhdXHJcblxyXG4gICAgZm9udCA9IGFzc3J0KGZvbnRzLmdldChmb250TmFtZSksIGBFeHBlY3RlZCBmb250ICR7Zm9udE5hbWV9YClcclxuICAgIGZvbnRQdHMgPSBmb250SW1hZ2VUb1BvaW50cyhmb250KVxyXG5cclxuICAgIGNvbnN0IGJ1ZmZlciA9IHN0YXRlLnZpZXcuZ2V0QnVmZmVyKClcclxuXHJcbiAgICBjb25zdCB2dyA9IGJ1ZmZlci53aWR0aCAtIHBhZGRpbmcgKiAyXHJcbiAgICBjb25zdCB2aCA9IGJ1ZmZlci5oZWlnaHQgLSBwYWRkaW5nICogMlxyXG5cclxuICAgIHRleHRDb2xzID0gTWF0aC5mbG9vcih2dyAvIGZvbnQud2lkdGgpXHJcbiAgICB0ZXh0Um93cyA9IE1hdGguZmxvb3IodmggLyBmb250LmhlaWdodClcclxuXHJcbiAgICB0ZXJtLmFwcGVuZExpbmUoYEZPTlQ9JHtmb250TmFtZX1gKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVzaXplZCA9ICgpID0+IHtcclxuICAgIHRlcm0uYXBwZW5kTGluZShgVFNJWkU9JHt0ZXh0Q29sc314JHt0ZXh0Um93c31gKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgaW5pdCA9IGFzeW5jIChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdpbml0aWFsaXppbmcgdGV4dCBzYW5kYm94IHNjZW5lJylcclxuXHJcbiAgICBmb3IgKGNvbnN0IG4gb2YgbW9ub0ZvbnRGaWxlcykge1xyXG4gICAgICBmb250cy5zZXQobiwgYXdhaXQgbG9hZEZvbnRNb25vKG4pKVxyXG4gICAgfVxyXG5cclxuICAgIHRlcm0uY2xlYXIoKVxyXG4gICAgdGVybS5hcHBlbmRMaW5lKCdUZXh0IE1vZGUgU2FuZGJveCcpXHJcblxyXG4gICAgZm9udEluZGV4ID0gMVxyXG5cclxuICAgIHNldEZvbnQoc3RhdGUsIGZvbnRJbmRleClcclxuICAgIHJlc2l6ZWQoKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgYmdDb2xvciA9IGNyZWF0ZUNvbG9yKDB4MWYsIDB4MWYsIDB4MWYpXHJcbiAgY29uc3QgZmdDb2xvciA9IGNyZWF0ZUNvbG9yKDB4NGYsIDB4YzEsIDB4ZmYpXHJcblxyXG4gIGNvbnN0IHBhZGRpbmcgPSAyXHJcblxyXG4gIGNvbnN0IGN1cnNvclJhdGUgPSA1MDBcclxuXHJcbiAgY29uc3QgX2hhbmRsZUtleXMgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBjb25zdCBrZXlzID0gc3RhdGUuZ2V0S2V5cygpXHJcblxyXG4gICAgaWYgKGtleXNbJ0VzY2FwZSddKSB7XHJcbiAgICAgIHN0YXRlLnNldFJ1bm5pbmcoZmFsc2UpXHJcblxyXG4gICAgICAvLyBjb25zdW1lIHRoZSBrZXlcclxuICAgICAga2V5c1snRXNjYXBlJ10gPSBmYWxzZVxyXG5cclxuICAgICAgcmV0dXJuXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZlN0YXRlID0ga2V5c1snRjEnXVxyXG5cclxuICAgIGlmIChmU3RhdGUpIHtcclxuICAgICAgZm9udEluZGV4ID0gKGZvbnRJbmRleCArIDEpICUgbW9ub0ZvbnRGaWxlcy5sZW5ndGhcclxuICAgICAga2V5c1snRjEnXSA9IGZhbHNlXHJcbiAgICAgIHNldEZvbnQoc3RhdGUsIGZvbnRJbmRleClcclxuICAgICAgcmVzaXplZCgpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qga2V5UHJlc3NlcyA9IHN0YXRlLmdldEtleVByZXNzZXMoKVxyXG5cclxuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleVByZXNzZXMpIHtcclxuICAgICAgaWYgKHByaW50YWJsZUtleVNldC5oYXMoa2V5IGFzIFByaW50YWJsZUtleSkpIHtcclxuICAgICAgICB0ZXJtLmFwcGVuZChrZXkpXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChrZXkgPT09ICdFbnRlcicpIHtcclxuICAgICAgICB0ZXJtLmFwcGVuZExpbmUoKVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoa2V5ID09PSAnQmFja3NwYWNlJykge1xyXG4gICAgICAgIHRlcm0uYmFja3NwYWNlKClcclxuICAgICAgICBjb25zb2xlLmxvZygnYmFja3NwYWNlJylcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGNvbnN1bWUgYWxsIGtleSBwcmVzc2VzXHJcbiAgICBrZXlQcmVzc2VzLmxlbmd0aCA9IDBcclxuICB9XHJcblxyXG4gIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGlmIChpc0FjdGl2ZSkge1xyXG4gICAgICAvLyBrZXlzXHJcbiAgICAgIF9oYW5kbGVLZXlzKHN0YXRlKVxyXG5cclxuICAgICAgLy8gbW91c2VcclxuXHJcbiAgICAgIGNvbnN0IHdoZWVsID0gc3RhdGUubW91c2UuZ2V0V2hlZWwoKVxyXG4gICAgICBjb25zdCB6b29tID0gc3RhdGUudmlldy5nZXRab29tKClcclxuXHJcbiAgICAgIGlmICh3aGVlbCA8IDApIHtcclxuICAgICAgICAvL3N0YXRlLnZpZXcuem9vbSArPSAxXHJcbiAgICAgICAgc3RhdGUudmlldy5zZXRab29tKHpvb20gKyAxKVxyXG4gICAgICB9IGVsc2UgaWYgKHdoZWVsID4gMCkge1xyXG4gICAgICAgIHN0YXRlLnZpZXcuc2V0Wm9vbSh6b29tIC0gMSlcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGRyYXdcclxuXHJcbiAgICBjb25zdCBidWZmZXIgPSBzdGF0ZS52aWV3LmdldEJ1ZmZlcigpXHJcblxyXG4gICAgZmlsbChidWZmZXIsIGJnQ29sb3IpXHJcblxyXG4gICAgY29uc3QgdncgPSBidWZmZXIud2lkdGggLSBwYWRkaW5nICogMlxyXG4gICAgY29uc3QgdmggPSBidWZmZXIuaGVpZ2h0IC0gcGFkZGluZyAqIDJcclxuXHJcbiAgICBjb25zdCBuZXdUZXh0Q29scyA9IE1hdGguZmxvb3IodncgLyBmb250LndpZHRoKVxyXG4gICAgY29uc3QgbmV3VGV4dFJvd3MgPSBNYXRoLmZsb29yKHZoIC8gZm9udC5oZWlnaHQpXHJcblxyXG4gICAgaWYgKG5ld1RleHRDb2xzICE9PSB0ZXh0Q29scyB8fCBuZXdUZXh0Um93cyAhPT0gdGV4dFJvd3MpIHtcclxuICAgICAgdGV4dENvbHMgPSBuZXdUZXh0Q29sc1xyXG4gICAgICB0ZXh0Um93cyA9IG5ld1RleHRSb3dzXHJcblxyXG4gICAgICByZXNpemVkKClcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB0ZXJtVmlldyA9IHRlcm0udmlldyh0ZXh0Q29scywgdGV4dFJvd3MpXHJcblxyXG4gICAgY29uc3QgaXNDdXJzb3IgPSAoc3RhdGUudGltZS5nZXRFbGFwc2VkKCkgJSAoY3Vyc29yUmF0ZSAqIDIpKSA8IGN1cnNvclJhdGVcclxuXHJcbiAgICBsZXQgY3Vyc29yID0gaXNDdXJzb3IgPyAnXycgOiAnICdcclxuXHJcbiAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRlcm1WaWV3Lmxlbmd0aDsgeSsrKSB7XHJcbiAgICAgIGxldCBsaW5lID0gdGVybVZpZXdbeV1cclxuXHJcbiAgICAgIGlmICh5ID09PSB0ZXJtVmlldy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgbGluZSArPSBjdXJzb3JcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgbGluZUxheW91dCA9IGxheW91dFRleHRMaW5lKGZvbnQsIGxpbmUpXHJcbiAgICAgIGNvbnN0IGR4ID0gcGFkZGluZ1xyXG4gICAgICBjb25zdCBkeSA9IHBhZGRpbmcgKyB5ICogZm9udC5oZWlnaHRcclxuXHJcbiAgICAgIGNvbnN0IGluZGljZXMgPSB0ZXh0TGF5b3V0VG9JbmRpY2VzKFxyXG4gICAgICAgIGJ1ZmZlciwgZHgsIGR5LCBmb250UHRzLCBsaW5lTGF5b3V0XHJcbiAgICAgIClcclxuXHJcbiAgICAgIGZpbGxJbmRpY2VzKGluZGljZXMsIGJ1ZmZlciwgZmdDb2xvcilcclxuICAgIH1cclxuXHJcbiAgICAvLyBkZWJ1Z1xyXG5cclxuICAgIGNvbnN0IGZyYW1lVGltZSA9IHN0YXRlLnRpbWUuZ2V0RnJhbWVUaW1lKClcclxuICAgIGNvbnN0IGZwcyA9IE1hdGgucm91bmQoMTAwMCAvIGZyYW1lVGltZSlcclxuICAgIGNvbnN0IGZwc1RleHQgPSBgJHtmcHN9IGZwcyAoJHtmcmFtZVRpbWUudG9GaXhlZCgxKX1tcylgXHJcblxyXG4gICAgY29uc3QgZnBzVyA9IGZvbnQud2lkdGggKiBmcHNUZXh0Lmxlbmd0aCArIHBhZGRpbmcgKiAyXHJcbiAgICBjb25zdCBmcHNIID0gZm9udC5oZWlnaHQgKyBwYWRkaW5nICogMlxyXG4gICAgY29uc3QgZnBzWCA9IGJ1ZmZlci53aWR0aCAtIGZwc1cgLSBwYWRkaW5nXHJcbiAgICBjb25zdCBmcHNZID0gcGFkZGluZ1xyXG5cclxuICAgIGNvbnN0IGZwc0JnID0gY3JlYXRlQ29sb3IoMHgwMCwgMHg3OCwgMHhkNClcclxuICAgIGNvbnN0IGZwc0ZnID0gY3JlYXRlQ29sb3IoMHhmZiwgMHhkNywgMHgwMClcclxuXHJcbiAgICBmaWxsKGJ1ZmZlciwgZnBzQmcsIFtmcHNYLCBmcHNZLCBmcHNXLCBmcHNIXSlcclxuXHJcbiAgICBjb25zdCBmcHNMYXlvdXQgPSBsYXlvdXRUZXh0TGluZShmb250LCBmcHNUZXh0KVxyXG5cclxuICAgIGNvbnN0IGZwc0luZGljZXMgPSB0ZXh0TGF5b3V0VG9JbmRpY2VzKFxyXG4gICAgICBidWZmZXIsIGZwc1ggKyBwYWRkaW5nLCBmcHNZICsgcGFkZGluZywgZm9udFB0cywgZnBzTGF5b3V0XHJcbiAgICApXHJcblxyXG4gICAgZmlsbEluZGljZXMoZnBzSW5kaWNlcywgYnVmZmVyLCBmcHNGZylcclxuICB9XHJcblxyXG4gIGNvbnN0IHF1aXQgPSBhc3luYyAoX3N0YXRlOiBTdGF0ZSkgPT4ge1xyXG4gICAgY29uc29sZS5sb2coJ3F1aXR0aW5nIHRleHQgc2FuZGJveCBzY2VuZScpXHJcbiAgfVxyXG5cclxuICBjb25zdCBzZXRBY3RpdmUgPSAoYWN0aXZlOiBib29sZWFuKSA9PiB7XHJcbiAgICBpc0FjdGl2ZSA9IGFjdGl2ZVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgaW5pdCwgdXBkYXRlLCBxdWl0LCBzZXRBY3RpdmUgfVxyXG59XHJcblxyXG4vLyBrZXlib2FyZCBoYW5kbGluZ1xyXG5cclxuLy8gdGhpcyBzdWJzZXQgc2hvdWxkIGJlIGZpbmUgdG8gc3RhcnQgd2l0aFxyXG5cclxuY29uc3QgbW9kaWZpZXJLZXlzID0gW1xyXG4gICdBbHQnLCAnQWx0R3JhcGgnLCAnQ2Fwc0xvY2snLCAnQ29udHJvbCcsICdOdW1Mb2NrJywgJ1Njcm9sbExvY2snLCAnU2hpZnQnXHJcbl0gYXMgY29uc3RcclxuXHJcbmNvbnN0IHdoaXRlc3BhY2VLZXlzID0gW1xyXG4gICdFbnRlcicsICdUYWInLCAnICdcclxuXSBhcyBjb25zdFxyXG5cclxuY29uc3QgbmF2aWdhdGlvbktleXMgPSBbXHJcbiAgJ0Fycm93RG93bicsICdBcnJvd0xlZnQnLCAnQXJyb3dSaWdodCcsICdBcnJvd1VwJywgJ0VuZCcsICdIb21lJywgJ1BhZ2VEb3duJyxcclxuICAnUGFnZVVwJ1xyXG5dIGFzIGNvbnN0XHJcblxyXG5jb25zdCBlZGl0aW5nS2V5cyA9IFtcclxuICAnQmFja3NwYWNlJywgJ0RlbGV0ZScsICdJbnNlcnQnXHJcbl0gYXMgY29uc3RcclxuXHJcbi8vIG5iIEVzY2FwZSBpcyB1c2VkIGJ5IHRoZSBzY2VuZSB0byBleGl0IHNvIHdlJ2xsIG5ldmVyIGJlIGFibGUgdG8gdHJhcCBpdCxcclxuLy8gYnV0IGxlYXZpbmcgaXQgaW4gYW55d2F5IGluIGNhc2UgdGhpbmdzIGNoYW5nZSBpbiBmdXR1cmVcclxuY29uc3QgdWlLZXlzID0gW1xyXG4gICdFc2NhcGUnLCAnSGVscCcsICdQYXVzZSdcclxuXSBhcyBjb25zdFxyXG5cclxuY29uc3QgYWxwaGFLZXlzID0gW1xyXG4gICdBJywgJ0InLCAnQycsICdEJywgJ0UnLCAnRicsICdHJywgJ0gnLCAnSScsICdKJywgJ0snLCAnTCcsICdNJyxcclxuICAnTicsICdPJywgJ1AnLCAnUScsICdSJywgJ1MnLCAnVCcsICdVJywgJ1YnLCAnVycsICdYJywgJ1knLCAnWicsXHJcbiAgJ2EnLCAnYicsICdjJywgJ2QnLCAnZScsICdmJywgJ2cnLCAnaCcsICdpJywgJ2onLCAnaycsICdsJywgJ20nLFxyXG4gICduJywgJ28nLCAncCcsICdxJywgJ3InLCAncycsICd0JywgJ3UnLCAndicsICd3JywgJ3gnLCAneScsICd6J1xyXG5dIGFzIGNvbnN0XHJcblxyXG5jb25zdCBudW1iZXJLZXlzID0gW1xyXG4gICcwJywgJzEnLCAnMicsICczJywgJzQnLCAnNScsICc2JywgJzcnLCAnOCcsICc5J1xyXG5dIGFzIGNvbnN0XHJcblxyXG5jb25zdCBzeW1ib2xLZXlzID0gW1xyXG4gICchJywgJ1wiJywgJyMnLCAnJCcsICclJywgJyYnLCAnXFwnJywgJygnLCAnKScsICcqJywgJysnLCAnLCcsICctJyxcclxuICAnLicsICcvJywgJzonLCAnOycsICc8JywgJz0nLCAnPicsICc/JywgJ0AnLCAnWycsICdcXFxcJywgJ10nLCAnXicsXHJcbiAgJ18nLCAnYCcsICd7JywgJ3wnLCAnfScsICd+J1xyXG5dIGFzIGNvbnN0XHJcblxyXG4vLyBlZyBrZXlzIHRoYXQgd2lsbCBiZSBlY2hvZWQgdG8gdGhlIHRlcm1pbmFsLCBub3QgY29udHJvbCBvciBzcGVjaWFsIGtleXNcclxuY29uc3QgcHJpbnRhYmxlS2V5cyA9IFtcclxuICAuLi5hbHBoYUtleXMsIC4uLm51bWJlcktleXMsIC4uLnN5bWJvbEtleXMsICcgJ1xyXG5dIGFzIGNvbnN0XHJcblxyXG50eXBlIFByaW50YWJsZUtleSA9IHR5cGVvZiBwcmludGFibGVLZXlzW251bWJlcl1cclxuXHJcbmNvbnN0IHByaW50YWJsZUtleVNldCA9IG5ldyBTZXQocHJpbnRhYmxlS2V5cylcclxuXHJcbmNvbnN0IGFsbEtleXMgPSBbXHJcbiAgLi4ubW9kaWZpZXJLZXlzLCAuLi53aGl0ZXNwYWNlS2V5cywgLi4ubmF2aWdhdGlvbktleXMsIC4uLmVkaXRpbmdLZXlzLFxyXG4gIC4uLnVpS2V5cywgLi4uYWxwaGFLZXlzLCAuLi5udW1iZXJLZXlzLCAuLi5zeW1ib2xLZXlzXHJcbl0gYXMgY29uc3RcclxuIl19
import { fontImageToPoints, layoutTextLine, textLayoutToIndices } from '../lib/bmpfont/layout.js';
import { createColor } from '../lib/image/color.js';
import { fill, fillIndices } from '../lib/image/fill.js';
import { loadImage } from '../lib/image/load.js';
import { printableKeySet } from '../lib/io/const.js';
import { findSizeSlug, parseSizeSlug } from '../lib/slug.js';
import { createTerminal } from '../lib/term/index.js';
import { assrt, assrtInt } from '../lib/util.js';
const fontPath = 'data';
const monoFontFiles = [
    'ATI_SmallW_6x8',
    'EverexME_5x8',
    'HP_100LX_6x8',
    'Portfolio_6x8',
    'TsengEVA_132_6x8',
    'IBM_EGA_8x8',
    'IBM_VGA_8x14',
    'IBM_VGA_8x16',
    'IBM_VGA_9x8',
    'IBM_VGA_9x14',
    'IBM_VGA_9x16'
];
const loadFontMono = async (name) => {
    const image = await loadImage(`${fontPath}/Bm437_${name}.png`);
    const sizeSlug = assrt(findSizeSlug(name), 'Expected size slug');
    const [width, height] = parseSizeSlug(sizeSlug);
    const cols = assrtInt(image.width / width);
    const rows = assrtInt(image.height / height);
    const font = {
        type: 'mono',
        width,
        height,
        leading: 0, // built into the bitmap glyphs
        image: image,
        rects: {},
        advance: 0, // built into the bitmap glyphs
        fallback: 127
    };
    for (let r = 0; r < rows; r++) {
        const rowIndex = r * cols;
        for (let c = 0; c < cols; c++) {
            const charCode = rowIndex + c;
            font.rects[charCode] = [c * width, r * height, width, height];
        }
    }
    return font;
};
export const textSandboxScene = () => {
    const fonts = new Map();
    const term = createTerminal();
    let fontIndex = 1;
    let font;
    let fontPts;
    let textCols;
    let textRows;
    let isActive = true;
    const setFont = (state, fontIndex) => {
        const fontName = monoFontFiles[fontIndex];
        font = assrt(fonts.get(fontName), `Expected font ${fontName}`);
        fontPts = fontImageToPoints(font);
        const buffer = state.view.getBuffer();
        const vw = buffer.width - padding * 2;
        const vh = buffer.height - padding * 2;
        textCols = Math.floor(vw / font.width);
        textRows = Math.floor(vh / font.height);
        term.appendLine(`FONT=${fontName}`);
    };
    const resized = () => {
        term.appendLine(`TSIZE=${textCols}x${textRows}`);
    };
    const init = async (state) => {
        console.log('initializing text sandbox scene');
        for (const n of monoFontFiles) {
            fonts.set(n, await loadFontMono(n));
        }
        term.clear();
        term.appendLine('Text Mode Sandbox');
        fontIndex = 1;
        setFont(state, fontIndex);
        resized();
    };
    const bgColor = createColor(0x1f, 0x1f, 0x1f);
    const fgColor = createColor(0x4f, 0xc1, 0xff);
    const padding = 2;
    const cursorRate = 500;
    const _handleKeys = (state) => {
        const keys = state.getKeys();
        if (keys['Escape']) {
            state.setRunning(false);
            // consume the key
            keys['Escape'] = false;
            return;
        }
        const fState = keys['F1'];
        if (fState) {
            fontIndex = (fontIndex + 1) % monoFontFiles.length;
            keys['F1'] = false;
            setFont(state, fontIndex);
            resized();
        }
        const keyPresses = state.getKeyPresses();
        for (const key of keyPresses) {
            if (printableKeySet.has(key)) {
                term.append(key);
            }
            if (key === 'Enter') {
                term.appendLine();
            }
            if (key === 'Backspace') {
                term.backspace();
                console.log('backspace');
            }
        }
        // consume all key presses
        keyPresses.length = 0;
    };
    const update = (state) => {
        if (isActive) {
            // keys
            _handleKeys(state);
            // mouse
            const wheel = state.mouse.takeWheel();
            const zoom = state.view.getZoom();
            if (wheel < 0) {
                //state.view.zoom += 1
                state.view.setZoom(zoom + 1);
            }
            else if (wheel > 0) {
                state.view.setZoom(zoom - 1);
            }
        }
        // draw
        const buffer = state.view.getBuffer();
        fill(buffer, bgColor);
        const vw = buffer.width - padding * 2;
        const vh = buffer.height - padding * 2;
        const newTextCols = Math.floor(vw / font.width);
        const newTextRows = Math.floor(vh / font.height);
        if (newTextCols !== textCols || newTextRows !== textRows) {
            textCols = newTextCols;
            textRows = newTextRows;
            resized();
        }
        const termView = term.view(textCols, textRows);
        const isCursor = (state.time.getElapsed() % (cursorRate * 2)) < cursorRate;
        let cursor = isCursor ? '_' : ' ';
        for (let y = 0; y < termView.length; y++) {
            let line = termView[y];
            if (y === termView.length - 1) {
                line += cursor;
            }
            const lineLayout = layoutTextLine(font, line);
            const dx = padding;
            const dy = padding + y * font.height;
            const indices = textLayoutToIndices(buffer, dx, dy, fontPts, lineLayout);
            fillIndices(indices, buffer, fgColor);
        }
        // debug
        const frameTime = state.time.getFrameTime();
        const fps = Math.round(1000 / frameTime);
        const fpsText = `${fps} fps (${frameTime.toFixed(1)}ms)`;
        const fpsW = font.width * fpsText.length + padding * 2;
        const fpsH = font.height + padding * 2;
        const fpsX = buffer.width - fpsW - padding;
        const fpsY = padding;
        const fpsBg = createColor(0x00, 0x78, 0xd4);
        const fpsFg = createColor(0xff, 0xd7, 0x00);
        fill(buffer, fpsBg, [fpsX, fpsY, fpsW, fpsH]);
        const fpsLayout = layoutTextLine(font, fpsText);
        const fpsIndices = textLayoutToIndices(buffer, fpsX + padding, fpsY + padding, fontPts, fpsLayout);
        fillIndices(fpsIndices, buffer, fpsFg);
    };
    const quit = async (_state) => {
        console.log('quitting text sandbox scene');
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dC1zYW5kYm94LXNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lcy90ZXh0LXNhbmRib3gtc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGlCQUFpQixFQUFFLGNBQWMsRUFBRSxtQkFBbUIsRUFDdkQsTUFBTSwwQkFBMEIsQ0FBQTtBQUdqQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFDbkQsT0FBTyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDaEQsT0FBTyxFQUFnQixlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUNsRSxPQUFPLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUVyRCxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBRWhELE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQTtBQUV2QixNQUFNLGFBQWEsR0FBRztJQUNwQixnQkFBZ0I7SUFDaEIsY0FBYztJQUNkLGNBQWM7SUFDZCxlQUFlO0lBQ2Ysa0JBQWtCO0lBQ2xCLGFBQWE7SUFDYixjQUFjO0lBQ2QsY0FBYztJQUNkLGFBQWE7SUFDYixjQUFjO0lBQ2QsY0FBYztDQUNOLENBQUE7QUFJVixNQUFNLFlBQVksR0FBRyxLQUFLLEVBQUUsSUFBa0IsRUFBRSxFQUFFO0lBQ2hELE1BQU0sS0FBSyxHQUFHLE1BQU0sU0FBUyxDQUFDLEdBQUcsUUFBUSxVQUFVLElBQUksTUFBTSxDQUFDLENBQUE7SUFDOUQsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxvQkFBb0Is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eW91dFRleHRMaW5lLCB0ZXh0TGF5b3V0VG9JbmRpY2VzXHJcbn0gZnJvbSAnLi4vbGliL2JtcGZvbnQvbGF5b3V0LmpzJ1xyXG5cclxuaW1wb3J0IHsgQm1wRm9udE0sIEZvbnRQb2ludHMgfSBmcm9tICcuLi9saWIvYm1wZm9udC90eXBlcy5qcydcclxuaW1wb3J0IHsgY3JlYXRlQ29sb3IgfSBmcm9tICcuLi9saWIvaW1hZ2UvY29sb3IuanMnXHJcbmltcG9ydCB7IGZpbGwsIGZpbGxJbmRpY2VzIH0gZnJvbSAnLi4vbGliL2ltYWdlL2ZpbGwuanMnXHJcbmltcG9ydCB7IGxvYWRJbWFnZSB9IGZyb20gJy4uL2xpYi9pbWFnZS9sb2FkLmpzJ1xyXG5pbXBvcnQgeyBQcmludGFibGVLZXksIHByaW50YWJsZUtleVNldCB9IGZyb20gJy4uL2xpYi9pby9jb25zdC5qcydcclxuaW1wb3J0IHsgZmluZFNpemVTbHVnLCBwYXJzZVNpemVTbHVnIH0gZnJvbSAnLi4vbGliL3NsdWcuanMnXHJcbmltcG9ydCB7IGNyZWF0ZVRlcm1pbmFsIH0gZnJvbSAnLi4vbGliL3Rlcm0vaW5kZXguanMnXHJcbmltcG9ydCB7IFNjZW5lLCBTdGF0ZSB9IGZyb20gJy4uL2xpYi90eXBlcy5qcydcclxuaW1wb3J0IHsgYXNzcnQsIGFzc3J0SW50IH0gZnJvbSAnLi4vbGliL3V0aWwuanMnXHJcblxyXG5jb25zdCBmb250UGF0aCA9ICdkYXRhJ1xyXG5cclxuY29uc3QgbW9ub0ZvbnRGaWxlcyA9IFtcclxuICAnQVRJX1NtYWxsV182eDgnLFxyXG4gICdFdmVyZXhNRV81eDgnLFxyXG4gICdIUF8xMDBMWF82eDgnLFxyXG4gICdQb3J0Zm9saW9fNng4JyxcclxuICAnVHNlbmdFVkFfMTMyXzZ4OCcsXHJcbiAgJ0lCTV9FR0FfOHg4JyxcclxuICAnSUJNX1ZHQV84eDE0JyxcclxuICAnSUJNX1ZHQV84eDE2JyxcclxuICAnSUJNX1ZHQV85eDgnLFxyXG4gICdJQk1fVkdBXzl4MTQnLFxyXG4gICdJQk1fVkdBXzl4MTYnXHJcbl0gYXMgY29uc3RcclxuXHJcbnR5cGUgTW9ub0ZvbnROYW1lID0gdHlwZW9mIG1vbm9Gb250RmlsZXNbbnVtYmVyXVxyXG5cclxuY29uc3QgbG9hZEZvbnRNb25vID0gYXN5bmMgKG5hbWU6IE1vbm9Gb250TmFtZSkgPT4ge1xyXG4gIGNvbnN0IGltYWdlID0gYXdhaXQgbG9hZEltYWdlKGAke2ZvbnRQYXRofS9CbTQzN18ke25hbWV9LnBuZ2ApXHJcbiAgY29uc3Qgc2l6ZVNsdWcgPSBhc3NydChmaW5kU2l6ZVNsdWcobmFtZSksICdFeHBlY3RlZCBzaXplIHNsdWcnKVxyXG4gIGNvbnN0IFt3aWR0aCwgaGVpZ2h0XSA9IHBhcnNlU2l6ZVNsdWcoc2l6ZVNsdWcpXHJcblxyXG4gIGNvbnN0IGNvbHMgPSBhc3NydEludChpbWFnZS53aWR0aCAvIHdpZHRoKVxyXG4gIGNvbnN0IHJvd3MgPSBhc3NydEludChpbWFnZS5oZWlnaHQgLyBoZWlnaHQpXHJcblxyXG4gIGNvbnN0IGZvbnQ6IEJtcEZvbnRNID0ge1xyXG4gICAgdHlwZTogJ21vbm8nLFxyXG4gICAgd2lkdGgsXHJcbiAgICBoZWlnaHQsXHJcbiAgICBsZWFkaW5nOiAwLCAvLyBidWlsdCBpbnRvIHRoZSBiaXRtYXAgZ2x5cGhzXHJcbiAgICBpbWFnZTogaW1hZ2UsXHJcbiAgICByZWN0czoge30sXHJcbiAgICBhZHZhbmNlOiAwLCAvLyBidWlsdCBpbnRvIHRoZSBiaXRtYXAgZ2x5cGhzXHJcbiAgICBmYWxsYmFjazogMTI3XHJcbiAgfVxyXG5cclxuICBmb3IgKGxldCByID0gMDsgciA8IHJvd3M7IHIrKykge1xyXG4gICAgY29uc3Qgcm93SW5kZXggPSByICogY29sc1xyXG4gICAgZm9yIChsZXQgYyA9IDA7IGMgPCBjb2xzOyBjKyspIHtcclxuICAgICAgY29uc3QgY2hhckNvZGUgPSByb3dJbmRleCArIGNcclxuXHJcbiAgICAgIGZvbnQucmVjdHNbY2hhckNvZGVdID0gW2MgKiB3aWR0aCwgciAqIGhlaWdodCwgd2lkdGgsIGhlaWdodF1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBmb250XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCB0ZXh0U2FuZGJveFNjZW5lID0gKCk6IFNjZW5lID0+IHtcclxuICBjb25zdCBmb250cyA9IG5ldyBNYXA8TW9ub0ZvbnROYW1lLCBCbXBGb250TT4oKVxyXG4gIGNvbnN0IHRlcm0gPSBjcmVhdGVUZXJtaW5hbCgpXHJcblxyXG4gIGxldCBmb250SW5kZXggPSAxXHJcbiAgbGV0IGZvbnQ6IEJtcEZvbnRNXHJcbiAgbGV0IGZvbnRQdHM6IEZvbnRQb2ludHNcclxuICBsZXQgdGV4dENvbHM6IG51bWJlclxyXG4gIGxldCB0ZXh0Um93czogbnVtYmVyXHJcblxyXG4gIGxldCBpc0FjdGl2ZSA9IHRydWVcclxuXHJcbiAgY29uc3Qgc2V0Rm9udCA9IChzdGF0ZTogU3RhdGUsIGZvbnRJbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICBjb25zdCBmb250TmFtZTogTW9ub0ZvbnROYW1lID0gbW9ub0ZvbnRGaWxlc1tmb250SW5kZXhdXHJcblxyXG4gICAgZm9udCA9IGFzc3J0KGZvbnRzLmdldChmb250TmFtZSksIGBFeHBlY3RlZCBmb250ICR7Zm9udE5hbWV9YClcclxuICAgIGZvbnRQdHMgPSBmb250SW1hZ2VUb1BvaW50cyhmb250KVxyXG5cclxuICAgIGNvbnN0IGJ1ZmZlciA9IHN0YXRlLnZpZXcuZ2V0QnVmZmVyKClcclxuXHJcbiAgICBjb25zdCB2dyA9IGJ1ZmZlci53aWR0aCAtIHBhZGRpbmcgKiAyXHJcbiAgICBjb25zdCB2aCA9IGJ1ZmZlci5oZWlnaHQgLSBwYWRkaW5nICogMlxyXG5cclxuICAgIHRleHRDb2xzID0gTWF0aC5mbG9vcih2dyAvIGZvbnQud2lkdGgpXHJcbiAgICB0ZXh0Um93cyA9IE1hdGguZmxvb3IodmggLyBmb250LmhlaWdodClcclxuXHJcbiAgICB0ZXJtLmFwcGVuZExpbmUoYEZPTlQ9JHtmb250TmFtZX1gKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVzaXplZCA9ICgpID0+IHtcclxuICAgIHRlcm0uYXBwZW5kTGluZShgVFNJWkU9JHt0ZXh0Q29sc314JHt0ZXh0Um93c31gKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgaW5pdCA9IGFzeW5jIChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdpbml0aWFsaXppbmcgdGV4dCBzYW5kYm94IHNjZW5lJylcclxuXHJcbiAgICBmb3IgKGNvbnN0IG4gb2YgbW9ub0ZvbnRGaWxlcykge1xyXG4gICAgICBmb250cy5zZXQobiwgYXdhaXQgbG9hZEZvbnRNb25vKG4pKVxyXG4gICAgfVxyXG5cclxuICAgIHRlcm0uY2xlYXIoKVxyXG4gICAgdGVybS5hcHBlbmRMaW5lKCdUZXh0IE1vZGUgU2FuZGJveCcpXHJcblxyXG4gICAgZm9udEluZGV4ID0gMVxyXG5cclxuICAgIHNldEZvbnQoc3RhdGUsIGZvbnRJbmRleClcclxuICAgIHJlc2l6ZWQoKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgYmdDb2xvciA9IGNyZWF0ZUNvbG9yKDB4MWYsIDB4MWYsIDB4MWYpXHJcbiAgY29uc3QgZmdDb2xvciA9IGNyZWF0ZUNvbG9yKDB4NGYsIDB4YzEsIDB4ZmYpXHJcblxyXG4gIGNvbnN0IHBhZGRpbmcgPSAyXHJcblxyXG4gIGNvbnN0IGN1cnNvclJhdGUgPSA1MDBcclxuXHJcbiAgY29uc3QgX2hhbmRsZUtleXMgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBjb25zdCBrZXlzID0gc3RhdGUuZ2V0S2V5cygpXHJcblxyXG4gICAgaWYgKGtleXNbJ0VzY2FwZSddKSB7XHJcbiAgICAgIHN0YXRlLnNldFJ1bm5pbmcoZmFsc2UpXHJcblxyXG4gICAgICAvLyBjb25zdW1lIHRoZSBrZXlcclxuICAgICAga2V5c1snRXNjYXBlJ10gPSBmYWxzZVxyXG5cclxuICAgICAgcmV0dXJuXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZlN0YXRlID0ga2V5c1snRjEnXVxyXG5cclxuICAgIGlmIChmU3RhdGUpIHtcclxuICAgICAgZm9udEluZGV4ID0gKGZvbnRJbmRleCArIDEpICUgbW9ub0ZvbnRGaWxlcy5sZW5ndGhcclxuICAgICAga2V5c1snRjEnXSA9IGZhbHNlXHJcbiAgICAgIHNldEZvbnQoc3RhdGUsIGZvbnRJbmRleClcclxuICAgICAgcmVzaXplZCgpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qga2V5UHJlc3NlcyA9IHN0YXRlLmdldEtleVByZXNzZXMoKVxyXG5cclxuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleVByZXNzZXMpIHtcclxuICAgICAgaWYgKHByaW50YWJsZUtleVNldC5oYXMoa2V5IGFzIFByaW50YWJsZUtleSkpIHtcclxuICAgICAgICB0ZXJtLmFwcGVuZChrZXkpXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChrZXkgPT09ICdFbnRlcicpIHtcclxuICAgICAgICB0ZXJtLmFwcGVuZExpbmUoKVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoa2V5ID09PSAnQmFja3NwYWNlJykge1xyXG4gICAgICAgIHRlcm0uYmFja3NwYWNlKClcclxuICAgICAgICBjb25zb2xlLmxvZygnYmFja3NwYWNlJylcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGNvbnN1bWUgYWxsIGtleSBwcmVzc2VzXHJcbiAgICBrZXlQcmVzc2VzLmxlbmd0aCA9IDBcclxuICB9XHJcblxyXG4gIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGlmIChpc0FjdGl2ZSkge1xyXG4gICAgICAvLyBrZXlzXHJcbiAgICAgIF9oYW5kbGVLZXlzKHN0YXRlKVxyXG5cclxuICAgICAgLy8gbW91c2VcclxuXHJcbiAgICAgIGNvbnN0IHdoZWVsID0gc3RhdGUubW91c2UudGFrZVdoZWVsKClcclxuICAgICAgY29uc3Qgem9vbSA9IHN0YXRlLnZpZXcuZ2V0Wm9vbSgpXHJcblxyXG4gICAgICBpZiAod2hlZWwgPCAwKSB7XHJcbiAgICAgICAgLy9zdGF0ZS52aWV3Lnpvb20gKz0gMVxyXG4gICAgICAgIHN0YXRlLnZpZXcuc2V0Wm9vbSh6b29tICsgMSlcclxuICAgICAgfSBlbHNlIGlmICh3aGVlbCA+IDApIHtcclxuICAgICAgICBzdGF0ZS52aWV3LnNldFpvb20oem9vbSAtIDEpXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBkcmF3XHJcblxyXG4gICAgY29uc3QgYnVmZmVyID0gc3RhdGUudmlldy5nZXRCdWZmZXIoKVxyXG5cclxuICAgIGZpbGwoYnVmZmVyLCBiZ0NvbG9yKVxyXG5cclxuICAgIGNvbnN0IHZ3ID0gYnVmZmVyLndpZHRoIC0gcGFkZGluZyAqIDJcclxuICAgIGNvbnN0IHZoID0gYnVmZmVyLmhlaWdodCAtIHBhZGRpbmcgKiAyXHJcblxyXG4gICAgY29uc3QgbmV3VGV4dENvbHMgPSBNYXRoLmZsb29yKHZ3IC8gZm9udC53aWR0aClcclxuICAgIGNvbnN0IG5ld1RleHRSb3dzID0gTWF0aC5mbG9vcih2aCAvIGZvbnQuaGVpZ2h0KVxyXG5cclxuICAgIGlmIChuZXdUZXh0Q29scyAhPT0gdGV4dENvbHMgfHwgbmV3VGV4dFJvd3MgIT09IHRleHRSb3dzKSB7XHJcbiAgICAgIHRleHRDb2xzID0gbmV3VGV4dENvbHNcclxuICAgICAgdGV4dFJvd3MgPSBuZXdUZXh0Um93c1xyXG5cclxuICAgICAgcmVzaXplZCgpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdGVybVZpZXcgPSB0ZXJtLnZpZXcodGV4dENvbHMsIHRleHRSb3dzKVxyXG5cclxuICAgIGNvbnN0IGlzQ3Vyc29yID0gKHN0YXRlLnRpbWUuZ2V0RWxhcHNlZCgpICUgKGN1cnNvclJhdGUgKiAyKSkgPCBjdXJzb3JSYXRlXHJcblxyXG4gICAgbGV0IGN1cnNvciA9IGlzQ3Vyc29yID8gJ18nIDogJyAnXHJcblxyXG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0ZXJtVmlldy5sZW5ndGg7IHkrKykge1xyXG4gICAgICBsZXQgbGluZSA9IHRlcm1WaWV3W3ldXHJcblxyXG4gICAgICBpZiAoeSA9PT0gdGVybVZpZXcubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgIGxpbmUgKz0gY3Vyc29yXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGxpbmVMYXlvdXQgPSBsYXlvdXRUZXh0TGluZShmb250LCBsaW5lKVxyXG4gICAgICBjb25zdCBkeCA9IHBhZGRpbmdcclxuICAgICAgY29uc3QgZHkgPSBwYWRkaW5nICsgeSAqIGZvbnQuaGVpZ2h0XHJcblxyXG4gICAgICBjb25zdCBpbmRpY2VzID0gdGV4dExheW91dFRvSW5kaWNlcyhcclxuICAgICAgICBidWZmZXIsIGR4LCBkeSwgZm9udFB0cywgbGluZUxheW91dFxyXG4gICAgICApXHJcblxyXG4gICAgICBmaWxsSW5kaWNlcyhpbmRpY2VzLCBidWZmZXIsIGZnQ29sb3IpXHJcbiAgICB9XHJcblxyXG4gICAgLy8gZGVidWdcclxuXHJcbiAgICBjb25zdCBmcmFtZVRpbWUgPSBzdGF0ZS50aW1lLmdldEZyYW1lVGltZSgpXHJcbiAgICBjb25zdCBmcHMgPSBNYXRoLnJvdW5kKDEwMDAgLyBmcmFtZVRpbWUpXHJcbiAgICBjb25zdCBmcHNUZXh0ID0gYCR7ZnBzfSBmcHMgKCR7ZnJhbWVUaW1lLnRvRml4ZWQoMSl9bXMpYFxyXG5cclxuICAgIGNvbnN0IGZwc1cgPSBmb250LndpZHRoICogZnBzVGV4dC5sZW5ndGggKyBwYWRkaW5nICogMlxyXG4gICAgY29uc3QgZnBzSCA9IGZvbnQuaGVpZ2h0ICsgcGFkZGluZyAqIDJcclxuICAgIGNvbnN0IGZwc1ggPSBidWZmZXIud2lkdGggLSBmcHNXIC0gcGFkZGluZ1xyXG4gICAgY29uc3QgZnBzWSA9IHBhZGRpbmdcclxuXHJcbiAgICBjb25zdCBmcHNCZyA9IGNyZWF0ZUNvbG9yKDB4MDAsIDB4NzgsIDB4ZDQpXHJcbiAgICBjb25zdCBmcHNGZyA9IGNyZWF0ZUNvbG9yKDB4ZmYsIDB4ZDcsIDB4MDApXHJcblxyXG4gICAgZmlsbChidWZmZXIsIGZwc0JnLCBbZnBzWCwgZnBzWSwgZnBzVywgZnBzSF0pXHJcblxyXG4gICAgY29uc3QgZnBzTGF5b3V0ID0gbGF5b3V0VGV4dExpbmUoZm9udCwgZnBzVGV4dClcclxuXHJcbiAgICBjb25zdCBmcHNJbmRpY2VzID0gdGV4dExheW91dFRvSW5kaWNlcyhcclxuICAgICAgYnVmZmVyLCBmcHNYICsgcGFkZGluZywgZnBzWSArIHBhZGRpbmcsIGZvbnRQdHMsIGZwc0xheW91dFxyXG4gICAgKVxyXG5cclxuICAgIGZpbGxJbmRpY2VzKGZwc0luZGljZXMsIGJ1ZmZlciwgZnBzRmcpXHJcbiAgfVxyXG5cclxuICBjb25zdCBxdWl0ID0gYXN5bmMgKF9zdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdxdWl0dGluZyB0ZXh0IHNhbmRib3ggc2NlbmUnKVxyXG4gIH1cclxuXHJcbiAgY29uc3Qgc2V0QWN0aXZlID0gKGFjdGl2ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgaXNBY3RpdmUgPSBhY3RpdmVcclxuICB9XHJcblxyXG4gIHJldHVybiB7IGluaXQsIHVwZGF0ZSwgcXVpdCwgc2V0QWN0aXZlIH1cclxufVxyXG4iXX0=
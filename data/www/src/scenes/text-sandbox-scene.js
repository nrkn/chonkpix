import { fontImageToPoints, layoutTextLine, textLayoutToIndices } from '../lib/bmpfont/layout.js';
import { createColor } from '../lib/image/color.js';
import { fill, fillIndices } from '../lib/image/fill.js';
import { loadImage } from '../lib/image/load.js';
import { findSizeSlug, parseSizeSlug } from '../lib/slug.js';
import { createTerminal } from '../lib/term/index.js';
import { assrt, assrtInt } from '../lib/util.js';
const fontPath = 'data';
const monoFontFiles = [
    'ATI_SmallW_6x8',
    'EverexME_5x8',
    'HP_100LX_6x8',
    'Portfolio_6x8',
    'TsengEVA_132_6x8',
    'IBM_EGA_8x8',
    'IBM_VGA_8x14',
    'IBM_VGA_8x16',
    'IBM_VGA_9x8',
    'IBM_VGA_9x14',
    'IBM_VGA_9x16'
];
const loadFontMono = async (name) => {
    const image = await loadImage(`${fontPath}/Bm437_${name}.png`);
    const sizeSlug = assrt(findSizeSlug(name), 'Expected size slug');
    const [width, height] = parseSizeSlug(sizeSlug);
    const cols = assrtInt(image.width / width);
    const rows = assrtInt(image.height / height);
    const font = {
        type: 'mono',
        width,
        height,
        leading: 0, // built into the bitmap glyphs
        image: image,
        rects: {},
        advance: 0, // built into the bitmap glyphs
        fallback: 127
    };
    for (let r = 0; r < rows; r++) {
        const rowIndex = r * cols;
        for (let c = 0; c < cols; c++) {
            const charCode = rowIndex + c;
            font.rects[charCode] = [c * width, r * height, width, height];
        }
    }
    return font;
};
export const textSandboxScene = () => {
    const fonts = new Map();
    const term = createTerminal();
    let fontIndex = 1;
    let font;
    let fontPts;
    let textCols;
    let textRows;
    let isActive = true;
    const setFont = (state, fontIndex) => {
        const fontName = monoFontFiles[fontIndex];
        font = assrt(fonts.get(fontName), `Expected font ${fontName}`);
        fontPts = fontImageToPoints(font);
        const vw = state.view.buffer.width - padding * 2;
        const vh = state.view.buffer.height - padding * 2;
        textCols = Math.floor(vw / font.width);
        textRows = Math.floor(vh / font.height);
        term.appendLine(`FONT=${fontName}`);
    };
    const resized = () => {
        term.appendLine(`TSIZE=${textCols}x${textRows}`);
    };
    const init = async (state) => {
        console.log('initializing text sandbox scene');
        for (const n of monoFontFiles) {
            fonts.set(n, await loadFontMono(n));
        }
        term.clear();
        term.appendLine('Text Mode Sandbox');
        fontIndex = 1;
        setFont(state, fontIndex);
        resized();
    };
    const bgColor = createColor(0x1f, 0x1f, 0x1f);
    const fgColor = createColor(0x4f, 0xc1, 0xff);
    const padding = 2;
    const cursorRate = 500;
    const _handleKeys = (state) => {
        if (state.keys['Escape']) {
            state.running = false;
            // consume the key
            state.keys['Escape'] = false;
            return;
        }
        const fState = state.keys['F1'];
        if (fState) {
            fontIndex = (fontIndex + 1) % monoFontFiles.length;
            state.keys['F1'] = false;
            setFont(state, fontIndex);
            resized();
        }
        for (const key of state.keyPresses) {
            if (printableKeySet.has(key)) {
                term.append(key);
            }
            if (key === 'Enter') {
                term.appendLine();
            }
            if (key === 'Backspace') {
                term.backspace();
                console.log('backspace');
            }
        }
        state.keyPresses = [];
    };
    const update = (state) => {
        if (isActive) {
            // keys
            _handleKeys(state);
            // mouse
            const wheel = state.mouse.wheel;
            if (wheel < 0) {
                state.view.zoom += 1;
            }
            else if (wheel > 0) {
                state.view.zoom -= 1;
            }
        }
        // draw
        fill(state.view.buffer, bgColor);
        const vw = state.view.buffer.width - padding * 2;
        const vh = state.view.buffer.height - padding * 2;
        const newTextCols = Math.floor(vw / font.width);
        const newTextRows = Math.floor(vh / font.height);
        if (newTextCols !== textCols || newTextRows !== textRows) {
            textCols = newTextCols;
            textRows = newTextRows;
            resized();
        }
        const termView = term.view(textCols, textRows);
        const isCursor = (state.time.elapsed % (cursorRate * 2)) < cursorRate;
        let cursor = isCursor ? '_' : ' ';
        for (let y = 0; y < termView.length; y++) {
            let line = termView[y];
            if (y === termView.length - 1) {
                line += cursor;
            }
            const lineLayout = layoutTextLine(font, line);
            const dx = padding;
            const dy = padding + y * font.height;
            const indices = textLayoutToIndices(state.view.buffer, dx, dy, fontPts, lineLayout);
            fillIndices(indices, state.view.buffer, fgColor);
        }
        // debug
        const fps = Math.round(1000 / state.time.frameTime);
        const fpsText = `${fps} fps (${state.time.frameTime.toFixed(1)}ms)`;
        const fpsW = font.width * fpsText.length + padding * 2;
        const fpsH = font.height + padding * 2;
        const fpsX = state.view.buffer.width - fpsW - padding;
        const fpsY = padding;
        const fpsBg = createColor(0x00, 0x78, 0xd4);
        const fpsFg = createColor(0xff, 0xd7, 0x00);
        fill(state.view.buffer, fpsBg, [fpsX, fpsY, fpsW, fpsH]);
        const fpsLayout = layoutTextLine(font, fpsText);
        const fpsIndices = textLayoutToIndices(state.view.buffer, fpsX + padding, fpsY + padding, fontPts, fpsLayout);
        fillIndices(fpsIndices, state.view.buffer, fpsFg);
    };
    const quit = async (_state) => {
        console.log('quitting text sandbox scene');
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
// keyboard handling
// this subset should be fine to start with
const modifierKeys = [
    'Alt', 'AltGraph', 'CapsLock', 'Control', 'NumLock', 'ScrollLock', 'Shift'
];
const whitespaceKeys = [
    'Enter', 'Tab', ' '
];
const navigationKeys = [
    'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'End', 'Home', 'PageDown',
    'PageUp'
];
const editingKeys = [
    'Backspace', 'Delete', 'Insert'
];
// nb Escape is used by the scene to exit so we'll never be able to trap it,
// but leaving it in anyway in case things change in future
const uiKeys = [
    'Escape', 'Help', 'Pause'
];
const alphaKeys = [
    'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',
    'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
    'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm',
    'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'
];
const numberKeys = [
    '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'
];
const symbolKeys = [
    '!', '"', '#', '$', '%', '&', '\'', '(', ')', '*', '+', ',', '-',
    '.', '/', ':', ';', '<', '=', '>', '?', '@', '[', '\\', ']', '^',
    '_', '`', '{', '|', '}', '~'
];
// eg keys that will be echoed to the terminal, not control or special keys
const printableKeys = [
    ...alphaKeys, ...numberKeys, ...symbolKeys, ' '
];
const printableKeySet = new Set(printableKeys);
const allKeys = [
    ...modifierKeys, ...whitespaceKeys, ...navigationKeys, ...editingKeys,
    ...uiKeys, ...alphaKeys, ...numberKeys, ...symbolKeys
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dC1zYW5kYm94LXNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NjZW5lcy90ZXh0LXNhbmRib3gtc2NlbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGlCQUFpQixFQUFFLGNBQWMsRUFBRSxtQkFBbUIsRUFDdkQsTUFBTSwwQkFBMEIsQ0FBQTtBQUdqQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFDbkQsT0FBTyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDaEQsT0FBTyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUM1RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFFckQsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUVoRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUE7QUFFdkIsTUFBTSxhQUFhLEdBQUc7SUFDcEIsZ0JBQWdCO0lBQ2hCLGNBQWM7SUFDZCxjQUFjO0lBQ2QsZUFBZTtJQUNmLGtCQUFrQjtJQUNsQixhQUFhO0lBQ2IsY0FBYztJQUNkLGNBQWM7SUFDZCxhQUFhO0lBQ2IsY0FBYztJQUNkLGNBQWM7Q0FDTixDQUFBO0FBSVYsTUFBTSxZQUFZLEdBQUcsS0FBSyxFQUFFLElBQWtCLEVBQUUsRUFBRTtJQUNoRCxNQUFNLEtBQUssR0FBRyxNQUFNLFNBQVMsQ0FBQyxHQUFHLFFBQVEsVUFBVSxJQUFJLE1BQU0sQ0FBQyxDQUFBO0lBQzlELE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsb0JBQW9CLENBQUMsQ0FBQTtJQUNoRSxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FB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QUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHO0NBQ3hDLENBQUE7QUFFVixNQUFNLFVBQVUsR0FBRztJQUNqQixHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHO0lBQ2hFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUc7SUFDaEUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHO0NBQ3BCLENBQUE7QUFFViwyRUFBMkU7QUFDM0UsTUFBTSxhQUFhLEdBQUc7SUFDcEIsR0FBRyxTQUFTLEVBQUUsR0FBRyxVQUFVLEVBQUUsR0FBRyxVQUFVLEVBQUUsR0FBRztDQUN2QyxDQUFBO0FBSVYsTUFBTSxlQUFlLEdBQUcsSUFBSSxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUE7QUFFOUMsTUFBTSxPQUFPLEdBQUc7SUFDZCxHQUFHLFlBQVksRUFBRSxHQUFHLGNBQWMsRUFBRSxHQUFHLGNBQWMsRUFBRSxHQUFHLFdBQVc7SUFDckUsR0FBRyxNQUFNLEVBQUUsR0FBRyxTQUFTLEVBQUUsR0FBRyxVQUFVLEVBQUUsR0FBRyxVQUFVO0NBQzdDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIGZvbnRJbWFnZVRvUG9pbnRzLCBsYXlvdXRUZXh0TGluZSwgdGV4dExheW91dFRvSW5kaWNlc1xyXG59IGZyb20gJy4uL2xpYi9ibXBmb250L2xheW91dC5qcydcclxuXHJcbmltcG9ydCB7IEJtcEZvbnRNLCBGb250UG9pbnRzIH0gZnJvbSAnLi4vbGliL2JtcGZvbnQvdHlwZXMuanMnXHJcbmltcG9ydCB7IGNyZWF0ZUNvbG9yIH0gZnJvbSAnLi4vbGliL2ltYWdlL2NvbG9yLmpzJ1xyXG5pbXBvcnQgeyBmaWxsLCBmaWxsSW5kaWNlcyB9IGZyb20gJy4uL2xpYi9pbWFnZS9maWxsLmpzJ1xyXG5pbXBvcnQgeyBsb2FkSW1hZ2UgfSBmcm9tICcuLi9saWIvaW1hZ2UvbG9hZC5qcydcclxuaW1wb3J0IHsgZmluZFNpemVTbHVnLCBwYXJzZVNpemVTbHVnIH0gZnJvbSAnLi4vbGliL3NsdWcuanMnXHJcbmltcG9ydCB7IGNyZWF0ZVRlcm1pbmFsIH0gZnJvbSAnLi4vbGliL3Rlcm0vaW5kZXguanMnXHJcbmltcG9ydCB7IFNjZW5lLCBTdGF0ZSB9IGZyb20gJy4uL2xpYi90eXBlcy5qcydcclxuaW1wb3J0IHsgYXNzcnQsIGFzc3J0SW50IH0gZnJvbSAnLi4vbGliL3V0aWwuanMnXHJcblxyXG5jb25zdCBmb250UGF0aCA9ICdkYXRhJ1xyXG5cclxuY29uc3QgbW9ub0ZvbnRGaWxlcyA9IFtcclxuICAnQVRJX1NtYWxsV182eDgnLFxyXG4gICdFdmVyZXhNRV81eDgnLFxyXG4gICdIUF8xMDBMWF82eDgnLFxyXG4gICdQb3J0Zm9saW9fNng4JyxcclxuICAnVHNlbmdFVkFfMTMyXzZ4OCcsXHJcbiAgJ0lCTV9FR0FfOHg4JyxcclxuICAnSUJNX1ZHQV84eDE0JyxcclxuICAnSUJNX1ZHQV84eDE2JyxcclxuICAnSUJNX1ZHQV85eDgnLFxyXG4gICdJQk1fVkdBXzl4MTQnLFxyXG4gICdJQk1fVkdBXzl4MTYnXHJcbl0gYXMgY29uc3RcclxuXHJcbnR5cGUgTW9ub0ZvbnROYW1lID0gdHlwZW9mIG1vbm9Gb250RmlsZXNbbnVtYmVyXVxyXG5cclxuY29uc3QgbG9hZEZvbnRNb25vID0gYXN5bmMgKG5hbWU6IE1vbm9Gb250TmFtZSkgPT4ge1xyXG4gIGNvbnN0IGltYWdlID0gYXdhaXQgbG9hZEltYWdlKGAke2ZvbnRQYXRofS9CbTQzN18ke25hbWV9LnBuZ2ApXHJcbiAgY29uc3Qgc2l6ZVNsdWcgPSBhc3NydChmaW5kU2l6ZVNsdWcobmFtZSksICdFeHBlY3RlZCBzaXplIHNsdWcnKVxyXG4gIGNvbnN0IFt3aWR0aCwgaGVpZ2h0XSA9IHBhcnNlU2l6ZVNsdWcoc2l6ZVNsdWcpXHJcblxyXG4gIGNvbnN0IGNvbHMgPSBhc3NydEludChpbWFnZS53aWR0aCAvIHdpZHRoKVxyXG4gIGNvbnN0IHJvd3MgPSBhc3NydEludChpbWFnZS5oZWlnaHQgLyBoZWlnaHQpXHJcblxyXG4gIGNvbnN0IGZvbnQ6IEJtcEZvbnRNID0ge1xyXG4gICAgdHlwZTogJ21vbm8nLFxyXG4gICAgd2lkdGgsXHJcbiAgICBoZWlnaHQsXHJcbiAgICBsZWFkaW5nOiAwLCAvLyBidWlsdCBpbnRvIHRoZSBiaXRtYXAgZ2x5cGhzXHJcbiAgICBpbWFnZTogaW1hZ2UsXHJcbiAgICByZWN0czoge30sXHJcbiAgICBhZHZhbmNlOiAwLCAvLyBidWlsdCBpbnRvIHRoZSBiaXRtYXAgZ2x5cGhzXHJcbiAgICBmYWxsYmFjazogMTI3XHJcbiAgfVxyXG5cclxuICBmb3IgKGxldCByID0gMDsgciA8IHJvd3M7IHIrKykge1xyXG4gICAgY29uc3Qgcm93SW5kZXggPSByICogY29sc1xyXG4gICAgZm9yIChsZXQgYyA9IDA7IGMgPCBjb2xzOyBjKyspIHtcclxuICAgICAgY29uc3QgY2hhckNvZGUgPSByb3dJbmRleCArIGNcclxuXHJcbiAgICAgIGZvbnQucmVjdHNbY2hhckNvZGVdID0gW2MgKiB3aWR0aCwgciAqIGhlaWdodCwgd2lkdGgsIGhlaWdodF1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBmb250XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCB0ZXh0U2FuZGJveFNjZW5lID0gKCk6IFNjZW5lID0+IHtcclxuICBjb25zdCBmb250cyA9IG5ldyBNYXA8TW9ub0ZvbnROYW1lLCBCbXBGb250TT4oKVxyXG4gIGNvbnN0IHRlcm0gPSBjcmVhdGVUZXJtaW5hbCgpXHJcblxyXG4gIGxldCBmb250SW5kZXggPSAxXHJcbiAgbGV0IGZvbnQ6IEJtcEZvbnRNXHJcbiAgbGV0IGZvbnRQdHM6IEZvbnRQb2ludHNcclxuICBsZXQgdGV4dENvbHM6IG51bWJlclxyXG4gIGxldCB0ZXh0Um93czogbnVtYmVyXHJcblxyXG4gIGxldCBpc0FjdGl2ZSA9IHRydWVcclxuXHJcbiAgY29uc3Qgc2V0Rm9udCA9IChzdGF0ZTogU3RhdGUsIGZvbnRJbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICBjb25zdCBmb250TmFtZTogTW9ub0ZvbnROYW1lID0gbW9ub0ZvbnRGaWxlc1tmb250SW5kZXhdXHJcblxyXG4gICAgZm9udCA9IGFzc3J0KGZvbnRzLmdldChmb250TmFtZSksIGBFeHBlY3RlZCBmb250ICR7Zm9udE5hbWV9YClcclxuICAgIGZvbnRQdHMgPSBmb250SW1hZ2VUb1BvaW50cyhmb250KVxyXG5cclxuICAgIGNvbnN0IHZ3ID0gc3RhdGUudmlldy5idWZmZXIud2lkdGggLSBwYWRkaW5nICogMlxyXG4gICAgY29uc3QgdmggPSBzdGF0ZS52aWV3LmJ1ZmZlci5oZWlnaHQgLSBwYWRkaW5nICogMlxyXG5cclxuICAgIHRleHRDb2xzID0gTWF0aC5mbG9vcih2dyAvIGZvbnQud2lkdGgpXHJcbiAgICB0ZXh0Um93cyA9IE1hdGguZmxvb3IodmggLyBmb250LmhlaWdodClcclxuXHJcbiAgICB0ZXJtLmFwcGVuZExpbmUoYEZPTlQ9JHtmb250TmFtZX1gKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVzaXplZCA9ICgpID0+IHtcclxuICAgIHRlcm0uYXBwZW5kTGluZShgVFNJWkU9JHt0ZXh0Q29sc314JHt0ZXh0Um93c31gKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgaW5pdCA9IGFzeW5jIChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdpbml0aWFsaXppbmcgdGV4dCBzYW5kYm94IHNjZW5lJylcclxuXHJcbiAgICBmb3IgKGNvbnN0IG4gb2YgbW9ub0ZvbnRGaWxlcykge1xyXG4gICAgICBmb250cy5zZXQobiwgYXdhaXQgbG9hZEZvbnRNb25vKG4pKVxyXG4gICAgfVxyXG5cclxuICAgIHRlcm0uY2xlYXIoKVxyXG4gICAgdGVybS5hcHBlbmRMaW5lKCdUZXh0IE1vZGUgU2FuZGJveCcpXHJcblxyXG4gICAgZm9udEluZGV4ID0gMVxyXG5cclxuICAgIHNldEZvbnQoc3RhdGUsIGZvbnRJbmRleClcclxuICAgIHJlc2l6ZWQoKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgYmdDb2xvciA9IGNyZWF0ZUNvbG9yKDB4MWYsIDB4MWYsIDB4MWYpXHJcbiAgY29uc3QgZmdDb2xvciA9IGNyZWF0ZUNvbG9yKDB4NGYsIDB4YzEsIDB4ZmYpXHJcblxyXG4gIGNvbnN0IHBhZGRpbmcgPSAyXHJcblxyXG4gIGNvbnN0IGN1cnNvclJhdGUgPSA1MDBcclxuXHJcbiAgY29uc3QgX2hhbmRsZUtleXMgPSAoc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBpZiAoc3RhdGUua2V5c1snRXNjYXBlJ10pIHtcclxuICAgICAgc3RhdGUucnVubmluZyA9IGZhbHNlXHJcbiAgICAgIC8vIGNvbnN1bWUgdGhlIGtleVxyXG4gICAgICBzdGF0ZS5rZXlzWydFc2NhcGUnXSA9IGZhbHNlXHJcblxyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmU3RhdGUgPSBzdGF0ZS5rZXlzWydGMSddXHJcblxyXG4gICAgaWYgKGZTdGF0ZSkge1xyXG4gICAgICBmb250SW5kZXggPSAoZm9udEluZGV4ICsgMSkgJSBtb25vRm9udEZpbGVzLmxlbmd0aFxyXG4gICAgICBzdGF0ZS5rZXlzWydGMSddID0gZmFsc2VcclxuICAgICAgc2V0Rm9udChzdGF0ZSwgZm9udEluZGV4KVxyXG4gICAgICByZXNpemVkKClcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBzdGF0ZS5rZXlQcmVzc2VzKSB7XHJcbiAgICAgIGlmIChwcmludGFibGVLZXlTZXQuaGFzKGtleSBhcyBQcmludGFibGVLZXkpKSB7XHJcbiAgICAgICAgdGVybS5hcHBlbmQoa2V5KVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoa2V5ID09PSAnRW50ZXInKSB7XHJcbiAgICAgICAgdGVybS5hcHBlbmRMaW5lKClcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGtleSA9PT0gJ0JhY2tzcGFjZScpIHtcclxuICAgICAgICB0ZXJtLmJhY2tzcGFjZSgpXHJcbiAgICAgICAgY29uc29sZS5sb2coJ2JhY2tzcGFjZScpXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzdGF0ZS5rZXlQcmVzc2VzID0gW11cclxuICB9XHJcblxyXG4gIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogU3RhdGUpID0+IHtcclxuICAgIGlmIChpc0FjdGl2ZSkge1xyXG4gICAgICAvLyBrZXlzXHJcbiAgICAgIF9oYW5kbGVLZXlzKHN0YXRlKVxyXG5cclxuICAgICAgLy8gbW91c2VcclxuXHJcbiAgICAgIGNvbnN0IHdoZWVsID0gc3RhdGUubW91c2Uud2hlZWxcclxuXHJcbiAgICAgIGlmICh3aGVlbCA8IDApIHtcclxuICAgICAgICBzdGF0ZS52aWV3Lnpvb20gKz0gMVxyXG4gICAgICB9IGVsc2UgaWYgKHdoZWVsID4gMCkge1xyXG4gICAgICAgIHN0YXRlLnZpZXcuem9vbSAtPSAxXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBkcmF3XHJcblxyXG4gICAgZmlsbChzdGF0ZS52aWV3LmJ1ZmZlciwgYmdDb2xvcilcclxuXHJcbiAgICBjb25zdCB2dyA9IHN0YXRlLnZpZXcuYnVmZmVyLndpZHRoIC0gcGFkZGluZyAqIDJcclxuICAgIGNvbnN0IHZoID0gc3RhdGUudmlldy5idWZmZXIuaGVpZ2h0IC0gcGFkZGluZyAqIDJcclxuXHJcbiAgICBjb25zdCBuZXdUZXh0Q29scyA9IE1hdGguZmxvb3IodncgLyBmb250LndpZHRoKVxyXG4gICAgY29uc3QgbmV3VGV4dFJvd3MgPSBNYXRoLmZsb29yKHZoIC8gZm9udC5oZWlnaHQpXHJcblxyXG4gICAgaWYgKG5ld1RleHRDb2xzICE9PSB0ZXh0Q29scyB8fCBuZXdUZXh0Um93cyAhPT0gdGV4dFJvd3MpIHtcclxuICAgICAgdGV4dENvbHMgPSBuZXdUZXh0Q29sc1xyXG4gICAgICB0ZXh0Um93cyA9IG5ld1RleHRSb3dzXHJcblxyXG4gICAgICByZXNpemVkKClcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB0ZXJtVmlldyA9IHRlcm0udmlldyh0ZXh0Q29scywgdGV4dFJvd3MpXHJcblxyXG4gICAgY29uc3QgaXNDdXJzb3IgPSAoc3RhdGUudGltZS5lbGFwc2VkICUgKGN1cnNvclJhdGUgKiAyKSkgPCBjdXJzb3JSYXRlXHJcblxyXG4gICAgbGV0IGN1cnNvciA9IGlzQ3Vyc29yID8gJ18nIDogJyAnXHJcblxyXG4gICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0ZXJtVmlldy5sZW5ndGg7IHkrKykge1xyXG4gICAgICBsZXQgbGluZSA9IHRlcm1WaWV3W3ldXHJcblxyXG4gICAgICBpZiAoeSA9PT0gdGVybVZpZXcubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgIGxpbmUgKz0gY3Vyc29yXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGxpbmVMYXlvdXQgPSBsYXlvdXRUZXh0TGluZShmb250LCBsaW5lKVxyXG4gICAgICBjb25zdCBkeCA9IHBhZGRpbmdcclxuICAgICAgY29uc3QgZHkgPSBwYWRkaW5nICsgeSAqIGZvbnQuaGVpZ2h0XHJcblxyXG4gICAgICBjb25zdCBpbmRpY2VzID0gdGV4dExheW91dFRvSW5kaWNlcyhcclxuICAgICAgICBzdGF0ZS52aWV3LmJ1ZmZlciwgZHgsIGR5LCBmb250UHRzLCBsaW5lTGF5b3V0XHJcbiAgICAgIClcclxuXHJcbiAgICAgIGZpbGxJbmRpY2VzKGluZGljZXMsIHN0YXRlLnZpZXcuYnVmZmVyLCBmZ0NvbG9yKVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGRlYnVnXHJcblxyXG4gICAgY29uc3QgZnBzID0gTWF0aC5yb3VuZCgxMDAwIC8gc3RhdGUudGltZS5mcmFtZVRpbWUpXHJcbiAgICBjb25zdCBmcHNUZXh0ID0gYCR7ZnBzfSBmcHMgKCR7c3RhdGUudGltZS5mcmFtZVRpbWUudG9GaXhlZCgxKX1tcylgXHJcblxyXG4gICAgY29uc3QgZnBzVyA9IGZvbnQud2lkdGggKiBmcHNUZXh0Lmxlbmd0aCArIHBhZGRpbmcgKiAyXHJcbiAgICBjb25zdCBmcHNIID0gZm9udC5oZWlnaHQgKyBwYWRkaW5nICogMlxyXG4gICAgY29uc3QgZnBzWCA9IHN0YXRlLnZpZXcuYnVmZmVyLndpZHRoIC0gZnBzVyAtIHBhZGRpbmdcclxuICAgIGNvbnN0IGZwc1kgPSBwYWRkaW5nXHJcblxyXG4gICAgY29uc3QgZnBzQmcgPSBjcmVhdGVDb2xvcigweDAwLCAweDc4LCAweGQ0KVxyXG4gICAgY29uc3QgZnBzRmcgPSBjcmVhdGVDb2xvcigweGZmLCAweGQ3LCAweDAwKVxyXG5cclxuICAgIGZpbGwoc3RhdGUudmlldy5idWZmZXIsIGZwc0JnLCBbZnBzWCwgZnBzWSwgZnBzVywgZnBzSF0pXHJcblxyXG4gICAgY29uc3QgZnBzTGF5b3V0ID0gbGF5b3V0VGV4dExpbmUoZm9udCwgZnBzVGV4dClcclxuXHJcbiAgICBjb25zdCBmcHNJbmRpY2VzID0gdGV4dExheW91dFRvSW5kaWNlcyhcclxuICAgICAgc3RhdGUudmlldy5idWZmZXIsIGZwc1ggKyBwYWRkaW5nLCBmcHNZICsgcGFkZGluZywgZm9udFB0cywgZnBzTGF5b3V0XHJcbiAgICApXHJcblxyXG4gICAgZmlsbEluZGljZXMoZnBzSW5kaWNlcywgc3RhdGUudmlldy5idWZmZXIsIGZwc0ZnKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgcXVpdCA9IGFzeW5jIChfc3RhdGU6IFN0YXRlKSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZygncXVpdHRpbmcgdGV4dCBzYW5kYm94IHNjZW5lJylcclxuICB9XHJcblxyXG4gIGNvbnN0IHNldEFjdGl2ZSA9IChhY3RpdmU6IGJvb2xlYW4pID0+IHtcclxuICAgIGlzQWN0aXZlID0gYWN0aXZlXHJcbiAgfVxyXG5cclxuICByZXR1cm4geyBpbml0LCB1cGRhdGUsIHF1aXQsIHNldEFjdGl2ZSB9XHJcbn1cclxuXHJcbi8vIGtleWJvYXJkIGhhbmRsaW5nXHJcblxyXG4vLyB0aGlzIHN1YnNldCBzaG91bGQgYmUgZmluZSB0byBzdGFydCB3aXRoXHJcblxyXG5jb25zdCBtb2RpZmllcktleXMgPSBbXHJcbiAgJ0FsdCcsICdBbHRHcmFwaCcsICdDYXBzTG9jaycsICdDb250cm9sJywgJ051bUxvY2snLCAnU2Nyb2xsTG9jaycsICdTaGlmdCdcclxuXSBhcyBjb25zdFxyXG5cclxuY29uc3Qgd2hpdGVzcGFjZUtleXMgPSBbXHJcbiAgJ0VudGVyJywgJ1RhYicsICcgJ1xyXG5dIGFzIGNvbnN0XHJcblxyXG5jb25zdCBuYXZpZ2F0aW9uS2V5cyA9IFtcclxuICAnQXJyb3dEb3duJywgJ0Fycm93TGVmdCcsICdBcnJvd1JpZ2h0JywgJ0Fycm93VXAnLCAnRW5kJywgJ0hvbWUnLCAnUGFnZURvd24nLFxyXG4gICdQYWdlVXAnXHJcbl0gYXMgY29uc3RcclxuXHJcbmNvbnN0IGVkaXRpbmdLZXlzID0gW1xyXG4gICdCYWNrc3BhY2UnLCAnRGVsZXRlJywgJ0luc2VydCdcclxuXSBhcyBjb25zdFxyXG5cclxuLy8gbmIgRXNjYXBlIGlzIHVzZWQgYnkgdGhlIHNjZW5lIHRvIGV4aXQgc28gd2UnbGwgbmV2ZXIgYmUgYWJsZSB0byB0cmFwIGl0LFxyXG4vLyBidXQgbGVhdmluZyBpdCBpbiBhbnl3YXkgaW4gY2FzZSB0aGluZ3MgY2hhbmdlIGluIGZ1dHVyZVxyXG5jb25zdCB1aUtleXMgPSBbXHJcbiAgJ0VzY2FwZScsICdIZWxwJywgJ1BhdXNlJ1xyXG5dIGFzIGNvbnN0XHJcblxyXG5jb25zdCBhbHBoYUtleXMgPSBbXHJcbiAgJ0EnLCAnQicsICdDJywgJ0QnLCAnRScsICdGJywgJ0cnLCAnSCcsICdJJywgJ0onLCAnSycsICdMJywgJ00nLFxyXG4gICdOJywgJ08nLCAnUCcsICdRJywgJ1InLCAnUycsICdUJywgJ1UnLCAnVicsICdXJywgJ1gnLCAnWScsICdaJyxcclxuICAnYScsICdiJywgJ2MnLCAnZCcsICdlJywgJ2YnLCAnZycsICdoJywgJ2knLCAnaicsICdrJywgJ2wnLCAnbScsXHJcbiAgJ24nLCAnbycsICdwJywgJ3EnLCAncicsICdzJywgJ3QnLCAndScsICd2JywgJ3cnLCAneCcsICd5JywgJ3onXHJcbl0gYXMgY29uc3RcclxuXHJcbmNvbnN0IG51bWJlcktleXMgPSBbXHJcbiAgJzAnLCAnMScsICcyJywgJzMnLCAnNCcsICc1JywgJzYnLCAnNycsICc4JywgJzknXHJcbl0gYXMgY29uc3RcclxuXHJcbmNvbnN0IHN5bWJvbEtleXMgPSBbXHJcbiAgJyEnLCAnXCInLCAnIycsICckJywgJyUnLCAnJicsICdcXCcnLCAnKCcsICcpJywgJyonLCAnKycsICcsJywgJy0nLFxyXG4gICcuJywgJy8nLCAnOicsICc7JywgJzwnLCAnPScsICc+JywgJz8nLCAnQCcsICdbJywgJ1xcXFwnLCAnXScsICdeJyxcclxuICAnXycsICdgJywgJ3snLCAnfCcsICd9JywgJ34nXHJcbl0gYXMgY29uc3RcclxuXHJcbi8vIGVnIGtleXMgdGhhdCB3aWxsIGJlIGVjaG9lZCB0byB0aGUgdGVybWluYWwsIG5vdCBjb250cm9sIG9yIHNwZWNpYWwga2V5c1xyXG5jb25zdCBwcmludGFibGVLZXlzID0gW1xyXG4gIC4uLmFscGhhS2V5cywgLi4ubnVtYmVyS2V5cywgLi4uc3ltYm9sS2V5cywgJyAnXHJcbl0gYXMgY29uc3RcclxuXHJcbnR5cGUgUHJpbnRhYmxlS2V5ID0gdHlwZW9mIHByaW50YWJsZUtleXNbbnVtYmVyXVxyXG5cclxuY29uc3QgcHJpbnRhYmxlS2V5U2V0ID0gbmV3IFNldChwcmludGFibGVLZXlzKVxyXG5cclxuY29uc3QgYWxsS2V5cyA9IFtcclxuICAuLi5tb2RpZmllcktleXMsIC4uLndoaXRlc3BhY2VLZXlzLCAuLi5uYXZpZ2F0aW9uS2V5cywgLi4uZWRpdGluZ0tleXMsXHJcbiAgLi4udWlLZXlzLCAuLi5hbHBoYUtleXMsIC4uLm51bWJlcktleXMsIC4uLnN5bWJvbEtleXNcclxuXSBhcyBjb25zdFxyXG4iXX0=
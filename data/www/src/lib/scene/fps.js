import { fontImageToPoints, layoutTextLine, textLayoutToIndices } from '../bmpfont/layout.js';
import { loadFontMono } from '../bmpfont/load.js';
import { createColor } from '../image/color.js';
import { fill, fillIndices } from '../image/fill.js';
import { maybe } from '../util.js';
export const fpsSceneHelper = () => {
    let isActive = false;
    let font;
    let fontPts = {};
    const init = async (_state) => {
        font = await loadFontMono('EverexME_5x8');
        fontPts = fontImageToPoints(font);
        isActive = true;
    };
    const update = (state) => {
        if (!maybe(font))
            throw Error('Expected font');
        if (!maybe(fontPts))
            throw Error('Expected fontPts');
        const buffer = state.view.getBuffer();
        const { width } = buffer;
        const padding = 2;
        const frameTime = state.time.getFrameTime();
        const fps = Math.round(1000 / frameTime);
        const fpsText = `${fps} fps (${frameTime.toFixed(1)}ms)`;
        const fpsW = font.width * fpsText.length + padding * 2;
        const fpsH = font.height + padding * 2;
        const fpsX = width - fpsW - padding;
        const fpsY = padding;
        const fpsBg = createColor(0x00, 0x78, 0xd4);
        const fpsFg = createColor(0xff, 0xd7, 0x00);
        fill(buffer, fpsBg, [fpsX, fpsY, fpsW, fpsH]);
        const fpsLayout = layoutTextLine(font, fpsText);
        const fpsIndices = textLayoutToIndices(buffer, fpsX + padding, fpsY + padding, fontPts, fpsLayout);
        fillIndices(fpsIndices, buffer, fpsFg);
    };
    const quit = async (_state) => {
        font = null;
        fontPts = {};
        isActive = false;
    };
    const setActive = (active) => {
        isActive = active;
    };
    return { init, update, quit, setActive };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnBzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9zY2VuZS9mcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGlCQUFpQixFQUFFLGNBQWMsRUFBRSxtQkFBbUIsRUFDdkQsTUFBTSxzQkFBc0IsQ0FBQTtBQUM3QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFFakQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBQy9DLE9BQU8sRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFFcEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFlBQVksQ0FBQTtBQUVsQyxNQUFNLENBQUMsTUFBTSxjQUFjLEdBQUcsR0FBVSxFQUFFO0lBQ3hDLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQTtJQUNwQixJQUFJLElBQXFCLENBQUE7SUFDekIsSUFBSSxPQUFPLEdBQWdDLEVBQUUsQ0FBQTtJQUU3QyxNQUFNLElBQUksR0FBRyxLQUFLLEVBQUUsTUFBYSxFQUFFLEVBQUU7UUFDbkMsSUFBSSxHQUFHLE1BQU0sWUFBWSxDQUFDLGNBQWMsQ0FBQyxDQUFBO1FBQ3pDLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVqQyxRQUFRLEdBQUcsSUFBSSxDQUFBO0lBQ2pCLENBQUMsQ0FBQTtJQUVELE1BQU0sTUFBTSxHQUFHLENBQUMsS0FBWSxFQUFFLEVBQUU7UUFDOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7WUFBRSxNQUFNLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQTtRQUM5QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQztZQUFFLE1BQU0sS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUE7UUFFcEQsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUNyQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxDQUFBO1FBRXhCLE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBQTtRQUVqQixNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO1FBQzNDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxDQUFBO1FBQ3hDLE1BQU0sT0FBTyxHQUFHLEdBQUcsR0FBRyxTQUFTLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQTtRQUV4RCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEdBQUcsT0FBTyxHQUFHLENBQUMsQ0FBQTtRQUN0RCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sR0FBRyxDQUFDLENBQUE7UUFDdEMsTUFBTSxJQUFJLEdBQUcsS0FBSyxHQUFHLElBQUksR0FBRyxPQUFPLENBQUE7UUFDbkMsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFBO1FBRXBCLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQzNDLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBRTNDLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQTtRQUU3QyxNQUFNLFNBQVMsR0FBRyxjQUFjLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBRS9DLE1BQU0sVUFBVSxHQUFHLG1CQUFtQixDQUNwQyxNQUFNLEVBQUUsSUFBSSxHQUFHLE9BQU8sRUFBRSxJQUFJLEdBQUcsT0FBTyxFQUFFLE9BQU8sRUFBRSxTQUFTLENBQzNELENBQUE7UUFFRCxXQUFXLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQTtJQUN4QyxDQUFDLENBQUE7SUFFRCxNQUFNLElBQUksR0FBRyxLQUFLLEVBQUUsTUFBYSxFQUFFLEVBQUU7UUFDbkMsSUFBSSxHQUFHLElBQUksQ0FBQTtRQUNYLE9BQU8sR0FBRyxFQUFFLENBQUE7UUFFWixRQUFRLEdBQUcsS0FBSyxDQUFBO0lBQ2xCLENBQUMsQ0FBQTtJQUVELE1BQU0sU0FBUyxHQUFHLENBQUMsTUFBZSxFQUFFLEVBQUU7UUFDcEMsUUFBUSxHQUFHLE1BQU0sQ0FBQTtJQUNuQixDQUFDLENBQUE7SUFFRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUE7QUFDMUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgZm9udEltYWdlVG9Qb2ludHMsIGxheW91dFRleHRMaW5lLCB0ZXh0TGF5b3V0VG9JbmRpY2VzXG59IGZyb20gJy4uL2JtcGZvbnQvbGF5b3V0LmpzJ1xuaW1wb3J0IHsgbG9hZEZvbnRNb25vIH0gZnJvbSAnLi4vYm1wZm9udC9sb2FkLmpzJ1xuaW1wb3J0IHsgQm1wRm9udE0gfSBmcm9tICcuLi9ibXBmb250L3R5cGVzLmpzJ1xuaW1wb3J0IHsgY3JlYXRlQ29sb3IgfSBmcm9tICcuLi9pbWFnZS9jb2xvci5qcydcbmltcG9ydCB7IGZpbGwsIGZpbGxJbmRpY2VzIH0gZnJvbSAnLi4vaW1hZ2UvZmlsbC5qcydcbmltcG9ydCB7IE1heWJlLCBTY2VuZSwgU3RhdGUsIFQyIH0gZnJvbSAnLi4vdHlwZXMuanMnXG5pbXBvcnQgeyBtYXliZSB9IGZyb20gJy4uL3V0aWwuanMnXG5cbmV4cG9ydCBjb25zdCBmcHNTY2VuZUhlbHBlciA9ICgpOiBTY2VuZSA9PiB7XG4gIGxldCBpc0FjdGl2ZSA9IGZhbHNlXG4gIGxldCBmb250OiBNYXliZTxCbXBGb250TT5cbiAgbGV0IGZvbnRQdHM6IFJlY29yZDxudW1iZXIsIE1heWJlPFQyW10+PiA9IHt9XG5cbiAgY29uc3QgaW5pdCA9IGFzeW5jIChfc3RhdGU6IFN0YXRlKSA9PiB7XG4gICAgZm9udCA9IGF3YWl0IGxvYWRGb250TW9ubygnRXZlcmV4TUVfNXg4JylcbiAgICBmb250UHRzID0gZm9udEltYWdlVG9Qb2ludHMoZm9udClcblxuICAgIGlzQWN0aXZlID0gdHJ1ZVxuICB9XG5cbiAgY29uc3QgdXBkYXRlID0gKHN0YXRlOiBTdGF0ZSkgPT4ge1xuICAgIGlmICghbWF5YmUoZm9udCkpIHRocm93IEVycm9yKCdFeHBlY3RlZCBmb250JylcbiAgICBpZiAoIW1heWJlKGZvbnRQdHMpKSB0aHJvdyBFcnJvcignRXhwZWN0ZWQgZm9udFB0cycpXG5cbiAgICBjb25zdCBidWZmZXIgPSBzdGF0ZS52aWV3LmdldEJ1ZmZlcigpXG4gICAgY29uc3QgeyB3aWR0aCB9ID0gYnVmZmVyXG5cbiAgICBjb25zdCBwYWRkaW5nID0gMlxuXG4gICAgY29uc3QgZnJhbWVUaW1lID0gc3RhdGUudGltZS5nZXRGcmFtZVRpbWUoKVxuICAgIGNvbnN0IGZwcyA9IE1hdGgucm91bmQoMTAwMCAvIGZyYW1lVGltZSlcbiAgICBjb25zdCBmcHNUZXh0ID0gYCR7ZnBzfSBmcHMgKCR7ZnJhbWVUaW1lLnRvRml4ZWQoMSl9bXMpYFxuXG4gICAgY29uc3QgZnBzVyA9IGZvbnQud2lkdGggKiBmcHNUZXh0Lmxlbmd0aCArIHBhZGRpbmcgKiAyXG4gICAgY29uc3QgZnBzSCA9IGZvbnQuaGVpZ2h0ICsgcGFkZGluZyAqIDJcbiAgICBjb25zdCBmcHNYID0gd2lkdGggLSBmcHNXIC0gcGFkZGluZ1xuICAgIGNvbnN0IGZwc1kgPSBwYWRkaW5nXG5cbiAgICBjb25zdCBmcHNCZyA9IGNyZWF0ZUNvbG9yKDB4MDAsIDB4NzgsIDB4ZDQpXG4gICAgY29uc3QgZnBzRmcgPSBjcmVhdGVDb2xvcigweGZmLCAweGQ3LCAweDAwKVxuXG4gICAgZmlsbChidWZmZXIsIGZwc0JnLCBbZnBzWCwgZnBzWSwgZnBzVywgZnBzSF0pXG5cbiAgICBjb25zdCBmcHNMYXlvdXQgPSBsYXlvdXRUZXh0TGluZShmb250LCBmcHNUZXh0KVxuXG4gICAgY29uc3QgZnBzSW5kaWNlcyA9IHRleHRMYXlvdXRUb0luZGljZXMoXG4gICAgICBidWZmZXIsIGZwc1ggKyBwYWRkaW5nLCBmcHNZICsgcGFkZGluZywgZm9udFB0cywgZnBzTGF5b3V0XG4gICAgKVxuXG4gICAgZmlsbEluZGljZXMoZnBzSW5kaWNlcywgYnVmZmVyLCBmcHNGZylcbiAgfVxuXG4gIGNvbnN0IHF1aXQgPSBhc3luYyAoX3N0YXRlOiBTdGF0ZSkgPT4ge1xuICAgIGZvbnQgPSBudWxsXG4gICAgZm9udFB0cyA9IHt9XG5cbiAgICBpc0FjdGl2ZSA9IGZhbHNlXG4gIH1cblxuICBjb25zdCBzZXRBY3RpdmUgPSAoYWN0aXZlOiBib29sZWFuKSA9PiB7XG4gICAgaXNBY3RpdmUgPSBhY3RpdmVcbiAgfVxuXG4gIHJldHVybiB7IGluaXQsIHVwZGF0ZSwgcXVpdCwgc2V0QWN0aXZlIH1cbn1cbiJdfQ==
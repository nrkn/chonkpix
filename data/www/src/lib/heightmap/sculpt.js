import { clampRect } from '../image/util.js';
import { enqueueNeighbours } from './util.js';
export const raise = (heightmap, x, y) => {
    const { width, height, data } = heightmap;
    const i = y * width + x;
    const v = data[i] + 1;
    if (v > 255)
        return;
    data[i] = v;
    const queue = [];
    enqueueNeighbours(queue, x, y, v);
    while (queue.length) {
        const [nx, ny, nv] = queue.shift();
        if (nx < 0 || nx >= width || ny < 0 || ny >= height) {
            continue;
        }
        const n = ny * width + nx;
        if (data[n] >= nv) {
            continue;
        }
        if (data[n] === nv - 1) {
            continue;
        }
        data[n] = nv - 1;
        enqueueNeighbours(queue, nx, ny, nv - 1);
    }
};
export const lower = (heightmap, x, y) => {
    const { width, height, data } = heightmap;
    const i = y * width + x;
    const v = data[i] - 1;
    if (v < 0)
        return;
    data[i] = v;
    const queue = [];
    enqueueNeighbours(queue, x, y, v);
    while (queue.length) {
        const [nx, ny, nv] = queue.shift();
        if (nx < 0 || nx >= width || ny < 0 || ny >= height) {
            continue;
        }
        const n = ny * width + nx;
        if (data[n] <= nv) {
            continue;
        }
        if (data[n] === nv + 1) {
            continue;
        }
        data[n] = nv + 1;
        enqueueNeighbours(queue, nx, ny, nv + 1);
    }
};
// raise every point in rect to highest value in rect
export const raiseRect = (heightmap, x, y, w, h) => {
    let highest = 0;
    // find highest value in rect
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            const v = heightmap.data[index];
            if (v > highest)
                highest = v;
        }
    }
    // for each point in rect < highest, raise until matches highest
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            let v = heightmap.data[index];
            while (v < highest) {
                raise(heightmap, i, j);
                v++;
            }
        }
    }
    return highest;
};
// lower every point in rect to lowest value in rect
export const lowerRect = (heightmap, x, y, w, h) => {
    let lowest = 255;
    // find lowest value in rect
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            const v = heightmap.data[index];
            if (v < lowest)
                lowest = v;
        }
    }
    // for each point in rect > lowest, lower until matches lowest
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            let v = heightmap.data[index];
            while (v > lowest) {
                lower(heightmap, i, j);
                v--;
            }
        }
    }
    return lowest;
};
// average the values in the rect, then raise or lower each point to match
export const flattenRect = (heightmap, x, y, w, h) => {
    let sum = 0;
    let count = 0;
    // sum values in rect
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            sum += heightmap.data[index];
            count++;
        }
    }
    const avg = Math.floor(sum / count);
    // for each point in rect, raise or lower to match avg
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            let v = heightmap.data[index];
            while (v < avg) {
                raise(heightmap, i, j);
                v++;
            }
            while (v > avg) {
                lower(heightmap, i, j);
                v--;
            }
        }
    }
    return avg;
};
export const smooth = (heightmap, rect, times) => {
    rect = clampRect(heightmap.width, heightmap.height, rect);
    const { width, height, data: srcData } = heightmap;
    const size = width * height;
    const result = {
        width,
        height,
        data: new Uint8ClampedArray(size)
    };
    const [sx, sy, sw, sh] = rect;
    for (let t = 0; t < times; t++) {
        for (let y = sy; y < sy + sh; y++) {
            for (let x = sx; x < sx + sw; x++) {
                const i = y * width + x;
                let sum = srcData[i];
                let count = 1;
                if (x > 0) {
                    const l = i - 1;
                    sum += srcData[l];
                    count++;
                }
                if (x < width - 1) {
                    const r = i + 1;
                    sum += srcData[r];
                    count++;
                }
                if (y > 0) {
                    const u = i - width;
                    sum += srcData[u];
                    count++;
                }
                if (y < height - 1) {
                    const d = i + width;
                    sum += srcData[d];
                    count++;
                }
                result.data[i] = Math.floor(sum / count);
            }
        }
    }
    return result;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2N1bHB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9oZWlnaHRtYXAvc2N1bHB0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUc1QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFFN0MsTUFBTSxDQUFDLE1BQU0sS0FBSyxHQUFHLENBQUMsU0FBb0IsRUFBRSxDQUFTLEVBQUUsQ0FBUyxFQUFFLEVBQUU7SUFDbEUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsU0FBUyxDQUFBO0lBRXpDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFBO0lBRXZCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7SUFFckIsSUFBSSxDQUFDLEdBQUcsR0FBRztRQUFFLE9BQU07SUFFbkIsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUVYLE1BQU0sS0FBSyxHQUErQixFQUFFLENBQUE7SUFFNUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFFakMsT0FBTyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDcEIsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRyxDQUFBO1FBRW5DLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksS0FBSyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ3BELFNBQVE7UUFDVixDQUFDO1FBRUQsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLEtBQUssR0FBRyxFQUFFLENB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QTtvQkFFZixHQUFHLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFBO29CQUNqQixLQUFLLEVBQUUsQ0FBQTtnQkFDVCxDQUFDO2dCQUVELElBQUksQ0FBQyxHQUFHLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztvQkFDbEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFFZixHQUFHLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFBO29CQUNqQixLQUFLLEVBQUUsQ0FBQTtnQkFDVCxDQUFDO2dCQUVELElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUNWLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUE7b0JBRW5CLEdBQUcsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQ2pCLEtBQUssRUFBRSxDQUFBO2dCQUNULENBQUM7Z0JBRUQsSUFBSSxDQUFDLEdBQUcsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUNuQixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFBO29CQUVuQixHQUFHLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFBO29CQUNqQixLQUFLLEVBQUUsQ0FBQTtnQkFDVCxDQUFDO2dCQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLENBQUE7WUFDMUMsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0lBRUQsT0FBTyxNQUFNLENBQUE7QUFDZixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjbGFtcFJlY3QgfSBmcm9tICcuLi9pbWFnZS91dGlsLmpzJ1xuaW1wb3J0IHsgVDQgfSBmcm9tICcuLi90eXBlcy5qcydcbmltcG9ydCB7IEhlaWdodG1hcCB9IGZyb20gJy4vdHlwZXMuanMnXG5pbXBvcnQgeyBlbnF1ZXVlTmVpZ2hib3VycyB9IGZyb20gJy4vdXRpbC5qcydcblxuZXhwb3J0IGNvbnN0IHJhaXNlID0gKGhlaWdodG1hcDogSGVpZ2h0bWFwLCB4OiBudW1iZXIsIHk6IG51bWJlcikgPT4ge1xuICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIGRhdGEgfSA9IGhlaWdodG1hcFxuXG4gIGNvbnN0IGkgPSB5ICogd2lkdGggKyB4XG5cbiAgY29uc3QgdiA9IGRhdGFbaV0gKyAxXG5cbiAgaWYgKHYgPiAyNTUpIHJldHVyblxuXG4gIGRhdGFbaV0gPSB2XG5cbiAgY29uc3QgcXVldWU6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXVtdID0gW11cblxuICBlbnF1ZXVlTmVpZ2hib3VycyhxdWV1ZSwgeCwgeSwgdilcblxuICB3aGlsZSAocXVldWUubGVuZ3RoKSB7XG4gICAgY29uc3QgW254LCBueSwgbnZdID0gcXVldWUuc2hpZnQoKSFcblxuICAgIGlmIChueCA8IDAgfHwgbnggPj0gd2lkdGggfHwgbnkgPCAwIHx8IG55ID49IGhlaWdodCkge1xuICAgICAgY29udGludWVcbiAgICB9XG5cbiAgICBjb25zdCBuID0gbnkgKiB3aWR0aCArIG54XG5cbiAgICBpZiAoZGF0YVtuXSA+PSBudikge1xuICAgICAgY29udGludWVcbiAgICB9XG5cbiAgICBpZiAoZGF0YVtuXSA9PT0gbnYgLSAxKSB7XG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGRhdGFbbl0gPSBudiAtIDFcblxuICAgIGVucXVldWVOZWlnaGJvdXJzKHF1ZXVlLCBueCwgbnksIG52IC0gMSlcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgbG93ZXIgPSAoaGVpZ2h0bWFwOiBIZWlnaHRtYXAsIHg6IG51bWJlciwgeTogbnVtYmVyKSA9PiB7XG4gIGNvbnN0IHsgd2lkdGgsIGhlaWdodCwgZGF0YSB9ID0gaGVpZ2h0bWFwXG5cbiAgY29uc3QgaSA9IHkgKiB3aWR0aCArIHhcblxuICBjb25zdCB2ID0gZGF0YVtpXSAtIDFcblxuICBpZiAodiA8IDApIHJldHVyblxuXG4gIGRhdGFbaV0gPSB2XG5cbiAgY29uc3QgcXVldWU6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXVtdID0gW11cblxuICBlbnF1ZXVlTmVpZ2hib3VycyhxdWV1ZSwgeCwgeSwgdilcblxuICB3aGlsZSAocXVldWUubGVuZ3RoKSB7XG4gICAgY29uc3QgW254LCBueSwgbnZdID0gcXVldWUuc2hpZnQoKSFcblxuICAgIGlmIChueCA8IDAgfHwgbnggPj0gd2lkdGggfHwgbnkgPCAwIHx8IG55ID49IGhlaWdodCkge1xuICAgICAgY29udGludWVcbiAgICB9XG5cbiAgICBjb25zdCBuID0gbnkgKiB3aWR0aCArIG54XG5cbiAgICBpZiAoZGF0YVtuXSA8PSBudikge1xuICAgICAgY29udGludWVcbiAgICB9XG5cbiAgICBpZiAoZGF0YVtuXSA9PT0gbnYgKyAxKSB7XG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGRhdGFbbl0gPSBudiArIDFcblxuICAgIGVucXVldWVOZWlnaGJvdXJzKHF1ZXVlLCBueCwgbnksIG52ICsgMSlcbiAgfVxufVxuXG5cbi8vIHJhaXNlIGV2ZXJ5IHBvaW50IGluIHJlY3QgdG8gaGlnaGVzdCB2YWx1ZSBpbiByZWN0XG5leHBvcnQgY29uc3QgcmFpc2VSZWN0ID0gKFxuICBoZWlnaHRtYXA6IEhlaWdodG1hcCwgeDogbnVtYmVyLCB5OiBudW1iZXIsIHc6IG51bWJlciwgaDogbnVtYmVyXG4pID0+IHtcbiAgbGV0IGhpZ2hlc3QgPSAwXG5cbiAgLy8gZmluZCBoaWdoZXN0IHZhbHVlIGluIHJlY3RcbiAgZm9yIChsZXQgaiA9IHk7IGogPCB5ICsgaDsgaisrKSB7XG4gICAgaWYgKGogPCAwIHx8IGogPj0gaGVpZ2h0bWFwLmhlaWdodCkgY29udGludWVcblxuICAgIGNvbnN0IHJvd1N0YXJ0ID0gaiAqIGhlaWdodG1hcC53aWR0aFxuXG4gICAgZm9yIChsZXQgaSA9IHg7IGkgPCB4ICsgdzsgaSsrKSB7XG4gICAgICBpZiAoaSA8IDAgfHwgaSA+PSBoZWlnaHRtYXAud2lkdGgpIGNvbnRpbnVlXG5cbiAgICAgIGNvbnN0IGluZGV4ID0gcm93U3RhcnQgKyBpXG5cbiAgICAgIGNvbnN0IHYgPSBoZWlnaHRtYXAuZGF0YVtpbmRleF1cblxuICAgICAgaWYgKHYgPiBoaWdoZXN0KSBoaWdoZXN0ID0gdlxuICAgIH1cbiAgfVxuXG4gIC8vIGZvciBlYWNoIHBvaW50IGluIHJlY3QgPCBoaWdoZXN0LCByYWlzZSB1bnRpbCBtYXRjaGVzIGhpZ2hlc3RcbiAgZm9yIChsZXQgaiA9IHk7IGogPCB5ICsgaDsgaisrKSB7XG4gICAgaWYgKGogPCAwIHx8IGogPj0gaGVpZ2h0bWFwLmhlaWdodCkgY29udGludWVcblxuICAgIGNvbnN0IHJvd1N0YXJ0ID0gaiAqIGhlaWdodG1hcC53aWR0aFxuXG4gICAgZm9yIChsZXQgaSA9IHg7IGkgPCB4ICsgdzsgaSsrKSB7XG4gICAgICBpZiAoaSA8IDAgfHwgaSA+PSBoZWlnaHRtYXAud2lkdGgpIGNvbnRpbnVlXG5cbiAgICAgIGNvbnN0IGluZGV4ID0gcm93U3RhcnQgKyBpXG5cbiAgICAgIGxldCB2ID0gaGVpZ2h0bWFwLmRhdGFbaW5kZXhdXG5cbiAgICAgIHdoaWxlICh2IDwgaGlnaGVzdCkge1xuICAgICAgICByYWlzZShoZWlnaHRtYXAsIGksIGopXG4gICAgICAgIHYrK1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBoaWdoZXN0XG59XG5cbi8vIGxvd2VyIGV2ZXJ5IHBvaW50IGluIHJlY3QgdG8gbG93ZXN0IHZhbHVlIGluIHJlY3RcbmV4cG9ydCBjb25zdCBsb3dlclJlY3QgPSAoXG4gIGhlaWdodG1hcDogSGVpZ2h0bWFwLCB4OiBudW1iZXIsIHk6IG51bWJlciwgdzogbnVtYmVyLCBoOiBudW1iZXJcbikgPT4ge1xuICBsZXQgbG93ZXN0ID0gMjU1XG5cbiAgLy8gZmluZCBsb3dlc3QgdmFsdWUgaW4gcmVjdFxuICBmb3IgKGxldCBqID0geTsgaiA8IHkgKyBoOyBqKyspIHtcbiAgICBpZiAoaiA8IDAgfHwgaiA+PSBoZWlnaHRtYXAuaGVpZ2h0KSBjb250aW51ZVxuXG4gICAgY29uc3Qgcm93U3RhcnQgPSBqICogaGVpZ2h0bWFwLndpZHRoXG5cbiAgICBmb3IgKGxldCBpID0geDsgaSA8IHggKyB3OyBpKyspIHtcbiAgICAgIGlmIChpIDwgMCB8fCBpID49IGhlaWdodG1hcC53aWR0aCkgY29udGludWVcblxuICAgICAgY29uc3QgaW5kZXggPSByb3dTdGFydCArIGlcblxuICAgICAgY29uc3QgdiA9IGhlaWdodG1hcC5kYXRhW2luZGV4XVxuXG4gICAgICBpZiAodiA8IGxvd2VzdCkgbG93ZXN0ID0gdlxuICAgIH1cbiAgfVxuXG4gIC8vIGZvciBlYWNoIHBvaW50IGluIHJlY3QgPiBsb3dlc3QsIGxvd2VyIHVudGlsIG1hdGNoZXMgbG93ZXN0XG4gIGZvciAobGV0IGogPSB5OyBqIDwgeSArIGg7IGorKykge1xuICAgIGlmIChqIDwgMCB8fCBqID49IGhlaWdodG1hcC5oZWlnaHQpIGNvbnRpbnVlXG5cbiAgICBjb25zdCByb3dTdGFydCA9IGogKiBoZWlnaHRtYXAud2lkdGhcblxuICAgIGZvciAobGV0IGkgPSB4OyBpIDwgeCArIHc7IGkrKykge1xuICAgICAgaWYgKGkgPCAwIHx8IGkgPj0gaGVpZ2h0bWFwLndpZHRoKSBjb250aW51ZVxuXG4gICAgICBjb25zdCBpbmRleCA9IHJvd1N0YXJ0ICsgaVxuXG4gICAgICBsZXQgdiA9IGhlaWdodG1hcC5kYXRhW2luZGV4XVxuXG4gICAgICB3aGlsZSAodiA+IGxvd2VzdCkge1xuICAgICAgICBsb3dlcihoZWlnaHRtYXAsIGksIGopXG4gICAgICAgIHYtLVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBsb3dlc3Rcbn1cblxuLy8gYXZlcmFnZSB0aGUgdmFsdWVzIGluIHRoZSByZWN0LCB0aGVuIHJhaXNlIG9yIGxvd2VyIGVhY2ggcG9pbnQgdG8gbWF0Y2hcbmV4cG9ydCBjb25zdCBmbGF0dGVuUmVjdCA9IChcbiAgaGVpZ2h0bWFwOiBIZWlnaHRtYXAsIHg6IG51bWJlciwgeTogbnVtYmVyLCB3OiBudW1iZXIsIGg6IG51bWJlclxuKSA9PiB7XG4gIGxldCBzdW0gPSAwXG4gIGxldCBjb3VudCA9IDBcblxuICAvLyBzdW0gdmFsdWVzIGluIHJlY3RcbiAgZm9yIChsZXQgaiA9IHk7IGogPCB5ICsgaDsgaisrKSB7XG4gICAgaWYgKGogPCAwIHx8IGogPj0gaGVpZ2h0bWFwLmhlaWdodCkgY29udGludWVcblxuICAgIGNvbnN0IHJvd1N0YXJ0ID0gaiAqIGhlaWdodG1hcC53aWR0aFxuXG4gICAgZm9yIChsZXQgaSA9IHg7IGkgPCB4ICsgdzsgaSsrKSB7XG4gICAgICBpZiAoaSA8IDAgfHwgaSA+PSBoZWlnaHRtYXAud2lkdGgpIGNvbnRpbnVlXG5cbiAgICAgIGNvbnN0IGluZGV4ID0gcm93U3RhcnQgKyBpXG5cbiAgICAgIHN1bSArPSBoZWlnaHRtYXAuZGF0YVtpbmRleF1cbiAgICAgIGNvdW50KytcbiAgICB9XG4gIH1cblxuICBjb25zdCBhdmcgPSBNYXRoLmZsb29yKHN1bSAvIGNvdW50KVxuXG4gIC8vIGZvciBlYWNoIHBvaW50IGluIHJlY3QsIHJhaXNlIG9yIGxvd2VyIHRvIG1hdGNoIGF2Z1xuICBmb3IgKGxldCBqID0geTsgaiA8IHkgKyBoOyBqKyspIHtcbiAgICBpZiAoaiA8IDAgfHwgaiA+PSBoZWlnaHRtYXAuaGVpZ2h0KSBjb250aW51ZVxuXG4gICAgY29uc3Qgcm93U3RhcnQgPSBqICogaGVpZ2h0bWFwLndpZHRoXG5cbiAgICBmb3IgKGxldCBpID0geDsgaSA8IHggKyB3OyBpKyspIHtcbiAgICAgIGlmIChpIDwgMCB8fCBpID49IGhlaWdodG1hcC53aWR0aCkgY29udGludWVcblxuICAgICAgY29uc3QgaW5kZXggPSByb3dTdGFydCArIGlcblxuICAgICAgbGV0IHYgPSBoZWlnaHRtYXAuZGF0YVtpbmRleF1cblxuICAgICAgd2hpbGUgKHYgPCBhdmcpIHtcbiAgICAgICAgcmFpc2UoaGVpZ2h0bWFwLCBpLCBqKVxuICAgICAgICB2KytcbiAgICAgIH1cbiAgICAgIHdoaWxlICh2ID4gYXZnKSB7XG4gICAgICAgIGxvd2VyKGhlaWdodG1hcCwgaSwgailcbiAgICAgICAgdi0tXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGF2Z1xufVxuXG5leHBvcnQgY29uc3Qgc21vb3RoID0gKFxuICBoZWlnaHRtYXA6IEhlaWdodG1hcCxcbiAgcmVjdDogVDQsXG4gIHRpbWVzOiBudW1iZXJcbikgPT4ge1xuICByZWN0ID0gY2xhbXBSZWN0KGhlaWdodG1hcC53aWR0aCwgaGVpZ2h0bWFwLmhlaWdodCwgcmVjdClcblxuICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIGRhdGE6IHNyY0RhdGEgfSA9IGhlaWdodG1hcFxuXG4gIGNvbnN0IHNpemUgPSB3aWR0aCAqIGhlaWdodFxuXG4gIGNvbnN0IHJlc3VsdDogSGVpZ2h0bWFwID0ge1xuICAgIHdpZHRoLFxuICAgIGhlaWdodCxcbiAgICBkYXRhOiBuZXcgVWludDhDbGFtcGVkQXJyYXkoc2l6ZSlcbiAgfVxuXG4gIGNvbnN0IFtzeCwgc3ksIHN3LCBzaF0gPSByZWN0XG5cbiAgZm9yIChsZXQgdCA9IDA7IHQgPCB0aW1lczsgdCsrKSB7XG4gICAgZm9yIChsZXQgeSA9IHN5OyB5IDwgc3kgKyBzaDsgeSsrKSB7XG4gICAgICBmb3IgKGxldCB4ID0gc3g7IHggPCBzeCArIHN3OyB4KyspIHtcbiAgICAgICAgY29uc3QgaSA9IHkgKiB3aWR0aCArIHhcblxuICAgICAgICBsZXQgc3VtID0gc3JjRGF0YVtpXVxuICAgICAgICBsZXQgY291bnQgPSAxXG5cbiAgICAgICAgaWYgKHggPiAwKSB7XG4gICAgICAgICAgY29uc3QgbCA9IGkgLSAxXG5cbiAgICAgICAgICBzdW0gKz0gc3JjRGF0YVtsXVxuICAgICAgICAgIGNvdW50KytcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh4IDwgd2lkdGggLSAxKSB7XG4gICAgICAgICAgY29uc3QgciA9IGkgKyAxXG5cbiAgICAgICAgICBzdW0gKz0gc3JjRGF0YVtyXVxuICAgICAgICAgIGNvdW50KytcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh5ID4gMCkge1xuICAgICAgICAgIGNvbnN0IHUgPSBpIC0gd2lkdGhcblxuICAgICAgICAgIHN1bSArPSBzcmNEYXRhW3VdXG4gICAgICAgICAgY291bnQrK1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHkgPCBoZWlnaHQgLSAxKSB7XG4gICAgICAgICAgY29uc3QgZCA9IGkgKyB3aWR0aFxuXG4gICAgICAgICAgc3VtICs9IHNyY0RhdGFbZF1cbiAgICAgICAgICBjb3VudCsrXG4gICAgICAgIH1cblxuICAgICAgICByZXN1bHQuZGF0YVtpXSA9IE1hdGguZmxvb3Ioc3VtIC8gY291bnQpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdFxufVxuIl19
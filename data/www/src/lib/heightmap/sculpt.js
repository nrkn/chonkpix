import { clampRect } from '../image/util.js';
import { enqueueNeighbours } from './util.js';
// excl max
const MAX_U8 = 256;
const MAX_U16 = 65536;
const MAX_I16 = 32768;
// incl min
const MIN_U8 = 0;
const MIN_U16 = 0;
const MIN_I16 = -32768;
export const raiseHmPt = (heightmap, x, y, max = MAX_U8) => {
    const { width, height, data } = heightmap;
    const i = y * width + x;
    const v = data[i] + 1;
    if (v >= max)
        return;
    data[i] = v;
    const queue = [];
    enqueueNeighbours(queue, x, y, v);
    while (queue.length) {
        const [nx, ny, nv] = queue.shift();
        if (nx < 0 || nx >= width || ny < 0 || ny >= height) {
            continue;
        }
        const n = ny * width + nx;
        if (data[n] >= nv) {
            continue;
        }
        if (data[n] === nv - 1) {
            continue;
        }
        data[n] = nv - 1;
        enqueueNeighbours(queue, nx, ny, nv - 1);
    }
};
export const raiseHmPtU16 = (heightmap, x, y, max = MAX_U16) => raiseHmPt(heightmap, x, y, max);
export const raiseHmPtI16 = (heightmap, x, y, max = MAX_I16) => raiseHmPt(heightmap, x, y, max);
export const lowerHmPt = (heightmap, x, y, min = MIN_U8) => {
    const { width, height, data } = heightmap;
    const i = y * width + x;
    const v = data[i] - 1;
    if (v < min)
        return;
    data[i] = v;
    const queue = [];
    enqueueNeighbours(queue, x, y, v);
    while (queue.length) {
        const [nx, ny, nv] = queue.shift();
        if (nx < 0 || nx >= width || ny < 0 || ny >= height) {
            continue;
        }
        const n = ny * width + nx;
        if (data[n] <= nv) {
            continue;
        }
        if (data[n] === nv + 1) {
            continue;
        }
        data[n] = nv + 1;
        enqueueNeighbours(queue, nx, ny, nv + 1);
    }
};
export const lowerHmPtU16 = (heightmap, x, y, min = MIN_U16) => lowerHmPt(heightmap, x, y, min);
export const lowerHmPtI16 = (heightmap, x, y, min = MIN_I16) => lowerHmPt(heightmap, x, y, min);
// raise every point in rect to highest value in rect
export const raiseHmRect = (heightmap, x, y, w, h, max = MAX_U8) => {
    let highest = Number.NEGATIVE_INFINITY;
    // find highest value in rect
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            const v = heightmap.data[index];
            if (v > highest)
                highest = v;
        }
    }
    // for each point in rect < highest, raise until matches highest
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            let v = heightmap.data[index];
            while (v < highest) {
                raiseHmPt(heightmap, i, j, max);
                v++;
            }
        }
    }
    return highest;
};
export const raiseHmRectU16 = (heightmap, x, y, w, h, max = MAX_U16) => raiseHmRect(heightmap, x, y, w, h, max);
export const raiseHmRectI16 = (heightmap, x, y, w, h, max = MAX_I16) => raiseHmRect(heightmap, x, y, w, h, max);
// lower every point in rect to lowest value in rect
export const lowerHmRect = (heightmap, x, y, w, h, min = MIN_U8) => {
    let lowest = Number.POSITIVE_INFINITY;
    // find lowest value in rect
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            const v = heightmap.data[index];
            if (v < lowest)
                lowest = v;
        }
    }
    // for each point in rect > lowest, lower until matches lowest
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            let v = heightmap.data[index];
            while (v > lowest) {
                lowerHmPt(heightmap, i, j, min);
                v--;
            }
        }
    }
    return lowest;
};
export const lowerHmRectU16 = (heightmap, x, y, w, h, min = MIN_U16) => lowerHmRect(heightmap, x, y, w, h, min);
export const lowerHmRectI16 = (heightmap, x, y, w, h, min = MIN_I16) => lowerHmRect(heightmap, x, y, w, h, min);
// average the values in the rect, then raise or lower each point to match
export const flattenHmRect = (heightmap, x, y, w, h, min = MIN_U8, max = MAX_U8) => {
    let sum = 0;
    let count = 0;
    // sum values in rect
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            sum += heightmap.data[index];
            count++;
        }
    }
    const avg = Math.floor(sum / count);
    // for each point in rect, raise or lower to match avg
    for (let j = y; j < y + h; j++) {
        if (j < 0 || j >= heightmap.height)
            continue;
        const rowStart = j * heightmap.width;
        for (let i = x; i < x + w; i++) {
            if (i < 0 || i >= heightmap.width)
                continue;
            const index = rowStart + i;
            let v = heightmap.data[index];
            while (v < avg) {
                raiseHmPt(heightmap, i, j, max);
                v++;
            }
            while (v > avg) {
                lowerHmPt(heightmap, i, j, min);
                v--;
            }
        }
    }
    return avg;
};
export const flattenHmRectU16 = (heightmap, x, y, w, h, min = MIN_U16, max = MAX_U16) => flattenHmRect(heightmap, x, y, w, h, min, max);
export const flattenHmRectI16 = (heightmap, x, y, w, h, min = MIN_I16, max = MAX_I16) => flattenHmRect(heightmap, x, y, w, h, min, max);
export const smoothHmU8C = (heightmap, rect, times) => {
    rect = clampRect(heightmap.width, heightmap.height, rect);
    const { width, height, data: srcData } = heightmap;
    const size = width * height;
    const result = {
        width,
        height,
        data: new Uint8ClampedArray(size)
    };
    const [sx, sy, sw, sh] = rect;
    for (let t = 0; t < times; t++) {
        for (let y = sy; y < sy + sh; y++) {
            for (let x = sx; x < sx + sw; x++) {
                const i = y * width + x;
                let sum = srcData[i];
                let count = 1;
                if (x > 0) {
                    const l = i - 1;
                    sum += srcData[l];
                    count++;
                }
                if (x < width - 1) {
                    const r = i + 1;
                    sum += srcData[r];
                    count++;
                }
                if (y > 0) {
                    const u = i - width;
                    sum += srcData[u];
                    count++;
                }
                if (y < height - 1) {
                    const d = i + width;
                    sum += srcData[d];
                    count++;
                }
                result.data[i] = Math.floor(sum / count);
            }
        }
    }
    return result;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2N1bHB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9oZWlnaHRtYXAvc2N1bHB0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUc1QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFFN0MsV0FBVztBQUNYLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQTtBQUNsQixNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUE7QUFDckIsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFBO0FBRXJCLFdBQVc7QUFDWCxNQUFNLE1BQU0sR0FBRyxDQUFDLENBQUE7QUFDaEIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxDQUFBO0FBQ2pCLE1BQU0sT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFBO0FBRXRCLE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBRyxDQUN2QixTQUF1QixFQUFFLENBQVMsRUFBRSxDQUFTLEVBQUUsR0FBRyxHQUFHLE1BQU0sRUFDM0QsRUFBRTtJQUNGLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLFNBQVMsQ0FBQTtJQUV6QyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQTtJQUV2QixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBRXJCLElBQUksQ0FBQyxJQUFJLEdBQUc7UUFBRSxPQUFNO0lBRXBCLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7SUFFWCxNQUFNLEtBQUssR0FBK0IsRUFBRSxDQUFBO0lBRTVDLGlCQUFpQixDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBRWpDLE9BQU8sS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3BCLE1B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QUcsQ0FBQyxHQUFHLEtBQUssQ0FBQTtvQkFFbkIsR0FBRyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtvQkFDakIsS0FBSyxFQUFFLENBQUE7Z0JBQ1QsQ0FBQztnQkFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFBO1lBQzFDLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVELE9BQU8sTUFBTSxDQUFBO0FBQ2YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY2xhbXBSZWN0IH0gZnJvbSAnLi4vaW1hZ2UvdXRpbC5qcydcclxuaW1wb3J0IHsgVDQgfSBmcm9tICcuLi90eXBlcy5qcydcclxuaW1wb3J0IHsgSGVpZ2h0bWFwLCBIZWlnaHRtYXBBbnkgfSBmcm9tICcuL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyBlbnF1ZXVlTmVpZ2hib3VycyB9IGZyb20gJy4vdXRpbC5qcydcclxuXHJcbi8vIGV4Y2wgbWF4XHJcbmNvbnN0IE1BWF9VOCA9IDI1NlxyXG5jb25zdCBNQVhfVTE2ID0gNjU1MzZcclxuY29uc3QgTUFYX0kxNiA9IDMyNzY4XHJcblxyXG4vLyBpbmNsIG1pblxyXG5jb25zdCBNSU5fVTggPSAwXHJcbmNvbnN0IE1JTl9VMTYgPSAwXHJcbmNvbnN0IE1JTl9JMTYgPSAtMzI3NjhcclxuXHJcbmV4cG9ydCBjb25zdCByYWlzZUhtUHQgPSAoXHJcbiAgaGVpZ2h0bWFwOiBIZWlnaHRtYXBBbnksIHg6IG51bWJlciwgeTogbnVtYmVyLCBtYXggPSBNQVhfVThcclxuKSA9PiB7XHJcbiAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0LCBkYXRhIH0gPSBoZWlnaHRtYXBcclxuXHJcbiAgY29uc3QgaSA9IHkgKiB3aWR0aCArIHhcclxuXHJcbiAgY29uc3QgdiA9IGRhdGFbaV0gKyAxXHJcblxyXG4gIGlmICh2ID49IG1heCkgcmV0dXJuXHJcblxyXG4gIGRhdGFbaV0gPSB2XHJcblxyXG4gIGNvbnN0IHF1ZXVlOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl1bXSA9IFtdXHJcblxyXG4gIGVucXVldWVOZWlnaGJvdXJzKHF1ZXVlLCB4LCB5LCB2KVxyXG5cclxuICB3aGlsZSAocXVldWUubGVuZ3RoKSB7XHJcbiAgICBjb25zdCBbbngsIG55LCBudl0gPSBxdWV1ZS5zaGlmdCgpIVxyXG5cclxuICAgIGlmIChueCA8IDAgfHwgbnggPj0gd2lkdGggfHwgbnkgPCAwIHx8IG55ID49IGhlaWdodCkge1xyXG4gICAgICBjb250aW51ZVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG4gPSBueSAqIHdpZHRoICsgbnhcclxuXHJcbiAgICBpZiAoZGF0YVtuXSA+PSBudikge1xyXG4gICAgICBjb250aW51ZVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChkYXRhW25dID09PSBudiAtIDEpIHtcclxuICAgICAgY29udGludWVcclxuICAgIH1cclxuXHJcbiAgICBkYXRhW25dID0gbnYgLSAxXHJcblxyXG4gICAgZW5xdWV1ZU5laWdoYm91cnMocXVldWUsIG54LCBueSwgbnYgLSAxKVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHJhaXNlSG1QdFUxNiA9IChcclxuICBoZWlnaHRtYXA6IEhlaWdodG1hcDxVaW50MTZBcnJheT4sIHg6IG51bWJlciwgeTogbnVtYmVyLCBtYXggPSBNQVhfVTE2XHJcbikgPT4gcmFpc2VIbVB0KGhlaWdodG1hcCwgeCwgeSwgbWF4KVxyXG5cclxuZXhwb3J0IGNvbnN0IHJhaXNlSG1QdEkxNiA9IChcclxuICBoZWlnaHRtYXA6IEhlaWdodG1hcDxJbnQxNkFycmF5PiwgeDogbnVtYmVyLCB5OiBudW1iZXIsIG1heCA9IE1BWF9JMTZcclxuKSA9PiByYWlzZUhtUHQoaGVpZ2h0bWFwLCB4LCB5LCBtYXgpXHJcblxyXG5leHBvcnQgY29uc3QgbG93ZXJIbVB0ID0gKFxyXG4gIGhlaWdodG1hcDogSGVpZ2h0bWFwQW55LCB4OiBudW1iZXIsIHk6IG51bWJlciwgbWluID0gTUlOX1U4XHJcbikgPT4ge1xyXG4gIGNvbnN0IHsgd2lkdGgsIGhlaWdodCwgZGF0YSB9ID0gaGVpZ2h0bWFwXHJcblxyXG4gIGNvbnN0IGkgPSB5ICogd2lkdGggKyB4XHJcblxyXG4gIGNvbnN0IHYgPSBkYXRhW2ldIC0gMVxyXG5cclxuICBpZiAodiA8IG1pbikgcmV0dXJuXHJcblxyXG4gIGRhdGFbaV0gPSB2XHJcblxyXG4gIGNvbnN0IHF1ZXVlOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl1bXSA9IFtdXHJcblxyXG4gIGVucXVldWVOZWlnaGJvdXJzKHF1ZXVlLCB4LCB5LCB2KVxyXG5cclxuICB3aGlsZSAocXVldWUubGVuZ3RoKSB7XHJcbiAgICBjb25zdCBbbngsIG55LCBudl0gPSBxdWV1ZS5zaGlmdCgpIVxyXG5cclxuICAgIGlmIChueCA8IDAgfHwgbnggPj0gd2lkdGggfHwgbnkgPCAwIHx8IG55ID49IGhlaWdodCkge1xyXG4gICAgICBjb250aW51ZVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG4gPSBueSAqIHdpZHRoICsgbnhcclxuXHJcbiAgICBpZiAoZGF0YVtuXSA8PSBudikge1xyXG4gICAgICBjb250aW51ZVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChkYXRhW25dID09PSBudiArIDEpIHtcclxuICAgICAgY29udGludWVcclxuICAgIH1cclxuXHJcbiAgICBkYXRhW25dID0gbnYgKyAxXHJcblxyXG4gICAgZW5xdWV1ZU5laWdoYm91cnMocXVldWUsIG54LCBueSwgbnYgKyAxKVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGxvd2VySG1QdFUxNiA9IChcclxuICBoZWlnaHRtYXA6IEhlaWdodG1hcDxVaW50MTZBcnJheT4sIHg6IG51bWJlciwgeTogbnVtYmVyLCBtaW4gPSBNSU5fVTE2XHJcbikgPT4gbG93ZXJIbVB0KGhlaWdodG1hcCwgeCwgeSwgbWluKVxyXG5cclxuZXhwb3J0IGNvbnN0IGxvd2VySG1QdEkxNiA9IChcclxuICBoZWlnaHRtYXA6IEhlaWdodG1hcDxJbnQxNkFycmF5PiwgeDogbnVtYmVyLCB5OiBudW1iZXIsIG1pbiA9IE1JTl9JMTZcclxuKSA9PiBsb3dlckhtUHQoaGVpZ2h0bWFwLCB4LCB5LCBtaW4pXHJcblxyXG4vLyByYWlzZSBldmVyeSBwb2ludCBpbiByZWN0IHRvIGhpZ2hlc3QgdmFsdWUgaW4gcmVjdFxyXG5leHBvcnQgY29uc3QgcmFpc2VIbVJlY3QgPSAoXHJcbiAgaGVpZ2h0bWFwOiBIZWlnaHRtYXBBbnksIHg6IG51bWJlciwgeTogbnVtYmVyLCB3OiBudW1iZXIsIGg6IG51bWJlcixcclxuICBtYXggPSBNQVhfVThcclxuKSA9PiB7XHJcbiAgbGV0IGhpZ2hlc3QgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFlcclxuXHJcbiAgLy8gZmluZCBoaWdoZXN0IHZhbHVlIGluIHJlY3RcclxuICBmb3IgKGxldCBqID0geTsgaiA8IHkgKyBoOyBqKyspIHtcclxuICAgIGlmIChqIDwgMCB8fCBqID49IGhlaWdodG1hcC5oZWlnaHQpIGNvbnRpbnVlXHJcblxyXG4gICAgY29uc3Qgcm93U3RhcnQgPSBqICogaGVpZ2h0bWFwLndpZHRoXHJcblxyXG4gICAgZm9yIChsZXQgaSA9IHg7IGkgPCB4ICsgdzsgaSsrKSB7XHJcbiAgICAgIGlmIChpIDwgMCB8fCBpID49IGhlaWdodG1hcC53aWR0aCkgY29udGludWVcclxuXHJcbiAgICAgIGNvbnN0IGluZGV4ID0gcm93U3RhcnQgKyBpXHJcblxyXG4gICAgICBjb25zdCB2ID0gaGVpZ2h0bWFwLmRhdGFbaW5kZXhdXHJcblxyXG4gICAgICBpZiAodiA+IGhpZ2hlc3QpIGhpZ2hlc3QgPSB2XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBmb3IgZWFjaCBwb2ludCBpbiByZWN0IDwgaGlnaGVzdCwgcmFpc2UgdW50aWwgbWF0Y2hlcyBoaWdoZXN0XHJcbiAgZm9yIChsZXQgaiA9IHk7IGogPCB5ICsgaDsgaisrKSB7XHJcbiAgICBpZiAoaiA8IDAgfHwgaiA+PSBoZWlnaHRtYXAuaGVpZ2h0KSBjb250aW51ZVxyXG5cclxuICAgIGNvbnN0IHJvd1N0YXJ0ID0gaiAqIGhlaWdodG1hcC53aWR0aFxyXG5cclxuICAgIGZvciAobGV0IGkgPSB4OyBpIDwgeCArIHc7IGkrKykge1xyXG4gICAgICBpZiAoaSA8IDAgfHwgaSA+PSBoZWlnaHRtYXAud2lkdGgpIGNvbnRpbnVlXHJcblxyXG4gICAgICBjb25zdCBpbmRleCA9IHJvd1N0YXJ0ICsgaVxyXG5cclxuICAgICAgbGV0IHYgPSBoZWlnaHRtYXAuZGF0YVtpbmRleF1cclxuXHJcbiAgICAgIHdoaWxlICh2IDwgaGlnaGVzdCkge1xyXG4gICAgICAgIHJhaXNlSG1QdChoZWlnaHRtYXAsIGksIGosIG1heClcclxuICAgICAgICB2KytcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGhpZ2hlc3RcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHJhaXNlSG1SZWN0VTE2ID0gKFxyXG4gIGhlaWdodG1hcDogSGVpZ2h0bWFwPFVpbnQxNkFycmF5PiwgeDogbnVtYmVyLCB5OiBudW1iZXIsIHc6IG51bWJlciwgaDogbnVtYmVyLFxyXG4gIG1heCA9IE1BWF9VMTZcclxuKSA9PiByYWlzZUhtUmVjdChoZWlnaHRtYXAsIHgsIHksIHcsIGgsIG1heClcclxuXHJcbmV4cG9ydCBjb25zdCByYWlzZUhtUmVjdEkxNiA9IChcclxuICBoZWlnaHRtYXA6IEhlaWdodG1hcDxJbnQxNkFycmF5PiwgeDogbnVtYmVyLCB5OiBudW1iZXIsIHc6IG51bWJlciwgaDogbnVtYmVyLFxyXG4gIG1heCA9IE1BWF9JMTZcclxuKSA9PiByYWlzZUhtUmVjdChoZWlnaHRtYXAsIHgsIHksIHcsIGgsIG1heClcclxuXHJcbi8vIGxvd2VyIGV2ZXJ5IHBvaW50IGluIHJlY3QgdG8gbG93ZXN0IHZhbHVlIGluIHJlY3RcclxuZXhwb3J0IGNvbnN0IGxvd2VySG1SZWN0ID0gKFxyXG4gIGhlaWdodG1hcDogSGVpZ2h0bWFwQW55LCB4OiBudW1iZXIsIHk6IG51bWJlciwgdzogbnVtYmVyLCBoOiBudW1iZXIsXHJcbiAgbWluID0gTUlOX1U4XHJcbikgPT4ge1xyXG4gIGxldCBsb3dlc3QgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFlcclxuXHJcbiAgLy8gZmluZCBsb3dlc3QgdmFsdWUgaW4gcmVjdFxyXG4gIGZvciAobGV0IGogPSB5OyBqIDwgeSArIGg7IGorKykge1xyXG4gICAgaWYgKGogPCAwIHx8IGogPj0gaGVpZ2h0bWFwLmhlaWdodCkgY29udGludWVcclxuXHJcbiAgICBjb25zdCByb3dTdGFydCA9IGogKiBoZWlnaHRtYXAud2lkdGhcclxuXHJcbiAgICBmb3IgKGxldCBpID0geDsgaSA8IHggKyB3OyBpKyspIHtcclxuICAgICAgaWYgKGkgPCAwIHx8IGkgPj0gaGVpZ2h0bWFwLndpZHRoKSBjb250aW51ZVxyXG5cclxuICAgICAgY29uc3QgaW5kZXggPSByb3dTdGFydCArIGlcclxuXHJcbiAgICAgIGNvbnN0IHYgPSBoZWlnaHRtYXAuZGF0YVtpbmRleF1cclxuXHJcbiAgICAgIGlmICh2IDwgbG93ZXN0KSBsb3dlc3QgPSB2XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBmb3IgZWFjaCBwb2ludCBpbiByZWN0ID4gbG93ZXN0LCBsb3dlciB1bnRpbCBtYXRjaGVzIGxvd2VzdFxyXG4gIGZvciAobGV0IGogPSB5OyBqIDwgeSArIGg7IGorKykge1xyXG4gICAgaWYgKGogPCAwIHx8IGogPj0gaGVpZ2h0bWFwLmhlaWdodCkgY29udGludWVcclxuXHJcbiAgICBjb25zdCByb3dTdGFydCA9IGogKiBoZWlnaHRtYXAud2lkdGhcclxuXHJcbiAgICBmb3IgKGxldCBpID0geDsgaSA8IHggKyB3OyBpKyspIHtcclxuICAgICAgaWYgKGkgPCAwIHx8IGkgPj0gaGVpZ2h0bWFwLndpZHRoKSBjb250aW51ZVxyXG5cclxuICAgICAgY29uc3QgaW5kZXggPSByb3dTdGFydCArIGlcclxuXHJcbiAgICAgIGxldCB2ID0gaGVpZ2h0bWFwLmRhdGFbaW5kZXhdXHJcblxyXG4gICAgICB3aGlsZSAodiA+IGxvd2VzdCkge1xyXG4gICAgICAgIGxvd2VySG1QdChoZWlnaHRtYXAsIGksIGosIG1pbilcclxuICAgICAgICB2LS1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGxvd2VzdFxyXG59XHJcblxyXG5leHBvcnQgY29uc3QgbG93ZXJIbVJlY3RVMTYgPSAoXHJcbiAgaGVpZ2h0bWFwOiBIZWlnaHRtYXA8VWludDE2QXJyYXk+LCB4OiBudW1iZXIsIHk6IG51bWJlciwgdzogbnVtYmVyLCBoOiBudW1iZXIsXHJcbiAgbWluID0gTUlOX1UxNlxyXG4pID0+IGxvd2VySG1SZWN0KGhlaWdodG1hcCwgeCwgeSwgdywgaCwgbWluKVxyXG5cclxuZXhwb3J0IGNvbnN0IGxvd2VySG1SZWN0STE2ID0gKFxyXG4gIGhlaWdodG1hcDogSGVpZ2h0bWFwPEludDE2QXJyYXk+LCB4OiBudW1iZXIsIHk6IG51bWJlciwgdzogbnVtYmVyLCBoOiBudW1iZXIsXHJcbiAgbWluID0gTUlOX0kxNlxyXG4pID0+IGxvd2VySG1SZWN0KGhlaWdodG1hcCwgeCwgeSwgdywgaCwgbWluKVxyXG5cclxuLy8gYXZlcmFnZSB0aGUgdmFsdWVzIGluIHRoZSByZWN0LCB0aGVuIHJhaXNlIG9yIGxvd2VyIGVhY2ggcG9pbnQgdG8gbWF0Y2hcclxuZXhwb3J0IGNvbnN0IGZsYXR0ZW5IbVJlY3QgPSAoXHJcbiAgaGVpZ2h0bWFwOiBIZWlnaHRtYXBBbnksIHg6IG51bWJlciwgeTogbnVtYmVyLCB3OiBudW1iZXIsIGg6IG51bWJlcixcclxuICBtaW4gPSBNSU5fVTgsIG1heCA9IE1BWF9VOFxyXG4pID0+IHtcclxuICBsZXQgc3VtID0gMFxyXG4gIGxldCBjb3VudCA9IDBcclxuXHJcbiAgLy8gc3VtIHZhbHVlcyBpbiByZWN0XHJcbiAgZm9yIChsZXQgaiA9IHk7IGogPCB5ICsgaDsgaisrKSB7XHJcbiAgICBpZiAoaiA8IDAgfHwgaiA+PSBoZWlnaHRtYXAuaGVpZ2h0KSBjb250aW51ZVxyXG5cclxuICAgIGNvbnN0IHJvd1N0YXJ0ID0gaiAqIGhlaWdodG1hcC53aWR0aFxyXG5cclxuICAgIGZvciAobGV0IGkgPSB4OyBpIDwgeCArIHc7IGkrKykge1xyXG4gICAgICBpZiAoaSA8IDAgfHwgaSA+PSBoZWlnaHRtYXAud2lkdGgpIGNvbnRpbnVlXHJcblxyXG4gICAgICBjb25zdCBpbmRleCA9IHJvd1N0YXJ0ICsgaVxyXG5cclxuICAgICAgc3VtICs9IGhlaWdodG1hcC5kYXRhW2luZGV4XVxyXG4gICAgICBjb3VudCsrXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCBhdmcgPSBNYXRoLmZsb29yKHN1bSAvIGNvdW50KVxyXG5cclxuICAvLyBmb3IgZWFjaCBwb2ludCBpbiByZWN0LCByYWlzZSBvciBsb3dlciB0byBtYXRjaCBhdmdcclxuICBmb3IgKGxldCBqID0geTsgaiA8IHkgKyBoOyBqKyspIHtcclxuICAgIGlmIChqIDwgMCB8fCBqID49IGhlaWdodG1hcC5oZWlnaHQpIGNvbnRpbnVlXHJcblxyXG4gICAgY29uc3Qgcm93U3RhcnQgPSBqICogaGVpZ2h0bWFwLndpZHRoXHJcblxyXG4gICAgZm9yIChsZXQgaSA9IHg7IGkgPCB4ICsgdzsgaSsrKSB7XHJcbiAgICAgIGlmIChpIDwgMCB8fCBpID49IGhlaWdodG1hcC53aWR0aCkgY29udGludWVcclxuXHJcbiAgICAgIGNvbnN0IGluZGV4ID0gcm93U3RhcnQgKyBpXHJcblxyXG4gICAgICBsZXQgdiA9IGhlaWdodG1hcC5kYXRhW2luZGV4XVxyXG5cclxuICAgICAgd2hpbGUgKHYgPCBhdmcpIHtcclxuICAgICAgICByYWlzZUhtUHQoaGVpZ2h0bWFwLCBpLCBqLCBtYXgpXHJcbiAgICAgICAgdisrXHJcbiAgICAgIH1cclxuICAgICAgd2hpbGUgKHYgPiBhdmcpIHtcclxuICAgICAgICBsb3dlckhtUHQoaGVpZ2h0bWFwLCBpLCBqLCBtaW4pXHJcbiAgICAgICAgdi0tXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBhdmdcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGZsYXR0ZW5IbVJlY3RVMTYgPSAoXHJcbiAgaGVpZ2h0bWFwOiBIZWlnaHRtYXA8VWludDE2QXJyYXk+LCB4OiBudW1iZXIsIHk6IG51bWJlciwgdzogbnVtYmVyLCBoOiBudW1iZXIsXHJcbiAgbWluID0gTUlOX1UxNiwgbWF4ID0gTUFYX1UxNlxyXG4pID0+IGZsYXR0ZW5IbVJlY3QoaGVpZ2h0bWFwLCB4LCB5LCB3LCBoLCBtaW4sIG1heClcclxuXHJcbmV4cG9ydCBjb25zdCBmbGF0dGVuSG1SZWN0STE2ID0gKFxyXG4gIGhlaWdodG1hcDogSGVpZ2h0bWFwPEludDE2QXJyYXk+LCB4OiBudW1iZXIsIHk6IG51bWJlciwgdzogbnVtYmVyLCBoOiBudW1iZXIsXHJcbiAgbWluID0gTUlOX0kxNiwgbWF4ID0gTUFYX0kxNlxyXG4pID0+IGZsYXR0ZW5IbVJlY3QoaGVpZ2h0bWFwLCB4LCB5LCB3LCBoLCBtaW4sIG1heClcclxuXHJcbmV4cG9ydCBjb25zdCBzbW9vdGhIbVU4QyA9IChcclxuICBoZWlnaHRtYXA6IEhlaWdodG1hcCxcclxuICByZWN0OiBUNCxcclxuICB0aW1lczogbnVtYmVyXHJcbikgPT4ge1xyXG4gIHJlY3QgPSBjbGFtcFJlY3QoaGVpZ2h0bWFwLndpZHRoLCBoZWlnaHRtYXAuaGVpZ2h0LCByZWN0KVxyXG5cclxuICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIGRhdGE6IHNyY0RhdGEgfSA9IGhlaWdodG1hcFxyXG5cclxuICBjb25zdCBzaXplID0gd2lkdGggKiBoZWlnaHRcclxuXHJcbiAgY29uc3QgcmVzdWx0OiBIZWlnaHRtYXAgPSB7XHJcbiAgICB3aWR0aCxcclxuICAgIGhlaWdodCxcclxuICAgIGRhdGE6IG5ldyBVaW50OENsYW1wZWRBcnJheShzaXplKVxyXG4gIH1cclxuXHJcbiAgY29uc3QgW3N4LCBzeSwgc3csIHNoXSA9IHJlY3RcclxuXHJcbiAgZm9yIChsZXQgdCA9IDA7IHQgPCB0aW1lczsgdCsrKSB7XHJcbiAgICBmb3IgKGxldCB5ID0gc3k7IHkgPCBzeSArIHNoOyB5KyspIHtcclxuICAgICAgZm9yIChsZXQgeCA9IHN4OyB4IDwgc3ggKyBzdzsgeCsrKSB7XHJcbiAgICAgICAgY29uc3QgaSA9IHkgKiB3aWR0aCArIHhcclxuXHJcbiAgICAgICAgbGV0IHN1bSA9IHNyY0RhdGFbaV1cclxuICAgICAgICBsZXQgY291bnQgPSAxXHJcblxyXG4gICAgICAgIGlmICh4ID4gMCkge1xyXG4gICAgICAgICAgY29uc3QgbCA9IGkgLSAxXHJcblxyXG4gICAgICAgICAgc3VtICs9IHNyY0RhdGFbbF1cclxuICAgICAgICAgIGNvdW50KytcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh4IDwgd2lkdGggLSAxKSB7XHJcbiAgICAgICAgICBjb25zdCByID0gaSArIDFcclxuXHJcbiAgICAgICAgICBzdW0gKz0gc3JjRGF0YVtyXVxyXG4gICAgICAgICAgY291bnQrK1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHkgPiAwKSB7XHJcbiAgICAgICAgICBjb25zdCB1ID0gaSAtIHdpZHRoXHJcblxyXG4gICAgICAgICAgc3VtICs9IHNyY0RhdGFbdV1cclxuICAgICAgICAgIGNvdW50KytcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh5IDwgaGVpZ2h0IC0gMSkge1xyXG4gICAgICAgICAgY29uc3QgZCA9IGkgKyB3aWR0aFxyXG5cclxuICAgICAgICAgIHN1bSArPSBzcmNEYXRhW2RdXHJcbiAgICAgICAgICBjb3VudCsrXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXN1bHQuZGF0YVtpXSA9IE1hdGguZmxvb3Ioc3VtIC8gY291bnQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiByZXN1bHRcclxufVxyXG4iXX0=
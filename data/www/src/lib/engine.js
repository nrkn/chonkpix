import { createImage } from './image/create.js';
// chonkpix
// a stupidly simple chonky pixel engine
// private state:
let currentScene;
// misc 
let running = false;
let rafId;
let isReady = false;
// io
const keys = {};
let keyPresses = [];
let viewMouseX = 0;
let viewMouseY = 0;
let useSystemMouse = true;
let cursorInBounds = true;
let frameMouseX = 0;
let frameMouseY = 0;
let mouseWheelDelta = 0;
const mouseButtons = {};
// sound
// todo - plug in a small sound library like ZzFX or similar
// time
let startTime = null;
let lastTime;
let elapsed;
let frameTime;
// view
const minZoom = 1;
const maxZoom = 16;
let zoom = 3;
let frameW;
let frameH;
let frameBuffer;
let frameCanvas;
let frameCtx;
// public state
const state = {
    // expose keys directly, that way the consumer can make decisions like
    // clearing the key state after reading etc
    getKeys: () => keys,
    getKeyPresses: () => keyPresses,
    mouse: {
        getButtons: () => mouseButtons,
        getX: () => frameMouseX,
        getY: () => frameMouseY,
        takeWheel: () => {
            // destructive read
            // otherwise the delta is retained from frame to frame
            // we could have made it so the consumer can explicitly clear it after use
            // or choose to use it, but we have no use case for
            const value = mouseWheelDelta;
            mouseWheelDelta = 0;
            return value;
        },
        isInBounds: () => cursorInBounds
    },
    time: {
        getElapsed: () => elapsed,
        getFrameTime: () => frameTime
    },
    view: {
        getZoom: () => zoom,
        setZoom: (value) => {
            zoom = Math.max(minZoom, Math.min(maxZoom, value));
            resized();
        },
        getBuffer: () => frameBuffer
    },
    getRunning: () => running,
    setRunning: (value) => {
        running = value;
    }
};
// event handlers:
const preventDefaults = new Set(['Tab']);
const keyDown = (event) => {
    keys[event.key] = true;
    keyPresses.push(event.key);
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const keyUp = (event) => {
    keys[event.key] = false;
    // any others in future
    // 
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const mouseMove = (event) => {
    viewMouseX = event.clientX;
    viewMouseY = event.clientY;
    frameMouseX = Math.floor(viewMouseX / zoom);
    frameMouseY = Math.floor(viewMouseY / zoom);
};
const mouseWheel = (event) => {
    mouseWheelDelta = event.deltaY;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseButtonDown = (event) => {
    mouseButtons[event.button] = true;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseButtonUp = (event) => {
    mouseButtons[event.button] = false;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const preventContextDefault = (event) => {
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseLeave = () => {
    cursorInBounds = false;
};
const mouseEnter = () => {
    cursorInBounds = true;
};
const resized = () => {
    frameW = Math.floor(innerWidth / zoom);
    frameH = Math.floor(innerHeight / zoom);
    frameBuffer = createImage(frameW, frameH);
    frameCanvas.width = frameW;
    frameCanvas.height = frameH;
};
// mouse control:
export const releaseMouse = () => {
    useSystemMouse = true;
    frameCanvas.classList.toggle('hide-cursor', false);
};
export const takeMouse = () => {
    useSystemMouse = false;
    frameCanvas.classList.toggle('hide-cursor', true);
};
// runner:
// initialise the engine with a scene
export const start = async (scene) => {
    // if it already has a scene, halt it first
    if (currentScene)
        halt();
    currentScene = scene;
    if (frameCanvas)
        frameCanvas.remove();
    frameCanvas = document.createElement('canvas');
    frameCanvas.id = 'viewport';
    frameCanvas.tabIndex = 0;
    document.body.append(frameCanvas);
    frameCanvas.focus();
    frameCtx = frameCanvas.getContext('2d');
    resized();
    addEventListener('resize', resized);
    frameCanvas.addEventListener('keydown', keyDown);
    frameCanvas.addEventListener('keyup', keyUp);
    frameCanvas.addEventListener('mousemove', mouseMove);
    frameCanvas.addEventListener('wheel', mouseWheel);
    frameCanvas.addEventListener('mousedown', mouseButtonDown);
    frameCanvas.addEventListener('mouseup', mouseButtonUp);
    frameCanvas.addEventListener('contextmenu', preventContextDefault);
    frameCanvas.addEventListener('mouseleave', mouseLeave);
    frameCanvas.addEventListener('mouseenter', mouseEnter);
    running = true;
    rafId = requestAnimationFrame(tick);
    await scene.init(state);
    isReady = true;
};
// tidy everything up
const halt = () => {
    running = false;
    isReady = false;
    cancelAnimationFrame(rafId);
    removeEventListener('resize', resized);
    frameCanvas.removeEventListener('keydown', keyDown);
    frameCanvas.removeEventListener('keyup', keyUp);
    frameCanvas.removeEventListener('mousemove', mouseMove);
    frameCanvas.removeEventListener('wheel', mouseWheel);
    frameCanvas.removeEventListener('mousedown', mouseButtonDown);
    frameCanvas.removeEventListener('mouseup', mouseButtonUp);
    frameCanvas.removeEventListener('contextmenu', preventContextDefault);
    frameCanvas.removeEventListener('mouseleave', mouseLeave);
    frameCanvas.removeEventListener('mouseenter', mouseEnter);
    frameCanvas.remove();
    startTime = null;
    releaseMouse();
    if (currentScene) {
        currentScene.quit(state).catch(console.error);
        currentScene = null;
    }
};
const initTick = (time) => {
    if (startTime !== null)
        return startTime;
    // first tick
    startTime = time;
    elapsed = 0;
    frameTime = 0;
    lastTime = time;
    return startTime;
};
const tick = (time) => {
    if (!running)
        return;
    startTime = initTick(time);
    elapsed = time - startTime;
    frameTime = time - lastTime;
    lastTime = time;
    if (currentScene && isReady)
        currentScene.update(state);
    // scene may have sent a quit signal
    if (!running) {
        halt();
        return;
    }
    // render
    frameCtx.putImageData(frameBuffer, 0, 0);
    //
    rafId = requestAnimationFrame(tick);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9lbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBRy9DLFdBQVc7QUFDWCx3Q0FBd0M7QUFFeEMsaUJBQWlCO0FBRWpCLElBQUksWUFBMEIsQ0FBQTtBQUU5QixRQUFRO0FBRVIsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFBO0FBQ25CLElBQUksS0FBYSxDQUFBO0FBQ2pCLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQTtBQUVuQixLQUFLO0FBRUwsTUFBTSxJQUFJLEdBQTRCLEVBQUUsQ0FBQTtBQUN4QyxJQUFJLFVBQVUsR0FBYSxFQUFFLENBQUE7QUFFN0IsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFBO0FBQ2xCLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQTtBQUVsQixJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUE7QUFDekIsSUFBSSxjQUFjLEdBQUcsSUFBSSxDQUFBO0FBQ3pCLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQTtBQUNuQixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUE7QUFFbkIsSUFBSSxlQUFlLEdBQUcsQ0FBQyxDQUFBO0FBRXZCLE1BQU0sWUFBWSxHQUE0QixFQUFFLENBQUE7QUFFaEQsUUFBUTtBQUNSLDREQUE0RDtBQUU1RCxPQUFPO0FBRVAsSUFBSSxTQUFTLEdBQWtCLElBQUksQ0FBQTtBQUNuQyxJQUFJLFFBQWdCLENBQUE7QUFDcEIsSUFBSSxPQUFlLENBQUE7QUFDbkIsSUFBSSxTQUFpQixDQUFBO0FBRXJCLE9BQU87QUFFUCxNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUE7QUFDakIsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFBO0FBRWxCLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQTtBQUVaLElBQUksTUFBYyxDQUFBO0FBQ2xCLElBQUksTUFBYyxD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QUksU0FBUyxLQUFLLElBQUk7UUFBRSxPQUFPLFNBQVMsQ0FBQTtJQUV4QyxhQUFhO0lBRWIsU0FBUyxHQUFHLElBQUksQ0FBQTtJQUVoQixPQUFPLEdBQUcsQ0FBQyxDQUFBO0lBQ1gsU0FBUyxHQUFHLENBQUMsQ0FBQTtJQUNiLFFBQVEsR0FBRyxJQUFJLENBQUE7SUFFZixPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDLENBQUE7QUFFRCxNQUFNLElBQUksR0FBRyxDQUFDLElBQVksRUFBRSxFQUFFO0lBQzVCLElBQUksQ0FBQyxPQUFPO1FBQUUsT0FBTTtJQUVwQixTQUFTLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzFCLE9BQU8sR0FBRyxJQUFJLEdBQUcsU0FBUyxDQUFBO0lBQzFCLFNBQVMsR0FBRyxJQUFJLEdBQUcsUUFBUSxDQUFBO0lBQzNCLFFBQVEsR0FBRyxJQUFJLENBQUE7SUFFZixJQUFJLFlBQVksSUFBSSxPQUFPO1FBQUUsWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUV2RCxvQ0FBb0M7SUFDcEMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2IsSUFBSSxFQUFFLENBQUE7UUFFTixPQUFNO0lBQ1IsQ0FBQztJQUVELFNBQVM7SUFFVCxRQUFRLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFFeEMsRUFBRTtJQUVGLEtBQUssR0FBRyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUNyQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjcmVhdGVJbWFnZSB9IGZyb20gJy4vaW1hZ2UvY3JlYXRlLmpzJ1xuaW1wb3J0IHsgTWF5YmUsIFNjZW5lLCBTdGF0ZSB9IGZyb20gJy4vdHlwZXMuanMnXG5cbi8vIGNob25rcGl4XG4vLyBhIHN0dXBpZGx5IHNpbXBsZSBjaG9ua3kgcGl4ZWwgZW5naW5lXG5cbi8vIHByaXZhdGUgc3RhdGU6XG5cbmxldCBjdXJyZW50U2NlbmU6IE1heWJlPFNjZW5lPlxuXG4vLyBtaXNjIFxuXG5sZXQgcnVubmluZyA9IGZhbHNlXG5sZXQgcmFmSWQ6IG51bWJlclxubGV0IGlzUmVhZHkgPSBmYWxzZVxuXG4vLyBpb1xuXG5jb25zdCBrZXlzOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPiA9IHt9XG5sZXQga2V5UHJlc3Nlczogc3RyaW5nW10gPSBbXVxuXG5sZXQgdmlld01vdXNlWCA9IDBcbmxldCB2aWV3TW91c2VZID0gMFxuXG5sZXQgdXNlU3lzdGVtTW91c2UgPSB0cnVlXG5sZXQgY3Vyc29ySW5Cb3VuZHMgPSB0cnVlXG5sZXQgZnJhbWVNb3VzZVggPSAwXG5sZXQgZnJhbWVNb3VzZVkgPSAwXG5cbmxldCBtb3VzZVdoZWVsRGVsdGEgPSAwXG5cbmNvbnN0IG1vdXNlQnV0dG9uczogUmVjb3JkPG51bWJlciwgYm9vbGVhbj4gPSB7fVxuXG4vLyBzb3VuZFxuLy8gdG9kbyAtIHBsdWcgaW4gYSBzbWFsbCBzb3VuZCBsaWJyYXJ5IGxpa2UgWnpGWCBvciBzaW1pbGFyXG5cbi8vIHRpbWVcblxubGV0IHN0YXJ0VGltZTogbnVtYmVyIHwgbnVsbCA9IG51bGxcbmxldCBsYXN0VGltZTogbnVtYmVyXG5sZXQgZWxhcHNlZDogbnVtYmVyXG5sZXQgZnJhbWVUaW1lOiBudW1iZXJcblxuLy8gdmlld1xuXG5jb25zdCBtaW5ab29tID0gMVxuY29uc3QgbWF4Wm9vbSA9IDE2XG5cbmxldCB6b29tID0gM1xuXG5sZXQgZnJhbWVXOiBudW1iZXJcbmxldCBmcmFtZUg6IG51bWJlclxubGV0IGZyYW1lQnVmZmVyOiBJbWFnZURhdGFcbmxldCBmcmFtZUNhbnZhczogSFRNTENhbnZhc0VsZW1lbnRcbmxldCBmcmFtZUN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEXG5cbi8vIHB1YmxpYyBzdGF0ZVxuXG5jb25zdCBzdGF0ZTogU3RhdGUgPSB7XG4gIC8vIGV4cG9zZSBrZXlzIGRpcmVjdGx5LCB0aGF0IHdheSB0aGUgY29uc3VtZXIgY2FuIG1ha2UgZGVjaXNpb25zIGxpa2VcbiAgLy8gY2xlYXJpbmcgdGhlIGtleSBzdGF0ZSBhZnRlciByZWFkaW5nIGV0Y1xuICBnZXRLZXlzOiAoKSA9PiBrZXlzLFxuICBnZXRLZXlQcmVzc2VzOiAoKSA9PiBrZXlQcmVzc2VzLFxuXG4gIG1vdXNlOiB7XG4gICAgZ2V0QnV0dG9uczogKCkgPT4gbW91c2VCdXR0b25zLFxuICAgIGdldFg6ICgpID0+IGZyYW1lTW91c2VYLFxuICAgIGdldFk6ICgpID0+IGZyYW1lTW91c2VZLFxuICAgIHRha2VXaGVlbDogKCkgPT4ge1xuICAgICAgLy8gZGVzdHJ1Y3RpdmUgcmVhZFxuICAgICAgLy8gb3RoZXJ3aXNlIHRoZSBkZWx0YSBpcyByZXRhaW5lZCBmcm9tIGZyYW1lIHRvIGZyYW1lXG4gICAgICAvLyB3ZSBjb3VsZCBoYXZlIG1hZGUgaXQgc28gdGhlIGNvbnN1bWVyIGNhbiBleHBsaWNpdGx5IGNsZWFyIGl0IGFmdGVyIHVzZVxuICAgICAgLy8gb3IgY2hvb3NlIHRvIHVzZSBpdCwgYnV0IHdlIGhhdmUgbm8gdXNlIGNhc2UgZm9yXG4gICAgICBjb25zdCB2YWx1ZSA9IG1vdXNlV2hlZWxEZWx0YVxuXG4gICAgICBtb3VzZVdoZWVsRGVsdGEgPSAwXG5cbiAgICAgIHJldHVybiB2YWx1ZVxuICAgIH0sXG4gICAgaXNJbkJvdW5kczogKCkgPT4gY3Vyc29ySW5Cb3VuZHNcbiAgfSxcblxuICB0aW1lOiB7XG4gICAgZ2V0RWxhcHNlZDogKCkgPT4gZWxhcHNlZCxcbiAgICBnZXRGcmFtZVRpbWU6ICgpID0+IGZyYW1lVGltZVxuICB9LFxuXG4gIHZpZXc6IHtcbiAgICBnZXRab29tOiAoKSA9PiB6b29tLFxuICAgIHNldFpvb206ICh2YWx1ZTogbnVtYmVyKSA9PiB7XG4gICAgICB6b29tID0gTWF0aC5tYXgobWluWm9vbSwgTWF0aC5taW4obWF4Wm9vbSwgdmFsdWUpKVxuICAgICAgcmVzaXplZCgpXG4gICAgfSxcbiAgICBnZXRCdWZmZXI6ICgpID0+IGZyYW1lQnVmZmVyXG4gIH0sXG5cbiAgZ2V0UnVubmluZzogKCkgPT4gcnVubmluZyxcbiAgc2V0UnVubmluZzogKHZhbHVlOiBib29sZWFuKSA9PiB7XG4gICAgcnVubmluZyA9IHZhbHVlXG4gIH1cbn1cblxuLy8gZXZlbnQgaGFuZGxlcnM6XG5cbmNvbnN0IHByZXZlbnREZWZhdWx0cyA9IG5ldyBTZXQ8c3RyaW5nPihbJ1RhYiddKVxuXG5jb25zdCBrZXlEb3duID0gKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XG4gIGtleXNbZXZlbnQua2V5XSA9IHRydWVcbiAga2V5UHJlc3Nlcy5wdXNoKGV2ZW50LmtleSlcblxuICBpZiAocHJldmVudERlZmF1bHRzLmhhcyhldmVudC5rZXkpKSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxuXG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuY29uc3Qga2V5VXAgPSAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpID0+IHtcbiAga2V5c1tldmVudC5rZXldID0gZmFsc2VcblxuICAvLyBhbnkgb3RoZXJzIGluIGZ1dHVyZVxuXG4gIC8vIFxuXG4gIGlmIChwcmV2ZW50RGVmYXVsdHMuaGFzKGV2ZW50LmtleSkpIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXG5cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG5jb25zdCBtb3VzZU1vdmUgPSAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcbiAgdmlld01vdXNlWCA9IGV2ZW50LmNsaWVudFhcbiAgdmlld01vdXNlWSA9IGV2ZW50LmNsaWVudFlcblxuICBmcmFtZU1vdXNlWCA9IE1hdGguZmxvb3Iodmlld01vdXNlWCAvIHpvb20pXG4gIGZyYW1lTW91c2VZID0gTWF0aC5mbG9vcih2aWV3TW91c2VZIC8gem9vbSlcbn1cblxuY29uc3QgbW91c2VXaGVlbCA9IChldmVudDogV2hlZWxFdmVudCkgPT4ge1xuICBtb3VzZVdoZWVsRGVsdGEgPSBldmVudC5kZWx0YVlcblxuICBpZiAoIXVzZVN5c3RlbU1vdXNlKSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxuXG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuY29uc3QgbW91c2VCdXR0b25Eb3duID0gKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XG4gIG1vdXNlQnV0dG9uc1tldmVudC5idXR0b25dID0gdHJ1ZVxuXG4gIGlmICghdXNlU3lzdGVtTW91c2UpIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXG5cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG5jb25zdCBtb3VzZUJ1dHRvblVwID0gKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XG4gIG1vdXNlQnV0dG9uc1tldmVudC5idXR0b25dID0gZmFsc2VcblxuICBpZiAoIXVzZVN5c3RlbU1vdXNlKSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxuXG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuY29uc3QgcHJldmVudENvbnRleHREZWZhdWx0ID0gKGV2ZW50OiBFdmVudCkgPT4ge1xuICBpZiAoIXVzZVN5c3RlbU1vdXNlKSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxuXG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuY29uc3QgbW91c2VMZWF2ZSA9ICgpID0+IHtcbiAgY3Vyc29ySW5Cb3VuZHMgPSBmYWxzZVxufVxuXG5jb25zdCBtb3VzZUVudGVyID0gKCkgPT4ge1xuICBjdXJzb3JJbkJvdW5kcyA9IHRydWVcbn1cblxuY29uc3QgcmVzaXplZCA9ICgpID0+IHtcbiAgZnJhbWVXID0gTWF0aC5mbG9vcihpbm5lcldpZHRoIC8gem9vbSlcbiAgZnJhbWVIID0gTWF0aC5mbG9vcihpbm5lckhlaWdodCAvIHpvb20pXG5cbiAgZnJhbWVCdWZmZXIgPSBjcmVhdGVJbWFnZShmcmFtZVcsIGZyYW1lSClcblxuICBmcmFtZUNhbnZhcy53aWR0aCA9IGZyYW1lV1xuICBmcmFtZUNhbnZhcy5oZWlnaHQgPSBmcmFtZUhcbn1cblxuLy8gbW91c2UgY29udHJvbDpcblxuZXhwb3J0IGNvbnN0IHJlbGVhc2VNb3VzZSA9ICgpID0+IHtcbiAgdXNlU3lzdGVtTW91c2UgPSB0cnVlXG4gIGZyYW1lQ2FudmFzLmNsYXNzTGlzdC50b2dnbGUoJ2hpZGUtY3Vyc29yJywgZmFsc2UpXG59XG5cbmV4cG9ydCBjb25zdCB0YWtlTW91c2UgPSAoKSA9PiB7XG4gIHVzZVN5c3RlbU1vdXNlID0gZmFsc2VcbiAgZnJhbWVDYW52YXMuY2xhc3NMaXN0LnRvZ2dsZSgnaGlkZS1jdXJzb3InLCB0cnVlKVxufVxuXG4vLyBydW5uZXI6XG5cbi8vIGluaXRpYWxpc2UgdGhlIGVuZ2luZSB3aXRoIGEgc2NlbmVcbmV4cG9ydCBjb25zdCBzdGFydCA9IGFzeW5jIChzY2VuZTogU2NlbmUpID0+IHtcbiAgLy8gaWYgaXQgYWxyZWFkeSBoYXMgYSBzY2VuZSwgaGFsdCBpdCBmaXJzdFxuICBpZiAoY3VycmVudFNjZW5lKSBoYWx0KClcblxuICBjdXJyZW50U2NlbmUgPSBzY2VuZVxuXG4gIGlmIChmcmFtZUNhbnZhcykgZnJhbWVDYW52YXMucmVtb3ZlKClcblxuICBmcmFtZUNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpXG4gIGZyYW1lQ2FudmFzLmlkID0gJ3ZpZXdwb3J0J1xuICBmcmFtZUNhbnZhcy50YWJJbmRleCA9IDBcblxuICBkb2N1bWVudC5ib2R5LmFwcGVuZChmcmFtZUNhbnZhcylcblxuICBmcmFtZUNhbnZhcy5mb2N1cygpXG5cbiAgZnJhbWVDdHggPSBmcmFtZUNhbnZhcy5nZXRDb250ZXh0KCcyZCcpIVxuXG4gIHJlc2l6ZWQoKVxuXG4gIGFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHJlc2l6ZWQpXG5cbiAgZnJhbWVDYW52YXMuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGtleURvd24pXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywga2V5VXApXG5cbiAgZnJhbWVDYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgbW91c2VNb3ZlKVxuICBmcmFtZUNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCd3aGVlbCcsIG1vdXNlV2hlZWwpXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG1vdXNlQnV0dG9uRG93bilcbiAgZnJhbWVDYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIG1vdXNlQnV0dG9uVXApXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgcHJldmVudENvbnRleHREZWZhdWx0KVxuICBmcmFtZUNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgbW91c2VMZWF2ZSlcbiAgZnJhbWVDYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsIG1vdXNlRW50ZXIpXG5cbiAgcnVubmluZyA9IHRydWVcblxuICByYWZJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKVxuXG4gIGF3YWl0IHNjZW5lLmluaXQoc3RhdGUpXG5cbiAgaXNSZWFkeSA9IHRydWVcbn1cblxuLy8gdGlkeSBldmVyeXRoaW5nIHVwXG5jb25zdCBoYWx0ID0gKCkgPT4ge1xuICBydW5uaW5nID0gZmFsc2VcbiAgaXNSZWFkeSA9IGZhbHNlXG5cbiAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmFmSWQpXG5cbiAgcmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgcmVzaXplZClcblxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5RG93bilcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBrZXlVcClcblxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBtb3VzZU1vdmUpXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3doZWVsJywgbW91c2VXaGVlbClcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgbW91c2VCdXR0b25Eb3duKVxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgbW91c2VCdXR0b25VcClcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCBwcmV2ZW50Q29udGV4dERlZmF1bHQpXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBtb3VzZUxlYXZlKVxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgbW91c2VFbnRlcilcblxuICBmcmFtZUNhbnZhcy5yZW1vdmUoKVxuXG4gIHN0YXJ0VGltZSA9IG51bGxcblxuICByZWxlYXNlTW91c2UoKVxuXG4gIGlmIChjdXJyZW50U2NlbmUpIHtcbiAgICBjdXJyZW50U2NlbmUucXVpdChzdGF0ZSkuY2F0Y2goY29uc29sZS5lcnJvcilcblxuICAgIGN1cnJlbnRTY2VuZSA9IG51bGxcbiAgfVxufVxuXG5jb25zdCBpbml0VGljayA9ICh0aW1lOiBudW1iZXIpID0+IHtcbiAgaWYgKHN0YXJ0VGltZSAhPT0gbnVsbCkgcmV0dXJuIHN0YXJ0VGltZVxuXG4gIC8vIGZpcnN0IHRpY2tcblxuICBzdGFydFRpbWUgPSB0aW1lXG5cbiAgZWxhcHNlZCA9IDBcbiAgZnJhbWVUaW1lID0gMFxuICBsYXN0VGltZSA9IHRpbWVcblxuICByZXR1cm4gc3RhcnRUaW1lXG59XG5cbmNvbnN0IHRpY2sgPSAodGltZTogbnVtYmVyKSA9PiB7XG4gIGlmICghcnVubmluZykgcmV0dXJuXG5cbiAgc3RhcnRUaW1lID0gaW5pdFRpY2sodGltZSlcbiAgZWxhcHNlZCA9IHRpbWUgLSBzdGFydFRpbWVcbiAgZnJhbWVUaW1lID0gdGltZSAtIGxhc3RUaW1lXG4gIGxhc3RUaW1lID0gdGltZVxuXG4gIGlmIChjdXJyZW50U2NlbmUgJiYgaXNSZWFkeSkgY3VycmVudFNjZW5lLnVwZGF0ZShzdGF0ZSlcblxuICAvLyBzY2VuZSBtYXkgaGF2ZSBzZW50IGEgcXVpdCBzaWduYWxcbiAgaWYgKCFydW5uaW5nKSB7XG4gICAgaGFsdCgpXG5cbiAgICByZXR1cm5cbiAgfVxuXG4gIC8vIHJlbmRlclxuXG4gIGZyYW1lQ3R4LnB1dEltYWdlRGF0YShmcmFtZUJ1ZmZlciwgMCwgMClcblxuICAvL1xuXG4gIHJhZklkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spXG59XG4iXX0=
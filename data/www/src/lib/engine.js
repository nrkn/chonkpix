import { createImage } from './image/create.js';
// stupidly simple 2d pixel game engine
// defers pretty much everything to the scene, just provides a basic harness
// for handling input, timing, rendering etc
//
// this is pretty flexible - for example you can have multiple scenes 
// concurrently by having a single scene act as a manager and dispatching to
// its child scenes, intercepting the main state and passing decorated versions
// to the children so that mouse is relative to the child scene position, they
// can have their own frame buffer which gets blitted to the main one, keys and
// mouse only go to the active scene etc etc
// state:
let currentScene;
// misc 
let debug = false;
let running = false;
let rafId;
// io
const keys = {};
let keyPresses = [];
let viewMouseX = 0;
let viewMouseY = 0;
let useSystemMouse = true;
let cursorInBounds = true;
let frameMouseX = 0;
let frameMouseY = 0;
let mouseWheelDelta = 0;
const mouseButtons = {};
// sound
// todo - plug in a small sound library like ZzFX or similar
// time
let startTime = null;
let lastTime;
let elapsed;
let frameTime;
// view
const minZoom = 2;
const maxZoom = 16;
let zoom = 5;
let frameW;
let frameH;
let frameBuffer;
let frameCanvas;
let frameCtx;
// public state
const state = {
    // expose keys directly, that way the consumer can make decisions like 
    // clearing the key state after reading etc
    keys,
    get keyPresses() {
        return keyPresses;
    },
    set keyPresses(value) {
        keyPresses = value;
    },
    mouse: {
        // same as keys
        buttons: mouseButtons,
        get x() {
            return frameMouseX;
        },
        get y() {
            return frameMouseY;
        },
        get inBounds() {
            return cursorInBounds;
        },
        // destructive read
        // otherwise the delta is retained from frame to frame
        // we could have made it so the consumer can explicitly clear it after use
        // or choose to use it, but we have no use case for that
        get wheel() {
            const value = mouseWheelDelta;
            mouseWheelDelta = 0;
            return value;
        }
    },
    time: {
        get elapsed() {
            return elapsed;
        },
        get frameTime() {
            return frameTime;
        }
    },
    view: {
        get zoom() {
            return zoom;
        },
        set zoom(value) {
            zoom = Math.max(minZoom, Math.min(maxZoom, value));
            resize();
        },
        get buffer() {
            return frameBuffer;
        }
    },
    get running() {
        return running;
    },
    set running(value) {
        running = value;
    },
    get debug() {
        return debug;
    },
    set debug(value) {
        debug = value;
    }
};
// event handlers:
const preventDefaults = new Set(['Tab']);
const keyDown = (event) => {
    keys[event.key] = true;
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const keyUp = (event) => {
    keys[event.key] = false;
    // forward non-printable keys to keyPress
    if (event.key === 'Backspace') {
        keyPress(event);
        return;
    }
    // any others in future
    // 
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const keyPress = (event) => {
    keyPresses.push(event.key);
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const mouseMove = (event) => {
    viewMouseX = event.clientX;
    viewMouseY = event.clientY;
    frameMouseX = Math.floor(viewMouseX / zoom);
    frameMouseY = Math.floor(viewMouseY / zoom);
};
const mouseWheel = (event) => {
    mouseWheelDelta = event.deltaY;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseButtonDown = (event) => {
    mouseButtons[event.button] = true;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseButtonUp = (event) => {
    mouseButtons[event.button] = false;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const preventContextDefault = (event) => {
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseLeave = () => {
    cursorInBounds = false;
};
const mouseEnter = () => {
    cursorInBounds = true;
};
const resize = () => {
    frameW = Math.floor(innerWidth / zoom);
    frameH = Math.floor(innerHeight / zoom);
    frameBuffer = createImage(frameW, frameH);
    frameCanvas.width = frameW;
    frameCanvas.height = frameH;
};
// mouse control:
export const releaseMouse = () => {
    useSystemMouse = true;
    frameCanvas.classList.toggle('hide-cursor', false);
};
export const takeMouse = () => {
    useSystemMouse = false;
    frameCanvas.classList.toggle('hide-cursor', true);
};
// runner:
// initialise the engine with a scene
export const start = async (scene) => {
    // if it already has a scene, halt it first
    if (currentScene)
        halt();
    currentScene = scene;
    frameCanvas = document.createElement('canvas');
    frameCanvas.id = 'viewport';
    frameCanvas.tabIndex = 0;
    document.body.append(frameCanvas);
    frameCanvas.focus();
    frameCtx = frameCanvas.getContext('2d');
    resize();
    addEventListener('resize', resize);
    frameCanvas.addEventListener('keydown', keyDown);
    frameCanvas.addEventListener('keyup', keyUp);
    frameCanvas.addEventListener('keypress', keyPress);
    frameCanvas.addEventListener('mousemove', mouseMove);
    frameCanvas.addEventListener('wheel', mouseWheel);
    frameCanvas.addEventListener('mousedown', mouseButtonDown);
    frameCanvas.addEventListener('mouseup', mouseButtonUp);
    frameCanvas.addEventListener('contextmenu', preventContextDefault);
    frameCanvas.addEventListener('mouseleave', mouseLeave);
    frameCanvas.addEventListener('mouseenter', mouseEnter);
    running = true;
    await scene.init(state);
    rafId = requestAnimationFrame(tick);
};
// tidy everything up
const halt = () => {
    running = false;
    cancelAnimationFrame(rafId);
    removeEventListener('resize', resize);
    frameCanvas.removeEventListener('keydown', keyDown);
    frameCanvas.removeEventListener('keyup', keyUp);
    frameCanvas.removeEventListener('keypress', keyPress);
    frameCanvas.removeEventListener('mousemove', mouseMove);
    frameCanvas.removeEventListener('wheel', mouseWheel);
    frameCanvas.removeEventListener('mousedown', mouseButtonDown);
    frameCanvas.removeEventListener('mouseup', mouseButtonUp);
    frameCanvas.removeEventListener('contextmenu', preventContextDefault);
    frameCanvas.removeEventListener('mouseleave', mouseLeave);
    frameCanvas.removeEventListener('mouseenter', mouseEnter);
    frameCanvas.remove();
    startTime = null;
    releaseMouse();
    if (currentScene) {
        currentScene.quit(state).catch(console.error);
        currentScene = null;
    }
};
const initTick = (time) => {
    if (startTime !== null)
        return startTime;
    // first tick
    startTime = time;
    elapsed = 0;
    frameTime = 0;
    lastTime = time;
    return startTime;
};
const tick = (time) => {
    if (!running)
        return;
    startTime = initTick(time);
    elapsed = time - startTime;
    frameTime = time - lastTime;
    lastTime = time;
    if (currentScene)
        currentScene.update(state);
    // scene may have sent a quit signal
    if (!running) {
        halt();
        return;
    }
    // render
    frameCtx.putImageData(frameBuffer, 0, 0);
    // debug
    if (!debug) {
        rafId = requestAnimationFrame(tick);
        return;
    }
    frameCtx.fillStyle = `rgba(0,0,0,0.5)`;
    frameCtx.fillRect(0, 0, 100, 33);
    frameCtx.fillStyle = '#ffffff';
    frameCtx.font = `10px monospace`;
    let mouseBtnState = '';
    for (let i = 0; i < 3; i++) {
        mouseBtnState += mouseButtons[i] ? `${i}` : '-';
    }
    let keyState = '';
    keyState += (keys['W'] || keys['w'] ? 'W' : '-');
    keyState += (keys['A'] || keys['a'] ? 'A' : '-');
    keyState += (keys['S'] || keys['s'] ? 'S' : '-');
    keyState += (keys['D'] || keys['d'] ? 'D' : '-');
    const fps = Math.round(1000 / frameTime);
    const cursorState = useSystemMouse ? ' ON' : 'OFF';
    frameCtx.fillText(`${fps} fps (${frameTime.toFixed(1)})`, 1, 11);
    frameCtx.fillText(`${mouseBtnState} ${cursorState} ${frameMouseX}, ${frameMouseY}`, 1, 21);
    frameCtx.fillText(`${keyState}`, 1, 31);
    //
    rafId = requestAnimationFrame(tick);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9lbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBRy9DLHVDQUF1QztBQUV2Qyw0RUFBNEU7QUFDNUUsNENBQTRDO0FBQzVDLEVBQUU7QUFDRixzRUFBc0U7QUFDdEUsNEVBQTRFO0FBQzVFLCtFQUErRTtBQUMvRSw4RUFBOEU7QUFDOUUsK0VBQStFO0FBQy9FLDRDQUE0QztBQUU1QyxTQUFTO0FBRVQsSUFBSSxZQUEwQixDQUFBO0FBRTlCLFFBQVE7QUFFUixJQUFJLEtBQUssR0FBRyxLQUFLLENBQUE7QUFDakIsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFBO0FBQ25CLElBQUksS0FBYSxDQUFBO0FBRWpCLEtBQUs7QUFFTCxNQUFNLElBQUksR0FBNEIsRUFBRSxDQUFBO0FBQ3hDLElBQUksVUFBVSxHQUFhLEVBQUUsQ0FBQTtBQUU3QixJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUE7QUFDbEIsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFBO0FBRWxCLElBQUksY0FBYyxHQUFHLElBQUksQ0FBQTtBQUN6QixJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUE7QUFDekIsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFBO0FBQ25CLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQTtBQUVuQixJQUFJLGVBQWUsR0FBRyxDQUFDLENBQUE7QUFFdkIsTUFBTSxZQUFZLEdBQTRCLEVBQUUsQ0FBQTtBQUVoRCxRQUFRO0FBQ1IsNERBQTREO0FBRTVELE9BQU87QUFFUCxJQUFJLFNBQVMsR0FBa0IsSUFBSSxDQUFBO0FBQ25DLElBQUksUUFBZ0IsQ0FBQTtBQUNwQixJQUFJLE9BQWUsQ0FBQTtBQUNuQixJQUFJLFNBQWlCLENBQUE7QUFFckIsT0FBTztBQUVQLE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBQTtBQUNqQixNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUE7QUFFbEIsSUFBSSxJQUFJLEdBQUcsQ0FBQyxDQUFBO0FBRVosSUFBSSxNQUFjLENBQUE7QUFDbEIsSUFBSSxNQUFjLENBQUE7QUFDbEIsSUFBSSxXQUFzQixDQUFBO0FBQzFCLElBQUksV0FBOEIsQ0FBQTtBQUNsQyxJQUFJLFFBQWtDLENBQUE7QUFFdEMsZUFBZTtBQUVmLE1BQU0sS0FBSyxHQUFVO0lBQ25CLHVFQUF1RTtJQUN2RSwyQ0FBMkM7SUFDM0MsSUFBSTtJQUNKLElBQUksVUFBVTtRQUNaLE9BQU8sVUFBVSxDQUFBO0lBQ25CLENBQUM7SUFDRCxJQUFJLFVBQVUsQ0FBQyxLQUFlO1FBQzVCLFVBQVUsR0FBRyxLQUFLLENBQUE7SUFDcEIsQ0FBQztJQUVELEtBQUssRUFBRTtRQUNMLGVBQWU7UUFDZixPQUFPLEVBQUUsWUFBWTtRQUNyQixJQUFJLENBQUM7WUFDSCxPQUFPLFdBQVcsQ0FBQTtRQUNwQixDQUFDO1FBQ0QsSUFBSSxDQUFDO1lBQ0gsT0FBTyxXQUFXLENBQUE7UUFDcEIsQ0FBQztRQUNELElBQUksUUFBUTtZQUNWLE9BQU8sY0FBYyxDQUFBO1FBQ3ZCLENBQUM7UUFDRCxtQkFBbUI7UUFDbkIsc0RBQXNEO1FBQ3RELDBFQUEwRTtRQUMxRSx3REFBd0Q7UUFDeEQsSUFBSSxLQUFLO1lBQ1AsTUFBTSxLQUFLLEdBQUcsZUFBZSxDQUFBO1lBRTdCLGVBQWUsR0FBRyxDQUFDLENBQUE7WUFFbkIsT0FBTyxLQUFLLENBQUE7UUFDZCxDQUFDO0tBQ0Y7SUFDRCxJQUFJLEVBQUU7UUFDSixJQUFJLE9BQU87WUFDVCxPQUFPLE9BQU8sQ0FBQTtRQUNoQixDQUFDO1FBQ0QsSUFBSSxTQUFTO1lBQ1gsT0FBTyxTQUFTLENBQUE7UUFDbEIsQ0FBQztLQUNGO0lBQ0QsSUFBSSxFQUFFO1FBQ0osSUFBSSxJQUFJO1lBQ04sT0FBTyxJQUFJLENBQUE7UUFDYixDQUFDO1FBQ0QsSUFBSSxJQUFJLENBQUMsS0FBYTtZQUNwQixJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQTtZQUNsRCxNQUFNLEVBQUUsQ0FBQTtRQUNWLENBQUM7UUFDRCxJQUFJLE1BQU07WUFDUixPQUFPLFdBQVcsQ0FBQTtRQUNwQixDQUFDO0tBQ0Y7SUFDRCxJQUFJLE9BQU87UUFDVCxPQUFPLE9BQU8sQ0FBQTtJQUNoQixDQUFDO0lBQ0QsSUFBSSxPQUFPLENBQUMsS0FBYztRQUN4QixPQUFPLEdBQUcsS0FBSyxDQUFBO0lBQ2pCLENBQUM7SUFDRCxJQUFJLEtBQUs7UUFDUCxPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFDRCxJQUFJLEtBQUssQ0FBQyxLQUFjO1FBQ3RCLEtBQUssR0FBRyxLQUFLLENBQUE7SUFDZixDQUFDO0NBQ0YsQ0FBQTtBQUVELGtCQUFrQjtBQUVsQixNQUFNLGVBQWUsR0FBRyxJQUFJLEdBQUcsQ0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7QUFFaEQsTUFBTSxPQUFPLEdBQUcsQ0FBQyxLQUFvQixFQUFFLEVBQUU7SUFDdkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUE7SUFFdEIsSUFBSSxlQUFlLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ25DLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUV0QixPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7QUFDSCxDQUFDLENBQUE7QUFFRCxNQUFNLEtBQUssR0FBRyxDQUFDLEtBQW9CLEVBQUUsRUFBRTtJQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQTtJQUV2Qix5Q0FBeUM7SUFDekMsSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFLLFdBQVcsRUFBRSxDQUFDO1FBQzlCLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUVmLE9BQU07SUFDUixDQUFDO0lBRUQsdUJBQXVCO0lBRXZCLEdBQUc7SUFFSCxJQUFJLGVBQWUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDbkMsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFBO1FBRXRCLE9BQU8sS0FBSyxDQUFBO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQTtBQUVELE1BQU0sUUFBUSxHQUFHLENBQUMsS0FBb0IsRUFBRSxFQUFFO0lBQ3hDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBRTFCLElBQUksZUFBZSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUNuQyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUE7UUFFdEIsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsTUFBTSxTQUFTLEdBQUcsQ0FBQyxLQUFpQixFQUFFLEVBQUU7SUFDdEMsVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUE7SUFDMUIsVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUE7SUFFMUIsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxDQUFBO0lBQzNDLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsQ0FBQTtBQUM3QyxDQUFDLENBQUE7QUFFRCxNQUFNLFVBQVUsR0FBRyxDQUFDLEtBQWlCLEVBQUUsRUFBRTtJQUN2QyxlQUFlLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQTtJQUU5QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDcEIsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFBO1FBRXRCLE9BQU8sS0FBSyxDQUFBO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQTtBQUVELE1BQU0sZUFBZSxHQUFHLENBQUMsS0FBaUIsRUFBRSxFQUFFO0lBQzVDLFlBQVksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFBO0lBRWpDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUNwQixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUE7UUFFdEIsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxLQUFpQixFQUFFLEVBQUU7SUFDMUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUE7SUFFbEMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3BCLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUV0QixPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7QUFDSCxDQUFDLENBQUE7QUFFRCxNQUFNLHFCQUFxQixHQUFHLENBQUMsS0FBWSxFQUFFLEVBQUU7SUFDN0MsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3BCLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUV0QixPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7QUFDSCxDQUFDLENBQUE7QUFFRCxNQUFNLFVBQVUsR0FBRyxHQUFHLEVBQUU7SUFDdEIsY0FBYyxHQUFHLEtBQUssQ0FBQTtBQUN4QixDQUFDLENBQUE7QUFFRCxNQUFNLFVBQVUsR0FBRyxHQUFHLEVBQUU7SUFDdEIsY0FBYyxHQUFHLElBQUksQ0FBQTtBQUN2QixDQUFDLENBQUE7QUFFRCxNQUFNLE1BQU0sR0FBRyxHQUFHLEVBQUU7SUFDbEIsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxDQUFBO0lBQ3RDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsQ0FBQTtJQUV2QyxXQUFXLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUV6QyxXQUFXLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQTtJQUMxQixXQUFXLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtBQUM3QixDQUFDLENBQUE7QUFFRCxpQkFBaUI7QUFFakIsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLEdBQUcsRUFBRTtJQUMvQixjQUFjLEdBQUcsSUFBSSxDQUFBO0lBQ3JCLFdBQVcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQTtBQUNwRCxDQUFDLENBQUE7QUFFRCxNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUcsR0FBRyxFQUFFO0lBQzVCLGNBQWMsR0FBRyxLQUFLLENBQUE7SUFDdEIsV0FBVyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFBO0FBQ25ELENBQUMsQ0FBQTtBQUVELFVBQVU7QUFFVixxQ0FBcUM7QUFDckMsTUFBTSxDQUFDLE1BQU0sS0FBSyxHQUFHLEtBQUssRUFBRSxLQUFZLEVBQUUsRUFBRTtJQUMxQywyQ0FBMkM7SUFDM0MsSUFBSSxZQUFZO1FBQUcsSUFBSSxFQUFFLENBQUE7SUFFekIsWUFBWSxHQUFHLEtBQUssQ0FBQTtJQUVwQixXQUFXLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUM5QyxXQUFXLENBQUMsRUFBRSxHQUFHLFVBQVUsQ0FBQTtJQUMzQixXQUFXLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQTtJQUV4QixRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUVqQyxXQUFXLENBQUMsS0FBSyxFQUFFLENBQUE7SUFFbkIsUUFBUSxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFFLENBQUE7SUFFeEMsTUFBTSxFQUFFLENBQUE7SUFFUixnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFFbEMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQTtJQUNoRCxXQUFXLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFBO0lBQzVDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFFbEQsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUNwRCxXQUFXLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFBO0lBQ2pELFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsZUFBZSxDQUFDLENBQUE7SUFDMUQsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQTtJQUN0RCxXQUFXLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxFQUFFLHFCQUFxQixDQUFDLENBQUE7SUFDbEUsV0FBVyxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxVQUFVLENBQUMsQ0FBQTtJQUN0RCxXQUFXLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0lBRXRELE9BQU8sR0FBRyxJQUFJLENBQUE7SUFFZCxNQUFNLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7SUFFdkIsS0FBSyxHQUFHLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFBO0FBQ3JDLENBQUMsQ0FBQTtBQUVELHFCQUFxQjtBQUNyQixNQUFNLElBQUksR0FBRyxHQUFHLEVBQUU7SUFDaEIsT0FBTyxHQUFHLEtBQUssQ0FBQTtJQUNmLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFBO0lBRTNCLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUVyQyxXQUFXLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFBO0lBQ25ELFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUE7SUFDL0MsV0FBVyxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUVyRCxXQUFXLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLFNBQVMsQ0FBQyxDQUFBO0lBQ3ZELFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUE7SUFDcEQsV0FBVyxDQUFDLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQTtJQUM3RCxXQUFXLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFBO0lBQ3pELFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxhQUFhLEVBQUUscUJBQXFCLENBQUMsQ0FBQTtJQUNyRSxXQUFXLENBQUMsbUJBQW1CLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0lBQ3pELFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUE7SUFFekQsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFBO0lBRXBCLFNBQVMsR0FBRyxJQUFJLENBQUE7SUFFaEIsWUFBWSxFQUFFLENBQUE7SUFFZCxJQUFJLFlBQVksRUFBQyxDQUFDO1FBQ2hCLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUU3QyxZQUFZLEdBQUcsSUFBSSxDQUFBO0lBQ3JCLENBQUM7QUFDSCxDQUFDLENBQUE7QUFFRCxNQUFNLFFBQVEsR0FBRyxDQUFDLElBQVksRUFBRSxFQUFFO0lBQ2hDLElBQUksU0FBUyxLQUFLLElBQUk7UUFBRSxPQUFPLFNBQVMsQ0FBQTtJQUV4QyxhQUFhO0lBRWIsU0FBUyxHQUFHLElBQUksQ0FBQTtJQUVoQixPQUFPLEdBQUcsQ0FBQyxDQUFBO0lBQ1gsU0FBUyxHQUFHLENBQUMsQ0FBQTtJQUNiLFFBQVEsR0FBRyxJQUFJLENBQUE7SUFFZixPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDLENBQUE7QUFFRCxNQUFNLElBQUksR0FBRyxDQUFDLElBQVksRUFBRSxFQUFFO0lBQzVCLElBQUksQ0FBQyxPQUFPO1FBQUUsT0FBTTtJQUVwQixTQUFTLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzFCLE9BQU8sR0FBRyxJQUFJLEdBQUcsU0FBUyxDQUFBO0lBQzFCLFNBQVMsR0FBRyxJQUFJLEdBQUcsUUFBUSxDQUFBO0lBQzNCLFFBQVEsR0FBRyxJQUFJLENBQUE7SUFFZixJQUFJLFlBQVk7UUFBRyxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBRTdDLG9DQUFvQztJQUNwQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDYixJQUFJLEVBQUUsQ0FBQTtRQUVOLE9BQU07SUFDUixDQUFDO0lBRUQsU0FBUztJQUVULFFBQVEsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUV4QyxRQUFRO0lBRVIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ1gsS0FBSyxHQUFHLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ25DLE9BQU07SUFDUixDQUFDO0lBRUQsUUFBUSxDQUFDLFNBQVMsR0FBRyxpQkFBaUIsQ0FBQTtJQUN0QyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRWhDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFBO0lBQzlCLFFBQVEsQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLENBQUE7SUFFaEMsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFBO0lBRXRCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUMzQixhQUFhLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUE7SUFDakQsQ0FBQztJQUVELElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQTtJQUVqQixRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ2hELFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDaEQsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUNoRCxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBRWhELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxDQUFBO0lBRXhDLE1BQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUE7SUFFbEQsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEdBQUcsU0FBUyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ2hFLFFBQVEsQ0FBQyxRQUFRLENBQ2YsR0FBRyxhQUFhLElBQUksV0FBVyxJQUFJLFdBQVcsS0FBSyxXQUFXLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUN4RSxDQUFBO0lBQ0QsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLFFBQVEsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUV2QyxFQUFFO0lBRUYsS0FBSyxHQUFHLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFBO0FBQ3JDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZUltYWdlIH0gZnJvbSAnLi9pbWFnZS9jcmVhdGUuanMnXHJcbmltcG9ydCB7IE1heWJlLCBTY2VuZSwgU3RhdGUgfSBmcm9tICcuL3R5cGVzLmpzJ1xyXG5cclxuLy8gc3R1cGlkbHkgc2ltcGxlIDJkIHBpeGVsIGdhbWUgZW5naW5lXHJcblxyXG4vLyBkZWZlcnMgcHJldHR5IG11Y2ggZXZlcnl0aGluZyB0byB0aGUgc2NlbmUsIGp1c3QgcHJvdmlkZXMgYSBiYXNpYyBoYXJuZXNzXHJcbi8vIGZvciBoYW5kbGluZyBpbnB1dCwgdGltaW5nLCByZW5kZXJpbmcgZXRjXHJcbi8vXHJcbi8vIHRoaXMgaXMgcHJldHR5IGZsZXhpYmxlIC0gZm9yIGV4YW1wbGUgeW91IGNhbiBoYXZlIG11bHRpcGxlIHNjZW5lcyBcclxuLy8gY29uY3VycmVudGx5IGJ5IGhhdmluZyBhIHNpbmdsZSBzY2VuZSBhY3QgYXMgYSBtYW5hZ2VyIGFuZCBkaXNwYXRjaGluZyB0b1xyXG4vLyBpdHMgY2hpbGQgc2NlbmVzLCBpbnRlcmNlcHRpbmcgdGhlIG1haW4gc3RhdGUgYW5kIHBhc3NpbmcgZGVjb3JhdGVkIHZlcnNpb25zXHJcbi8vIHRvIHRoZSBjaGlsZHJlbiBzbyB0aGF0IG1vdXNlIGlzIHJlbGF0aXZlIHRvIHRoZSBjaGlsZCBzY2VuZSBwb3NpdGlvbiwgdGhleVxyXG4vLyBjYW4gaGF2ZSB0aGVpciBvd24gZnJhbWUgYnVmZmVyIHdoaWNoIGdldHMgYmxpdHRlZCB0byB0aGUgbWFpbiBvbmUsIGtleXMgYW5kXHJcbi8vIG1vdXNlIG9ubHkgZ28gdG8gdGhlIGFjdGl2ZSBzY2VuZSBldGMgZXRjXHJcblxyXG4vLyBzdGF0ZTpcclxuXHJcbmxldCBjdXJyZW50U2NlbmU6IE1heWJlPFNjZW5lPlxyXG5cclxuLy8gbWlzYyBcclxuXHJcbmxldCBkZWJ1ZyA9IGZhbHNlXHJcbmxldCBydW5uaW5nID0gZmFsc2VcclxubGV0IHJhZklkOiBudW1iZXJcclxuXHJcbi8vIGlvXHJcblxyXG5jb25zdCBrZXlzOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPiA9IHt9XHJcbmxldCBrZXlQcmVzc2VzOiBzdHJpbmdbXSA9IFtdXHJcblxyXG5sZXQgdmlld01vdXNlWCA9IDBcclxubGV0IHZpZXdNb3VzZVkgPSAwXHJcblxyXG5sZXQgdXNlU3lzdGVtTW91c2UgPSB0cnVlXHJcbmxldCBjdXJzb3JJbkJvdW5kcyA9IHRydWVcclxubGV0IGZyYW1lTW91c2VYID0gMFxyXG5sZXQgZnJhbWVNb3VzZVkgPSAwXHJcblxyXG5sZXQgbW91c2VXaGVlbERlbHRhID0gMFxyXG5cclxuY29uc3QgbW91c2VCdXR0b25zOiBSZWNvcmQ8bnVtYmVyLCBib29sZWFuPiA9IHt9XHJcblxyXG4vLyBzb3VuZFxyXG4vLyB0b2RvIC0gcGx1ZyBpbiBhIHNtYWxsIHNvdW5kIGxpYnJhcnkgbGlrZSBaekZYIG9yIHNpbWlsYXJcclxuXHJcbi8vIHRpbWVcclxuXHJcbmxldCBzdGFydFRpbWU6IG51bWJlciB8IG51bGwgPSBudWxsXHJcbmxldCBsYXN0VGltZTogbnVtYmVyXHJcbmxldCBlbGFwc2VkOiBudW1iZXJcclxubGV0IGZyYW1lVGltZTogbnVtYmVyXHJcblxyXG4vLyB2aWV3XHJcblxyXG5jb25zdCBtaW5ab29tID0gMlxyXG5jb25zdCBtYXhab29tID0gMTZcclxuXHJcbmxldCB6b29tID0gNVxyXG5cclxubGV0IGZyYW1lVzogbnVtYmVyXHJcbmxldCBmcmFtZUg6IG51bWJlclxyXG5sZXQgZnJhbWVCdWZmZXI6IEltYWdlRGF0YVxyXG5sZXQgZnJhbWVDYW52YXM6IEhUTUxDYW52YXNFbGVtZW50XHJcbmxldCBmcmFtZUN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEXHJcblxyXG4vLyBwdWJsaWMgc3RhdGVcclxuXHJcbmNvbnN0IHN0YXRlOiBTdGF0ZSA9IHtcclxuICAvLyBleHBvc2Uga2V5cyBkaXJlY3RseSwgdGhhdCB3YXkgdGhlIGNvbnN1bWVyIGNhbiBtYWtlIGRlY2lzaW9ucyBsaWtlIFxyXG4gIC8vIGNsZWFyaW5nIHRoZSBrZXkgc3RhdGUgYWZ0ZXIgcmVhZGluZyBldGNcclxuICBrZXlzLFxyXG4gIGdldCBrZXlQcmVzc2VzKCkge1xyXG4gICAgcmV0dXJuIGtleVByZXNzZXNcclxuICB9LFxyXG4gIHNldCBrZXlQcmVzc2VzKHZhbHVlOiBzdHJpbmdbXSkge1xyXG4gICAga2V5UHJlc3NlcyA9IHZhbHVlXHJcbiAgfSxcclxuXHJcbiAgbW91c2U6IHtcclxuICAgIC8vIHNhbWUgYXMga2V5c1xyXG4gICAgYnV0dG9uczogbW91c2VCdXR0b25zLFxyXG4gICAgZ2V0IHgoKSB7XHJcbiAgICAgIHJldHVybiBmcmFtZU1vdXNlWFxyXG4gICAgfSxcclxuICAgIGdldCB5KCkge1xyXG4gICAgICByZXR1cm4gZnJhbWVNb3VzZVlcclxuICAgIH0sXHJcbiAgICBnZXQgaW5Cb3VuZHMoKSB7XHJcbiAgICAgIHJldHVybiBjdXJzb3JJbkJvdW5kc1xyXG4gICAgfSxcclxuICAgIC8vIGRlc3RydWN0aXZlIHJlYWRcclxuICAgIC8vIG90aGVyd2lzZSB0aGUgZGVsdGEgaXMgcmV0YWluZWQgZnJvbSBmcmFtZSB0byBmcmFtZVxyXG4gICAgLy8gd2UgY291bGQgaGF2ZSBtYWRlIGl0IHNvIHRoZSBjb25zdW1lciBjYW4gZXhwbGljaXRseSBjbGVhciBpdCBhZnRlciB1c2VcclxuICAgIC8vIG9yIGNob29zZSB0byB1c2UgaXQsIGJ1dCB3ZSBoYXZlIG5vIHVzZSBjYXNlIGZvciB0aGF0XHJcbiAgICBnZXQgd2hlZWwoKSB7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gbW91c2VXaGVlbERlbHRhXHJcblxyXG4gICAgICBtb3VzZVdoZWVsRGVsdGEgPSAwXHJcblxyXG4gICAgICByZXR1cm4gdmFsdWVcclxuICAgIH1cclxuICB9LFxyXG4gIHRpbWU6IHtcclxuICAgIGdldCBlbGFwc2VkKCkge1xyXG4gICAgICByZXR1cm4gZWxhcHNlZFxyXG4gICAgfSxcclxuICAgIGdldCBmcmFtZVRpbWUoKSB7XHJcbiAgICAgIHJldHVybiBmcmFtZVRpbWVcclxuICAgIH1cclxuICB9LFxyXG4gIHZpZXc6IHtcclxuICAgIGdldCB6b29tKCkge1xyXG4gICAgICByZXR1cm4gem9vbVxyXG4gICAgfSxcclxuICAgIHNldCB6b29tKHZhbHVlOiBudW1iZXIpIHtcclxuICAgICAgem9vbSA9IE1hdGgubWF4KG1pblpvb20sIE1hdGgubWluKG1heFpvb20sIHZhbHVlKSlcclxuICAgICAgcmVzaXplKClcclxuICAgIH0sXHJcbiAgICBnZXQgYnVmZmVyKCkge1xyXG4gICAgICByZXR1cm4gZnJhbWVCdWZmZXJcclxuICAgIH1cclxuICB9LFxyXG4gIGdldCBydW5uaW5nKCkge1xyXG4gICAgcmV0dXJuIHJ1bm5pbmdcclxuICB9LFxyXG4gIHNldCBydW5uaW5nKHZhbHVlOiBib29sZWFuKSB7XHJcbiAgICBydW5uaW5nID0gdmFsdWVcclxuICB9LFxyXG4gIGdldCBkZWJ1ZygpIHtcclxuICAgIHJldHVybiBkZWJ1Z1xyXG4gIH0sXHJcbiAgc2V0IGRlYnVnKHZhbHVlOiBib29sZWFuKSB7XHJcbiAgICBkZWJ1ZyA9IHZhbHVlXHJcbiAgfVxyXG59XHJcblxyXG4vLyBldmVudCBoYW5kbGVyczpcclxuXHJcbmNvbnN0IHByZXZlbnREZWZhdWx0cyA9IG5ldyBTZXQ8c3RyaW5nPihbJ1RhYiddKVxyXG5cclxuY29uc3Qga2V5RG93biA9IChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gIGtleXNbZXZlbnQua2V5XSA9IHRydWVcclxuXHJcbiAgaWYgKHByZXZlbnREZWZhdWx0cy5oYXMoZXZlbnQua2V5KSkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxyXG5cclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuY29uc3Qga2V5VXAgPSAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpID0+IHtcclxuICBrZXlzW2V2ZW50LmtleV0gPSBmYWxzZVxyXG5cclxuICAvLyBmb3J3YXJkIG5vbi1wcmludGFibGUga2V5cyB0byBrZXlQcmVzc1xyXG4gIGlmIChldmVudC5rZXkgPT09ICdCYWNrc3BhY2UnKSB7XHJcbiAgICBrZXlQcmVzcyhldmVudClcclxuXHJcbiAgICByZXR1cm5cclxuICB9XHJcblxyXG4gIC8vIGFueSBvdGhlcnMgaW4gZnV0dXJlXHJcblxyXG4gIC8vIFxyXG5cclxuICBpZiAocHJldmVudERlZmF1bHRzLmhhcyhldmVudC5rZXkpKSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXHJcblxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBrZXlQcmVzcyA9IChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gIGtleVByZXNzZXMucHVzaChldmVudC5rZXkpXHJcblxyXG4gIGlmIChwcmV2ZW50RGVmYXVsdHMuaGFzKGV2ZW50LmtleSkpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcclxuXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IG1vdXNlTW92ZSA9IChldmVudDogTW91c2VFdmVudCkgPT4ge1xyXG4gIHZpZXdNb3VzZVggPSBldmVudC5jbGllbnRYXHJcbiAgdmlld01vdXNlWSA9IGV2ZW50LmNsaWVudFlcclxuXHJcbiAgZnJhbWVNb3VzZVggPSBNYXRoLmZsb29yKHZpZXdNb3VzZVggLyB6b29tKVxyXG4gIGZyYW1lTW91c2VZID0gTWF0aC5mbG9vcih2aWV3TW91c2VZIC8gem9vbSlcclxufVxyXG5cclxuY29uc3QgbW91c2VXaGVlbCA9IChldmVudDogV2hlZWxFdmVudCkgPT4ge1xyXG4gIG1vdXNlV2hlZWxEZWx0YSA9IGV2ZW50LmRlbHRhWVxyXG5cclxuICBpZiAoIXVzZVN5c3RlbU1vdXNlKSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXHJcblxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBtb3VzZUJ1dHRvbkRvd24gPSAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcclxuICBtb3VzZUJ1dHRvbnNbZXZlbnQuYnV0dG9uXSA9IHRydWVcclxuXHJcbiAgaWYgKCF1c2VTeXN0ZW1Nb3VzZSkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxyXG5cclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuY29uc3QgbW91c2VCdXR0b25VcCA9IChldmVudDogTW91c2VFdmVudCkgPT4ge1xyXG4gIG1vdXNlQnV0dG9uc1tldmVudC5idXR0b25dID0gZmFsc2VcclxuXHJcbiAgaWYgKCF1c2VTeXN0ZW1Nb3VzZSkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxyXG5cclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuY29uc3QgcHJldmVudENvbnRleHREZWZhdWx0ID0gKGV2ZW50OiBFdmVudCkgPT4ge1xyXG4gIGlmICghdXNlU3lzdGVtTW91c2UpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcclxuXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IG1vdXNlTGVhdmUgPSAoKSA9PiB7XHJcbiAgY3Vyc29ySW5Cb3VuZHMgPSBmYWxzZVxyXG59XHJcblxyXG5jb25zdCBtb3VzZUVudGVyID0gKCkgPT4ge1xyXG4gIGN1cnNvckluQm91bmRzID0gdHJ1ZVxyXG59XHJcblxyXG5jb25zdCByZXNpemUgPSAoKSA9PiB7XHJcbiAgZnJhbWVXID0gTWF0aC5mbG9vcihpbm5lcldpZHRoIC8gem9vbSlcclxuICBmcmFtZUggPSBNYXRoLmZsb29yKGlubmVySGVpZ2h0IC8gem9vbSlcclxuXHJcbiAgZnJhbWVCdWZmZXIgPSBjcmVhdGVJbWFnZShmcmFtZVcsIGZyYW1lSClcclxuXHJcbiAgZnJhbWVDYW52YXMud2lkdGggPSBmcmFtZVdcclxuICBmcmFtZUNhbnZhcy5oZWlnaHQgPSBmcmFtZUhcclxufVxyXG5cclxuLy8gbW91c2UgY29udHJvbDpcclxuXHJcbmV4cG9ydCBjb25zdCByZWxlYXNlTW91c2UgPSAoKSA9PiB7XHJcbiAgdXNlU3lzdGVtTW91c2UgPSB0cnVlXHJcbiAgZnJhbWVDYW52YXMuY2xhc3NMaXN0LnRvZ2dsZSgnaGlkZS1jdXJzb3InLCBmYWxzZSlcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHRha2VNb3VzZSA9ICgpID0+IHtcclxuICB1c2VTeXN0ZW1Nb3VzZSA9IGZhbHNlXHJcbiAgZnJhbWVDYW52YXMuY2xhc3NMaXN0LnRvZ2dsZSgnaGlkZS1jdXJzb3InLCB0cnVlKVxyXG59XHJcblxyXG4vLyBydW5uZXI6XHJcblxyXG4vLyBpbml0aWFsaXNlIHRoZSBlbmdpbmUgd2l0aCBhIHNjZW5lXHJcbmV4cG9ydCBjb25zdCBzdGFydCA9IGFzeW5jIChzY2VuZTogU2NlbmUpID0+IHtcclxuICAvLyBpZiBpdCBhbHJlYWR5IGhhcyBhIHNjZW5lLCBoYWx0IGl0IGZpcnN0XHJcbiAgaWYoIGN1cnJlbnRTY2VuZSApIGhhbHQoKVxyXG5cclxuICBjdXJyZW50U2NlbmUgPSBzY2VuZVxyXG5cclxuICBmcmFtZUNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpXHJcbiAgZnJhbWVDYW52YXMuaWQgPSAndmlld3BvcnQnXHJcbiAgZnJhbWVDYW52YXMudGFiSW5kZXggPSAwXHJcblxyXG4gIGRvY3VtZW50LmJvZHkuYXBwZW5kKGZyYW1lQ2FudmFzKVxyXG5cclxuICBmcmFtZUNhbnZhcy5mb2N1cygpXHJcblxyXG4gIGZyYW1lQ3R4ID0gZnJhbWVDYW52YXMuZ2V0Q29udGV4dCgnMmQnKSFcclxuXHJcbiAgcmVzaXplKClcclxuXHJcbiAgYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgcmVzaXplKVxyXG5cclxuICBmcmFtZUNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5RG93bilcclxuICBmcmFtZUNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIGtleVVwKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ2tleXByZXNzJywga2V5UHJlc3MpXHJcblxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdXNlTW92ZSlcclxuICBmcmFtZUNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCd3aGVlbCcsIG1vdXNlV2hlZWwpXHJcbiAgZnJhbWVDYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgbW91c2VCdXR0b25Eb3duKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBtb3VzZUJ1dHRvblVwKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgcHJldmVudENvbnRleHREZWZhdWx0KVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBtb3VzZUxlYXZlKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCBtb3VzZUVudGVyKVxyXG5cclxuICBydW5uaW5nID0gdHJ1ZVxyXG5cclxuICBhd2FpdCBzY2VuZS5pbml0KHN0YXRlKVxyXG5cclxuICByYWZJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKVxyXG59XHJcblxyXG4vLyB0aWR5IGV2ZXJ5dGhpbmcgdXBcclxuY29uc3QgaGFsdCA9ICgpID0+IHtcclxuICBydW5uaW5nID0gZmFsc2VcclxuICBjYW5jZWxBbmltYXRpb25GcmFtZShyYWZJZClcclxuXHJcbiAgcmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgcmVzaXplKVxyXG5cclxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5RG93bilcclxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXl1cCcsIGtleVVwKVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXByZXNzJywga2V5UHJlc3MpXHJcblxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdXNlTW92ZSlcclxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd3aGVlbCcsIG1vdXNlV2hlZWwpXHJcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgbW91c2VCdXR0b25Eb3duKVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBtb3VzZUJ1dHRvblVwKVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgcHJldmVudENvbnRleHREZWZhdWx0KVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBtb3VzZUxlYXZlKVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCBtb3VzZUVudGVyKVxyXG5cclxuICBmcmFtZUNhbnZhcy5yZW1vdmUoKVxyXG5cclxuICBzdGFydFRpbWUgPSBudWxsXHJcblxyXG4gIHJlbGVhc2VNb3VzZSgpXHJcblxyXG4gIGlmIChjdXJyZW50U2NlbmUpe1xyXG4gICAgY3VycmVudFNjZW5lLnF1aXQoc3RhdGUpLmNhdGNoKGNvbnNvbGUuZXJyb3IpXHJcblxyXG4gICAgY3VycmVudFNjZW5lID0gbnVsbFxyXG4gIH1cclxufVxyXG5cclxuY29uc3QgaW5pdFRpY2sgPSAodGltZTogbnVtYmVyKSA9PiB7XHJcbiAgaWYgKHN0YXJ0VGltZSAhPT0gbnVsbCkgcmV0dXJuIHN0YXJ0VGltZVxyXG5cclxuICAvLyBmaXJzdCB0aWNrXHJcblxyXG4gIHN0YXJ0VGltZSA9IHRpbWVcclxuXHJcbiAgZWxhcHNlZCA9IDBcclxuICBmcmFtZVRpbWUgPSAwXHJcbiAgbGFzdFRpbWUgPSB0aW1lXHJcblxyXG4gIHJldHVybiBzdGFydFRpbWVcclxufVxyXG5cclxuY29uc3QgdGljayA9ICh0aW1lOiBudW1iZXIpID0+IHtcclxuICBpZiAoIXJ1bm5pbmcpIHJldHVyblxyXG5cclxuICBzdGFydFRpbWUgPSBpbml0VGljayh0aW1lKVxyXG4gIGVsYXBzZWQgPSB0aW1lIC0gc3RhcnRUaW1lXHJcbiAgZnJhbWVUaW1lID0gdGltZSAtIGxhc3RUaW1lXHJcbiAgbGFzdFRpbWUgPSB0aW1lXHJcblxyXG4gIGlmKCBjdXJyZW50U2NlbmUgKSBjdXJyZW50U2NlbmUudXBkYXRlKHN0YXRlKVxyXG4gIFxyXG4gIC8vIHNjZW5lIG1heSBoYXZlIHNlbnQgYSBxdWl0IHNpZ25hbFxyXG4gIGlmICghcnVubmluZykge1xyXG4gICAgaGFsdCgpXHJcblxyXG4gICAgcmV0dXJuXHJcbiAgfVxyXG5cclxuICAvLyByZW5kZXJcclxuXHJcbiAgZnJhbWVDdHgucHV0SW1hZ2VEYXRhKGZyYW1lQnVmZmVyLCAwLCAwKVxyXG5cclxuICAvLyBkZWJ1Z1xyXG5cclxuICBpZiAoIWRlYnVnKSB7XHJcbiAgICByYWZJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKVxyXG4gICAgcmV0dXJuXHJcbiAgfVxyXG5cclxuICBmcmFtZUN0eC5maWxsU3R5bGUgPSBgcmdiYSgwLDAsMCwwLjUpYFxyXG4gIGZyYW1lQ3R4LmZpbGxSZWN0KDAsIDAsIDEwMCwgMzMpXHJcblxyXG4gIGZyYW1lQ3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJ1xyXG4gIGZyYW1lQ3R4LmZvbnQgPSBgMTBweCBtb25vc3BhY2VgXHJcblxyXG4gIGxldCBtb3VzZUJ0blN0YXRlID0gJydcclxuXHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyBpKyspIHtcclxuICAgIG1vdXNlQnRuU3RhdGUgKz0gbW91c2VCdXR0b25zW2ldID8gYCR7aX1gIDogJy0nXHJcbiAgfVxyXG5cclxuICBsZXQga2V5U3RhdGUgPSAnJ1xyXG5cclxuICBrZXlTdGF0ZSArPSAoa2V5c1snVyddIHx8IGtleXNbJ3cnXSA/ICdXJyA6ICctJylcclxuICBrZXlTdGF0ZSArPSAoa2V5c1snQSddIHx8IGtleXNbJ2EnXSA/ICdBJyA6ICctJylcclxuICBrZXlTdGF0ZSArPSAoa2V5c1snUyddIHx8IGtleXNbJ3MnXSA/ICdTJyA6ICctJylcclxuICBrZXlTdGF0ZSArPSAoa2V5c1snRCddIHx8IGtleXNbJ2QnXSA/ICdEJyA6ICctJylcclxuXHJcbiAgY29uc3QgZnBzID0gTWF0aC5yb3VuZCgxMDAwIC8gZnJhbWVUaW1lKVxyXG5cclxuICBjb25zdCBjdXJzb3JTdGF0ZSA9IHVzZVN5c3RlbU1vdXNlID8gJyBPTicgOiAnT0ZGJ1xyXG5cclxuICBmcmFtZUN0eC5maWxsVGV4dChgJHtmcHN9IGZwcyAoJHtmcmFtZVRpbWUudG9GaXhlZCgxKX0pYCwgMSwgMTEpXHJcbiAgZnJhbWVDdHguZmlsbFRleHQoXHJcbiAgICBgJHttb3VzZUJ0blN0YXRlfSAke2N1cnNvclN0YXRlfSAke2ZyYW1lTW91c2VYfSwgJHtmcmFtZU1vdXNlWX1gLCAxLCAyMVxyXG4gIClcclxuICBmcmFtZUN0eC5maWxsVGV4dChgJHtrZXlTdGF0ZX1gLCAxLCAzMSlcclxuXHJcbiAgLy9cclxuXHJcbiAgcmFmSWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGljaylcclxufVxyXG4iXX0=
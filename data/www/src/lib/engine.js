import { createImage } from './image/create.js';
import { wait } from './util.js';
// chonkpix
// a stupidly simple chonky pixel engine
// private state:
let currentScene;
// misc 
let running = false;
let rafId;
// io
const keys = {};
let keyPresses = [];
let viewMouseX = 0;
let viewMouseY = 0;
let useSystemMouse = true;
let cursorInBounds = true;
let frameMouseX = 0;
let frameMouseY = 0;
let mouseWheelDelta = 0;
const mouseButtons = {};
// sound
// todo - plug in a small sound library like ZzFX or similar
// time
let startTime = null;
let lastTime;
let elapsed;
let frameTime;
// view
const minZoom = 2;
const maxZoom = 16;
let zoom = 5;
let frameW;
let frameH;
let frameBuffer;
let frameCanvas;
let frameCtx;
// public state
const state = {
    // expose keys directly, that way the consumer can make decisions like
    // clearing the key state after reading etc
    getKeys: () => keys,
    getKeyPresses: () => keyPresses,
    mouse: {
        getButtons: () => mouseButtons,
        getX: () => frameMouseX,
        getY: () => frameMouseY,
        getWheel: () => {
            // destructive read
            // otherwise the delta is retained from frame to frame
            // we could have made it so the consumer can explicitly clear it after use
            // or choose to use it, but we have no use case for
            const value = mouseWheelDelta;
            mouseWheelDelta = 0;
            return value;
        },
        isInBounds: () => cursorInBounds
    },
    time: {
        getElapsed: () => elapsed,
        getFrameTime: () => frameTime
    },
    view: {
        getZoom: () => zoom,
        setZoom: (value) => {
            zoom = Math.max(minZoom, Math.min(maxZoom, value));
            resize();
        },
        getBuffer: () => frameBuffer
    },
    getRunning: () => running,
    setRunning: (value) => {
        running = value;
    }
};
// event handlers:
const preventDefaults = new Set(['Tab']);
const keyDown = (event) => {
    keys[event.key] = true;
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const keyUp = (event) => {
    keys[event.key] = false;
    // forward non-printable keys to keyPress
    if (event.key === 'Backspace') {
        keyPress(event);
        return;
    }
    // any others in future
    // 
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const keyPress = (event) => {
    keyPresses.push(event.key);
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const mouseMove = (event) => {
    viewMouseX = event.clientX;
    viewMouseY = event.clientY;
    frameMouseX = Math.floor(viewMouseX / zoom);
    frameMouseY = Math.floor(viewMouseY / zoom);
};
const mouseWheel = (event) => {
    mouseWheelDelta = event.deltaY;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseButtonDown = (event) => {
    mouseButtons[event.button] = true;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseButtonUp = (event) => {
    mouseButtons[event.button] = false;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const preventContextDefault = (event) => {
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseLeave = () => {
    cursorInBounds = false;
};
const mouseEnter = () => {
    cursorInBounds = true;
};
const resize = () => {
    frameW = Math.floor(innerWidth / zoom);
    frameH = Math.floor(innerHeight / zoom);
    frameBuffer = createImage(frameW, frameH);
    frameCanvas.width = frameW;
    frameCanvas.height = frameH;
};
// mouse control:
export const releaseMouse = () => {
    useSystemMouse = true;
    frameCanvas.classList.toggle('hide-cursor', false);
};
export const takeMouse = () => {
    useSystemMouse = false;
    frameCanvas.classList.toggle('hide-cursor', true);
};
// hard render
export const render = async () => {
    frameCtx.putImageData(frameBuffer, 0, 0);
    await wait();
};
// runner:
// initialise the engine with a scene
export const start = async (scene) => {
    // if it already has a scene, halt it first
    if (currentScene)
        halt();
    currentScene = scene;
    if (frameCanvas)
        frameCanvas.remove();
    frameCanvas = document.createElement('canvas');
    frameCanvas.id = 'viewport';
    frameCanvas.tabIndex = 0;
    document.body.append(frameCanvas);
    frameCanvas.focus();
    frameCtx = frameCanvas.getContext('2d');
    resize();
    addEventListener('resize', resize);
    frameCanvas.addEventListener('keydown', keyDown);
    frameCanvas.addEventListener('keyup', keyUp);
    frameCanvas.addEventListener('keypress', keyPress);
    frameCanvas.addEventListener('mousemove', mouseMove);
    frameCanvas.addEventListener('wheel', mouseWheel);
    frameCanvas.addEventListener('mousedown', mouseButtonDown);
    frameCanvas.addEventListener('mouseup', mouseButtonUp);
    frameCanvas.addEventListener('contextmenu', preventContextDefault);
    frameCanvas.addEventListener('mouseleave', mouseLeave);
    frameCanvas.addEventListener('mouseenter', mouseEnter);
    running = true;
    await scene.init(state);
    rafId = requestAnimationFrame(tick);
};
// tidy everything up
const halt = () => {
    running = false;
    cancelAnimationFrame(rafId);
    removeEventListener('resize', resize);
    frameCanvas.removeEventListener('keydown', keyDown);
    frameCanvas.removeEventListener('keyup', keyUp);
    frameCanvas.removeEventListener('keypress', keyPress);
    frameCanvas.removeEventListener('mousemove', mouseMove);
    frameCanvas.removeEventListener('wheel', mouseWheel);
    frameCanvas.removeEventListener('mousedown', mouseButtonDown);
    frameCanvas.removeEventListener('mouseup', mouseButtonUp);
    frameCanvas.removeEventListener('contextmenu', preventContextDefault);
    frameCanvas.removeEventListener('mouseleave', mouseLeave);
    frameCanvas.removeEventListener('mouseenter', mouseEnter);
    frameCanvas.remove();
    startTime = null;
    releaseMouse();
    if (currentScene) {
        currentScene.quit(state).catch(console.error);
        currentScene = null;
    }
};
const initTick = (time) => {
    if (startTime !== null)
        return startTime;
    // first tick
    startTime = time;
    elapsed = 0;
    frameTime = 0;
    lastTime = time;
    return startTime;
};
const tick = (time) => {
    if (!running)
        return;
    startTime = initTick(time);
    elapsed = time - startTime;
    frameTime = time - lastTime;
    lastTime = time;
    if (currentScene)
        currentScene.update(state);
    // scene may have sent a quit signal
    if (!running) {
        halt();
        return;
    }
    // render
    frameCtx.putImageData(frameBuffer, 0, 0);
    //
    rafId = requestAnimationFrame(tick);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9lbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBRS9DLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFFaEMsV0FBVztBQUNYLHdDQUF3QztBQUV4QyxpQkFBaUI7QUFFakIsSUFBSSxZQUEwQixDQUFBO0FBRTlCLFFBQVE7QUFFUixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUE7QUFDbkIsSUFBSSxLQUFhLENBQUE7QUFFakIsS0FBSztBQUVMLE1BQU0sSUFBSSxHQUE0QixFQUFFLENBQUE7QUFDeEMsSUFBSSxVQUFVLEdBQWEsRUFBRSxDQUFBO0FBRTdCLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQTtBQUNsQixJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUE7QUFFbEIsSUFBSSxjQUFjLEdBQUcsSUFBSSxDQUFBO0FBQ3pCLElBQUksY0FBYyxHQUFHLElBQUksQ0FBQTtBQUN6QixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUE7QUFDbkIsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFBO0FBRW5CLElBQUksZUFBZSxHQUFHLENBQUMsQ0FBQTtBQUV2QixNQUFNLFlBQVksR0FBNEIsRUFBRSxDQUFBO0FBRWhELFFBQVE7QUFDUiw0REFBNEQ7QUFFNUQsT0FBTztBQUVQLElBQUksU0FBUyxHQUFrQixJQUFJLENBQUE7QUFDbkMsSUFBSSxRQUFnQixDQUFBO0FBQ3BCLElBQUksT0FBZSxDQUFBO0FBQ25CLElBQUksU0FBaUIsQ0FBQTtBQUVyQixPQUFPO0FBRVAsTUFBTSxPQUFPLEdBQUcsQ0FBQyxDQUFBO0FBQ2pCLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQTtBQUVsQixJQUFJLElBQUksR0FBRyxDQUFDLENBQUE7QUFFWixJQUFJLE1BQWMsQ0FBQTtBQUNsQixJ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LENBQUE7SUFFZixJQUFJLFlBQVk7UUFBRSxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBRTVDLG9DQUFvQztJQUNwQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDYixJQUFJLEVBQUUsQ0FBQTtRQUVOLE9BQU07SUFDUixDQUFDO0lBRUQsU0FBUztJQUVULFFBQVEsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUV4QyxFQUFFO0lBRUYsS0FBSyxHQUFHLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFBO0FBQ3JDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZUltYWdlIH0gZnJvbSAnLi9pbWFnZS9jcmVhdGUuanMnXHJcbmltcG9ydCB7IE1heWJlLCBTY2VuZSwgU3RhdGUgfSBmcm9tICcuL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyB3YWl0IH0gZnJvbSAnLi91dGlsLmpzJ1xyXG5cclxuLy8gY2hvbmtwaXhcclxuLy8gYSBzdHVwaWRseSBzaW1wbGUgY2hvbmt5IHBpeGVsIGVuZ2luZVxyXG5cclxuLy8gcHJpdmF0ZSBzdGF0ZTpcclxuXHJcbmxldCBjdXJyZW50U2NlbmU6IE1heWJlPFNjZW5lPlxyXG5cclxuLy8gbWlzYyBcclxuXHJcbmxldCBydW5uaW5nID0gZmFsc2VcclxubGV0IHJhZklkOiBudW1iZXJcclxuXHJcbi8vIGlvXHJcblxyXG5jb25zdCBrZXlzOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPiA9IHt9XHJcbmxldCBrZXlQcmVzc2VzOiBzdHJpbmdbXSA9IFtdXHJcblxyXG5sZXQgdmlld01vdXNlWCA9IDBcclxubGV0IHZpZXdNb3VzZVkgPSAwXHJcblxyXG5sZXQgdXNlU3lzdGVtTW91c2UgPSB0cnVlXHJcbmxldCBjdXJzb3JJbkJvdW5kcyA9IHRydWVcclxubGV0IGZyYW1lTW91c2VYID0gMFxyXG5sZXQgZnJhbWVNb3VzZVkgPSAwXHJcblxyXG5sZXQgbW91c2VXaGVlbERlbHRhID0gMFxyXG5cclxuY29uc3QgbW91c2VCdXR0b25zOiBSZWNvcmQ8bnVtYmVyLCBib29sZWFuPiA9IHt9XHJcblxyXG4vLyBzb3VuZFxyXG4vLyB0b2RvIC0gcGx1ZyBpbiBhIHNtYWxsIHNvdW5kIGxpYnJhcnkgbGlrZSBaekZYIG9yIHNpbWlsYXJcclxuXHJcbi8vIHRpbWVcclxuXHJcbmxldCBzdGFydFRpbWU6IG51bWJlciB8IG51bGwgPSBudWxsXHJcbmxldCBsYXN0VGltZTogbnVtYmVyXHJcbmxldCBlbGFwc2VkOiBudW1iZXJcclxubGV0IGZyYW1lVGltZTogbnVtYmVyXHJcblxyXG4vLyB2aWV3XHJcblxyXG5jb25zdCBtaW5ab29tID0gMlxyXG5jb25zdCBtYXhab29tID0gMTZcclxuXHJcbmxldCB6b29tID0gNVxyXG5cclxubGV0IGZyYW1lVzogbnVtYmVyXHJcbmxldCBmcmFtZUg6IG51bWJlclxyXG5sZXQgZnJhbWVCdWZmZXI6IEltYWdlRGF0YVxyXG5sZXQgZnJhbWVDYW52YXM6IEhUTUxDYW52YXNFbGVtZW50XHJcbmxldCBmcmFtZUN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEXHJcblxyXG4vLyBwdWJsaWMgc3RhdGVcclxuXHJcbmNvbnN0IHN0YXRlOiBTdGF0ZSA9IHtcclxuICAvLyBleHBvc2Uga2V5cyBkaXJlY3RseSwgdGhhdCB3YXkgdGhlIGNvbnN1bWVyIGNhbiBtYWtlIGRlY2lzaW9ucyBsaWtlXHJcbiAgLy8gY2xlYXJpbmcgdGhlIGtleSBzdGF0ZSBhZnRlciByZWFkaW5nIGV0Y1xyXG4gIGdldEtleXM6ICgpID0+IGtleXMsXHJcbiAgZ2V0S2V5UHJlc3NlczogKCkgPT4ga2V5UHJlc3NlcyxcclxuXHJcbiAgbW91c2U6IHtcclxuICAgIGdldEJ1dHRvbnM6ICgpID0+IG1vdXNlQnV0dG9ucyxcclxuICAgIGdldFg6ICgpID0+IGZyYW1lTW91c2VYLFxyXG4gICAgZ2V0WTogKCkgPT4gZnJhbWVNb3VzZVksXHJcbiAgICBnZXRXaGVlbDogKCkgPT4ge1xyXG4gICAgICAvLyBkZXN0cnVjdGl2ZSByZWFkXHJcbiAgICAgIC8vIG90aGVyd2lzZSB0aGUgZGVsdGEgaXMgcmV0YWluZWQgZnJvbSBmcmFtZSB0byBmcmFtZVxyXG4gICAgICAvLyB3ZSBjb3VsZCBoYXZlIG1hZGUgaXQgc28gdGhlIGNvbnN1bWVyIGNhbiBleHBsaWNpdGx5IGNsZWFyIGl0IGFmdGVyIHVzZVxyXG4gICAgICAvLyBvciBjaG9vc2UgdG8gdXNlIGl0LCBidXQgd2UgaGF2ZSBubyB1c2UgY2FzZSBmb3JcclxuICAgICAgY29uc3QgdmFsdWUgPSBtb3VzZVdoZWVsRGVsdGFcclxuXHJcbiAgICAgIG1vdXNlV2hlZWxEZWx0YSA9IDBcclxuXHJcbiAgICAgIHJldHVybiB2YWx1ZVxyXG4gICAgfSxcclxuICAgIGlzSW5Cb3VuZHM6ICgpID0+IGN1cnNvckluQm91bmRzXHJcbiAgfSxcclxuXHJcbiAgdGltZToge1xyXG4gICAgZ2V0RWxhcHNlZDogKCkgPT4gZWxhcHNlZCxcclxuICAgIGdldEZyYW1lVGltZTogKCkgPT4gZnJhbWVUaW1lXHJcbiAgfSxcclxuXHJcbiAgdmlldzoge1xyXG4gICAgZ2V0Wm9vbTogKCkgPT4gem9vbSxcclxuICAgIHNldFpvb206ICh2YWx1ZTogbnVtYmVyKSA9PiB7XHJcbiAgICAgIHpvb20gPSBNYXRoLm1heChtaW5ab29tLCBNYXRoLm1pbihtYXhab29tLCB2YWx1ZSkpXHJcbiAgICAgIHJlc2l6ZSgpXHJcbiAgICB9LFxyXG4gICAgZ2V0QnVmZmVyOiAoKSA9PiBmcmFtZUJ1ZmZlclxyXG4gIH0sXHJcblxyXG4gIGdldFJ1bm5pbmc6ICgpID0+IHJ1bm5pbmcsXHJcbiAgc2V0UnVubmluZzogKHZhbHVlOiBib29sZWFuKSA9PiB7XHJcbiAgICBydW5uaW5nID0gdmFsdWVcclxuICB9XHJcbn1cclxuXHJcbi8vIGV2ZW50IGhhbmRsZXJzOlxyXG5cclxuY29uc3QgcHJldmVudERlZmF1bHRzID0gbmV3IFNldDxzdHJpbmc+KFsnVGFiJ10pXHJcblxyXG5jb25zdCBrZXlEb3duID0gKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XHJcbiAga2V5c1tldmVudC5rZXldID0gdHJ1ZVxyXG5cclxuICBpZiAocHJldmVudERlZmF1bHRzLmhhcyhldmVudC5rZXkpKSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXHJcblxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBrZXlVcCA9IChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gIGtleXNbZXZlbnQua2V5XSA9IGZhbHNlXHJcblxyXG4gIC8vIGZvcndhcmQgbm9uLXByaW50YWJsZSBrZXlzIHRvIGtleVByZXNzXHJcbiAgaWYgKGV2ZW50LmtleSA9PT0gJ0JhY2tzcGFjZScpIHtcclxuICAgIGtleVByZXNzKGV2ZW50KVxyXG5cclxuICAgIHJldHVyblxyXG4gIH1cclxuXHJcbiAgLy8gYW55IG90aGVycyBpbiBmdXR1cmVcclxuXHJcbiAgLy8gXHJcblxyXG4gIGlmIChwcmV2ZW50RGVmYXVsdHMuaGFzKGV2ZW50LmtleSkpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcclxuXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IGtleVByZXNzID0gKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XHJcbiAga2V5UHJlc3Nlcy5wdXNoKGV2ZW50LmtleSlcclxuXHJcbiAgaWYgKHByZXZlbnREZWZhdWx0cy5oYXMoZXZlbnQua2V5KSkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxyXG5cclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuY29uc3QgbW91c2VNb3ZlID0gKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgdmlld01vdXNlWCA9IGV2ZW50LmNsaWVudFhcclxuICB2aWV3TW91c2VZID0gZXZlbnQuY2xpZW50WVxyXG5cclxuICBmcmFtZU1vdXNlWCA9IE1hdGguZmxvb3Iodmlld01vdXNlWCAvIHpvb20pXHJcbiAgZnJhbWVNb3VzZVkgPSBNYXRoLmZsb29yKHZpZXdNb3VzZVkgLyB6b29tKVxyXG59XHJcblxyXG5jb25zdCBtb3VzZVdoZWVsID0gKGV2ZW50OiBXaGVlbEV2ZW50KSA9PiB7XHJcbiAgbW91c2VXaGVlbERlbHRhID0gZXZlbnQuZGVsdGFZXHJcblxyXG4gIGlmICghdXNlU3lzdGVtTW91c2UpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcclxuXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IG1vdXNlQnV0dG9uRG93biA9IChldmVudDogTW91c2VFdmVudCkgPT4ge1xyXG4gIG1vdXNlQnV0dG9uc1tldmVudC5idXR0b25dID0gdHJ1ZVxyXG5cclxuICBpZiAoIXVzZVN5c3RlbU1vdXNlKSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXHJcblxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBtb3VzZUJ1dHRvblVwID0gKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgbW91c2VCdXR0b25zW2V2ZW50LmJ1dHRvbl0gPSBmYWxzZVxyXG5cclxuICBpZiAoIXVzZVN5c3RlbU1vdXNlKSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXHJcblxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBwcmV2ZW50Q29udGV4dERlZmF1bHQgPSAoZXZlbnQ6IEV2ZW50KSA9PiB7XHJcbiAgaWYgKCF1c2VTeXN0ZW1Nb3VzZSkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxyXG5cclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuY29uc3QgbW91c2VMZWF2ZSA9ICgpID0+IHtcclxuICBjdXJzb3JJbkJvdW5kcyA9IGZhbHNlXHJcbn1cclxuXHJcbmNvbnN0IG1vdXNlRW50ZXIgPSAoKSA9PiB7XHJcbiAgY3Vyc29ySW5Cb3VuZHMgPSB0cnVlXHJcbn1cclxuXHJcbmNvbnN0IHJlc2l6ZSA9ICgpID0+IHtcclxuICBmcmFtZVcgPSBNYXRoLmZsb29yKGlubmVyV2lkdGggLyB6b29tKVxyXG4gIGZyYW1lSCA9IE1hdGguZmxvb3IoaW5uZXJIZWlnaHQgLyB6b29tKVxyXG5cclxuICBmcmFtZUJ1ZmZlciA9IGNyZWF0ZUltYWdlKGZyYW1lVywgZnJhbWVIKVxyXG5cclxuICBmcmFtZUNhbnZhcy53aWR0aCA9IGZyYW1lV1xyXG4gIGZyYW1lQ2FudmFzLmhlaWdodCA9IGZyYW1lSFxyXG59XHJcblxyXG4vLyBtb3VzZSBjb250cm9sOlxyXG5cclxuZXhwb3J0IGNvbnN0IHJlbGVhc2VNb3VzZSA9ICgpID0+IHtcclxuICB1c2VTeXN0ZW1Nb3VzZSA9IHRydWVcclxuICBmcmFtZUNhbnZhcy5jbGFzc0xpc3QudG9nZ2xlKCdoaWRlLWN1cnNvcicsIGZhbHNlKVxyXG59XHJcblxyXG5leHBvcnQgY29uc3QgdGFrZU1vdXNlID0gKCkgPT4ge1xyXG4gIHVzZVN5c3RlbU1vdXNlID0gZmFsc2VcclxuICBmcmFtZUNhbnZhcy5jbGFzc0xpc3QudG9nZ2xlKCdoaWRlLWN1cnNvcicsIHRydWUpXHJcbn1cclxuXHJcbi8vIGhhcmQgcmVuZGVyXHJcblxyXG5leHBvcnQgY29uc3QgcmVuZGVyID0gYXN5bmMgKCkgPT4ge1xyXG4gIGZyYW1lQ3R4LnB1dEltYWdlRGF0YShmcmFtZUJ1ZmZlciwgMCwgMClcclxuXHJcbiAgYXdhaXQgd2FpdCgpXHJcbn1cclxuXHJcbi8vIHJ1bm5lcjpcclxuXHJcbi8vIGluaXRpYWxpc2UgdGhlIGVuZ2luZSB3aXRoIGEgc2NlbmVcclxuZXhwb3J0IGNvbnN0IHN0YXJ0ID0gYXN5bmMgKHNjZW5lOiBTY2VuZSkgPT4ge1xyXG4gIC8vIGlmIGl0IGFscmVhZHkgaGFzIGEgc2NlbmUsIGhhbHQgaXQgZmlyc3RcclxuICBpZiAoY3VycmVudFNjZW5lKSBoYWx0KClcclxuXHJcbiAgY3VycmVudFNjZW5lID0gc2NlbmVcclxuXHJcbiAgaWYgKGZyYW1lQ2FudmFzKSBmcmFtZUNhbnZhcy5yZW1vdmUoKVxyXG5cclxuICBmcmFtZUNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpXHJcbiAgZnJhbWVDYW52YXMuaWQgPSAndmlld3BvcnQnXHJcbiAgZnJhbWVDYW52YXMudGFiSW5kZXggPSAwXHJcblxyXG4gIGRvY3VtZW50LmJvZHkuYXBwZW5kKGZyYW1lQ2FudmFzKVxyXG5cclxuICBmcmFtZUNhbnZhcy5mb2N1cygpXHJcblxyXG4gIGZyYW1lQ3R4ID0gZnJhbWVDYW52YXMuZ2V0Q29udGV4dCgnMmQnKSFcclxuXHJcbiAgcmVzaXplKClcclxuXHJcbiAgYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgcmVzaXplKVxyXG5cclxuICBmcmFtZUNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5RG93bilcclxuICBmcmFtZUNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIGtleVVwKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ2tleXByZXNzJywga2V5UHJlc3MpXHJcblxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdXNlTW92ZSlcclxuICBmcmFtZUNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCd3aGVlbCcsIG1vdXNlV2hlZWwpXHJcbiAgZnJhbWVDYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgbW91c2VCdXR0b25Eb3duKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBtb3VzZUJ1dHRvblVwKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgcHJldmVudENvbnRleHREZWZhdWx0KVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBtb3VzZUxlYXZlKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCBtb3VzZUVudGVyKVxyXG5cclxuICBydW5uaW5nID0gdHJ1ZVxyXG5cclxuICBhd2FpdCBzY2VuZS5pbml0KHN0YXRlKVxyXG5cclxuICByYWZJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKVxyXG59XHJcblxyXG4vLyB0aWR5IGV2ZXJ5dGhpbmcgdXBcclxuY29uc3QgaGFsdCA9ICgpID0+IHtcclxuICBydW5uaW5nID0gZmFsc2VcclxuICBjYW5jZWxBbmltYXRpb25GcmFtZShyYWZJZClcclxuXHJcbiAgcmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgcmVzaXplKVxyXG5cclxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5RG93bilcclxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXl1cCcsIGtleVVwKVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXByZXNzJywga2V5UHJlc3MpXHJcblxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdXNlTW92ZSlcclxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd3aGVlbCcsIG1vdXNlV2hlZWwpXHJcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgbW91c2VCdXR0b25Eb3duKVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBtb3VzZUJ1dHRvblVwKVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgcHJldmVudENvbnRleHREZWZhdWx0KVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBtb3VzZUxlYXZlKVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCBtb3VzZUVudGVyKVxyXG5cclxuICBmcmFtZUNhbnZhcy5yZW1vdmUoKVxyXG5cclxuICBzdGFydFRpbWUgPSBudWxsXHJcblxyXG4gIHJlbGVhc2VNb3VzZSgpXHJcblxyXG4gIGlmIChjdXJyZW50U2NlbmUpIHtcclxuICAgIGN1cnJlbnRTY2VuZS5xdWl0KHN0YXRlKS5jYXRjaChjb25zb2xlLmVycm9yKVxyXG5cclxuICAgIGN1cnJlbnRTY2VuZSA9IG51bGxcclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IGluaXRUaWNrID0gKHRpbWU6IG51bWJlcikgPT4ge1xyXG4gIGlmIChzdGFydFRpbWUgIT09IG51bGwpIHJldHVybiBzdGFydFRpbWVcclxuXHJcbiAgLy8gZmlyc3QgdGlja1xyXG5cclxuICBzdGFydFRpbWUgPSB0aW1lXHJcblxyXG4gIGVsYXBzZWQgPSAwXHJcbiAgZnJhbWVUaW1lID0gMFxyXG4gIGxhc3RUaW1lID0gdGltZVxyXG5cclxuICByZXR1cm4gc3RhcnRUaW1lXHJcbn1cclxuXHJcbmNvbnN0IHRpY2sgPSAodGltZTogbnVtYmVyKSA9PiB7XHJcbiAgaWYgKCFydW5uaW5nKSByZXR1cm5cclxuXHJcbiAgc3RhcnRUaW1lID0gaW5pdFRpY2sodGltZSlcclxuICBlbGFwc2VkID0gdGltZSAtIHN0YXJ0VGltZVxyXG4gIGZyYW1lVGltZSA9IHRpbWUgLSBsYXN0VGltZVxyXG4gIGxhc3RUaW1lID0gdGltZVxyXG5cclxuICBpZiAoY3VycmVudFNjZW5lKSBjdXJyZW50U2NlbmUudXBkYXRlKHN0YXRlKVxyXG5cclxuICAvLyBzY2VuZSBtYXkgaGF2ZSBzZW50IGEgcXVpdCBzaWduYWxcclxuICBpZiAoIXJ1bm5pbmcpIHtcclxuICAgIGhhbHQoKVxyXG5cclxuICAgIHJldHVyblxyXG4gIH1cclxuXHJcbiAgLy8gcmVuZGVyXHJcblxyXG4gIGZyYW1lQ3R4LnB1dEltYWdlRGF0YShmcmFtZUJ1ZmZlciwgMCwgMClcclxuXHJcbiAgLy9cclxuXHJcbiAgcmFmSWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGljaylcclxufVxyXG4iXX0=
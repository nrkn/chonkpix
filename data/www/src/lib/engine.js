import { createImage } from './image/create.js';
// chonkpix
// a stupidly simple chonky pixel engine
// private state:
let currentScene;
// misc 
let running = false;
let rafId;
let isReady = false;
// io
const keys = {};
let keyPresses = [];
let viewMouseX = 0;
let viewMouseY = 0;
let useSystemMouse = true;
let cursorInBounds = true;
let frameMouseX = 0;
let frameMouseY = 0;
let mouseWheelDelta = 0;
const mouseButtons = {};
// sound
// todo - plug in a small sound library like ZzFX or similar
// time
let startTime = null;
let lastTime;
let elapsed;
let frameTime;
// view
const minZoom = 2;
const maxZoom = 16;
let zoom = 5;
let frameW;
let frameH;
let frameBuffer;
let frameCanvas;
let frameCtx;
// public state
const state = {
    // expose keys directly, that way the consumer can make decisions like
    // clearing the key state after reading etc
    getKeys: () => keys,
    getKeyPresses: () => keyPresses,
    mouse: {
        getButtons: () => mouseButtons,
        getX: () => frameMouseX,
        getY: () => frameMouseY,
        takeWheel: () => {
            // destructive read
            // otherwise the delta is retained from frame to frame
            // we could have made it so the consumer can explicitly clear it after use
            // or choose to use it, but we have no use case for
            const value = mouseWheelDelta;
            mouseWheelDelta = 0;
            return value;
        },
        isInBounds: () => cursorInBounds
    },
    time: {
        getElapsed: () => elapsed,
        getFrameTime: () => frameTime
    },
    view: {
        getZoom: () => zoom,
        setZoom: (value) => {
            zoom = Math.max(minZoom, Math.min(maxZoom, value));
            resize();
        },
        getBuffer: () => frameBuffer
    },
    getRunning: () => running,
    setRunning: (value) => {
        running = value;
    }
};
// event handlers:
const preventDefaults = new Set(['Tab']);
const keyDown = (event) => {
    keys[event.key] = true;
    keyPresses.push(event.key);
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const keyUp = (event) => {
    keys[event.key] = false;
    // any others in future
    // 
    if (preventDefaults.has(event.key)) {
        event.preventDefault();
        return false;
    }
};
const mouseMove = (event) => {
    viewMouseX = event.clientX;
    viewMouseY = event.clientY;
    frameMouseX = Math.floor(viewMouseX / zoom);
    frameMouseY = Math.floor(viewMouseY / zoom);
};
const mouseWheel = (event) => {
    mouseWheelDelta = event.deltaY;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseButtonDown = (event) => {
    mouseButtons[event.button] = true;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseButtonUp = (event) => {
    mouseButtons[event.button] = false;
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const preventContextDefault = (event) => {
    if (!useSystemMouse) {
        event.preventDefault();
        return false;
    }
};
const mouseLeave = () => {
    cursorInBounds = false;
};
const mouseEnter = () => {
    cursorInBounds = true;
};
const resize = () => {
    frameW = Math.floor(innerWidth / zoom);
    frameH = Math.floor(innerHeight / zoom);
    frameBuffer = createImage(frameW, frameH);
    frameCanvas.width = frameW;
    frameCanvas.height = frameH;
};
// mouse control:
export const releaseMouse = () => {
    useSystemMouse = true;
    frameCanvas.classList.toggle('hide-cursor', false);
};
export const takeMouse = () => {
    useSystemMouse = false;
    frameCanvas.classList.toggle('hide-cursor', true);
};
// runner:
// initialise the engine with a scene
export const start = async (scene) => {
    // if it already has a scene, halt it first
    if (currentScene)
        halt();
    currentScene = scene;
    if (frameCanvas)
        frameCanvas.remove();
    frameCanvas = document.createElement('canvas');
    frameCanvas.id = 'viewport';
    frameCanvas.tabIndex = 0;
    document.body.append(frameCanvas);
    frameCanvas.focus();
    frameCtx = frameCanvas.getContext('2d');
    resize();
    addEventListener('resize', resize);
    frameCanvas.addEventListener('keydown', keyDown);
    frameCanvas.addEventListener('keyup', keyUp);
    frameCanvas.addEventListener('mousemove', mouseMove);
    frameCanvas.addEventListener('wheel', mouseWheel);
    frameCanvas.addEventListener('mousedown', mouseButtonDown);
    frameCanvas.addEventListener('mouseup', mouseButtonUp);
    frameCanvas.addEventListener('contextmenu', preventContextDefault);
    frameCanvas.addEventListener('mouseleave', mouseLeave);
    frameCanvas.addEventListener('mouseenter', mouseEnter);
    running = true;
    rafId = requestAnimationFrame(tick);
    await scene.init(state);
    isReady = true;
};
// tidy everything up
const halt = () => {
    running = false;
    isReady = false;
    cancelAnimationFrame(rafId);
    removeEventListener('resize', resize);
    frameCanvas.removeEventListener('keydown', keyDown);
    frameCanvas.removeEventListener('keyup', keyUp);
    frameCanvas.removeEventListener('mousemove', mouseMove);
    frameCanvas.removeEventListener('wheel', mouseWheel);
    frameCanvas.removeEventListener('mousedown', mouseButtonDown);
    frameCanvas.removeEventListener('mouseup', mouseButtonUp);
    frameCanvas.removeEventListener('contextmenu', preventContextDefault);
    frameCanvas.removeEventListener('mouseleave', mouseLeave);
    frameCanvas.removeEventListener('mouseenter', mouseEnter);
    frameCanvas.remove();
    startTime = null;
    releaseMouse();
    if (currentScene) {
        currentScene.quit(state).catch(console.error);
        currentScene = null;
    }
};
const initTick = (time) => {
    if (startTime !== null)
        return startTime;
    // first tick
    startTime = time;
    elapsed = 0;
    frameTime = 0;
    lastTime = time;
    return startTime;
};
const tick = (time) => {
    if (!running)
        return;
    startTime = initTick(time);
    elapsed = time - startTime;
    frameTime = time - lastTime;
    lastTime = time;
    if (currentScene && isReady)
        currentScene.update(state);
    // scene may have sent a quit signal
    if (!running) {
        halt();
        return;
    }
    // render
    frameCtx.putImageData(frameBuffer, 0, 0);
    //
    rafId = requestAnimationFrame(tick);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9lbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBSS9DLFdBQVc7QUFDWCx3Q0FBd0M7QUFFeEMsaUJBQWlCO0FBRWpCLElBQUksWUFBMEIsQ0FBQTtBQUU5QixRQUFRO0FBRVIsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFBO0FBQ25CLElBQUksS0FBYSxDQUFBO0FBQ2pCLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQTtBQUVuQixLQUFLO0FBRUwsTUFBTSxJQUFJLEdBQTRCLEVBQUUsQ0FBQTtBQUN4QyxJQUFJLFVBQVUsR0FBYSxFQUFFLENBQUE7QUFFN0IsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFBO0FBQ2xCLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQTtBQUVsQixJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUE7QUFDekIsSUFBSSxjQUFjLEdBQUcsSUFBSSxDQUFBO0FBQ3pCLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQTtBQUNuQixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUE7QUFFbkIsSUFBSSxlQUFlLEdBQUcsQ0FBQyxDQUFBO0FBRXZCLE1BQU0sWUFBWSxHQUE0QixFQUFFLENBQUE7QUFFaEQsUUFBUTtBQUNSLDREQUE0RDtBQUU1RCxPQUFPO0FBRVAsSUFBSSxTQUFTLEdBQWtCLElBQUksQ0FBQTtBQUNuQyxJQUFJLFFBQWdCLENBQUE7QUFDcEIsSUFBSSxPQUFlLENBQUE7QUFDbkIsSUFBSSxTQUFpQixDQUFBO0FBRXJCLE9BQU87QUFFUCxNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUE7QUFDakIsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFBO0FBRWxCLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQTtBQUVaLElBQUksTUFBYyxDQUFBO0FBQ2xCLElBQUksTUFBYyxD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QUksU0FBUyxLQUFLLElBQUk7UUFBRSxPQUFPLFNBQVMsQ0FBQTtJQUV4QyxhQUFhO0lBRWIsU0FBUyxHQUFHLElBQUksQ0FBQTtJQUVoQixPQUFPLEdBQUcsQ0FBQyxDQUFBO0lBQ1gsU0FBUyxHQUFHLENBQUMsQ0FBQTtJQUNiLFFBQVEsR0FBRyxJQUFJLENBQUE7SUFFZixPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDLENBQUE7QUFFRCxNQUFNLElBQUksR0FBRyxDQUFDLElBQVksRUFBRSxFQUFFO0lBQzVCLElBQUksQ0FBQyxPQUFPO1FBQUUsT0FBTTtJQUVwQixTQUFTLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzFCLE9BQU8sR0FBRyxJQUFJLEdBQUcsU0FBUyxDQUFBO0lBQzFCLFNBQVMsR0FBRyxJQUFJLEdBQUcsUUFBUSxDQUFBO0lBQzNCLFFBQVEsR0FBRyxJQUFJLENBQUE7SUFFZixJQUFJLFlBQVksSUFBSSxPQUFPO1FBQUUsWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUV2RCxvQ0FBb0M7SUFDcEMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2IsSUFBSSxFQUFFLENBQUE7UUFFTixPQUFNO0lBQ1IsQ0FBQztJQUVELFNBQVM7SUFFVCxRQUFRLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFFeEMsRUFBRTtJQUVGLEtBQUssR0FBRyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUNyQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjcmVhdGVJbWFnZSB9IGZyb20gJy4vaW1hZ2UvY3JlYXRlLmpzJ1xyXG5pbXBvcnQgeyBNYXliZSwgU2NlbmUsIFN0YXRlIH0gZnJvbSAnLi90eXBlcy5qcydcclxuaW1wb3J0IHsgd2FpdCB9IGZyb20gJy4vdXRpbC5qcydcclxuXHJcbi8vIGNob25rcGl4XHJcbi8vIGEgc3R1cGlkbHkgc2ltcGxlIGNob25reSBwaXhlbCBlbmdpbmVcclxuXHJcbi8vIHByaXZhdGUgc3RhdGU6XHJcblxyXG5sZXQgY3VycmVudFNjZW5lOiBNYXliZTxTY2VuZT5cclxuXHJcbi8vIG1pc2MgXHJcblxyXG5sZXQgcnVubmluZyA9IGZhbHNlXHJcbmxldCByYWZJZDogbnVtYmVyXHJcbmxldCBpc1JlYWR5ID0gZmFsc2VcclxuXHJcbi8vIGlvXHJcblxyXG5jb25zdCBrZXlzOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPiA9IHt9XHJcbmxldCBrZXlQcmVzc2VzOiBzdHJpbmdbXSA9IFtdXHJcblxyXG5sZXQgdmlld01vdXNlWCA9IDBcclxubGV0IHZpZXdNb3VzZVkgPSAwXHJcblxyXG5sZXQgdXNlU3lzdGVtTW91c2UgPSB0cnVlXHJcbmxldCBjdXJzb3JJbkJvdW5kcyA9IHRydWVcclxubGV0IGZyYW1lTW91c2VYID0gMFxyXG5sZXQgZnJhbWVNb3VzZVkgPSAwXHJcblxyXG5sZXQgbW91c2VXaGVlbERlbHRhID0gMFxyXG5cclxuY29uc3QgbW91c2VCdXR0b25zOiBSZWNvcmQ8bnVtYmVyLCBib29sZWFuPiA9IHt9XHJcblxyXG4vLyBzb3VuZFxyXG4vLyB0b2RvIC0gcGx1ZyBpbiBhIHNtYWxsIHNvdW5kIGxpYnJhcnkgbGlrZSBaekZYIG9yIHNpbWlsYXJcclxuXHJcbi8vIHRpbWVcclxuXHJcbmxldCBzdGFydFRpbWU6IG51bWJlciB8IG51bGwgPSBudWxsXHJcbmxldCBsYXN0VGltZTogbnVtYmVyXHJcbmxldCBlbGFwc2VkOiBudW1iZXJcclxubGV0IGZyYW1lVGltZTogbnVtYmVyXHJcblxyXG4vLyB2aWV3XHJcblxyXG5jb25zdCBtaW5ab29tID0gMlxyXG5jb25zdCBtYXhab29tID0gMTZcclxuXHJcbmxldCB6b29tID0gNVxyXG5cclxubGV0IGZyYW1lVzogbnVtYmVyXHJcbmxldCBmcmFtZUg6IG51bWJlclxyXG5sZXQgZnJhbWVCdWZmZXI6IEltYWdlRGF0YVxyXG5sZXQgZnJhbWVDYW52YXM6IEhUTUxDYW52YXNFbGVtZW50XHJcbmxldCBmcmFtZUN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEXHJcblxyXG4vLyBwdWJsaWMgc3RhdGVcclxuXHJcbmNvbnN0IHN0YXRlOiBTdGF0ZSA9IHtcclxuICAvLyBleHBvc2Uga2V5cyBkaXJlY3RseSwgdGhhdCB3YXkgdGhlIGNvbnN1bWVyIGNhbiBtYWtlIGRlY2lzaW9ucyBsaWtlXHJcbiAgLy8gY2xlYXJpbmcgdGhlIGtleSBzdGF0ZSBhZnRlciByZWFkaW5nIGV0Y1xyXG4gIGdldEtleXM6ICgpID0+IGtleXMsXHJcbiAgZ2V0S2V5UHJlc3NlczogKCkgPT4ga2V5UHJlc3NlcyxcclxuXHJcbiAgbW91c2U6IHtcclxuICAgIGdldEJ1dHRvbnM6ICgpID0+IG1vdXNlQnV0dG9ucyxcclxuICAgIGdldFg6ICgpID0+IGZyYW1lTW91c2VYLFxyXG4gICAgZ2V0WTogKCkgPT4gZnJhbWVNb3VzZVksXHJcbiAgICB0YWtlV2hlZWw6ICgpID0+IHtcclxuICAgICAgLy8gZGVzdHJ1Y3RpdmUgcmVhZFxyXG4gICAgICAvLyBvdGhlcndpc2UgdGhlIGRlbHRhIGlzIHJldGFpbmVkIGZyb20gZnJhbWUgdG8gZnJhbWVcclxuICAgICAgLy8gd2UgY291bGQgaGF2ZSBtYWRlIGl0IHNvIHRoZSBjb25zdW1lciBjYW4gZXhwbGljaXRseSBjbGVhciBpdCBhZnRlciB1c2VcclxuICAgICAgLy8gb3IgY2hvb3NlIHRvIHVzZSBpdCwgYnV0IHdlIGhhdmUgbm8gdXNlIGNhc2UgZm9yXHJcbiAgICAgIGNvbnN0IHZhbHVlID0gbW91c2VXaGVlbERlbHRhXHJcblxyXG4gICAgICBtb3VzZVdoZWVsRGVsdGEgPSAwXHJcblxyXG4gICAgICByZXR1cm4gdmFsdWVcclxuICAgIH0sXHJcbiAgICBpc0luQm91bmRzOiAoKSA9PiBjdXJzb3JJbkJvdW5kc1xyXG4gIH0sXHJcblxyXG4gIHRpbWU6IHtcclxuICAgIGdldEVsYXBzZWQ6ICgpID0+IGVsYXBzZWQsXHJcbiAgICBnZXRGcmFtZVRpbWU6ICgpID0+IGZyYW1lVGltZVxyXG4gIH0sXHJcblxyXG4gIHZpZXc6IHtcclxuICAgIGdldFpvb206ICgpID0+IHpvb20sXHJcbiAgICBzZXRab29tOiAodmFsdWU6IG51bWJlcikgPT4ge1xyXG4gICAgICB6b29tID0gTWF0aC5tYXgobWluWm9vbSwgTWF0aC5taW4obWF4Wm9vbSwgdmFsdWUpKVxyXG4gICAgICByZXNpemUoKVxyXG4gICAgfSxcclxuICAgIGdldEJ1ZmZlcjogKCkgPT4gZnJhbWVCdWZmZXJcclxuICB9LFxyXG5cclxuICBnZXRSdW5uaW5nOiAoKSA9PiBydW5uaW5nLFxyXG4gIHNldFJ1bm5pbmc6ICh2YWx1ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgcnVubmluZyA9IHZhbHVlXHJcbiAgfVxyXG59XHJcblxyXG4vLyBldmVudCBoYW5kbGVyczpcclxuXHJcbmNvbnN0IHByZXZlbnREZWZhdWx0cyA9IG5ldyBTZXQ8c3RyaW5nPihbJ1RhYiddKVxyXG5cclxuY29uc3Qga2V5RG93biA9IChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gIGtleXNbZXZlbnQua2V5XSA9IHRydWVcclxuICBrZXlQcmVzc2VzLnB1c2goZXZlbnQua2V5KVxyXG5cclxuICBpZiAocHJldmVudERlZmF1bHRzLmhhcyhldmVudC5rZXkpKSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXHJcblxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBrZXlVcCA9IChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gIGtleXNbZXZlbnQua2V5XSA9IGZhbHNlXHJcblxyXG4gIC8vIGFueSBvdGhlcnMgaW4gZnV0dXJlXHJcblxyXG4gIC8vIFxyXG5cclxuICBpZiAocHJldmVudERlZmF1bHRzLmhhcyhldmVudC5rZXkpKSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXHJcblxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBtb3VzZU1vdmUgPSAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcclxuICB2aWV3TW91c2VYID0gZXZlbnQuY2xpZW50WFxyXG4gIHZpZXdNb3VzZVkgPSBldmVudC5jbGllbnRZXHJcblxyXG4gIGZyYW1lTW91c2VYID0gTWF0aC5mbG9vcih2aWV3TW91c2VYIC8gem9vbSlcclxuICBmcmFtZU1vdXNlWSA9IE1hdGguZmxvb3Iodmlld01vdXNlWSAvIHpvb20pXHJcbn1cclxuXHJcbmNvbnN0IG1vdXNlV2hlZWwgPSAoZXZlbnQ6IFdoZWVsRXZlbnQpID0+IHtcclxuICBtb3VzZVdoZWVsRGVsdGEgPSBldmVudC5kZWx0YVlcclxuXHJcbiAgaWYgKCF1c2VTeXN0ZW1Nb3VzZSkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxyXG5cclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuY29uc3QgbW91c2VCdXR0b25Eb3duID0gKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgbW91c2VCdXR0b25zW2V2ZW50LmJ1dHRvbl0gPSB0cnVlXHJcblxyXG4gIGlmICghdXNlU3lzdGVtTW91c2UpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcclxuXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IG1vdXNlQnV0dG9uVXAgPSAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcclxuICBtb3VzZUJ1dHRvbnNbZXZlbnQuYnV0dG9uXSA9IGZhbHNlXHJcblxyXG4gIGlmICghdXNlU3lzdGVtTW91c2UpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcclxuXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IHByZXZlbnRDb250ZXh0RGVmYXVsdCA9IChldmVudDogRXZlbnQpID0+IHtcclxuICBpZiAoIXVzZVN5c3RlbU1vdXNlKSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXHJcblxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBtb3VzZUxlYXZlID0gKCkgPT4ge1xyXG4gIGN1cnNvckluQm91bmRzID0gZmFsc2VcclxufVxyXG5cclxuY29uc3QgbW91c2VFbnRlciA9ICgpID0+IHtcclxuICBjdXJzb3JJbkJvdW5kcyA9IHRydWVcclxufVxyXG5cclxuY29uc3QgcmVzaXplID0gKCkgPT4ge1xyXG4gIGZyYW1lVyA9IE1hdGguZmxvb3IoaW5uZXJXaWR0aCAvIHpvb20pXHJcbiAgZnJhbWVIID0gTWF0aC5mbG9vcihpbm5lckhlaWdodCAvIHpvb20pXHJcblxyXG4gIGZyYW1lQnVmZmVyID0gY3JlYXRlSW1hZ2UoZnJhbWVXLCBmcmFtZUgpXHJcblxyXG4gIGZyYW1lQ2FudmFzLndpZHRoID0gZnJhbWVXXHJcbiAgZnJhbWVDYW52YXMuaGVpZ2h0ID0gZnJhbWVIXHJcbn1cclxuXHJcbi8vIG1vdXNlIGNvbnRyb2w6XHJcblxyXG5leHBvcnQgY29uc3QgcmVsZWFzZU1vdXNlID0gKCkgPT4ge1xyXG4gIHVzZVN5c3RlbU1vdXNlID0gdHJ1ZVxyXG4gIGZyYW1lQ2FudmFzLmNsYXNzTGlzdC50b2dnbGUoJ2hpZGUtY3Vyc29yJywgZmFsc2UpXHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCB0YWtlTW91c2UgPSAoKSA9PiB7XHJcbiAgdXNlU3lzdGVtTW91c2UgPSBmYWxzZVxyXG4gIGZyYW1lQ2FudmFzLmNsYXNzTGlzdC50b2dnbGUoJ2hpZGUtY3Vyc29yJywgdHJ1ZSlcclxufVxyXG5cclxuLy8gcnVubmVyOlxyXG5cclxuLy8gaW5pdGlhbGlzZSB0aGUgZW5naW5lIHdpdGggYSBzY2VuZVxyXG5leHBvcnQgY29uc3Qgc3RhcnQgPSBhc3luYyAoc2NlbmU6IFNjZW5lKSA9PiB7XHJcbiAgLy8gaWYgaXQgYWxyZWFkeSBoYXMgYSBzY2VuZSwgaGFsdCBpdCBmaXJzdFxyXG4gIGlmIChjdXJyZW50U2NlbmUpIGhhbHQoKVxyXG5cclxuICBjdXJyZW50U2NlbmUgPSBzY2VuZVxyXG5cclxuICBpZiAoZnJhbWVDYW52YXMpIGZyYW1lQ2FudmFzLnJlbW92ZSgpXHJcblxyXG4gIGZyYW1lQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJylcclxuICBmcmFtZUNhbnZhcy5pZCA9ICd2aWV3cG9ydCdcclxuICBmcmFtZUNhbnZhcy50YWJJbmRleCA9IDBcclxuXHJcbiAgZG9jdW1lbnQuYm9keS5hcHBlbmQoZnJhbWVDYW52YXMpXHJcblxyXG4gIGZyYW1lQ2FudmFzLmZvY3VzKClcclxuXHJcbiAgZnJhbWVDdHggPSBmcmFtZUNhbnZhcy5nZXRDb250ZXh0KCcyZCcpIVxyXG5cclxuICByZXNpemUoKVxyXG5cclxuICBhZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCByZXNpemUpXHJcblxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBrZXlEb3duKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywga2V5VXApXHJcblxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG1vdXNlTW92ZSlcclxuICBmcmFtZUNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCd3aGVlbCcsIG1vdXNlV2hlZWwpXHJcbiAgZnJhbWVDYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgbW91c2VCdXR0b25Eb3duKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBtb3VzZUJ1dHRvblVwKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgcHJldmVudENvbnRleHREZWZhdWx0KVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBtb3VzZUxlYXZlKVxyXG4gIGZyYW1lQ2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCBtb3VzZUVudGVyKVxyXG5cclxuICBydW5uaW5nID0gdHJ1ZVxyXG5cclxuICByYWZJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKVxyXG5cclxuICBhd2FpdCBzY2VuZS5pbml0KHN0YXRlKVxyXG5cclxuICBpc1JlYWR5ID0gdHJ1ZVxyXG59XHJcblxyXG4vLyB0aWR5IGV2ZXJ5dGhpbmcgdXBcclxuY29uc3QgaGFsdCA9ICgpID0+IHtcclxuICBydW5uaW5nID0gZmFsc2VcclxuICBpc1JlYWR5ID0gZmFsc2VcclxuXHJcbiAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmFmSWQpXHJcblxyXG4gIHJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHJlc2l6ZSlcclxuXHJcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGtleURvd24pXHJcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBrZXlVcClcclxuXHJcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgbW91c2VNb3ZlKVxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3doZWVsJywgbW91c2VXaGVlbClcclxuICBmcmFtZUNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBtb3VzZUJ1dHRvbkRvd24pXHJcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIG1vdXNlQnV0dG9uVXApXHJcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCBwcmV2ZW50Q29udGV4dERlZmF1bHQpXHJcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIG1vdXNlTGVhdmUpXHJcbiAgZnJhbWVDYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsIG1vdXNlRW50ZXIpXHJcblxyXG4gIGZyYW1lQ2FudmFzLnJlbW92ZSgpXHJcblxyXG4gIHN0YXJ0VGltZSA9IG51bGxcclxuXHJcbiAgcmVsZWFzZU1vdXNlKClcclxuXHJcbiAgaWYgKGN1cnJlbnRTY2VuZSkge1xyXG4gICAgY3VycmVudFNjZW5lLnF1aXQoc3RhdGUpLmNhdGNoKGNvbnNvbGUuZXJyb3IpXHJcblxyXG4gICAgY3VycmVudFNjZW5lID0gbnVsbFxyXG4gIH1cclxufVxyXG5cclxuY29uc3QgaW5pdFRpY2sgPSAodGltZTogbnVtYmVyKSA9PiB7XHJcbiAgaWYgKHN0YXJ0VGltZSAhPT0gbnVsbCkgcmV0dXJuIHN0YXJ0VGltZVxyXG5cclxuICAvLyBmaXJzdCB0aWNrXHJcblxyXG4gIHN0YXJ0VGltZSA9IHRpbWVcclxuXHJcbiAgZWxhcHNlZCA9IDBcclxuICBmcmFtZVRpbWUgPSAwXHJcbiAgbGFzdFRpbWUgPSB0aW1lXHJcblxyXG4gIHJldHVybiBzdGFydFRpbWVcclxufVxyXG5cclxuY29uc3QgdGljayA9ICh0aW1lOiBudW1iZXIpID0+IHtcclxuICBpZiAoIXJ1bm5pbmcpIHJldHVyblxyXG5cclxuICBzdGFydFRpbWUgPSBpbml0VGljayh0aW1lKVxyXG4gIGVsYXBzZWQgPSB0aW1lIC0gc3RhcnRUaW1lXHJcbiAgZnJhbWVUaW1lID0gdGltZSAtIGxhc3RUaW1lXHJcbiAgbGFzdFRpbWUgPSB0aW1lXHJcblxyXG4gIGlmIChjdXJyZW50U2NlbmUgJiYgaXNSZWFkeSkgY3VycmVudFNjZW5lLnVwZGF0ZShzdGF0ZSlcclxuXHJcbiAgLy8gc2NlbmUgbWF5IGhhdmUgc2VudCBhIHF1aXQgc2lnbmFsXHJcbiAgaWYgKCFydW5uaW5nKSB7XHJcbiAgICBoYWx0KClcclxuXHJcbiAgICByZXR1cm5cclxuICB9XHJcblxyXG4gIC8vIHJlbmRlclxyXG5cclxuICBmcmFtZUN0eC5wdXRJbWFnZURhdGEoZnJhbWVCdWZmZXIsIDAsIDApXHJcblxyXG4gIC8vXHJcblxyXG4gIHJhZklkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spXHJcbn1cclxuIl19
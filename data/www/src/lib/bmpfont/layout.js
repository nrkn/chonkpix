import { blit } from '../image/blit.js';
import { imageQueryAll } from '../image/query.js';
import { assrt } from '../util.js';
export const layoutTextLine = (font, line, x = 0, y = 0) => {
    const layout = Array(line.length);
    let dx = x;
    for (let i = 0; i < line.length; i++) {
        const charCode = line.charCodeAt(i);
        layout[i] = [charCode, dx, y];
        let width = font.width;
        if (font.type === 'proportional') {
            width = font.widths[charCode] || font.width;
            if (i < line.length - 1) {
                const kernFrom = font.kerning[charCode];
                if (kernFrom) {
                    const kernTo = kernFrom[line.charCodeAt(i + 1)];
                    if (kernTo) {
                        width += kernTo;
                    }
                }
            }
        }
        dx += width + font.advance;
    }
    return layout;
};
export const blitTextLayout = (dest, dx, dy, font, layout) => {
    for (let i = 0; i < layout.length; i++) {
        const glyphLayout = layout[i];
        const charCode = glyphLayout[0];
        const x = glyphLayout[1];
        const y = glyphLayout[2];
        const glyphRect = assrt(font.rects[charCode], `Expected rect for charCode ${charCode}`);
        const transfer = [...glyphRect, x + dx, y + dy];
        blit(font.image, dest, transfer);
    }
    return dest;
};
export const fontImageToPoints = (font) => {
    const charCodes = Object.keys(font.rects).map(Number);
    const fontPts = {};
    for (let c = 0; c < charCodes.length; c++) {
        const ch = charCodes[c];
        const rect = font.rects[ch];
        if (!rect)
            continue;
        const sheetPoints = imageQueryAll(font.image, r => r !== 0, rect);
        const pts = sheetPoints.map(([x, y]) => [x - rect[0], y - rect[1]]);
        fontPts[ch] = pts;
    }
    return fontPts;
};
export const textLayoutToIndices = (dest, dx, dy, font, layout, channels = 1) => {
    const indices = [];
    for (let i = 0; i < layout.length; i++) {
        const glyphLayout = layout[i];
        const charCode = glyphLayout[0];
        const cpts = font[charCode];
        if (!cpts)
            continue;
        const x = glyphLayout[1];
        const y = glyphLayout[2];
        for (let i = 0; i < cpts.length; i++) {
            let [px, py] = cpts[i];
            px = px + dx + x;
            py = py + dy + y;
            if (px < 0 || px >= dest.width || py < 0 || py >= dest.height)
                continue;
            const index = (py * dest.width + px) * channels;
            indices.push(index);
        }
    }
    return indices;
};
export const textLayoutToCharIndices = (dest, dx, dy, font, layout, channels = 1) => {
    const indices = [];
    for (let i = 0; i < layout.length; i++) {
        const glyphLayout = layout[i];
        const charCode = glyphLayout[0];
        const cpts = font[charCode];
        if (!cpts)
            continue;
        const x = glyphLayout[1];
        const y = glyphLayout[2];
        const charIndices = [];
        for (let i = 0; i < cpts.length; i++) {
            let [px, py] = cpts[i];
            px = px + dx + x;
            py = py + dy + y;
            if (px < 0 || px >= dest.width || py < 0 || py >= dest.height)
                continue;
            const index = (py * dest.width + px) * channels;
            charIndices.push(index);
        }
        indices.push(charIndices);
    }
    return indices;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF5b3V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9ibXBmb250L2xheW91dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDdkMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBRWpELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFHbEMsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLENBQzVCLElBQWEsRUFBRSxJQUFZLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUM5QixFQUFFO0lBQ2IsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFLLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUVyQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFFVixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3JDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFFbkMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUU3QixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFBO1FBRXRCLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxjQUFjLEVBQUUsQ0FBQztZQUNqQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFBO1lBRTNDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3hCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxP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LENBQUMsSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLE1BQU07Z0JBQUUsU0FBUTtZQUV2RSxNQUFNLEtBQUssR0FBRyxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQTtZQUUvQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3pCLENBQUM7UUFFRCxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQzNCLENBQUM7SUFFRCxPQUFPLE9BQU8sQ0FBQTtBQUNoQixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBibGl0IH0gZnJvbSAnLi4vaW1hZ2UvYmxpdC5qcydcbmltcG9ydCB7IGltYWdlUXVlcnlBbGwgfSBmcm9tICcuLi9pbWFnZS9xdWVyeS5qcydcbmltcG9ydCB7IE1heWJlLCBUMiwgVDMsIFQ0LCBUNiB9IGZyb20gJy4uL3R5cGVzLmpzJ1xuaW1wb3J0IHsgYXNzcnQgfSBmcm9tICcuLi91dGlsLmpzJ1xuaW1wb3J0IHsgQm1wRm9udCwgQm1wTGF5b3V0LCBGb250UG9pbnRzIH0gZnJvbSAnLi90eXBlcy5qcydcblxuZXhwb3J0IGNvbnN0IGxheW91dFRleHRMaW5lID0gKFxuICBmb250OiBCbXBGb250LCBsaW5lOiBzdHJpbmcsIHggPSAwLCB5ID0gMFxuKTogQm1wTGF5b3V0ID0+IHtcbiAgY29uc3QgbGF5b3V0ID0gQXJyYXk8VDM+KGxpbmUubGVuZ3RoKVxuXG4gIGxldCBkeCA9IHhcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxpbmUubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBjaGFyQ29kZSA9IGxpbmUuY2hhckNvZGVBdChpKVxuXG4gICAgbGF5b3V0W2ldID0gW2NoYXJDb2RlLCBkeCwgeV1cblxuICAgIGxldCB3aWR0aCA9IGZvbnQud2lkdGhcblxuICAgIGlmIChmb250LnR5cGUgPT09ICdwcm9wb3J0aW9uYWwnKSB7XG4gICAgICB3aWR0aCA9IGZvbnQud2lkdGhzW2NoYXJDb2RlXSB8fCBmb250LndpZHRoXG5cbiAgICAgIGlmIChpIDwgbGluZS5sZW5ndGggLSAxKSB7XG4gICAgICAgIGNvbnN0IGtlcm5Gcm9tID0gZm9udC5rZXJuaW5nW2NoYXJDb2RlXVxuXG4gICAgICAgIGlmIChrZXJuRnJvbSkge1xuICAgICAgICAgIGNvbnN0IGtlcm5UbyA9IGtlcm5Gcm9tW2xpbmUuY2hhckNvZGVBdChpICsgMSldXG5cbiAgICAgICAgICBpZiAoa2VyblRvKSB7XG4gICAgICAgICAgICB3aWR0aCArPSBrZXJuVG9cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBkeCArPSB3aWR0aCArIGZvbnQuYWR2YW5jZVxuICB9XG5cbiAgcmV0dXJuIGxheW91dFxufVxuXG5leHBvcnQgY29uc3QgYmxpdFRleHRMYXlvdXQgPSAoXG4gIGRlc3Q6IEltYWdlRGF0YSwgZHg6IG51bWJlciwgZHk6IG51bWJlciwgZm9udDogQm1wRm9udCwgbGF5b3V0OiBCbXBMYXlvdXRcbikgPT4ge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGxheW91dC5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGdseXBoTGF5b3V0ID0gbGF5b3V0W2ldXG4gICAgY29uc3QgY2hhckNvZGUgPSBnbHlwaExheW91dFswXVxuICAgIGNvbnN0IHggPSBnbHlwaExheW91dFsxXVxuICAgIGNvbnN0IHkgPSBnbHlwaExheW91dFsyXVxuXG4gICAgY29uc3QgZ2x5cGhSZWN0ID0gYXNzcnQoXG4gICAgICBmb250LnJlY3RzW2NoYXJDb2RlXSwgYEV4cGVjdGVkIHJlY3QgZm9yIGNoYXJDb2RlICR7Y2hhckNvZGV9YFxuICAgIClcblxuICAgIGNvbnN0IHRyYW5zZmVyOiBUNiA9IFsuLi5nbHlwaFJlY3QsIHggKyBkeCwgeSArIGR5XVxuXG4gICAgYmxpdChmb250LmltYWdlLCBkZXN0LCB0cmFuc2ZlcilcbiAgfVxuXG4gIHJldHVybiBkZXN0XG59XG5cbmV4cG9ydCBjb25zdCBmb250SW1hZ2VUb1BvaW50cyA9IChcbiAgZm9udDogQm1wRm9udFxuKTogUmVjb3JkPG51bWJlciwgTWF5YmU8VDJbXT4+ID0+IHtcbiAgY29uc3QgY2hhckNvZGVzID0gT2JqZWN0LmtleXMoZm9udC5yZWN0cykubWFwKE51bWJlcilcblxuICBjb25zdCBmb250UHRzOiBSZWNvcmQ8bnVtYmVyLCBNYXliZTxUMltdPj4gPSB7fVxuXG4gIGZvciAobGV0IGMgPSAwOyBjIDwgY2hhckNvZGVzLmxlbmd0aDsgYysrKSB7XG4gICAgY29uc3QgY2ggPSBjaGFyQ29kZXNbY11cbiAgICBjb25zdCByZWN0ID0gZm9udC5yZWN0c1tjaF1cblxuICAgIGlmICghcmVjdCkgY29udGludWVcblxuICAgIGNvbnN0IHNoZWV0UG9pbnRzID0gaW1hZ2VRdWVyeUFsbChmb250LmltYWdlLCByID0+IHIgIT09IDAsIHJlY3QpXG4gICAgY29uc3QgcHRzID0gc2hlZXRQb2ludHMubWFwKChbeCwgeV0pOiBUMiA9PiBbeCAtIHJlY3RbMF0sIHkgLSByZWN0WzFdXSlcblxuICAgIGZvbnRQdHNbY2hdID0gcHRzXG4gIH1cblxuICByZXR1cm4gZm9udFB0c1xufVxuXG5leHBvcnQgY29uc3QgdGV4dExheW91dFRvSW5kaWNlcyA9IChcbiAgZGVzdDogSW1hZ2VEYXRhLCBkeDogbnVtYmVyLCBkeTogbnVtYmVyLCBmb250OiBGb250UG9pbnRzLCBsYXlvdXQ6IEJtcExheW91dCxcbiAgY2hhbm5lbHMgPSAxXG4pOiBudW1iZXJbXSA9PiB7XG4gIGNvbnN0IGluZGljZXM6IG51bWJlcltdID0gW11cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxheW91dC5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGdseXBoTGF5b3V0ID0gbGF5b3V0W2ldXG4gICAgY29uc3QgY2hhckNvZGUgPSBnbHlwaExheW91dFswXVxuICAgIGNvbnN0IGNwdHMgPSBmb250W2NoYXJDb2RlXVxuXG4gICAgaWYgKCFjcHRzKSBjb250aW51ZVxuXG4gICAgY29uc3QgeCA9IGdseXBoTGF5b3V0WzFdXG4gICAgY29uc3QgeSA9IGdseXBoTGF5b3V0WzJdXG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNwdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBbcHgsIHB5XSA9IGNwdHNbaV1cblxuICAgICAgcHggPSBweCArIGR4ICsgeFxuICAgICAgcHkgPSBweSArIGR5ICsgeVxuXG4gICAgICBpZiAocHggPCAwIHx8IHB4ID49IGRlc3Qud2lkdGggfHwgcHkgPCAwIHx8IHB5ID49IGRlc3QuaGVpZ2h0KSBjb250aW51ZVxuXG4gICAgICBjb25zdCBpbmRleCA9IChweSAqIGRlc3Qud2lkdGggKyBweCkgKiBjaGFubmVsc1xuXG4gICAgICBpbmRpY2VzLnB1c2goaW5kZXgpXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGluZGljZXNcbn1cblxuZXhwb3J0IGNvbnN0IHRleHRMYXlvdXRUb0NoYXJJbmRpY2VzID0gKFxuICBkZXN0OiBJbWFnZURhdGEsIGR4OiBudW1iZXIsIGR5OiBudW1iZXIsIGZvbnQ6IEZvbnRQb2ludHMsIGxheW91dDogQm1wTGF5b3V0LFxuICBjaGFubmVscyA9IDFcbik6IG51bWJlcltdW10gPT4ge1xuICBjb25zdCBpbmRpY2VzOiBudW1iZXJbXVtdID0gW11cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxheW91dC5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGdseXBoTGF5b3V0ID0gbGF5b3V0W2ldXG4gICAgY29uc3QgY2hhckNvZGUgPSBnbHlwaExheW91dFswXVxuICAgIGNvbnN0IGNwdHMgPSBmb250W2NoYXJDb2RlXVxuXG4gICAgaWYgKCFjcHRzKSBjb250aW51ZVxuXG4gICAgY29uc3QgeCA9IGdseXBoTGF5b3V0WzFdXG4gICAgY29uc3QgeSA9IGdseXBoTGF5b3V0WzJdXG5cbiAgICBjb25zdCBjaGFySW5kaWNlczogbnVtYmVyW10gPSBbXVxuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjcHRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgW3B4LCBweV0gPSBjcHRzW2ldXG5cbiAgICAgIHB4ID0gcHggKyBkeCArIHhcbiAgICAgIHB5ID0gcHkgKyBkeSArIHlcblxuICAgICAgaWYgKHB4IDwgMCB8fCBweCA+PSBkZXN0LndpZHRoIHx8IHB5IDwgMCB8fCBweSA+PSBkZXN0LmhlaWdodCkgY29udGludWVcblxuICAgICAgY29uc3QgaW5kZXggPSAocHkgKiBkZXN0LndpZHRoICsgcHgpICogY2hhbm5lbHNcblxuICAgICAgY2hhckluZGljZXMucHVzaChpbmRleClcbiAgICB9XG5cbiAgICBpbmRpY2VzLnB1c2goY2hhckluZGljZXMpXG4gIH1cbiAgXG4gIHJldHVybiBpbmRpY2VzXG59Il19
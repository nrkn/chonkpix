import { blit } from '../image/blit.js';
import { imageQueryAll } from '../image/query.js';
import { assrt } from '../util.js';
export const layoutTextLine = (font, line, x = 0, y = 0) => {
    const layout = Array(line.length);
    let dx = x;
    for (let i = 0; i < line.length; i++) {
        const charCode = line.charCodeAt(i);
        layout[i] = [charCode, dx, y];
        let width = font.width;
        if (font.type === 'proportional') {
            width = font.widths[charCode] || font.width;
            if (i < line.length - 1) {
                const kernFrom = font.kerning[charCode];
                if (kernFrom) {
                    const kernTo = kernFrom[line.charCodeAt(i + 1)];
                    if (kernTo) {
                        width += kernTo;
                    }
                }
            }
        }
        dx += width + font.advance;
    }
    return layout;
};
export const blitTextLayout = (dest, dx, dy, font, layout) => {
    for (let i = 0; i < layout.length; i++) {
        const glyphLayout = layout[i];
        const charCode = glyphLayout[0];
        const x = glyphLayout[1];
        const y = glyphLayout[2];
        const glyphRect = assrt(font.rects[charCode], `Expected rect for charCode ${charCode}`);
        const transfer = [...glyphRect, x + dx, y + dy];
        blit(font.image, dest, transfer);
    }
    return dest;
};
export const fontImageToPoints = (font) => {
    const charCodes = Object.keys(font.rects).map(Number);
    const fontPts = {};
    for (let c = 0; c < charCodes.length; c++) {
        const ch = charCodes[c];
        const rect = font.rects[ch];
        if (!rect)
            continue;
        const sheetPoints = imageQueryAll(font.image, r => r !== 0, rect);
        const pts = sheetPoints.map(([x, y]) => [x - rect[0], y - rect[1]]);
        fontPts[ch] = pts;
    }
    return fontPts;
};
export const textLayoutToIndices = (dest, dx, dy, font, layout, channels = 1) => {
    const indices = [];
    for (let i = 0; i < layout.length; i++) {
        const glyphLayout = layout[i];
        const charCode = glyphLayout[0];
        const cpts = font[charCode];
        if (!cpts)
            continue;
        const x = glyphLayout[1];
        const y = glyphLayout[2];
        for (let i = 0; i < cpts.length; i++) {
            let [px, py] = cpts[i];
            px = px + dx + x;
            py = py + dy + y;
            if (px < 0 || px >= dest.width || py < 0 || py >= dest.height)
                continue;
            const index = (py * dest.width + px) * channels;
            indices.push(index);
        }
    }
    return indices;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF5b3V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9ibXBmb250L2xheW91dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDdkMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFBO0FBRWpELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFHbEMsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLENBQzVCLElBQWEsRUFBRSxJQUFZLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUM5QixFQUFFO0lBQ2IsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFLLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUVyQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFFVixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3JDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFFbkMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUU3QixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFBO1FBRXRCLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxjQUFjLEVBQUUsQ0FBQztZQUNqQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFBO1lBRTNDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3hCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxP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Q0FBQTtRQUNyQixDQUFDO0lBQ0gsQ0FBQztJQUVELE9BQU8sT0FBTyxDQUFBO0FBQ2hCLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGJsaXQgfSBmcm9tICcuLi9pbWFnZS9ibGl0LmpzJ1xyXG5pbXBvcnQgeyBpbWFnZVF1ZXJ5QWxsIH0gZnJvbSAnLi4vaW1hZ2UvcXVlcnkuanMnXHJcbmltcG9ydCB7IE1heWJlLCBUMiwgVDMsIFQ0LCBUNiB9IGZyb20gJy4uL3R5cGVzLmpzJ1xyXG5pbXBvcnQgeyBhc3NydCB9IGZyb20gJy4uL3V0aWwuanMnXHJcbmltcG9ydCB7IEJtcEZvbnQsIEJtcExheW91dCwgRm9udFBvaW50cyB9IGZyb20gJy4vdHlwZXMuanMnXHJcblxyXG5leHBvcnQgY29uc3QgbGF5b3V0VGV4dExpbmUgPSAoXHJcbiAgZm9udDogQm1wRm9udCwgbGluZTogc3RyaW5nLCB4ID0gMCwgeSA9IDBcclxuKTogQm1wTGF5b3V0ID0+IHtcclxuICBjb25zdCBsYXlvdXQgPSBBcnJheTxUMz4obGluZS5sZW5ndGgpXHJcblxyXG4gIGxldCBkeCA9IHhcclxuXHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaW5lLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBjb25zdCBjaGFyQ29kZSA9IGxpbmUuY2hhckNvZGVBdChpKVxyXG5cclxuICAgIGxheW91dFtpXSA9IFtjaGFyQ29kZSwgZHgsIHldXHJcblxyXG4gICAgbGV0IHdpZHRoID0gZm9udC53aWR0aFxyXG5cclxuICAgIGlmIChmb250LnR5cGUgPT09ICdwcm9wb3J0aW9uYWwnKSB7XHJcbiAgICAgIHdpZHRoID0gZm9udC53aWR0aHNbY2hhckNvZGVdIHx8IGZvbnQud2lkdGhcclxuXHJcbiAgICAgIGlmIChpIDwgbGluZS5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgY29uc3Qga2VybkZyb20gPSBmb250Lmtlcm5pbmdbY2hhckNvZGVdXHJcblxyXG4gICAgICAgIGlmIChrZXJuRnJvbSkge1xyXG4gICAgICAgICAgY29uc3Qga2VyblRvID0ga2VybkZyb21bbGluZS5jaGFyQ29kZUF0KGkgKyAxKV1cclxuXHJcbiAgICAgICAgICBpZiAoa2VyblRvKSB7XHJcbiAgICAgICAgICAgIHdpZHRoICs9IGtlcm5Ub1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGR4ICs9IHdpZHRoICsgZm9udC5hZHZhbmNlXHJcbiAgfVxyXG5cclxuICByZXR1cm4gbGF5b3V0XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBibGl0VGV4dExheW91dCA9IChcclxuICBkZXN0OiBJbWFnZURhdGEsIGR4OiBudW1iZXIsIGR5OiBudW1iZXIsIGZvbnQ6IEJtcEZvbnQsIGxheW91dDogQm1wTGF5b3V0XHJcbikgPT4ge1xyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbGF5b3V0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICBjb25zdCBnbHlwaExheW91dCA9IGxheW91dFtpXVxyXG4gICAgY29uc3QgY2hhckNvZGUgPSBnbHlwaExheW91dFswXVxyXG4gICAgY29uc3QgeCA9IGdseXBoTGF5b3V0WzFdXHJcbiAgICBjb25zdCB5ID0gZ2x5cGhMYXlvdXRbMl1cclxuXHJcbiAgICBjb25zdCBnbHlwaFJlY3QgPSBhc3NydChcclxuICAgICAgZm9udC5yZWN0c1tjaGFyQ29kZV0sIGBFeHBlY3RlZCByZWN0IGZvciBjaGFyQ29kZSAke2NoYXJDb2RlfWBcclxuICAgIClcclxuXHJcbiAgICBjb25zdCB0cmFuc2ZlcjogVDYgPSBbLi4uZ2x5cGhSZWN0LCB4ICsgZHgsIHkgKyBkeV1cclxuXHJcbiAgICBibGl0KGZvbnQuaW1hZ2UsIGRlc3QsIHRyYW5zZmVyKVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGRlc3RcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGZvbnRJbWFnZVRvUG9pbnRzID0gKFxyXG4gIGZvbnQ6IEJtcEZvbnRcclxuKTogUmVjb3JkPG51bWJlciwgTWF5YmU8VDJbXT4+ID0+IHtcclxuICBjb25zdCBjaGFyQ29kZXMgPSBPYmplY3Qua2V5cyhmb250LnJlY3RzKS5tYXAoTnVtYmVyKVxyXG5cclxuICBjb25zdCBmb250UHRzOiBSZWNvcmQ8bnVtYmVyLCBNYXliZTxUMltdPj4gPSB7fVxyXG5cclxuICBmb3IgKGxldCBjID0gMDsgYyA8IGNoYXJDb2Rlcy5sZW5ndGg7IGMrKykge1xyXG4gICAgY29uc3QgY2ggPSBjaGFyQ29kZXNbY11cclxuICAgIGNvbnN0IHJlY3QgPSBmb250LnJlY3RzW2NoXVxyXG5cclxuICAgIGlmICghcmVjdCkgY29udGludWVcclxuXHJcbiAgICBjb25zdCBzaGVldFBvaW50cyA9IGltYWdlUXVlcnlBbGwoZm9udC5pbWFnZSwgciA9PiByICE9PSAwLCByZWN0KVxyXG4gICAgY29uc3QgcHRzID0gc2hlZXRQb2ludHMubWFwKChbeCwgeV0pOiBUMiA9PiBbeCAtIHJlY3RbMF0sIHkgLSByZWN0WzFdXSlcclxuXHJcbiAgICBmb250UHRzW2NoXSA9IHB0c1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGZvbnRQdHNcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHRleHRMYXlvdXRUb0luZGljZXMgPSAoXHJcbiAgZGVzdDogSW1hZ2VEYXRhLCBkeDogbnVtYmVyLCBkeTogbnVtYmVyLCBmb250OiBGb250UG9pbnRzLCBsYXlvdXQ6IEJtcExheW91dCxcclxuICBjaGFubmVscyA9IDFcclxuKTogbnVtYmVyW10gPT4ge1xyXG4gIGNvbnN0IGluZGljZXM6IG51bWJlcltdID0gW11cclxuXHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXlvdXQubGVuZ3RoOyBpKyspIHtcclxuICAgIGNvbnN0IGdseXBoTGF5b3V0ID0gbGF5b3V0W2ldXHJcbiAgICBjb25zdCBjaGFyQ29kZSA9IGdseXBoTGF5b3V0WzBdXHJcbiAgICBjb25zdCBjcHRzID0gZm9udFtjaGFyQ29kZV1cclxuXHJcbiAgICBpZiAoIWNwdHMpIGNvbnRpbnVlXHJcblxyXG4gICAgY29uc3QgeCA9IGdseXBoTGF5b3V0WzFdXHJcbiAgICBjb25zdCB5ID0gZ2x5cGhMYXlvdXRbMl1cclxuXHJcbiAgICBmb3IoIGxldCBpID0gMDsgaSA8IGNwdHMubGVuZ3RoOyBpKysgKXtcclxuICAgICAgbGV0IFsgcHgsIHB5IF0gPSBjcHRzW2ldXHJcblxyXG4gICAgICBweCA9IHB4ICsgZHggKyB4XHJcbiAgICAgIHB5ID0gcHkgKyBkeSArIHlcclxuXHJcbiAgICAgIGlmKCBweCA8IDAgfHwgcHggPj0gZGVzdC53aWR0aCB8fCBweSA8IDAgfHwgcHkgPj0gZGVzdC5oZWlnaHQgKSBjb250aW51ZVxyXG5cclxuICAgICAgY29uc3QgaW5kZXggPSAocHkgKiBkZXN0LndpZHRoICsgcHgpICogY2hhbm5lbHNcclxuXHJcbiAgICAgIGluZGljZXMucHVzaChpbmRleClcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBpbmRpY2VzXHJcbn0iXX0=